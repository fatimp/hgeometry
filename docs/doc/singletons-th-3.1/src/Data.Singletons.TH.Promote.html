<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">{- Data/Singletons/TH/Promote.hs

(c) Richard Eisenberg 2013
rae@cs.brynmawr.edu

This file contains functions to promote term-level constructs to the
type level. It is an internal module to the singletons-th package.
-}</span><span>
</span><span id="line-9"></span><span>
</span><span id="line-10"></span><span class="hs-pragma">{-# LANGUAGE MultiWayIf, LambdaCase, TupleSections, ScopedTypeVariables #-}</span><span>
</span><span id="line-11"></span><span>
</span><span id="line-12"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Data.Singletons.TH.Promote</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-13"></span><span>
</span><span id="line-14"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Language.Haskell.TH</span></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier">Q</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">cxt</span></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-15"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Language.Haskell.TH.Syntax</span></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier">NameSpace</span></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">Quasi</span></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">Uniq</span></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-16"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Language.Haskell.TH.Desugar</span></span><span>
</span><span id="line-17"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Language.Haskell.TH.Desugar.OMap.Strict</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">OMap</span></span><span>
</span><span id="line-18"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Language.Haskell.TH.Desugar.OMap.Strict</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">OMap</span></span><span class="hs-special">)</span><span>
</span><span id="line-19"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Language.Haskell.TH.Desugar.OSet</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">OSet</span></span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Language.Haskell.TH.Desugar.OSet</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">OSet</span></span><span class="hs-special">)</span><span>
</span><span id="line-21"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Data.Singletons.TH.Deriving.Bounded.html"><span class="hs-identifier">Data.Singletons.TH.Deriving.Bounded</span></a></span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Data.Singletons.TH.Deriving.Enum.html"><span class="hs-identifier">Data.Singletons.TH.Deriving.Enum</span></a></span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Data.Singletons.TH.Deriving.Eq.html"><span class="hs-identifier">Data.Singletons.TH.Deriving.Eq</span></a></span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Data.Singletons.TH.Deriving.Ord.html"><span class="hs-identifier">Data.Singletons.TH.Deriving.Ord</span></a></span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Data.Singletons.TH.Deriving.Show.html"><span class="hs-identifier">Data.Singletons.TH.Deriving.Show</span></a></span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Data.Singletons.TH.Deriving.Util.html"><span class="hs-identifier">Data.Singletons.TH.Deriving.Util</span></a></span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Data.Singletons.TH.Names.html"><span class="hs-identifier">Data.Singletons.TH.Names</span></a></span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Data.Singletons.TH.Options.html"><span class="hs-identifier">Data.Singletons.TH.Options</span></a></span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Data.Singletons.TH.Partition.html"><span class="hs-identifier">Data.Singletons.TH.Partition</span></a></span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Data.Singletons.TH.Promote.Defun.html"><span class="hs-identifier">Data.Singletons.TH.Promote.Defun</span></a></span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Data.Singletons.TH.Promote.Monad.html"><span class="hs-identifier">Data.Singletons.TH.Promote.Monad</span></a></span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Data.Singletons.TH.Promote.Type.html"><span class="hs-identifier">Data.Singletons.TH.Promote.Type</span></a></span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Data.Singletons.TH.Syntax.html"><span class="hs-identifier">Data.Singletons.TH.Syntax</span></a></span><span>
</span><span id="line-34"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Data.Singletons.TH.Util.html"><span class="hs-identifier">Data.Singletons.TH.Util</span></a></span><span>
</span><span id="line-35"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Prelude</span></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">exp</span></span><span class="hs-special">)</span><span>
</span><span id="line-36"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Applicative</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Alternative</span></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-37"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Arrow</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">second</span></span><span class="hs-special">)</span><span>
</span><span id="line-38"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad</span></span><span>
</span><span id="line-39"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Trans.Maybe</span></span><span>
</span><span id="line-40"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Writer</span></span><span>
</span><span id="line-41"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.List</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">nub</span></span><span class="hs-special">)</span><span>
</span><span id="line-42"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Map.Strict</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Map</span></span><span>
</span><span id="line-43"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Map.Strict</span></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier">Map</span></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-44"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Maybe</span></span><span>
</span><span id="line-45"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">GHC.LanguageExtensions.Type</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">LangExt</span></span><span>
</span><span id="line-46"></span><span>
</span><span id="line-47"></span><span class="hs-comment">{-
Note [Disable genQuotedDecs in genPromotions and genSingletons]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Somewhat curiously, the genPromotions and genSingletons functions set the
genQuotedDecs option to False, despite neither function accepting quoted
declarations as arguments in the first place. There is a good reason for doing
this, however. Imagine this code:

  class C a where
    infixl 9 &lt;%%&gt;
    (&lt;%%&gt;) :: a -&gt; a -&gt; a
  $(genPromotions [''C])

If genQuotedDecs is set to True, then the (&lt;%%&gt;) type family will not receive
a fixity declaration (see
Note [singletons-th and fixity declarations] in D.S.TH.Single.Fixity, wrinkle 1 for
more details on this point). Therefore, we set genQuotedDecs to False to avoid
this problem.
-}</span><span>
</span><span id="line-66"></span><span>
</span><span id="line-67"></span><span class="hs-comment">-- | Generate promoted definitions for each of the provided type-level</span><span>
</span><span id="line-68"></span><span class="hs-comment">-- declaration 'Name's. This is generally only useful with classes.</span><span>
</span><span id="line-69"></span><span id="local-6989586621679309555"><span class="annot"><a href="Data.Singletons.TH.Promote.html#genPromotions"><span class="hs-identifier hs-type">genPromotions</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Data.Singletons.TH.Options.html#OptionsMonad"><span class="hs-identifier hs-type">OptionsMonad</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679309555"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679309555"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Dec</span></span><span class="hs-special">]</span></span><span>
</span><span id="line-70"></span><span id="genPromotions"><span class="annot"><span class="annottext">genPromotions :: forall (q :: * -&gt; *). OptionsMonad q =&gt; [Name] -&gt; q [Dec]
</span><a href="Data.Singletons.TH.Promote.html#genPromotions"><span class="hs-identifier hs-var hs-var">genPromotions</span></a></span></span><span> </span><span id="local-6989586621679308902"><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621679308902"><span class="hs-identifier hs-var">names</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-71"></span><span>  </span><span id="local-6989586621679308901"><span class="annot"><span class="annottext">Options
</span><a href="#local-6989586621679308901"><span class="hs-identifier hs-var">opts</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). OptionsMonad m =&gt; m Options
</span><a href="Data.Singletons.TH.Options.html#getOptions"><span class="hs-identifier hs-var">getOptions</span></a></span><span>
</span><span id="line-72"></span><span>  </span><span class="hs-comment">-- See Note [Disable genQuotedDecs in genPromotions and genSingletons]</span><span>
</span><span id="line-73"></span><span>  </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Options -&gt; OptionsM m a -&gt; m a
</span><a href="Data.Singletons.TH.Options.html#withOptions"><span class="hs-identifier hs-var">withOptions</span></a></span><span> </span><span class="annot"><span class="annottext">Options
</span><a href="#local-6989586621679308901"><span class="hs-identifier hs-var">opts</span></a></span><span class="hs-special">{</span><span class="annot"><span class="annottext">genQuotedDecs :: Bool
</span><a href="Data.Singletons.TH.Options.html#genQuotedDecs"><span class="hs-identifier hs-var">genQuotedDecs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">}</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-74"></span><span>    </span><span class="annot"><span class="annottext">forall (q :: * -&gt; *). Quasi q =&gt; [Name] -&gt; q ()
</span><a href="Data.Singletons.TH.Util.html#checkForRep"><span class="hs-identifier hs-var">checkForRep</span></a></span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621679308902"><span class="hs-identifier hs-var">names</span></a></span><span>
</span><span id="line-75"></span><span>    </span><span id="local-6989586621679308896"><span class="annot"><span class="annottext">[Info]
</span><a href="#local-6989586621679308896"><span class="hs-identifier hs-var">infos</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">forall (q :: * -&gt; *). DsMonad q =&gt; Name -&gt; q Info
</span><span class="hs-identifier hs-var">reifyWithLocals</span></span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621679308902"><span class="hs-identifier hs-var">names</span></a></span><span>
</span><span id="line-76"></span><span>    </span><span id="local-6989586621679308893"><span class="annot"><span class="annottext">[DInfo]
</span><a href="#local-6989586621679308893"><span class="hs-identifier hs-var">dinfos</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">forall (q :: * -&gt; *). DsMonad q =&gt; Info -&gt; q DInfo
</span><span class="hs-identifier hs-var">dsInfo</span></span><span> </span><span class="annot"><span class="annottext">[Info]
</span><a href="#local-6989586621679308896"><span class="hs-identifier hs-var">infos</span></a></span><span>
</span><span id="line-77"></span><span>    </span><span id="local-6989586621679308891"><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621679308891"><span class="hs-identifier hs-var">ddecs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (q :: * -&gt; *). OptionsMonad q =&gt; [Dec] -&gt; PrM () -&gt; q [DDec]
</span><a href="Data.Singletons.TH.Promote.Monad.html#promoteM_"><span class="hs-identifier hs-var">promoteM_</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><span class="hs-identifier hs-var">mapM_</span></span><span> </span><span class="annot"><span class="annottext">DInfo -&gt; PrM ()
</span><a href="Data.Singletons.TH.Promote.html#promoteInfo"><span class="hs-identifier hs-var">promoteInfo</span></a></span><span> </span><span class="annot"><span class="annottext">[DInfo]
</span><a href="#local-6989586621679308893"><span class="hs-identifier hs-var">dinfos</span></a></span><span>
</span><span id="line-78"></span><span>    </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[DDec] -&gt; [Dec]
</span><span class="hs-identifier hs-var">decsToTH</span></span><span> </span><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621679308891"><span class="hs-identifier hs-var">ddecs</span></a></span><span>
</span><span id="line-79"></span><span>
</span><span id="line-80"></span><span class="hs-comment">-- | Promote every declaration given to the type level, retaining the originals.</span><span>
</span><span id="line-81"></span><span class="hs-comment">-- See the</span><span>
</span><span id="line-82"></span><span class="hs-comment">-- @&lt;https://github.com/goldfirere/singletons/blob/master/README.md README&gt;@</span><span>
</span><span id="line-83"></span><span class="hs-comment">-- for further explanation.</span><span>
</span><span id="line-84"></span><span id="local-6989586621679309522"><span class="annot"><a href="Data.Singletons.TH.Promote.html#promote"><span class="hs-identifier hs-type">promote</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Data.Singletons.TH.Options.html#OptionsMonad"><span class="hs-identifier hs-type">OptionsMonad</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679309522"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679309522"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Dec</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679309522"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Dec</span></span><span class="hs-special">]</span></span><span>
</span><span id="line-85"></span><span id="promote"><span class="annot"><span class="annottext">promote :: forall (q :: * -&gt; *). OptionsMonad q =&gt; q [Dec] -&gt; q [Dec]
</span><a href="Data.Singletons.TH.Promote.html#promote"><span class="hs-identifier hs-var hs-var">promote</span></a></span></span><span> </span><span id="local-6989586621679308875"><span class="annot"><span class="annottext">q [Dec]
</span><a href="#local-6989586621679308875"><span class="hs-identifier hs-var">qdecs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-86"></span><span>  </span><span id="local-6989586621679308874"><span class="annot"><span class="annottext">Options
</span><a href="#local-6989586621679308874"><span class="hs-identifier hs-var">opts</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). OptionsMonad m =&gt; m Options
</span><a href="Data.Singletons.TH.Options.html#getOptions"><span class="hs-identifier hs-var">getOptions</span></a></span><span>
</span><span id="line-87"></span><span>  </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Options -&gt; OptionsM m a -&gt; m a
</span><a href="Data.Singletons.TH.Options.html#withOptions"><span class="hs-identifier hs-var">withOptions</span></a></span><span> </span><span class="annot"><span class="annottext">Options
</span><a href="#local-6989586621679308874"><span class="hs-identifier hs-var">opts</span></a></span><span class="hs-special">{</span><span class="annot"><span class="annottext">genQuotedDecs :: Bool
</span><a href="Data.Singletons.TH.Options.html#genQuotedDecs"><span class="hs-identifier hs-var">genQuotedDecs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">}</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall (q :: * -&gt; *). OptionsMonad q =&gt; q [Dec] -&gt; q [Dec]
</span><a href="Data.Singletons.TH.Promote.html#promote%27"><span class="hs-identifier hs-var">promote'</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">q [Dec]
</span><a href="#local-6989586621679308875"><span class="hs-identifier hs-var">qdecs</span></a></span><span>
</span><span id="line-88"></span><span>
</span><span id="line-89"></span><span class="hs-comment">-- | Promote each declaration, discarding the originals. Note that a promoted</span><span>
</span><span id="line-90"></span><span class="hs-comment">-- datatype uses the same definition as an original datatype, so this will</span><span>
</span><span id="line-91"></span><span class="hs-comment">-- not work with datatypes. Classes, instances, and functions are all fine.</span><span>
</span><span id="line-92"></span><span id="local-6989586621679308871"><span class="annot"><a href="Data.Singletons.TH.Promote.html#promoteOnly"><span class="hs-identifier hs-type">promoteOnly</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Data.Singletons.TH.Options.html#OptionsMonad"><span class="hs-identifier hs-type">OptionsMonad</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679308871"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679308871"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Dec</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679308871"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Dec</span></span><span class="hs-special">]</span></span><span>
</span><span id="line-93"></span><span id="promoteOnly"><span class="annot"><span class="annottext">promoteOnly :: forall (q :: * -&gt; *). OptionsMonad q =&gt; q [Dec] -&gt; q [Dec]
</span><a href="Data.Singletons.TH.Promote.html#promoteOnly"><span class="hs-identifier hs-var hs-var">promoteOnly</span></a></span></span><span> </span><span id="local-6989586621679308860"><span class="annot"><span class="annottext">q [Dec]
</span><a href="#local-6989586621679308860"><span class="hs-identifier hs-var">qdecs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-94"></span><span>  </span><span id="local-6989586621679308859"><span class="annot"><span class="annottext">Options
</span><a href="#local-6989586621679308859"><span class="hs-identifier hs-var">opts</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). OptionsMonad m =&gt; m Options
</span><a href="Data.Singletons.TH.Options.html#getOptions"><span class="hs-identifier hs-var">getOptions</span></a></span><span>
</span><span id="line-95"></span><span>  </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Options -&gt; OptionsM m a -&gt; m a
</span><a href="Data.Singletons.TH.Options.html#withOptions"><span class="hs-identifier hs-var">withOptions</span></a></span><span> </span><span class="annot"><span class="annottext">Options
</span><a href="#local-6989586621679308859"><span class="hs-identifier hs-var">opts</span></a></span><span class="hs-special">{</span><span class="annot"><span class="annottext">genQuotedDecs :: Bool
</span><a href="Data.Singletons.TH.Options.html#genQuotedDecs"><span class="hs-identifier hs-var">genQuotedDecs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">}</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall (q :: * -&gt; *). OptionsMonad q =&gt; q [Dec] -&gt; q [Dec]
</span><a href="Data.Singletons.TH.Promote.html#promote%27"><span class="hs-identifier hs-var">promote'</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">q [Dec]
</span><a href="#local-6989586621679308860"><span class="hs-identifier hs-var">qdecs</span></a></span><span>
</span><span id="line-96"></span><span>
</span><span id="line-97"></span><span class="hs-comment">-- The workhorse for 'promote' and 'promoteOnly'. The difference between the</span><span>
</span><span id="line-98"></span><span class="hs-comment">-- two functions is whether 'genQuotedDecs' is set to 'True' or 'False'.</span><span>
</span><span id="line-99"></span><span id="local-6989586621679308858"><span class="annot"><a href="Data.Singletons.TH.Promote.html#promote%27"><span class="hs-identifier hs-type">promote'</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Data.Singletons.TH.Options.html#OptionsMonad"><span class="hs-identifier hs-type">OptionsMonad</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679308858"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679308858"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Dec</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679308858"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Dec</span></span><span class="hs-special">]</span></span><span>
</span><span id="line-100"></span><span id="promote%27"><span class="annot"><span class="annottext">promote' :: forall (q :: * -&gt; *). OptionsMonad q =&gt; q [Dec] -&gt; q [Dec]
</span><a href="Data.Singletons.TH.Promote.html#promote%27"><span class="hs-identifier hs-var hs-var">promote'</span></a></span></span><span> </span><span id="local-6989586621679308842"><span class="annot"><span class="annottext">q [Dec]
</span><a href="#local-6989586621679308842"><span class="hs-identifier hs-var">qdecs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-101"></span><span>  </span><span id="local-6989586621679308841"><span class="annot"><span class="annottext">Options
</span><a href="#local-6989586621679308841"><span class="hs-identifier hs-var">opts</span></a></span></span><span>     </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). OptionsMonad m =&gt; m Options
</span><a href="Data.Singletons.TH.Options.html#getOptions"><span class="hs-identifier hs-var">getOptions</span></a></span><span>
</span><span id="line-102"></span><span>  </span><span id="local-6989586621679308840"><span class="annot"><span class="annottext">[Dec]
</span><a href="#local-6989586621679308840"><span class="hs-identifier hs-var">decs</span></a></span></span><span>     </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">q [Dec]
</span><a href="#local-6989586621679308842"><span class="hs-identifier hs-var">qdecs</span></a></span><span>
</span><span id="line-103"></span><span>  </span><span id="local-6989586621679308839"><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621679308839"><span class="hs-identifier hs-var">ddecs</span></a></span></span><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (q :: * -&gt; *) a. DsMonad q =&gt; [Dec] -&gt; DsM q a -&gt; q a
</span><span class="hs-identifier hs-var">withLocalDeclarations</span></span><span> </span><span class="annot"><span class="annottext">[Dec]
</span><a href="#local-6989586621679308840"><span class="hs-identifier hs-var">decs</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall (q :: * -&gt; *). DsMonad q =&gt; [Dec] -&gt; q [DDec]
</span><span class="hs-identifier hs-var">dsDecs</span></span><span> </span><span class="annot"><span class="annottext">[Dec]
</span><a href="#local-6989586621679308840"><span class="hs-identifier hs-var">decs</span></a></span><span>
</span><span id="line-104"></span><span>  </span><span id="local-6989586621679308836"><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621679308836"><span class="hs-identifier hs-var">promDecs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (q :: * -&gt; *). OptionsMonad q =&gt; [Dec] -&gt; PrM () -&gt; q [DDec]
</span><a href="Data.Singletons.TH.Promote.Monad.html#promoteM_"><span class="hs-identifier hs-var">promoteM_</span></a></span><span> </span><span class="annot"><span class="annottext">[Dec]
</span><a href="#local-6989586621679308840"><span class="hs-identifier hs-var">decs</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[DDec] -&gt; PrM ()
</span><a href="Data.Singletons.TH.Promote.html#promoteDecs"><span class="hs-identifier hs-var">promoteDecs</span></a></span><span> </span><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621679308839"><span class="hs-identifier hs-var">ddecs</span></a></span><span>
</span><span id="line-105"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679308834"><span class="annot"><span class="annottext">origDecs :: [Dec]
</span><a href="#local-6989586621679308834"><span class="hs-identifier hs-var hs-var">origDecs</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Options -&gt; Bool
</span><a href="Data.Singletons.TH.Options.html#genQuotedDecs"><span class="hs-identifier hs-var">genQuotedDecs</span></a></span><span> </span><span class="annot"><span class="annottext">Options
</span><a href="#local-6989586621679308841"><span class="hs-identifier hs-var">opts</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Dec]
</span><a href="#local-6989586621679308840"><span class="hs-identifier hs-var">decs</span></a></span><span>
</span><span id="line-106"></span><span>               </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-107"></span><span>  </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Dec]
</span><a href="#local-6989586621679308834"><span class="hs-identifier hs-var">origDecs</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[DDec] -&gt; [Dec]
</span><span class="hs-identifier hs-var">decsToTH</span></span><span> </span><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621679308836"><span class="hs-identifier hs-var">promDecs</span></a></span><span>
</span><span id="line-108"></span><span>
</span><span id="line-109"></span><span class="hs-comment">-- | Generate defunctionalization symbols for each of the provided type-level</span><span>
</span><span id="line-110"></span><span class="hs-comment">-- declaration 'Name's. See the &quot;Promotion and partial application&quot; section of</span><span>
</span><span id="line-111"></span><span class="hs-comment">-- the @singletons@</span><span>
</span><span id="line-112"></span><span class="hs-comment">-- @&lt;https://github.com/goldfirere/singletons/blob/master/README.md README&gt;@</span><span>
</span><span id="line-113"></span><span class="hs-comment">-- for further explanation.</span><span>
</span><span id="line-114"></span><span id="local-6989586621679308833"><span class="annot"><a href="Data.Singletons.TH.Promote.html#genDefunSymbols"><span class="hs-identifier hs-type">genDefunSymbols</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Data.Singletons.TH.Options.html#OptionsMonad"><span class="hs-identifier hs-type">OptionsMonad</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679308833"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679308833"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Dec</span></span><span class="hs-special">]</span></span><span>
</span><span id="line-115"></span><span id="genDefunSymbols"><span class="annot"><span class="annottext">genDefunSymbols :: forall (q :: * -&gt; *). OptionsMonad q =&gt; [Name] -&gt; q [Dec]
</span><a href="Data.Singletons.TH.Promote.html#genDefunSymbols"><span class="hs-identifier hs-var hs-var">genDefunSymbols</span></a></span></span><span> </span><span id="local-6989586621679308812"><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621679308812"><span class="hs-identifier hs-var">names</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-116"></span><span>  </span><span class="annot"><span class="annottext">forall (q :: * -&gt; *). Quasi q =&gt; [Name] -&gt; q ()
</span><a href="Data.Singletons.TH.Util.html#checkForRep"><span class="hs-identifier hs-var">checkForRep</span></a></span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621679308812"><span class="hs-identifier hs-var">names</span></a></span><span>
</span><span id="line-117"></span><span>  </span><span id="local-6989586621679308811"><span class="annot"><span class="annottext">[DInfo]
</span><a href="#local-6989586621679308811"><span class="hs-identifier hs-var">infos</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (q :: * -&gt; *). DsMonad q =&gt; Info -&gt; q DInfo
</span><span class="hs-identifier hs-var">dsInfo</span></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) b c a.
Monad m =&gt;
(b -&gt; m c) -&gt; (a -&gt; m b) -&gt; a -&gt; m c
</span><span class="hs-operator hs-var">&lt;=&lt;</span></span><span> </span><span class="annot"><span class="annottext">forall (q :: * -&gt; *). DsMonad q =&gt; Name -&gt; q Info
</span><span class="hs-identifier hs-var">reifyWithLocals</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621679308812"><span class="hs-identifier hs-var">names</span></a></span><span>
</span><span id="line-118"></span><span>  </span><span id="local-6989586621679308809"><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621679308809"><span class="hs-identifier hs-var">decs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (q :: * -&gt; *).
OptionsMonad q =&gt;
[Dec] -&gt; PrM [DDec] -&gt; q [DDec]
</span><a href="Data.Singletons.TH.Promote.Monad.html#promoteMDecs"><span class="hs-identifier hs-var">promoteMDecs</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall (monad :: * -&gt; *) monoid (t :: * -&gt; *) a.
(Monad monad, Monoid monoid, Traversable t) =&gt;
(a -&gt; monad monoid) -&gt; t a -&gt; monad monoid
</span><a href="Data.Singletons.TH.Util.html#concatMapM"><span class="hs-identifier hs-var">concatMapM</span></a></span><span> </span><span class="annot"><span class="annottext">DInfo -&gt; PrM [DDec]
</span><a href="Data.Singletons.TH.Promote.Defun.html#defunInfo"><span class="hs-identifier hs-var">defunInfo</span></a></span><span> </span><span class="annot"><span class="annottext">[DInfo]
</span><a href="#local-6989586621679308811"><span class="hs-identifier hs-var">infos</span></a></span><span>
</span><span id="line-119"></span><span>  </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[DDec] -&gt; [Dec]
</span><span class="hs-identifier hs-var">decsToTH</span></span><span> </span><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621679308809"><span class="hs-identifier hs-var">decs</span></a></span><span>
</span><span id="line-120"></span><span>
</span><span id="line-121"></span><span class="hs-comment">-- | Produce instances for @PEq@ from the given types</span><span>
</span><span id="line-122"></span><span id="local-6989586621679308805"><span class="annot"><a href="Data.Singletons.TH.Promote.html#promoteEqInstances"><span class="hs-identifier hs-type">promoteEqInstances</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Data.Singletons.TH.Options.html#OptionsMonad"><span class="hs-identifier hs-type">OptionsMonad</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679308805"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679308805"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Dec</span></span><span class="hs-special">]</span></span><span>
</span><span id="line-123"></span><span id="promoteEqInstances"><span class="annot"><span class="annottext">promoteEqInstances :: forall (q :: * -&gt; *). OptionsMonad q =&gt; [Name] -&gt; q [Dec]
</span><a href="Data.Singletons.TH.Promote.html#promoteEqInstances"><span class="hs-identifier hs-var hs-var">promoteEqInstances</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (monad :: * -&gt; *) monoid (t :: * -&gt; *) a.
(Monad monad, Monoid monoid, Traversable t) =&gt;
(a -&gt; monad monoid) -&gt; t a -&gt; monad monoid
</span><a href="Data.Singletons.TH.Util.html#concatMapM"><span class="hs-identifier hs-var">concatMapM</span></a></span><span> </span><span class="annot"><span class="annottext">forall (q :: * -&gt; *). OptionsMonad q =&gt; Name -&gt; q [Dec]
</span><a href="Data.Singletons.TH.Promote.html#promoteEqInstance"><span class="hs-identifier hs-var">promoteEqInstance</span></a></span><span>
</span><span id="line-124"></span><span>
</span><span id="line-125"></span><span class="hs-comment">-- | Produce an instance for @PEq@ from the given type</span><span>
</span><span id="line-126"></span><span id="local-6989586621679309498"><span class="annot"><a href="Data.Singletons.TH.Promote.html#promoteEqInstance"><span class="hs-identifier hs-type">promoteEqInstance</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Data.Singletons.TH.Options.html#OptionsMonad"><span class="hs-identifier hs-type">OptionsMonad</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679309498"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679309498"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Dec</span></span><span class="hs-special">]</span></span><span>
</span><span id="line-127"></span><span id="promoteEqInstance"><span class="annot"><span class="annottext">promoteEqInstance :: forall (q :: * -&gt; *). OptionsMonad q =&gt; Name -&gt; q [Dec]
</span><a href="Data.Singletons.TH.Promote.html#promoteEqInstance"><span class="hs-identifier hs-var hs-var">promoteEqInstance</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (q :: * -&gt; *).
OptionsMonad q =&gt;
DerivDesc q -&gt; String -&gt; Name -&gt; q [Dec]
</span><a href="Data.Singletons.TH.Promote.html#promoteInstance"><span class="hs-identifier hs-var">promoteInstance</span></a></span><span> </span><span class="annot"><span class="annottext">forall (q :: * -&gt; *). DsMonad q =&gt; DerivDesc q
</span><a href="Data.Singletons.TH.Deriving.Eq.html#mkEqInstance"><span class="hs-identifier hs-var">mkEqInstance</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Eq&quot;</span></span><span>
</span><span id="line-128"></span><span>
</span><span id="line-129"></span><span class="hs-comment">-- | Produce instances for 'POrd' from the given types</span><span>
</span><span id="line-130"></span><span id="local-6989586621679308788"><span class="annot"><a href="Data.Singletons.TH.Promote.html#promoteOrdInstances"><span class="hs-identifier hs-type">promoteOrdInstances</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Data.Singletons.TH.Options.html#OptionsMonad"><span class="hs-identifier hs-type">OptionsMonad</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679308788"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679308788"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Dec</span></span><span class="hs-special">]</span></span><span>
</span><span id="line-131"></span><span id="promoteOrdInstances"><span class="annot"><span class="annottext">promoteOrdInstances :: forall (q :: * -&gt; *). OptionsMonad q =&gt; [Name] -&gt; q [Dec]
</span><a href="Data.Singletons.TH.Promote.html#promoteOrdInstances"><span class="hs-identifier hs-var hs-var">promoteOrdInstances</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (monad :: * -&gt; *) monoid (t :: * -&gt; *) a.
(Monad monad, Monoid monoid, Traversable t) =&gt;
(a -&gt; monad monoid) -&gt; t a -&gt; monad monoid
</span><a href="Data.Singletons.TH.Util.html#concatMapM"><span class="hs-identifier hs-var">concatMapM</span></a></span><span> </span><span class="annot"><span class="annottext">forall (q :: * -&gt; *). OptionsMonad q =&gt; Name -&gt; q [Dec]
</span><a href="Data.Singletons.TH.Promote.html#promoteOrdInstance"><span class="hs-identifier hs-var">promoteOrdInstance</span></a></span><span>
</span><span id="line-132"></span><span>
</span><span id="line-133"></span><span class="hs-comment">-- | Produce an instance for 'POrd' from the given type</span><span>
</span><span id="line-134"></span><span id="local-6989586621679308777"><span class="annot"><a href="Data.Singletons.TH.Promote.html#promoteOrdInstance"><span class="hs-identifier hs-type">promoteOrdInstance</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Data.Singletons.TH.Options.html#OptionsMonad"><span class="hs-identifier hs-type">OptionsMonad</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679308777"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679308777"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Dec</span></span><span class="hs-special">]</span></span><span>
</span><span id="line-135"></span><span id="promoteOrdInstance"><span class="annot"><span class="annottext">promoteOrdInstance :: forall (q :: * -&gt; *). OptionsMonad q =&gt; Name -&gt; q [Dec]
</span><a href="Data.Singletons.TH.Promote.html#promoteOrdInstance"><span class="hs-identifier hs-var hs-var">promoteOrdInstance</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (q :: * -&gt; *).
OptionsMonad q =&gt;
DerivDesc q -&gt; String -&gt; Name -&gt; q [Dec]
</span><a href="Data.Singletons.TH.Promote.html#promoteInstance"><span class="hs-identifier hs-var">promoteInstance</span></a></span><span> </span><span class="annot"><span class="annottext">forall (q :: * -&gt; *). DsMonad q =&gt; DerivDesc q
</span><a href="Data.Singletons.TH.Deriving.Ord.html#mkOrdInstance"><span class="hs-identifier hs-var">mkOrdInstance</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Ord&quot;</span></span><span>
</span><span id="line-136"></span><span>
</span><span id="line-137"></span><span class="hs-comment">-- | Produce instances for 'PBounded' from the given types</span><span>
</span><span id="line-138"></span><span id="local-6989586621679308771"><span class="annot"><a href="Data.Singletons.TH.Promote.html#promoteBoundedInstances"><span class="hs-identifier hs-type">promoteBoundedInstances</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Data.Singletons.TH.Options.html#OptionsMonad"><span class="hs-identifier hs-type">OptionsMonad</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679308771"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679308771"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Dec</span></span><span class="hs-special">]</span></span><span>
</span><span id="line-139"></span><span id="promoteBoundedInstances"><span class="annot"><span class="annottext">promoteBoundedInstances :: forall (q :: * -&gt; *). OptionsMonad q =&gt; [Name] -&gt; q [Dec]
</span><a href="Data.Singletons.TH.Promote.html#promoteBoundedInstances"><span class="hs-identifier hs-var hs-var">promoteBoundedInstances</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (monad :: * -&gt; *) monoid (t :: * -&gt; *) a.
(Monad monad, Monoid monoid, Traversable t) =&gt;
(a -&gt; monad monoid) -&gt; t a -&gt; monad monoid
</span><a href="Data.Singletons.TH.Util.html#concatMapM"><span class="hs-identifier hs-var">concatMapM</span></a></span><span> </span><span class="annot"><span class="annottext">forall (q :: * -&gt; *). OptionsMonad q =&gt; Name -&gt; q [Dec]
</span><a href="Data.Singletons.TH.Promote.html#promoteBoundedInstance"><span class="hs-identifier hs-var">promoteBoundedInstance</span></a></span><span>
</span><span id="line-140"></span><span>
</span><span id="line-141"></span><span class="hs-comment">-- | Produce an instance for 'PBounded' from the given type</span><span>
</span><span id="line-142"></span><span id="local-6989586621679308760"><span class="annot"><a href="Data.Singletons.TH.Promote.html#promoteBoundedInstance"><span class="hs-identifier hs-type">promoteBoundedInstance</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Data.Singletons.TH.Options.html#OptionsMonad"><span class="hs-identifier hs-type">OptionsMonad</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679308760"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679308760"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Dec</span></span><span class="hs-special">]</span></span><span>
</span><span id="line-143"></span><span id="promoteBoundedInstance"><span class="annot"><span class="annottext">promoteBoundedInstance :: forall (q :: * -&gt; *). OptionsMonad q =&gt; Name -&gt; q [Dec]
</span><a href="Data.Singletons.TH.Promote.html#promoteBoundedInstance"><span class="hs-identifier hs-var hs-var">promoteBoundedInstance</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (q :: * -&gt; *).
OptionsMonad q =&gt;
DerivDesc q -&gt; String -&gt; Name -&gt; q [Dec]
</span><a href="Data.Singletons.TH.Promote.html#promoteInstance"><span class="hs-identifier hs-var">promoteInstance</span></a></span><span> </span><span class="annot"><span class="annottext">forall (q :: * -&gt; *). DsMonad q =&gt; DerivDesc q
</span><a href="Data.Singletons.TH.Deriving.Bounded.html#mkBoundedInstance"><span class="hs-identifier hs-var">mkBoundedInstance</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Bounded&quot;</span></span><span>
</span><span id="line-144"></span><span>
</span><span id="line-145"></span><span class="hs-comment">-- | Produce instances for 'PEnum' from the given types</span><span>
</span><span id="line-146"></span><span id="local-6989586621679308754"><span class="annot"><a href="Data.Singletons.TH.Promote.html#promoteEnumInstances"><span class="hs-identifier hs-type">promoteEnumInstances</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Data.Singletons.TH.Options.html#OptionsMonad"><span class="hs-identifier hs-type">OptionsMonad</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679308754"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679308754"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Dec</span></span><span class="hs-special">]</span></span><span>
</span><span id="line-147"></span><span id="promoteEnumInstances"><span class="annot"><span class="annottext">promoteEnumInstances :: forall (q :: * -&gt; *). OptionsMonad q =&gt; [Name] -&gt; q [Dec]
</span><a href="Data.Singletons.TH.Promote.html#promoteEnumInstances"><span class="hs-identifier hs-var hs-var">promoteEnumInstances</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (monad :: * -&gt; *) monoid (t :: * -&gt; *) a.
(Monad monad, Monoid monoid, Traversable t) =&gt;
(a -&gt; monad monoid) -&gt; t a -&gt; monad monoid
</span><a href="Data.Singletons.TH.Util.html#concatMapM"><span class="hs-identifier hs-var">concatMapM</span></a></span><span> </span><span class="annot"><span class="annottext">forall (q :: * -&gt; *). OptionsMonad q =&gt; Name -&gt; q [Dec]
</span><a href="Data.Singletons.TH.Promote.html#promoteEnumInstance"><span class="hs-identifier hs-var">promoteEnumInstance</span></a></span><span>
</span><span id="line-148"></span><span>
</span><span id="line-149"></span><span class="hs-comment">-- | Produce an instance for 'PEnum' from the given type</span><span>
</span><span id="line-150"></span><span id="local-6989586621679308743"><span class="annot"><a href="Data.Singletons.TH.Promote.html#promoteEnumInstance"><span class="hs-identifier hs-type">promoteEnumInstance</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Data.Singletons.TH.Options.html#OptionsMonad"><span class="hs-identifier hs-type">OptionsMonad</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679308743"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679308743"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Dec</span></span><span class="hs-special">]</span></span><span>
</span><span id="line-151"></span><span id="promoteEnumInstance"><span class="annot"><span class="annottext">promoteEnumInstance :: forall (q :: * -&gt; *). OptionsMonad q =&gt; Name -&gt; q [Dec]
</span><a href="Data.Singletons.TH.Promote.html#promoteEnumInstance"><span class="hs-identifier hs-var hs-var">promoteEnumInstance</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (q :: * -&gt; *).
OptionsMonad q =&gt;
DerivDesc q -&gt; String -&gt; Name -&gt; q [Dec]
</span><a href="Data.Singletons.TH.Promote.html#promoteInstance"><span class="hs-identifier hs-var">promoteInstance</span></a></span><span> </span><span class="annot"><span class="annottext">forall (q :: * -&gt; *). DsMonad q =&gt; DerivDesc q
</span><a href="Data.Singletons.TH.Deriving.Enum.html#mkEnumInstance"><span class="hs-identifier hs-var">mkEnumInstance</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Enum&quot;</span></span><span>
</span><span id="line-152"></span><span>
</span><span id="line-153"></span><span class="hs-comment">-- | Produce instances for 'PShow' from the given types</span><span>
</span><span id="line-154"></span><span id="local-6989586621679308737"><span class="annot"><a href="Data.Singletons.TH.Promote.html#promoteShowInstances"><span class="hs-identifier hs-type">promoteShowInstances</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Data.Singletons.TH.Options.html#OptionsMonad"><span class="hs-identifier hs-type">OptionsMonad</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679308737"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679308737"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Dec</span></span><span class="hs-special">]</span></span><span>
</span><span id="line-155"></span><span id="promoteShowInstances"><span class="annot"><span class="annottext">promoteShowInstances :: forall (q :: * -&gt; *). OptionsMonad q =&gt; [Name] -&gt; q [Dec]
</span><a href="Data.Singletons.TH.Promote.html#promoteShowInstances"><span class="hs-identifier hs-var hs-var">promoteShowInstances</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (monad :: * -&gt; *) monoid (t :: * -&gt; *) a.
(Monad monad, Monoid monoid, Traversable t) =&gt;
(a -&gt; monad monoid) -&gt; t a -&gt; monad monoid
</span><a href="Data.Singletons.TH.Util.html#concatMapM"><span class="hs-identifier hs-var">concatMapM</span></a></span><span> </span><span class="annot"><span class="annottext">forall (q :: * -&gt; *). OptionsMonad q =&gt; Name -&gt; q [Dec]
</span><a href="Data.Singletons.TH.Promote.html#promoteShowInstance"><span class="hs-identifier hs-var">promoteShowInstance</span></a></span><span>
</span><span id="line-156"></span><span>
</span><span id="line-157"></span><span class="hs-comment">-- | Produce an instance for 'PShow' from the given type</span><span>
</span><span id="line-158"></span><span id="local-6989586621679308726"><span class="annot"><a href="Data.Singletons.TH.Promote.html#promoteShowInstance"><span class="hs-identifier hs-type">promoteShowInstance</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Data.Singletons.TH.Options.html#OptionsMonad"><span class="hs-identifier hs-type">OptionsMonad</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679308726"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679308726"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Dec</span></span><span class="hs-special">]</span></span><span>
</span><span id="line-159"></span><span id="promoteShowInstance"><span class="annot"><span class="annottext">promoteShowInstance :: forall (q :: * -&gt; *). OptionsMonad q =&gt; Name -&gt; q [Dec]
</span><a href="Data.Singletons.TH.Promote.html#promoteShowInstance"><span class="hs-identifier hs-var hs-var">promoteShowInstance</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (q :: * -&gt; *).
OptionsMonad q =&gt;
DerivDesc q -&gt; String -&gt; Name -&gt; q [Dec]
</span><a href="Data.Singletons.TH.Promote.html#promoteInstance"><span class="hs-identifier hs-var">promoteInstance</span></a></span><span> </span><span class="annot"><span class="annottext">forall (q :: * -&gt; *). OptionsMonad q =&gt; DerivDesc q
</span><a href="Data.Singletons.TH.Deriving.Show.html#mkShowInstance"><span class="hs-identifier hs-var">mkShowInstance</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Show&quot;</span></span><span>
</span><span id="line-160"></span><span>
</span><span id="line-161"></span><span id="local-6989586621679309496"><span class="annot"><a href="Data.Singletons.TH.Promote.html#promoteInstance"><span class="hs-identifier hs-type">promoteInstance</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Data.Singletons.TH.Options.html#OptionsMonad"><span class="hs-identifier hs-type">OptionsMonad</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679309496"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Data.Singletons.TH.Deriving.Util.html#DerivDesc"><span class="hs-identifier hs-type">DerivDesc</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679309496"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679309496"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Dec</span></span><span class="hs-special">]</span></span><span>
</span><span id="line-162"></span><span id="promoteInstance"><span class="annot"><span class="annottext">promoteInstance :: forall (q :: * -&gt; *).
OptionsMonad q =&gt;
DerivDesc q -&gt; String -&gt; Name -&gt; q [Dec]
</span><a href="Data.Singletons.TH.Promote.html#promoteInstance"><span class="hs-identifier hs-var hs-var">promoteInstance</span></a></span></span><span> </span><span id="local-6989586621679308701"><span class="annot"><span class="annottext">DerivDesc q
</span><a href="#local-6989586621679308701"><span class="hs-identifier hs-var">mk_inst</span></a></span></span><span> </span><span id="local-6989586621679308700"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679308700"><span class="hs-identifier hs-var">class_name</span></a></span></span><span> </span><span id="local-6989586621679308699"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679308699"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-163"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621679308698"><span class="annot"><span class="annottext">[TyVarBndrUnit]
</span><a href="#local-6989586621679308698"><span class="hs-identifier hs-var">tvbs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679308697"><span class="annot"><span class="annottext">[Con]
</span><a href="#local-6989586621679308697"><span class="hs-identifier hs-var">cons</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (q :: * -&gt; *).
DsMonad q =&gt;
String -&gt; Name -&gt; q ([TyVarBndrUnit], [Con])
</span><span class="hs-identifier hs-var">getDataD</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;I cannot make an instance of &quot;</span></span><span> </span><span class="annot"><span class="annottext">forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679308700"><span class="hs-identifier hs-var">class_name</span></a></span><span>
</span><span id="line-164"></span><span>                            </span><span class="annot"><span class="annottext">forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; for it.&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679308699"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-165"></span><span>  </span><span id="local-6989586621679308695"><span class="annot"><span class="annottext">[DTyVarBndrUnit]
</span><a href="#local-6989586621679308695"><span class="hs-identifier hs-var">tvbs'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">forall (q :: * -&gt; *).
DsMonad q =&gt;
TyVarBndrUnit -&gt; q DTyVarBndrUnit
</span><span class="hs-identifier hs-var">dsTvbUnit</span></span><span> </span><span class="annot"><span class="annottext">[TyVarBndrUnit]
</span><a href="#local-6989586621679308698"><span class="hs-identifier hs-var">tvbs</span></a></span><span>
</span><span id="line-166"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679308693"><span class="annot"><span class="annottext">data_ty :: DType
</span><a href="#local-6989586621679308693"><span class="hs-identifier hs-var hs-var">data_ty</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall flag. DType -&gt; [DTyVarBndr flag] -&gt; DType
</span><a href="Data.Singletons.TH.Util.html#foldTypeTvbs"><span class="hs-identifier hs-var">foldTypeTvbs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; DType
</span><span class="hs-identifier hs-var">DConT</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679308699"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[DTyVarBndrUnit]
</span><a href="#local-6989586621679308695"><span class="hs-identifier hs-var">tvbs'</span></a></span><span>
</span><span id="line-167"></span><span>  </span><span id="local-6989586621679308690"><span class="annot"><span class="annottext">[DCon]
</span><a href="#local-6989586621679308690"><span class="hs-identifier hs-var">cons'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (monad :: * -&gt; *) monoid (t :: * -&gt; *) a.
(Monad monad, Monoid monoid, Traversable t) =&gt;
(a -&gt; monad monoid) -&gt; t a -&gt; monad monoid
</span><a href="Data.Singletons.TH.Util.html#concatMapM"><span class="hs-identifier hs-var">concatMapM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (q :: * -&gt; *).
DsMonad q =&gt;
[DTyVarBndrUnit] -&gt; DType -&gt; Con -&gt; q [DCon]
</span><span class="hs-identifier hs-var">dsCon</span></span><span> </span><span class="annot"><span class="annottext">[DTyVarBndrUnit]
</span><a href="#local-6989586621679308695"><span class="hs-identifier hs-var">tvbs'</span></a></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621679308693"><span class="hs-identifier hs-var">data_ty</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Con]
</span><a href="#local-6989586621679308697"><span class="hs-identifier hs-var">cons</span></a></span><span>
</span><span id="line-168"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679308688"><span class="annot"><span class="annottext">data_decl :: DataDecl
</span><a href="#local-6989586621679308688"><span class="hs-identifier hs-var hs-var">data_decl</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name -&gt; [DTyVarBndrUnit] -&gt; [DCon] -&gt; DataDecl
</span><a href="Data.Singletons.TH.Syntax.html#DataDecl"><span class="hs-identifier hs-var">DataDecl</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679308699"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">[DTyVarBndrUnit]
</span><a href="#local-6989586621679308695"><span class="hs-identifier hs-var">tvbs'</span></a></span><span> </span><span class="annot"><span class="annottext">[DCon]
</span><a href="#local-6989586621679308690"><span class="hs-identifier hs-var">cons'</span></a></span><span>
</span><span id="line-169"></span><span>  </span><span id="local-6989586621679308686"><span class="annot"><span class="annottext">UInstDecl
</span><a href="#local-6989586621679308686"><span class="hs-identifier hs-var">raw_inst</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">DerivDesc q
</span><a href="#local-6989586621679308701"><span class="hs-identifier hs-var">mk_inst</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621679308693"><span class="hs-identifier hs-var">data_ty</span></a></span><span> </span><span class="annot"><span class="annottext">DataDecl
</span><a href="#local-6989586621679308688"><span class="hs-identifier hs-var">data_decl</span></a></span><span>
</span><span id="line-170"></span><span>  </span><span id="local-6989586621679308685"><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621679308685"><span class="hs-identifier hs-var">decs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (q :: * -&gt; *). OptionsMonad q =&gt; [Dec] -&gt; PrM () -&gt; q [DDec]
</span><a href="Data.Singletons.TH.Promote.Monad.html#promoteM_"><span class="hs-identifier hs-var">promoteM_</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-171"></span><span>          </span><span class="annot"><span class="annottext">OMap Name DType
-&gt; Map Name [DTyVarBndrUnit] -&gt; UInstDecl -&gt; PrM AInstDecl
</span><a href="Data.Singletons.TH.Promote.html#promoteInstanceDec"><span class="hs-identifier hs-var">promoteInstanceDec</span></a></span><span> </span><span class="annot"><span class="annottext">forall k v. OMap k v
</span><span class="hs-identifier hs-var">OMap.empty</span></span><span> </span><span class="annot"><span class="annottext">forall k a. Map k a
</span><span class="hs-identifier hs-var">Map.empty</span></span><span> </span><span class="annot"><span class="annottext">UInstDecl
</span><a href="#local-6989586621679308686"><span class="hs-identifier hs-var">raw_inst</span></a></span><span>
</span><span id="line-172"></span><span>  </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[DDec] -&gt; [Dec]
</span><span class="hs-identifier hs-var">decsToTH</span></span><span> </span><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621679308685"><span class="hs-identifier hs-var">decs</span></a></span><span>
</span><span id="line-173"></span><span>
</span><span id="line-174"></span><span class="annot"><a href="Data.Singletons.TH.Promote.html#promoteInfo"><span class="hs-identifier hs-type">promoteInfo</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DInfo</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Data.Singletons.TH.Promote.Monad.html#PrM"><span class="hs-identifier hs-type">PrM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-175"></span><span id="promoteInfo"><span class="annot"><span class="annottext">promoteInfo :: DInfo -&gt; PrM ()
</span><a href="Data.Singletons.TH.Promote.html#promoteInfo"><span class="hs-identifier hs-var hs-var">promoteInfo</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DTyConI</span></span><span> </span><span id="local-6989586621679308679"><span class="annot"><span class="annottext">DDec
</span><a href="#local-6989586621679308679"><span class="hs-identifier hs-var">dec</span></a></span></span><span> </span><span id="local-6989586621679308678"><span class="annot"><span class="annottext">Maybe [DDec]
</span><a href="#local-6989586621679308678"><span class="hs-identifier hs-var">_instances</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[DDec] -&gt; PrM ()
</span><a href="Data.Singletons.TH.Promote.html#promoteDecs"><span class="hs-identifier hs-var">promoteDecs</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">DDec
</span><a href="#local-6989586621679308679"><span class="hs-identifier hs-var">dec</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-176"></span><span class="annot"><a href="Data.Singletons.TH.Promote.html#promoteInfo"><span class="hs-identifier hs-var">promoteInfo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DPrimTyConI</span></span><span> </span><span id="local-6989586621679308676"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679308676"><span class="hs-identifier hs-var">_name</span></a></span></span><span> </span><span id="local-6989586621679308675"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679308675"><span class="hs-identifier hs-var">_numArgs</span></a></span></span><span> </span><span id="local-6989586621679308674"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679308674"><span class="hs-identifier hs-var">_unlifted</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-177"></span><span>  </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadFail m =&gt; String -&gt; m a
</span><span class="hs-identifier hs-var">fail</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Promotion of primitive type constructors not supported&quot;</span></span><span>
</span><span id="line-178"></span><span class="annot"><a href="Data.Singletons.TH.Promote.html#promoteInfo"><span class="hs-identifier hs-var">promoteInfo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DVarI</span></span><span> </span><span id="local-6989586621679308672"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679308672"><span class="hs-identifier hs-var">_name</span></a></span></span><span> </span><span id="local-6989586621679308671"><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621679308671"><span class="hs-identifier hs-var">_ty</span></a></span></span><span> </span><span id="local-6989586621679308670"><span class="annot"><span class="annottext">Maybe Name
</span><a href="#local-6989586621679308670"><span class="hs-identifier hs-var">_mdec</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-179"></span><span>  </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadFail m =&gt; String -&gt; m a
</span><span class="hs-identifier hs-var">fail</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Promotion of individual values not supported&quot;</span></span><span>
</span><span id="line-180"></span><span class="annot"><a href="Data.Singletons.TH.Promote.html#promoteInfo"><span class="hs-identifier hs-var">promoteInfo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DTyVarI</span></span><span> </span><span id="local-6989586621679308668"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679308668"><span class="hs-identifier hs-var">_name</span></a></span></span><span> </span><span id="local-6989586621679308667"><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621679308667"><span class="hs-identifier hs-var">_ty</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-181"></span><span>  </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadFail m =&gt; String -&gt; m a
</span><span class="hs-identifier hs-var">fail</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Promotion of individual type variables not supported&quot;</span></span><span>
</span><span id="line-182"></span><span class="annot"><a href="Data.Singletons.TH.Promote.html#promoteInfo"><span class="hs-identifier hs-var">promoteInfo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DPatSynI</span></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-183"></span><span>  </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadFail m =&gt; String -&gt; m a
</span><span class="hs-identifier hs-var">fail</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Promotion of pattern synonyms not supported&quot;</span></span><span>
</span><span id="line-184"></span><span>
</span><span id="line-185"></span><span class="hs-comment">-- Note [Promoting declarations in two stages]</span><span>
</span><span id="line-186"></span><span class="hs-comment">-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><span>
</span><span id="line-187"></span><span class="hs-comment">--</span><span>
</span><span id="line-188"></span><span class="hs-comment">-- It is necessary to know the types of things when promoting. So,</span><span>
</span><span id="line-189"></span><span class="hs-comment">-- we promote in two stages: first, we build a LetDecEnv, which allows</span><span>
</span><span id="line-190"></span><span class="hs-comment">-- for easy lookup. Then, we go through the actual elements of the LetDecEnv,</span><span>
</span><span id="line-191"></span><span class="hs-comment">-- performing the promotion.</span><span>
</span><span id="line-192"></span><span class="hs-comment">--</span><span>
</span><span id="line-193"></span><span class="hs-comment">-- Why do we need the types? For kind annotations on the type family. We also</span><span>
</span><span id="line-194"></span><span class="hs-comment">-- need to have both the types and the actual function definition at the same</span><span>
</span><span id="line-195"></span><span class="hs-comment">-- time, because the function definition tells us how many patterns are</span><span>
</span><span id="line-196"></span><span class="hs-comment">-- matched. Note that an eta-contracted function needs to return a TyFun,</span><span>
</span><span id="line-197"></span><span class="hs-comment">-- not a proper type-level function.</span><span>
</span><span id="line-198"></span><span class="hs-comment">--</span><span>
</span><span id="line-199"></span><span class="hs-comment">-- Consider this example:</span><span>
</span><span id="line-200"></span><span class="hs-comment">--</span><span>
</span><span id="line-201"></span><span class="hs-comment">--   foo :: Nat -&gt; Bool -&gt; Bool</span><span>
</span><span id="line-202"></span><span class="hs-comment">--   foo Zero = id</span><span>
</span><span id="line-203"></span><span class="hs-comment">--   foo _    = not</span><span>
</span><span id="line-204"></span><span class="hs-comment">--</span><span>
</span><span id="line-205"></span><span class="hs-comment">-- Here the first parameter to foo is non-uniform, because it is</span><span>
</span><span id="line-206"></span><span class="hs-comment">-- inspected in a pattern and can be different in each defining</span><span>
</span><span id="line-207"></span><span class="hs-comment">-- equation of foo. The second parameter to foo, specified in the type</span><span>
</span><span id="line-208"></span><span class="hs-comment">-- signature as Bool, is a uniform parameter - it is not inspected and</span><span>
</span><span id="line-209"></span><span class="hs-comment">-- each defining equation of foo uses it the same way. The foo</span><span>
</span><span id="line-210"></span><span class="hs-comment">-- function will be promoted to a type familty Foo like this:</span><span>
</span><span id="line-211"></span><span class="hs-comment">--</span><span>
</span><span id="line-212"></span><span class="hs-comment">--   type family Foo (n :: Nat) :: Bool ~&gt; Bool where</span><span>
</span><span id="line-213"></span><span class="hs-comment">--      Foo Zero = Id</span><span>
</span><span id="line-214"></span><span class="hs-comment">--      Foo a    = Not</span><span>
</span><span id="line-215"></span><span class="hs-comment">--</span><span>
</span><span id="line-216"></span><span class="hs-comment">-- To generate type signature for Foo type family we must first learn</span><span>
</span><span id="line-217"></span><span class="hs-comment">-- what is the actual number of patterns used in defining cequations</span><span>
</span><span id="line-218"></span><span class="hs-comment">-- of foo. In this case there is only one so we declare Foo to take</span><span>
</span><span id="line-219"></span><span class="hs-comment">-- one argument and have return type of Bool -&gt; Bool.</span><span>
</span><span id="line-220"></span><span>
</span><span id="line-221"></span><span class="hs-comment">-- Promote a list of top-level declarations.</span><span>
</span><span id="line-222"></span><span class="annot"><a href="Data.Singletons.TH.Promote.html#promoteDecs"><span class="hs-identifier hs-type">promoteDecs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">DDec</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Data.Singletons.TH.Promote.Monad.html#PrM"><span class="hs-identifier hs-type">PrM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-223"></span><span id="promoteDecs"><span class="annot"><span class="annottext">promoteDecs :: [DDec] -&gt; PrM ()
</span><a href="Data.Singletons.TH.Promote.html#promoteDecs"><span class="hs-identifier hs-var hs-var">promoteDecs</span></a></span></span><span> </span><span id="local-6989586621679308665"><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621679308665"><span class="hs-identifier hs-var">raw_decls</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-224"></span><span>  </span><span id="local-6989586621679308664"><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621679308664"><span class="hs-identifier hs-var">decls</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (q :: * -&gt; *) a. (DsMonad q, Data a) =&gt; a -&gt; q a
</span><span class="hs-identifier hs-var">expand</span></span><span> </span><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621679308665"><span class="hs-identifier hs-var">raw_decls</span></a></span><span>     </span><span class="hs-comment">-- expand type synonyms</span><span>
</span><span id="line-225"></span><span>  </span><span class="annot"><span class="annottext">forall (q :: * -&gt; *). Quasi q =&gt; [DDec] -&gt; q ()
</span><a href="Data.Singletons.TH.Util.html#checkForRepInDecls"><span class="hs-identifier hs-var">checkForRepInDecls</span></a></span><span> </span><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621679308664"><span class="hs-identifier hs-var">decls</span></a></span><span>
</span><span id="line-226"></span><span>  </span><span class="annot"><a href="Data.Singletons.TH.Partition.html#PDecs"><span class="hs-identifier hs-type">PDecs</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">pd_let_decs :: PartitionedDecs -&gt; [DLetDec]
</span><a href="Data.Singletons.TH.Partition.html#pd_let_decs"><span class="hs-identifier hs-var">pd_let_decs</span></a></span><span>                </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621679308659"><span class="annot"><span class="annottext">[DLetDec]
</span><a href="#local-6989586621679308659"><span class="hs-identifier hs-var">let_decs</span></a></span></span><span>
</span><span id="line-227"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">pd_class_decs :: PartitionedDecs -&gt; [UClassDecl]
</span><a href="Data.Singletons.TH.Partition.html#pd_class_decs"><span class="hs-identifier hs-var">pd_class_decs</span></a></span><span>              </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621679308657"><span class="annot"><span class="annottext">[UClassDecl]
</span><a href="#local-6989586621679308657"><span class="hs-identifier hs-var">classes</span></a></span></span><span>
</span><span id="line-228"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">pd_instance_decs :: PartitionedDecs -&gt; [UInstDecl]
</span><a href="Data.Singletons.TH.Partition.html#pd_instance_decs"><span class="hs-identifier hs-var">pd_instance_decs</span></a></span><span>           </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621679308655"><span class="annot"><span class="annottext">[UInstDecl]
</span><a href="#local-6989586621679308655"><span class="hs-identifier hs-var">insts</span></a></span></span><span>
</span><span id="line-229"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">pd_data_decs :: PartitionedDecs -&gt; [DataDecl]
</span><a href="Data.Singletons.TH.Partition.html#pd_data_decs"><span class="hs-identifier hs-var">pd_data_decs</span></a></span><span>               </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621679308653"><span class="annot"><span class="annottext">[DataDecl]
</span><a href="#local-6989586621679308653"><span class="hs-identifier hs-var">datas</span></a></span></span><span>
</span><span id="line-230"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">pd_ty_syn_decs :: PartitionedDecs -&gt; [TySynDecl]
</span><a href="Data.Singletons.TH.Partition.html#pd_ty_syn_decs"><span class="hs-identifier hs-var">pd_ty_syn_decs</span></a></span><span>             </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621679308651"><span class="annot"><span class="annottext">[TySynDecl]
</span><a href="#local-6989586621679308651"><span class="hs-identifier hs-var">ty_syns</span></a></span></span><span>
</span><span id="line-231"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">pd_open_type_family_decs :: PartitionedDecs -&gt; [OpenTypeFamilyDecl]
</span><a href="Data.Singletons.TH.Partition.html#pd_open_type_family_decs"><span class="hs-identifier hs-var">pd_open_type_family_decs</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621679308649"><span class="annot"><span class="annottext">[OpenTypeFamilyDecl]
</span><a href="#local-6989586621679308649"><span class="hs-identifier hs-var">o_tyfams</span></a></span></span><span>
</span><span id="line-232"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">pd_closed_type_family_decs :: PartitionedDecs -&gt; [ClosedTypeFamilyDecl]
</span><a href="Data.Singletons.TH.Partition.html#pd_closed_type_family_decs"><span class="hs-identifier hs-var">pd_closed_type_family_decs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621679308647"><span class="annot"><span class="annottext">[ClosedTypeFamilyDecl]
</span><a href="#local-6989586621679308647"><span class="hs-identifier hs-var">c_tyfams</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). OptionsMonad m =&gt; [DDec] -&gt; m PartitionedDecs
</span><a href="Data.Singletons.TH.Partition.html#partitionDecs"><span class="hs-identifier hs-var">partitionDecs</span></a></span><span> </span><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621679308664"><span class="hs-identifier hs-var">decls</span></a></span><span>
</span><span id="line-233"></span><span>
</span><span id="line-234"></span><span>  </span><span class="annot"><span class="annottext">[TySynDecl]
-&gt; [ClosedTypeFamilyDecl] -&gt; [OpenTypeFamilyDecl] -&gt; PrM ()
</span><a href="Data.Singletons.TH.Promote.Defun.html#defunTopLevelTypeDecls"><span class="hs-identifier hs-var">defunTopLevelTypeDecls</span></a></span><span> </span><span class="annot"><span class="annottext">[TySynDecl]
</span><a href="#local-6989586621679308651"><span class="hs-identifier hs-var">ty_syns</span></a></span><span> </span><span class="annot"><span class="annottext">[ClosedTypeFamilyDecl]
</span><a href="#local-6989586621679308647"><span class="hs-identifier hs-var">c_tyfams</span></a></span><span> </span><span class="annot"><span class="annottext">[OpenTypeFamilyDecl]
</span><a href="#local-6989586621679308649"><span class="hs-identifier hs-var">o_tyfams</span></a></span><span>
</span><span id="line-235"></span><span>  </span><span id="local-6989586621679308644"><span class="annot"><span class="annottext">[DLetDec]
</span><a href="#local-6989586621679308644"><span class="hs-identifier hs-var">rec_sel_let_decs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[DataDecl] -&gt; PrM [DLetDec]
</span><a href="Data.Singletons.TH.Promote.html#promoteDataDecs"><span class="hs-identifier hs-var">promoteDataDecs</span></a></span><span> </span><span class="annot"><span class="annottext">[DataDecl]
</span><a href="#local-6989586621679308653"><span class="hs-identifier hs-var">datas</span></a></span><span>
</span><span id="line-236"></span><span>    </span><span class="hs-comment">-- promoteLetDecs returns LetBinds, which we don't need at top level</span><span>
</span><span id="line-237"></span><span>  </span><span class="annot"><span class="annottext">([LetBind], ALetDecEnv)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Maybe Uniq -&gt; [DLetDec] -&gt; PrM ([LetBind], ALetDecEnv)
</span><a href="Data.Singletons.TH.Promote.html#promoteLetDecs"><span class="hs-identifier hs-var">promoteLetDecs</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[DLetDec]
</span><a href="#local-6989586621679308644"><span class="hs-identifier hs-var">rec_sel_let_decs</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[DLetDec]
</span><a href="#local-6989586621679308659"><span class="hs-identifier hs-var">let_decs</span></a></span><span>
</span><span id="line-238"></span><span>  </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><span class="hs-identifier hs-var">mapM_</span></span><span> </span><span class="annot"><span class="annottext">UClassDecl -&gt; PrM AClassDecl
</span><a href="Data.Singletons.TH.Promote.html#promoteClassDec"><span class="hs-identifier hs-var">promoteClassDec</span></a></span><span> </span><span class="annot"><span class="annottext">[UClassDecl]
</span><a href="#local-6989586621679308657"><span class="hs-identifier hs-var">classes</span></a></span><span>
</span><span id="line-239"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679308636"><span class="annot"><span class="annottext">orig_meth_sigs :: OMap Name DType
</span><a href="#local-6989586621679308636"><span class="hs-identifier hs-var hs-var">orig_meth_sigs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) m a.
(Foldable t, Monoid m) =&gt;
(a -&gt; m) -&gt; t a -&gt; m
</span><span class="hs-identifier hs-var">foldMap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (ann :: AnnotationFlag). LetDecEnv ann -&gt; OMap Name DType
</span><a href="Data.Singletons.TH.Syntax.html#lde_types"><span class="hs-identifier hs-var">lde_types</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall (ann :: AnnotationFlag). ClassDecl ann -&gt; LetDecEnv ann
</span><a href="Data.Singletons.TH.Syntax.html#cd_lde"><span class="hs-identifier hs-var">cd_lde</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[UClassDecl]
</span><a href="#local-6989586621679308657"><span class="hs-identifier hs-var">classes</span></a></span><span>
</span><span id="line-240"></span><span>      </span><span id="local-6989586621679308630"><span class="annot"><span class="annottext">cls_tvbs_map :: Map Name [DTyVarBndrUnit]
</span><a href="#local-6989586621679308630"><span class="hs-identifier hs-var hs-var">cls_tvbs_map</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><span class="hs-identifier hs-var">Map.fromList</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679308628"><span class="annot"><span class="annottext">UClassDecl
</span><a href="#local-6989586621679308628"><span class="hs-identifier hs-var">cd</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (ann :: AnnotationFlag). ClassDecl ann -&gt; Name
</span><a href="Data.Singletons.TH.Syntax.html#cd_name"><span class="hs-identifier hs-var">cd_name</span></a></span><span> </span><span class="annot"><span class="annottext">UClassDecl
</span><a href="#local-6989586621679308628"><span class="hs-identifier hs-var">cd</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall (ann :: AnnotationFlag). ClassDecl ann -&gt; [DTyVarBndrUnit]
</span><a href="Data.Singletons.TH.Syntax.html#cd_tvbs"><span class="hs-identifier hs-var">cd_tvbs</span></a></span><span> </span><span class="annot"><span class="annottext">UClassDecl
</span><a href="#local-6989586621679308628"><span class="hs-identifier hs-var">cd</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[UClassDecl]
</span><a href="#local-6989586621679308657"><span class="hs-identifier hs-var">classes</span></a></span><span>
</span><span id="line-241"></span><span>  </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><span class="hs-identifier hs-var">mapM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OMap Name DType
-&gt; Map Name [DTyVarBndrUnit] -&gt; UInstDecl -&gt; PrM AInstDecl
</span><a href="Data.Singletons.TH.Promote.html#promoteInstanceDec"><span class="hs-identifier hs-var">promoteInstanceDec</span></a></span><span> </span><span class="annot"><span class="annottext">OMap Name DType
</span><a href="#local-6989586621679308636"><span class="hs-identifier hs-var">orig_meth_sigs</span></a></span><span> </span><span class="annot"><span class="annottext">Map Name [DTyVarBndrUnit]
</span><a href="#local-6989586621679308630"><span class="hs-identifier hs-var">cls_tvbs_map</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[UInstDecl]
</span><a href="#local-6989586621679308655"><span class="hs-identifier hs-var">insts</span></a></span><span>
</span><span id="line-242"></span><span>
</span><span id="line-243"></span><span class="hs-comment">-- curious about ALetDecEnv? See the LetDecEnv module for an explanation.</span><span>
</span><span id="line-244"></span><span class="annot"><a href="Data.Singletons.TH.Promote.html#promoteLetDecs"><span class="hs-identifier hs-type">promoteLetDecs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Uniq</span></span><span> </span><span class="hs-comment">-- let-binding unique (if locally bound)</span><span>
</span><span id="line-245"></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">DLetDec</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Data.Singletons.TH.Promote.Monad.html#PrM"><span class="hs-identifier hs-type">PrM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="Data.Singletons.TH.Promote.Monad.html#LetBind"><span class="hs-identifier hs-type">LetBind</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.Singletons.TH.Syntax.html#ALetDecEnv"><span class="hs-identifier hs-type">ALetDecEnv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-246"></span><span>  </span><span class="hs-comment">-- See Note [Promoting declarations in two stages]</span><span>
</span><span id="line-247"></span><span id="promoteLetDecs"><span class="annot"><span class="annottext">promoteLetDecs :: Maybe Uniq -&gt; [DLetDec] -&gt; PrM ([LetBind], ALetDecEnv)
</span><a href="Data.Singletons.TH.Promote.html#promoteLetDecs"><span class="hs-identifier hs-var hs-var">promoteLetDecs</span></a></span></span><span> </span><span id="local-6989586621679308625"><span class="annot"><span class="annottext">Maybe Uniq
</span><a href="#local-6989586621679308625"><span class="hs-identifier hs-var">mb_let_uniq</span></a></span></span><span> </span><span id="local-6989586621679308624"><span class="annot"><span class="annottext">[DLetDec]
</span><a href="#local-6989586621679308624"><span class="hs-identifier hs-var">decls</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-248"></span><span>  </span><span id="local-6989586621679308623"><span class="annot"><span class="annottext">Options
</span><a href="#local-6989586621679308623"><span class="hs-identifier hs-var">opts</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). OptionsMonad m =&gt; m Options
</span><a href="Data.Singletons.TH.Options.html#getOptions"><span class="hs-identifier hs-var">getOptions</span></a></span><span>
</span><span id="line-249"></span><span>  </span><span id="local-6989586621679308622"><span class="annot"><span class="annottext">ULetDecEnv
</span><a href="#local-6989586621679308622"><span class="hs-identifier hs-var">let_dec_env</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (q :: * -&gt; *). Quasi q =&gt; [DLetDec] -&gt; q ULetDecEnv
</span><a href="Data.Singletons.TH.Syntax.html#buildLetDecEnv"><span class="hs-identifier hs-var">buildLetDecEnv</span></a></span><span> </span><span class="annot"><span class="annottext">[DLetDec]
</span><a href="#local-6989586621679308624"><span class="hs-identifier hs-var">decls</span></a></span><span>
</span><span id="line-250"></span><span>  </span><span id="local-6989586621679308620"><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621679308620"><span class="hs-identifier hs-var">all_locals</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). MonadReader PrEnv m =&gt; m [Name]
</span><a href="Data.Singletons.TH.Promote.Monad.html#allLocals"><span class="hs-identifier hs-var">allLocals</span></a></span><span>
</span><span id="line-251"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679308618"><span class="annot"><span class="annottext">binds :: [LetBind]
</span><a href="#local-6989586621679308618"><span class="hs-identifier hs-var hs-var">binds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679308617"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">DType -&gt; [DType] -&gt; DType
</span><a href="Data.Singletons.TH.Util.html#foldType"><span class="hs-identifier hs-var">foldType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; DType
</span><span class="hs-identifier hs-var">DConT</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679308615"><span class="hs-identifier hs-var">sym</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; DType
</span><span class="hs-identifier hs-var">DVarT</span></span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621679308620"><span class="hs-identifier hs-var">all_locals</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-252"></span><span>              </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679308617"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679308617"><span class="hs-identifier hs-var">name</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">LetDecRHS Unannotated
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall k v. OMap k v -&gt; [(k, v)]
</span><span class="hs-identifier hs-var">OMap.assocs</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall (ann :: AnnotationFlag).
LetDecEnv ann -&gt; OMap Name (LetDecRHS ann)
</span><a href="Data.Singletons.TH.Syntax.html#lde_defns"><span class="hs-identifier hs-var">lde_defns</span></a></span><span> </span><span class="annot"><span class="annottext">ULetDecEnv
</span><a href="#local-6989586621679308622"><span class="hs-identifier hs-var">let_dec_env</span></a></span><span>
</span><span id="line-253"></span><span>              </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679308611"><span class="annot"><span class="annottext">proName :: Name
</span><a href="#local-6989586621679308611"><span class="hs-identifier hs-var hs-var">proName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Options -&gt; Name -&gt; Maybe Uniq -&gt; Name
</span><a href="Data.Singletons.TH.Options.html#promotedValueName"><span class="hs-identifier hs-var">promotedValueName</span></a></span><span> </span><span class="annot"><span class="annottext">Options
</span><a href="#local-6989586621679308623"><span class="hs-identifier hs-var">opts</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679308617"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Uniq
</span><a href="#local-6989586621679308625"><span class="hs-identifier hs-var">mb_let_uniq</span></a></span><span>
</span><span id="line-254"></span><span>                    </span><span id="local-6989586621679308615"><span class="annot"><span class="annottext">sym :: Name
</span><a href="#local-6989586621679308615"><span class="hs-identifier hs-var hs-var">sym</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Options -&gt; Name -&gt; Int -&gt; Name
</span><a href="Data.Singletons.TH.Options.html#defunctionalizedName"><span class="hs-identifier hs-var">defunctionalizedName</span></a></span><span> </span><span class="annot"><span class="annottext">Options
</span><a href="#local-6989586621679308623"><span class="hs-identifier hs-var">opts</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679308611"><span class="hs-identifier hs-var">proName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621679308620"><span class="hs-identifier hs-var">all_locals</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-255"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621679308606"><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621679308606"><span class="hs-identifier hs-var">decs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679308605"><span class="annot"><span class="annottext">ALetDecEnv
</span><a href="#local-6989586621679308605"><span class="hs-identifier hs-var">let_dec_env'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall a. [LetBind] -&gt; PrM a -&gt; PrM a
</span><a href="Data.Singletons.TH.Promote.Monad.html#letBind"><span class="hs-identifier hs-var">letBind</span></a></span><span> </span><span class="annot"><span class="annottext">[LetBind]
</span><a href="#local-6989586621679308618"><span class="hs-identifier hs-var">binds</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe Uniq -&gt; ULetDecEnv -&gt; PrM ([DDec], ALetDecEnv)
</span><a href="Data.Singletons.TH.Promote.html#promoteLetDecEnv"><span class="hs-identifier hs-var">promoteLetDecEnv</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Uniq
</span><a href="#local-6989586621679308625"><span class="hs-identifier hs-var">mb_let_uniq</span></a></span><span> </span><span class="annot"><span class="annottext">ULetDecEnv
</span><a href="#local-6989586621679308622"><span class="hs-identifier hs-var">let_dec_env</span></a></span><span>
</span><span id="line-256"></span><span>  </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). MonadWriter [DDec] m =&gt; [DDec] -&gt; m ()
</span><a href="Data.Singletons.TH.Promote.Monad.html#emitDecs"><span class="hs-identifier hs-var">emitDecs</span></a></span><span> </span><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621679308606"><span class="hs-identifier hs-var">decs</span></a></span><span>
</span><span id="line-257"></span><span>  </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[LetBind]
</span><a href="#local-6989586621679308618"><span class="hs-identifier hs-var">binds</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ALetDecEnv
</span><a href="#local-6989586621679308605"><span class="hs-identifier hs-var">let_dec_env'</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">lde_proms :: IfAnn Annotated (OMap Name DType) ()
</span><a href="Data.Singletons.TH.Syntax.html#lde_proms"><span class="hs-identifier hs-var">lde_proms</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall k v. Ord k =&gt; [(k, v)] -&gt; OMap k v
</span><span class="hs-identifier hs-var">OMap.fromList</span></span><span> </span><span class="annot"><span class="annottext">[LetBind]
</span><a href="#local-6989586621679308618"><span class="hs-identifier hs-var">binds</span></a></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-258"></span><span>
</span><span id="line-259"></span><span class="annot"><a href="Data.Singletons.TH.Promote.html#promoteDataDecs"><span class="hs-identifier hs-type">promoteDataDecs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Data.Singletons.TH.Syntax.html#DataDecl"><span class="hs-identifier hs-type">DataDecl</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Data.Singletons.TH.Promote.Monad.html#PrM"><span class="hs-identifier hs-type">PrM</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">DLetDec</span></span><span class="hs-special">]</span><span>
</span><span id="line-260"></span><span id="promoteDataDecs"><span class="annot"><span class="annottext">promoteDataDecs :: [DataDecl] -&gt; PrM [DLetDec]
</span><a href="Data.Singletons.TH.Promote.html#promoteDataDecs"><span class="hs-identifier hs-var hs-var">promoteDataDecs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (monad :: * -&gt; *) monoid (t :: * -&gt; *) a.
(Monad monad, Monoid monoid, Traversable t) =&gt;
(a -&gt; monad monoid) -&gt; t a -&gt; monad monoid
</span><a href="Data.Singletons.TH.Util.html#concatMapM"><span class="hs-identifier hs-var">concatMapM</span></a></span><span> </span><span class="annot"><span class="annottext">DataDecl -&gt; PrM [DLetDec]
</span><a href="Data.Singletons.TH.Promote.html#promoteDataDec"><span class="hs-identifier hs-var">promoteDataDec</span></a></span><span>
</span><span id="line-261"></span><span>
</span><span id="line-262"></span><span class="hs-comment">-- &quot;Promotes&quot; a data type, much like D.S.TH.Single.Data.singDataD singles a data</span><span>
</span><span id="line-263"></span><span class="hs-comment">-- type. Promoting a data type is much easier than singling it, however, since</span><span>
</span><span id="line-264"></span><span class="hs-comment">-- DataKinds automatically promotes data types and kinds and data constructors</span><span>
</span><span id="line-265"></span><span class="hs-comment">-- to types. That means that promoteDataDec only has to do three things:</span><span>
</span><span id="line-266"></span><span class="hs-comment">--</span><span>
</span><span id="line-267"></span><span class="hs-comment">-- 1. Emit defunctionalization symbols for each data constructor,</span><span>
</span><span id="line-268"></span><span class="hs-comment">--</span><span>
</span><span id="line-269"></span><span class="hs-comment">-- 2. Emit promoted fixity declarations for each data constructor and promoted</span><span>
</span><span id="line-270"></span><span class="hs-comment">--    record selector (assuming the originals have fixity declarations), and</span><span>
</span><span id="line-271"></span><span class="hs-comment">--</span><span>
</span><span id="line-272"></span><span class="hs-comment">-- 3. Assemble a top-level function that mimics the behavior of its record</span><span>
</span><span id="line-273"></span><span class="hs-comment">--    selectors. Note that promoteDataDec does not actually promote this record</span><span>
</span><span id="line-274"></span><span class="hs-comment">--    selector function&#8212;it merely returns its DLetDecs. Later, the promoteDecs</span><span>
</span><span id="line-275"></span><span class="hs-comment">--    function takes these DLetDecs and promotes them (using promoteLetDecs).</span><span>
</span><span id="line-276"></span><span class="hs-comment">--    This greatly simplifies the plumbing, since this allows all DLetDecs to</span><span>
</span><span id="line-277"></span><span class="hs-comment">--    be promoted in a single location.</span><span>
</span><span id="line-278"></span><span class="hs-comment">--    See Note [singletons-th and record selectors] in D.S.TH.Single.Data.</span><span>
</span><span id="line-279"></span><span class="annot"><a href="Data.Singletons.TH.Promote.html#promoteDataDec"><span class="hs-identifier hs-type">promoteDataDec</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Data.Singletons.TH.Syntax.html#DataDecl"><span class="hs-identifier hs-type">DataDecl</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Data.Singletons.TH.Promote.Monad.html#PrM"><span class="hs-identifier hs-type">PrM</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">DLetDec</span></span><span class="hs-special">]</span><span>
</span><span id="line-280"></span><span id="promoteDataDec"><span class="annot"><span class="annottext">promoteDataDec :: DataDecl -&gt; PrM [DLetDec]
</span><a href="Data.Singletons.TH.Promote.html#promoteDataDec"><span class="hs-identifier hs-var hs-var">promoteDataDec</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Data.Singletons.TH.Syntax.html#DataDecl"><span class="hs-identifier hs-type">DataDecl</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[DTyVarBndrUnit]
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679308598"><span class="annot"><span class="annottext">[DCon]
</span><a href="#local-6989586621679308598"><span class="hs-identifier hs-var">ctors</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-281"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679308594"><span class="annot"><span class="annottext">rec_sel_names :: [Name]
</span><a href="#local-6989586621679308594"><span class="hs-identifier hs-var hs-var">rec_sel_names</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">nub</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) a b. Foldable t =&gt; (a -&gt; [b]) -&gt; t a -&gt; [b]
</span><span class="hs-identifier hs-var">concatMap</span></span><span> </span><span class="annot"><span class="annottext">DCon -&gt; [Name]
</span><a href="Data.Singletons.TH.Util.html#extractRecSelNames"><span class="hs-identifier hs-var">extractRecSelNames</span></a></span><span> </span><span class="annot"><span class="annottext">[DCon]
</span><a href="#local-6989586621679308598"><span class="hs-identifier hs-var">ctors</span></a></span><span>
</span><span id="line-282"></span><span>                      </span><span class="hs-comment">-- Note the use of nub: the same record selector name can</span><span>
</span><span id="line-283"></span><span>                      </span><span class="hs-comment">-- be used in multiple constructors!</span><span>
</span><span id="line-284"></span><span>  </span><span id="local-6989586621679308591"><span class="annot"><span class="annottext">[DLetDec]
</span><a href="#local-6989586621679308591"><span class="hs-identifier hs-var">rec_sel_let_decs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (q :: * -&gt; *). DsMonad q =&gt; [DCon] -&gt; q [DLetDec]
</span><span class="hs-identifier hs-var">getRecordSelectors</span></span><span> </span><span class="annot"><span class="annottext">[DCon]
</span><a href="#local-6989586621679308598"><span class="hs-identifier hs-var">ctors</span></a></span><span>
</span><span id="line-285"></span><span>  </span><span id="local-6989586621679308589"><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621679308589"><span class="hs-identifier hs-var">ctorSyms</span></a></span></span><span>         </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[DCon] -&gt; PrM [DDec]
</span><a href="Data.Singletons.TH.Promote.Defun.html#buildDefunSymsDataD"><span class="hs-identifier hs-var">buildDefunSymsDataD</span></a></span><span> </span><span class="annot"><span class="annottext">[DCon]
</span><a href="#local-6989586621679308598"><span class="hs-identifier hs-var">ctors</span></a></span><span>
</span><span id="line-286"></span><span>  </span><span id="local-6989586621679308587"><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621679308587"><span class="hs-identifier hs-var">infix_decs</span></a></span></span><span>       </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (q :: * -&gt; *). OptionsMonad q =&gt; [Name] -&gt; q [DDec]
</span><a href="Data.Singletons.TH.Promote.html#promoteReifiedInfixDecls"><span class="hs-identifier hs-var">promoteReifiedInfixDecls</span></a></span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621679308594"><span class="hs-identifier hs-var">rec_sel_names</span></a></span><span>
</span><span id="line-287"></span><span>  </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). MonadWriter [DDec] m =&gt; [DDec] -&gt; m ()
</span><a href="Data.Singletons.TH.Promote.Monad.html#emitDecs"><span class="hs-identifier hs-var">emitDecs</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621679308589"><span class="hs-identifier hs-var">ctorSyms</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621679308587"><span class="hs-identifier hs-var">infix_decs</span></a></span><span>
</span><span id="line-288"></span><span>  </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">[DLetDec]
</span><a href="#local-6989586621679308591"><span class="hs-identifier hs-var">rec_sel_let_decs</span></a></span><span>
</span><span id="line-289"></span><span>
</span><span id="line-290"></span><span class="annot"><a href="Data.Singletons.TH.Promote.html#promoteClassDec"><span class="hs-identifier hs-type">promoteClassDec</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Data.Singletons.TH.Syntax.html#UClassDecl"><span class="hs-identifier hs-type">UClassDecl</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Data.Singletons.TH.Promote.Monad.html#PrM"><span class="hs-identifier hs-type">PrM</span></a></span><span> </span><span class="annot"><a href="Data.Singletons.TH.Syntax.html#AClassDecl"><span class="hs-identifier hs-type">AClassDecl</span></a></span><span>
</span><span id="line-291"></span><span id="promoteClassDec"><span class="annot"><span class="annottext">promoteClassDec :: UClassDecl -&gt; PrM AClassDecl
</span><a href="Data.Singletons.TH.Promote.html#promoteClassDec"><span class="hs-identifier hs-var hs-var">promoteClassDec</span></a></span></span><span> </span><span id="local-6989586621679308585"><span class="annot"><span class="annottext">decl :: UClassDecl
</span><a href="#local-6989586621679308585"><span class="hs-identifier hs-var">decl</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Data.Singletons.TH.Syntax.html#ClassDecl"><span class="hs-identifier hs-type">ClassDecl</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">cd_name :: forall (ann :: AnnotationFlag). ClassDecl ann -&gt; Name
</span><a href="Data.Singletons.TH.Syntax.html#cd_name"><span class="hs-identifier hs-var">cd_name</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621679308583"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679308583"><span class="hs-identifier hs-var">cls_name</span></a></span></span><span>
</span><span id="line-292"></span><span>                                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cd_tvbs :: forall (ann :: AnnotationFlag). ClassDecl ann -&gt; [DTyVarBndrUnit]
</span><a href="Data.Singletons.TH.Syntax.html#cd_tvbs"><span class="hs-identifier hs-var">cd_tvbs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621679308582"><span class="annot"><span class="annottext">[DTyVarBndrUnit]
</span><a href="#local-6989586621679308582"><span class="hs-identifier hs-var">tvbs</span></a></span></span><span>
</span><span id="line-293"></span><span>                                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cd_fds :: forall (ann :: AnnotationFlag). ClassDecl ann -&gt; [FunDep]
</span><a href="Data.Singletons.TH.Syntax.html#cd_fds"><span class="hs-identifier hs-var">cd_fds</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621679308580"><span class="annot"><span class="annottext">[FunDep]
</span><a href="#local-6989586621679308580"><span class="hs-identifier hs-var">fundeps</span></a></span></span><span>
</span><span id="line-294"></span><span>                                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cd_atfs :: forall (ann :: AnnotationFlag).
ClassDecl ann -&gt; [OpenTypeFamilyDecl]
</span><a href="Data.Singletons.TH.Syntax.html#cd_atfs"><span class="hs-identifier hs-var">cd_atfs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621679308578"><span class="annot"><span class="annottext">[OpenTypeFamilyDecl]
</span><a href="#local-6989586621679308578"><span class="hs-identifier hs-var">atfs</span></a></span></span><span>
</span><span id="line-295"></span><span>                                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cd_lde :: forall (ann :: AnnotationFlag). ClassDecl ann -&gt; LetDecEnv ann
</span><a href="Data.Singletons.TH.Syntax.html#cd_lde"><span class="hs-identifier hs-var">cd_lde</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621679308577"><span class="annot"><span class="annottext">lde :: ULetDecEnv
</span><a href="#local-6989586621679308577"><span class="hs-identifier hs-var">lde</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Data.Singletons.TH.Syntax.html#LetDecEnv"><span class="hs-identifier hs-type">LetDecEnv</span></a></span><span>
</span><span id="line-296"></span><span>                                    </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">lde_defns :: forall (ann :: AnnotationFlag).
LetDecEnv ann -&gt; OMap Name (LetDecRHS ann)
</span><a href="Data.Singletons.TH.Syntax.html#lde_defns"><span class="hs-identifier hs-var">lde_defns</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621679308575"><span class="annot"><span class="annottext">OMap Name (LetDecRHS Unannotated)
</span><a href="#local-6989586621679308575"><span class="hs-identifier hs-var">defaults</span></a></span></span><span>
</span><span id="line-297"></span><span>                                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">lde_types :: forall (ann :: AnnotationFlag). LetDecEnv ann -&gt; OMap Name DType
</span><a href="Data.Singletons.TH.Syntax.html#lde_types"><span class="hs-identifier hs-var">lde_types</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621679308574"><span class="annot"><span class="annottext">OMap Name DType
</span><a href="#local-6989586621679308574"><span class="hs-identifier hs-var">meth_sigs</span></a></span></span><span>
</span><span id="line-298"></span><span>                                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">lde_infix :: forall (ann :: AnnotationFlag). LetDecEnv ann -&gt; OMap Name Fixity
</span><a href="Data.Singletons.TH.Syntax.html#lde_infix"><span class="hs-identifier hs-var">lde_infix</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621679308572"><span class="annot"><span class="annottext">OMap Name Fixity
</span><a href="#local-6989586621679308572"><span class="hs-identifier hs-var">infix_decls</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-299"></span><span>  </span><span id="local-6989586621679308571"><span class="annot"><span class="annottext">Options
</span><a href="#local-6989586621679308571"><span class="hs-identifier hs-var">opts</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). OptionsMonad m =&gt; m Options
</span><a href="Data.Singletons.TH.Options.html#getOptions"><span class="hs-identifier hs-var">getOptions</span></a></span><span>
</span><span id="line-300"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679308570"><span class="annot"><span class="annottext">pClsName :: Name
</span><a href="#local-6989586621679308570"><span class="hs-identifier hs-var hs-var">pClsName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Options -&gt; Name -&gt; Name
</span><a href="Data.Singletons.TH.Options.html#promotedClassName"><span class="hs-identifier hs-var">promotedClassName</span></a></span><span> </span><span class="annot"><span class="annottext">Options
</span><a href="#local-6989586621679308571"><span class="hs-identifier hs-var">opts</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679308583"><span class="hs-identifier hs-var">cls_name</span></a></span><span>
</span><span id="line-301"></span><span>  </span><span class="annot"><span class="annottext">forall a. OSet Name -&gt; PrM a -&gt; PrM a
</span><a href="Data.Singletons.TH.Promote.Monad.html#forallBind"><span class="hs-identifier hs-var">forallBind</span></a></span><span> </span><span class="annot"><span class="annottext">OSet Name
</span><a href="#local-6989586621679308567"><span class="hs-identifier hs-var">cls_kvs_to_bind</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-302"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679308566"><span class="annot"><span class="annottext">meth_sigs_list :: [LetBind]
</span><a href="#local-6989586621679308566"><span class="hs-identifier hs-var hs-var">meth_sigs_list</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall k v. OMap k v -&gt; [(k, v)]
</span><span class="hs-identifier hs-var">OMap.assocs</span></span><span> </span><span class="annot"><span class="annottext">OMap Name DType
</span><a href="#local-6989586621679308574"><span class="hs-identifier hs-var">meth_sigs</span></a></span><span>
</span><span id="line-303"></span><span>        </span><span id="local-6989586621679308565"><span class="annot"><span class="annottext">meth_names :: [Name]
</span><a href="#local-6989586621679308565"><span class="hs-identifier hs-var hs-var">meth_names</span></a></span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">[LetBind]
</span><a href="#local-6989586621679308566"><span class="hs-identifier hs-var">meth_sigs_list</span></a></span><span>
</span><span id="line-304"></span><span>        </span><span id="local-6989586621679308564"><span class="annot"><span class="annottext">defaults_list :: [(Name, LetDecRHS Unannotated)]
</span><a href="#local-6989586621679308564"><span class="hs-identifier hs-var hs-var">defaults_list</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall k v. OMap k v -&gt; [(k, v)]
</span><span class="hs-identifier hs-var">OMap.assocs</span></span><span> </span><span class="annot"><span class="annottext">OMap Name (LetDecRHS Unannotated)
</span><a href="#local-6989586621679308575"><span class="hs-identifier hs-var">defaults</span></a></span><span>
</span><span id="line-305"></span><span>        </span><span id="local-6989586621679308563"><span class="annot"><span class="annottext">defaults_names :: [Name]
</span><a href="#local-6989586621679308563"><span class="hs-identifier hs-var hs-var">defaults_names</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">[(Name, LetDecRHS Unannotated)]
</span><a href="#local-6989586621679308564"><span class="hs-identifier hs-var">defaults_list</span></a></span><span>
</span><span id="line-306"></span><span>    </span><span id="local-6989586621679308562"><span class="annot"><span class="annottext">Maybe DType
</span><a href="#local-6989586621679308562"><span class="hs-identifier hs-var">mb_cls_sak</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (q :: * -&gt; *). DsMonad q =&gt; Name -&gt; q (Maybe DType)
</span><span class="hs-identifier hs-var">dsReifyType</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679308583"><span class="hs-identifier hs-var">cls_name</span></a></span><span>
</span><span id="line-307"></span><span>    </span><span id="local-6989586621679308560"><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621679308560"><span class="hs-identifier hs-var">sig_decs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a b c. (a -&gt; b -&gt; c) -&gt; (a, b) -&gt; c
</span><span class="hs-identifier hs-var">uncurry</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; DType -&gt; PrM DDec
</span><a href="#local-6989586621679308558"><span class="hs-identifier hs-var">promote_sig</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[LetBind]
</span><a href="#local-6989586621679308566"><span class="hs-identifier hs-var">meth_sigs_list</span></a></span><span>
</span><span id="line-308"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621679308557"><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621679308557"><span class="hs-identifier hs-var">default_decs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679308556"><span class="annot"><span class="annottext">[ALetDecRHS]
</span><a href="#local-6989586621679308556"><span class="hs-identifier hs-var">ann_rhss</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679308555"><span class="annot"><span class="annottext">[DType]
</span><a href="#local-6989586621679308555"><span class="hs-identifier hs-var">prom_rhss</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-309"></span><span>      </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b c d.
Monad m =&gt;
(a -&gt; m (b, c, d)) -&gt; [a] -&gt; m ([b], [c], [d])
</span><a href="Data.Singletons.TH.Util.html#mapAndUnzip3M"><span class="hs-identifier hs-var">mapAndUnzip3M</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MethodSort
-&gt; OMap Name DType
-&gt; (Name, LetDecRHS Unannotated)
-&gt; PrM (DDec, ALetDecRHS, DType)
</span><a href="Data.Singletons.TH.Promote.html#promoteMethod"><span class="hs-identifier hs-var">promoteMethod</span></a></span><span> </span><span class="annot"><span class="annottext">MethodSort
</span><a href="Data.Singletons.TH.Promote.html#DefaultMethods"><span class="hs-identifier hs-var">DefaultMethods</span></a></span><span> </span><span class="annot"><span class="annottext">OMap Name DType
</span><a href="#local-6989586621679308574"><span class="hs-identifier hs-var">meth_sigs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(Name, LetDecRHS Unannotated)]
</span><a href="#local-6989586621679308564"><span class="hs-identifier hs-var">defaults_list</span></a></span><span>
</span><span id="line-310"></span><span>    </span><span class="annot"><span class="annottext">[DTyVarBndrUnit] -&gt; [OpenTypeFamilyDecl] -&gt; PrM ()
</span><a href="Data.Singletons.TH.Promote.Defun.html#defunAssociatedTypeFamilies"><span class="hs-identifier hs-var">defunAssociatedTypeFamilies</span></a></span><span> </span><span class="annot"><span class="annottext">[DTyVarBndrUnit]
</span><a href="#local-6989586621679308582"><span class="hs-identifier hs-var">tvbs</span></a></span><span> </span><span class="annot"><span class="annottext">[OpenTypeFamilyDecl]
</span><a href="#local-6989586621679308578"><span class="hs-identifier hs-var">atfs</span></a></span><span>
</span><span id="line-311"></span><span>
</span><span id="line-312"></span><span>    </span><span id="local-6989586621679308550"><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621679308550"><span class="hs-identifier hs-var">infix_decls'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b.
Monad m =&gt;
(a -&gt; m (Maybe b)) -&gt; [a] -&gt; m [b]
</span><a href="Data.Singletons.TH.Util.html#mapMaybeM"><span class="hs-identifier hs-var">mapMaybeM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a b c. (a -&gt; b -&gt; c) -&gt; (a, b) -&gt; c
</span><span class="hs-identifier hs-var">uncurry</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (q :: * -&gt; *).
OptionsMonad q =&gt;
Maybe Uniq -&gt; Name -&gt; Fixity -&gt; q (Maybe DDec)
</span><a href="Data.Singletons.TH.Promote.html#promoteInfixDecl"><span class="hs-identifier hs-var">promoteInfixDecl</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-313"></span><span>                    </span><span class="annot"><span class="annottext">forall k v. OMap k v -&gt; [(k, v)]
</span><span class="hs-identifier hs-var">OMap.assocs</span></span><span> </span><span class="annot"><span class="annottext">OMap Name Fixity
</span><a href="#local-6989586621679308572"><span class="hs-identifier hs-var">infix_decls</span></a></span><span>
</span><span id="line-314"></span><span>    </span><span id="local-6989586621679308547"><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621679308547"><span class="hs-identifier hs-var">cls_infix_decls</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (q :: * -&gt; *). OptionsMonad q =&gt; [Name] -&gt; q [DDec]
</span><a href="Data.Singletons.TH.Promote.html#promoteReifiedInfixDecls"><span class="hs-identifier hs-var">promoteReifiedInfixDecls</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679308583"><span class="hs-identifier hs-var">cls_name</span></a></span><span class="annot"><span class="annottext">forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621679308565"><span class="hs-identifier hs-var">meth_names</span></a></span><span>
</span><span id="line-315"></span><span>
</span><span id="line-316"></span><span>    </span><span class="hs-comment">-- no need to do anything to the fundeps. They work as is!</span><span>
</span><span id="line-317"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679308546"><span class="annot"><span class="annottext">pro_cls_dec :: DDec
</span><a href="#local-6989586621679308546"><span class="hs-identifier hs-var hs-var">pro_cls_dec</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[DType] -&gt; Name -&gt; [DTyVarBndrUnit] -&gt; [FunDep] -&gt; [DDec] -&gt; DDec
</span><span class="hs-identifier hs-var">DClassD</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679308570"><span class="hs-identifier hs-var">pClsName</span></a></span><span> </span><span class="annot"><span class="annottext">[DTyVarBndrUnit]
</span><a href="#local-6989586621679308582"><span class="hs-identifier hs-var">tvbs</span></a></span><span> </span><span class="annot"><span class="annottext">[FunDep]
</span><a href="#local-6989586621679308580"><span class="hs-identifier hs-var">fundeps</span></a></span><span>
</span><span id="line-318"></span><span>                              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621679308560"><span class="hs-identifier hs-var">sig_decs</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621679308557"><span class="hs-identifier hs-var">default_decs</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621679308550"><span class="hs-identifier hs-var">infix_decls'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-319"></span><span>        </span><span id="local-6989586621679308542"><span class="annot"><span class="annottext">mb_pro_cls_sak :: Maybe DDec
</span><a href="#local-6989586621679308542"><span class="hs-identifier hs-var hs-var">mb_pro_cls_sak</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; DType -&gt; DDec
</span><span class="hs-identifier hs-var">DKiSigD</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679308570"><span class="hs-identifier hs-var">pClsName</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe DType
</span><a href="#local-6989586621679308562"><span class="hs-identifier hs-var">mb_cls_sak</span></a></span><span>
</span><span id="line-320"></span><span>    </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). MonadWriter [DDec] m =&gt; [DDec] -&gt; m ()
</span><a href="Data.Singletons.TH.Promote.Monad.html#emitDecs"><span class="hs-identifier hs-var">emitDecs</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a -&gt; [a]
</span><span class="hs-identifier hs-var">maybeToList</span></span><span> </span><span class="annot"><span class="annottext">Maybe DDec
</span><a href="#local-6989586621679308542"><span class="hs-identifier hs-var">mb_pro_cls_sak</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">DDec
</span><a href="#local-6989586621679308546"><span class="hs-identifier hs-var">pro_cls_dec</span></a></span><span class="annot"><span class="annottext">forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621679308547"><span class="hs-identifier hs-var">cls_infix_decls</span></a></span><span>
</span><span id="line-321"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679308539"><span class="annot"><span class="annottext">defaults_list' :: [(Name, ALetDecRHS)]
</span><a href="#local-6989586621679308539"><span class="hs-identifier hs-var hs-var">defaults_list'</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621679308563"><span class="hs-identifier hs-var">defaults_names</span></a></span><span> </span><span class="annot"><span class="annottext">[ALetDecRHS]
</span><a href="#local-6989586621679308556"><span class="hs-identifier hs-var">ann_rhss</span></a></span><span>
</span><span id="line-322"></span><span>        </span><span id="local-6989586621679308538"><span class="annot"><span class="annottext">proms :: [LetBind]
</span><a href="#local-6989586621679308538"><span class="hs-identifier hs-var hs-var">proms</span></a></span></span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621679308563"><span class="hs-identifier hs-var">defaults_names</span></a></span><span> </span><span class="annot"><span class="annottext">[DType]
</span><a href="#local-6989586621679308555"><span class="hs-identifier hs-var">prom_rhss</span></a></span><span>
</span><span id="line-323"></span><span>        </span><span id="local-6989586621679308535"><span class="annot"><span class="annottext">cls_kvs_to_bind' :: OMap Name (OSet Name)
</span><a href="#local-6989586621679308535"><span class="hs-identifier hs-var hs-var">cls_kvs_to_bind'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OSet Name
</span><a href="#local-6989586621679308567"><span class="hs-identifier hs-var">cls_kvs_to_bind</span></a></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; a -&gt; f b -&gt; f a
</span><span class="hs-operator hs-var">&lt;$</span></span><span> </span><span class="annot"><span class="annottext">OMap Name DType
</span><a href="#local-6989586621679308574"><span class="hs-identifier hs-var">meth_sigs</span></a></span><span>
</span><span id="line-324"></span><span>    </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UClassDecl
</span><a href="#local-6989586621679308585"><span class="hs-identifier hs-var">decl</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">cd_lde :: ALetDecEnv
</span><a href="Data.Singletons.TH.Syntax.html#cd_lde"><span class="hs-identifier hs-var">cd_lde</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ULetDecEnv
</span><a href="#local-6989586621679308577"><span class="hs-identifier hs-var">lde</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">lde_defns :: OMap Name ALetDecRHS
</span><a href="Data.Singletons.TH.Syntax.html#lde_defns"><span class="hs-identifier hs-var">lde_defns</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall k v. Ord k =&gt; [(k, v)] -&gt; OMap k v
</span><span class="hs-identifier hs-var">OMap.fromList</span></span><span> </span><span class="annot"><span class="annottext">[(Name, ALetDecRHS)]
</span><a href="#local-6989586621679308539"><span class="hs-identifier hs-var">defaults_list'</span></a></span><span>
</span><span id="line-325"></span><span>                                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">lde_proms :: IfAnn Annotated (OMap Name DType) ()
</span><a href="Data.Singletons.TH.Syntax.html#lde_proms"><span class="hs-identifier hs-var">lde_proms</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall k v. Ord k =&gt; [(k, v)] -&gt; OMap k v
</span><span class="hs-identifier hs-var">OMap.fromList</span></span><span> </span><span class="annot"><span class="annottext">[LetBind]
</span><a href="#local-6989586621679308538"><span class="hs-identifier hs-var">proms</span></a></span><span>
</span><span id="line-326"></span><span>                                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">lde_bound_kvs :: IfAnn Annotated (OMap Name (OSet Name)) ()
</span><a href="Data.Singletons.TH.Syntax.html#lde_bound_kvs"><span class="hs-identifier hs-var">lde_bound_kvs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OMap Name (OSet Name)
</span><a href="#local-6989586621679308535"><span class="hs-identifier hs-var">cls_kvs_to_bind'</span></a></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-327"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-328"></span><span>    </span><span class="annot"><a href="#local-6989586621679308532"><span class="hs-identifier hs-type">cls_kvb_names</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679308531"><span class="hs-identifier hs-type">cls_tvb_names</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679308567"><span class="hs-identifier hs-type">cls_kvs_to_bind</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">OSet</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span>
</span><span id="line-329"></span><span>    </span><span id="local-6989586621679308532"><span class="annot"><span class="annottext">cls_kvb_names :: OSet Name
</span><a href="#local-6989586621679308532"><span class="hs-identifier hs-var hs-var">cls_kvb_names</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) m a.
(Foldable t, Monoid m) =&gt;
(a -&gt; m) -&gt; t a -&gt; m
</span><span class="hs-identifier hs-var">foldMap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) m a.
(Foldable t, Monoid m) =&gt;
(a -&gt; m) -&gt; t a -&gt; m
</span><span class="hs-identifier hs-var">foldMap</span></span><span> </span><span class="annot"><span class="annottext">DType -&gt; OSet Name
</span><span class="hs-identifier hs-var">fvDType</span></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall flag. DTyVarBndr flag -&gt; Maybe DType
</span><a href="Data.Singletons.TH.Util.html#extractTvbKind"><span class="hs-identifier hs-var">extractTvbKind</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[DTyVarBndrUnit]
</span><a href="#local-6989586621679308582"><span class="hs-identifier hs-var">tvbs</span></a></span><span>
</span><span id="line-330"></span><span>    </span><span id="local-6989586621679308531"><span class="annot"><span class="annottext">cls_tvb_names :: OSet Name
</span><a href="#local-6989586621679308531"><span class="hs-identifier hs-var hs-var">cls_tvb_names</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; [a] -&gt; OSet a
</span><span class="hs-identifier hs-var">OSet.fromList</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">forall flag. DTyVarBndr flag -&gt; Name
</span><a href="Data.Singletons.TH.Util.html#extractTvbName"><span class="hs-identifier hs-var">extractTvbName</span></a></span><span> </span><span class="annot"><span class="annottext">[DTyVarBndrUnit]
</span><a href="#local-6989586621679308582"><span class="hs-identifier hs-var">tvbs</span></a></span><span>
</span><span id="line-331"></span><span>    </span><span id="local-6989586621679308567"><span class="annot"><span class="annottext">cls_kvs_to_bind :: OSet Name
</span><a href="#local-6989586621679308567"><span class="hs-identifier hs-var hs-var">cls_kvs_to_bind</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OSet Name
</span><a href="#local-6989586621679308532"><span class="hs-identifier hs-var">cls_kvb_names</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; OSet a -&gt; OSet a -&gt; OSet a
</span><span class="hs-operator hs-var">`OSet.union`</span></span><span> </span><span class="annot"><span class="annottext">OSet Name
</span><a href="#local-6989586621679308531"><span class="hs-identifier hs-var">cls_tvb_names</span></a></span><span>
</span><span id="line-332"></span><span>
</span><span id="line-333"></span><span>    </span><span class="annot"><a href="#local-6989586621679308558"><span class="hs-identifier hs-type">promote_sig</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DType</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Data.Singletons.TH.Promote.Monad.html#PrM"><span class="hs-identifier hs-type">PrM</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">DDec</span></span><span>
</span><span id="line-334"></span><span>    </span><span id="local-6989586621679308558"><span class="annot"><span class="annottext">promote_sig :: Name -&gt; DType -&gt; PrM DDec
</span><a href="#local-6989586621679308558"><span class="hs-identifier hs-var hs-var">promote_sig</span></a></span></span><span> </span><span id="local-6989586621679308525"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679308525"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span id="local-6989586621679308524"><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621679308524"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-335"></span><span>      </span><span id="local-6989586621679308523"><span class="annot"><span class="annottext">Options
</span><a href="#local-6989586621679308523"><span class="hs-identifier hs-var">opts</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). OptionsMonad m =&gt; m Options
</span><a href="Data.Singletons.TH.Options.html#getOptions"><span class="hs-identifier hs-var">getOptions</span></a></span><span>
</span><span id="line-336"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679308522"><span class="annot"><span class="annottext">proName :: Name
</span><a href="#local-6989586621679308522"><span class="hs-identifier hs-var hs-var">proName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Options -&gt; Name -&gt; Name
</span><a href="Data.Singletons.TH.Options.html#promotedTopLevelValueName"><span class="hs-identifier hs-var">promotedTopLevelValueName</span></a></span><span> </span><span class="annot"><span class="annottext">Options
</span><a href="#local-6989586621679308523"><span class="hs-identifier hs-var">opts</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679308525"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-337"></span><span>      </span><span class="hs-comment">-- When computing the kind to use for the defunctionalization symbols,</span><span>
</span><span id="line-338"></span><span>      </span><span class="hs-comment">-- /don't/ use the type variable binders from the method's type...</span><span>
</span><span id="line-339"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[DTyVarBndrSpec]
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679308520"><span class="annot"><span class="annottext">[DType]
</span><a href="#local-6989586621679308520"><span class="hs-identifier hs-var">argKs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679308519"><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621679308519"><span class="hs-identifier hs-var">resK</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *).
OptionsMonad m =&gt;
DType -&gt; m ([DTyVarBndrSpec], [DType], DType)
</span><a href="Data.Singletons.TH.Promote.Type.html#promoteUnraveled"><span class="hs-identifier hs-var">promoteUnraveled</span></a></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621679308524"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-340"></span><span>      </span><span id="local-6989586621679308517"><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621679308517"><span class="hs-identifier hs-var">args</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a b. a -&gt; b -&gt; a
</span><span class="hs-identifier hs-var">const</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). Quasi m =&gt; String -&gt; m Name
</span><span class="hs-identifier hs-var">qNewName</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;arg&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[DType]
</span><a href="#local-6989586621679308520"><span class="hs-identifier hs-var">argKs</span></a></span><span>
</span><span id="line-341"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679308514"><span class="annot"><span class="annottext">proTvbs :: [DTyVarBndrUnit]
</span><a href="#local-6989586621679308514"><span class="hs-identifier hs-var hs-var">proTvbs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a b c. (a -&gt; b -&gt; c) -&gt; [a] -&gt; [b] -&gt; [c]
</span><span class="hs-identifier hs-var">zipWith</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall flag. Name -&gt; flag -&gt; DType -&gt; DTyVarBndr flag
</span><span class="hs-operator hs-var">`DKindedTV`</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621679308517"><span class="hs-identifier hs-var">args</span></a></span><span> </span><span class="annot"><span class="annottext">[DType]
</span><a href="#local-6989586621679308520"><span class="hs-identifier hs-var">argKs</span></a></span><span>
</span><span id="line-342"></span><span>      </span><span class="hs-comment">-- ...instead, compute the type variable binders in a left-to-right order,</span><span>
</span><span id="line-343"></span><span>      </span><span class="hs-comment">-- since that is the same order that the promoted method's kind will use.</span><span>
</span><span id="line-344"></span><span>      </span><span class="hs-comment">-- See Note [Promoted class methods and kind variable ordering]</span><span>
</span><span id="line-345"></span><span>          </span><span id="local-6989586621679308511"><span class="annot"><span class="annottext">meth_sak_tvbs :: [DTyVarBndrSpec]
</span><a href="#local-6989586621679308511"><span class="hs-identifier hs-var hs-var">meth_sak_tvbs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall newFlag oldFlag.
newFlag -&gt; [DTyVarBndr oldFlag] -&gt; [DTyVarBndr newFlag]
</span><span class="hs-identifier hs-var">changeDTVFlags</span></span><span> </span><span class="annot"><span class="annottext">Specificity
</span><span class="hs-identifier hs-var">SpecifiedSpec</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-346"></span><span>                          </span><span class="annot"><span class="annottext">[DType] -&gt; [DTyVarBndrUnit]
</span><span class="hs-identifier hs-var">toposortTyVarsOf</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[DType]
</span><a href="#local-6989586621679308520"><span class="hs-identifier hs-var">argKs</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621679308519"><span class="hs-identifier hs-var">resK</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-347"></span><span>          </span><span id="local-6989586621679308507"><span class="annot"><span class="annottext">meth_sak :: DType
</span><a href="#local-6989586621679308507"><span class="hs-identifier hs-var hs-var">meth_sak</span></a></span></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[DTyVarBndrSpec] -&gt; [DType] -&gt; [DType] -&gt; DType -&gt; DType
</span><a href="Data.Singletons.TH.Util.html#ravelVanillaDType"><span class="hs-identifier hs-var">ravelVanillaDType</span></a></span><span> </span><span class="annot"><span class="annottext">[DTyVarBndrSpec]
</span><a href="#local-6989586621679308511"><span class="hs-identifier hs-var">meth_sak_tvbs</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">[DType]
</span><a href="#local-6989586621679308520"><span class="hs-identifier hs-var">argKs</span></a></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621679308519"><span class="hs-identifier hs-var">resK</span></a></span><span>
</span><span id="line-348"></span><span>      </span><span id="local-6989586621679308505"><span class="annot"><span class="annottext">Maybe Fixity
</span><a href="#local-6989586621679308505"><span class="hs-identifier hs-var">m_fixity</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (q :: * -&gt; *). DsMonad q =&gt; Name -&gt; q (Maybe Fixity)
</span><span class="hs-identifier hs-var">reifyFixityWithLocals</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679308525"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-349"></span><span>      </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). MonadWriter [DDec] m =&gt; m [DDec] -&gt; m ()
</span><a href="Data.Singletons.TH.Promote.Monad.html#emitDecsM"><span class="hs-identifier hs-var">emitDecsM</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; Maybe Fixity -&gt; DefunKindInfo -&gt; PrM [DDec]
</span><a href="Data.Singletons.TH.Promote.Defun.html#defunctionalize"><span class="hs-identifier hs-var">defunctionalize</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679308522"><span class="hs-identifier hs-var">proName</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Fixity
</span><a href="#local-6989586621679308505"><span class="hs-identifier hs-var">m_fixity</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">DType -&gt; DefunKindInfo
</span><a href="Data.Singletons.TH.Promote.Defun.html#DefunSAK"><span class="hs-identifier hs-var">DefunSAK</span></a></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621679308507"><span class="hs-identifier hs-var">meth_sak</span></a></span><span>
</span><span id="line-350"></span><span>
</span><span id="line-351"></span><span>      </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">DTypeFamilyHead -&gt; DDec
</span><span class="hs-identifier hs-var">DOpenTypeFamilyD</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name
-&gt; [DTyVarBndrUnit]
-&gt; DFamilyResultSig
-&gt; Maybe InjectivityAnn
-&gt; DTypeFamilyHead
</span><span class="hs-identifier hs-var">DTypeFamilyHead</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679308522"><span class="hs-identifier hs-var">proName</span></a></span><span>
</span><span id="line-352"></span><span>                                                 </span><span class="annot"><span class="annottext">[DTyVarBndrUnit]
</span><a href="#local-6989586621679308514"><span class="hs-identifier hs-var">proTvbs</span></a></span><span>
</span><span id="line-353"></span><span>                                                 </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DType -&gt; DFamilyResultSig
</span><span class="hs-identifier hs-var">DKindSig</span></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621679308519"><span class="hs-identifier hs-var">resK</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-354"></span><span>                                                 </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span>
</span><span id="line-355"></span><span>
</span><span id="line-356"></span><span class="hs-comment">{-
Note [Promoted class methods and kind variable ordering]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
In general, we make an effort to preserve the order of type variables when
promoting type signatures, but there is an annoying corner case where this is
difficult: class methods. When promoting class methods, the order of kind
variables in their kinds will often &quot;just work&quot; by happy coincidence, but
there are some situations where this does not happen. Consider the following
class:

  class C (b :: Type) where
    m :: forall a. a -&gt; b -&gt; a

The full type of `m` is `forall b. C b =&gt; forall a. a -&gt; b -&gt; a`, which binds
`b` before `a`. This order is preserved when singling `m`, but *not* when
promoting `m`. This is because the `C` class is promoted as follows:

  class PC (b :: Type) where
    type M (x :: a) (y :: b) :: a

Due to the way GHC kind-checks associated type families, the kind of `M` is
`forall a b. a -&gt; b -&gt; a`, which binds `b` *after* `a`. Moreover, the
`StandaloneKindSignatures` extension does not provide a way to explicitly
declare the full kind of an associated type family, so this limitation is
not easy to work around.

The defunctionalization symbols for `M` will also follow a similar
order of type variables:

  type MSym0 :: forall a b. a ~&gt; b ~&gt; a
  type MSym1 :: forall a b. a -&gt; b ~&gt; a

There is one potential hack we could use to rectify this:

  type FlipConst x y = y
  class PC (b :: Type) where
    type M (x :: FlipConst '(b, a) a) (y :: b) :: a

Using `FlipConst` would cause `b` to be mentioned before `a`, which would give
`M` the kind `forall b a. FlipConst '(b, a) a -&gt; b -&gt; a`. While the order of
type variables would be preserved, the downside is that the ugly `FlipConst`
type synonym leaks into the kind. I'm not particularly fond of this, so I have
decided not to use this hack unless someone specifically requests it.
-}</span><span>
</span><span id="line-400"></span><span>
</span><span id="line-401"></span><span class="hs-comment">-- returns (unpromoted method name, ALetDecRHS) pairs</span><span>
</span><span id="line-402"></span><span class="annot"><a href="Data.Singletons.TH.Promote.html#promoteInstanceDec"><span class="hs-identifier hs-type">promoteInstanceDec</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">OMap</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">DType</span></span><span>
</span><span id="line-403"></span><span>                      </span><span class="hs-comment">-- Class method type signatures</span><span>
</span><span id="line-404"></span><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">DTyVarBndrUnit</span></span><span class="hs-special">]</span><span>
</span><span id="line-405"></span><span>                      </span><span class="hs-comment">-- Class header type variable (e.g., if `class C a b` is</span><span>
</span><span id="line-406"></span><span>                      </span><span class="hs-comment">-- quoted, then this will have an entry for {C |-&gt; [a, b]})</span><span>
</span><span id="line-407"></span><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Data.Singletons.TH.Syntax.html#UInstDecl"><span class="hs-identifier hs-type">UInstDecl</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Data.Singletons.TH.Promote.Monad.html#PrM"><span class="hs-identifier hs-type">PrM</span></a></span><span> </span><span class="annot"><a href="Data.Singletons.TH.Syntax.html#AInstDecl"><span class="hs-identifier hs-type">AInstDecl</span></a></span><span>
</span><span id="line-408"></span><span id="promoteInstanceDec"><span class="annot"><span class="annottext">promoteInstanceDec :: OMap Name DType
-&gt; Map Name [DTyVarBndrUnit] -&gt; UInstDecl -&gt; PrM AInstDecl
</span><a href="Data.Singletons.TH.Promote.html#promoteInstanceDec"><span class="hs-identifier hs-var hs-var">promoteInstanceDec</span></a></span></span><span> </span><span id="local-6989586621679308497"><span class="annot"><span class="annottext">OMap Name DType
</span><a href="#local-6989586621679308497"><span class="hs-identifier hs-var">orig_meth_sigs</span></a></span></span><span> </span><span id="local-6989586621679308496"><span class="annot"><span class="annottext">Map Name [DTyVarBndrUnit]
</span><a href="#local-6989586621679308496"><span class="hs-identifier hs-var">cls_tvbs_map</span></a></span></span><span>
</span><span id="line-409"></span><span>                   </span><span id="local-6989586621679308495"><span class="annot"><span class="annottext">decl :: UInstDecl
</span><a href="#local-6989586621679308495"><span class="hs-identifier hs-var">decl</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Data.Singletons.TH.Syntax.html#InstDecl"><span class="hs-identifier hs-type">InstDecl</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">id_name :: forall (ann :: AnnotationFlag). InstDecl ann -&gt; Name
</span><a href="Data.Singletons.TH.Syntax.html#id_name"><span class="hs-identifier hs-var">id_name</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621679308492"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679308492"><span class="hs-identifier hs-var">cls_name</span></a></span></span><span>
</span><span id="line-410"></span><span>                                  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">id_arg_tys :: forall (ann :: AnnotationFlag). InstDecl ann -&gt; [DType]
</span><a href="Data.Singletons.TH.Syntax.html#id_arg_tys"><span class="hs-identifier hs-var">id_arg_tys</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621679308490"><span class="annot"><span class="annottext">[DType]
</span><a href="#local-6989586621679308490"><span class="hs-identifier hs-var">inst_tys</span></a></span></span><span>
</span><span id="line-411"></span><span>                                  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">id_sigs :: forall (ann :: AnnotationFlag). InstDecl ann -&gt; OMap Name DType
</span><a href="Data.Singletons.TH.Syntax.html#id_sigs"><span class="hs-identifier hs-var">id_sigs</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621679308488"><span class="annot"><span class="annottext">OMap Name DType
</span><a href="#local-6989586621679308488"><span class="hs-identifier hs-var">inst_sigs</span></a></span></span><span>
</span><span id="line-412"></span><span>                                  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">id_meths :: forall (ann :: AnnotationFlag).
InstDecl ann -&gt; [(Name, LetDecRHS ann)]
</span><a href="Data.Singletons.TH.Syntax.html#id_meths"><span class="hs-identifier hs-var">id_meths</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621679308486"><span class="annot"><span class="annottext">[(Name, LetDecRHS Unannotated)]
</span><a href="#local-6989586621679308486"><span class="hs-identifier hs-var">meths</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-413"></span><span>  </span><span id="local-6989586621679308485"><span class="annot"><span class="annottext">Options
</span><a href="#local-6989586621679308485"><span class="hs-identifier hs-var">opts</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). OptionsMonad m =&gt; m Options
</span><a href="Data.Singletons.TH.Options.html#getOptions"><span class="hs-identifier hs-var">getOptions</span></a></span><span>
</span><span id="line-414"></span><span>  </span><span id="local-6989586621679308484"><span class="annot"><span class="annottext">[DTyVarBndrUnit]
</span><a href="#local-6989586621679308484"><span class="hs-identifier hs-var">cls_tvbs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">PrM [DTyVarBndrUnit]
</span><a href="#local-6989586621679308483"><span class="hs-identifier hs-var">lookup_cls_tvbs</span></a></span><span>
</span><span id="line-415"></span><span>  </span><span id="local-6989586621679308482"><span class="annot"><span class="annottext">[DType]
</span><a href="#local-6989586621679308482"><span class="hs-identifier hs-var">inst_kis</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). OptionsMonad m =&gt; DType -&gt; m DType
</span><a href="Data.Singletons.TH.Promote.Type.html#promoteType"><span class="hs-identifier hs-var">promoteType</span></a></span><span> </span><span class="annot"><span class="annottext">[DType]
</span><a href="#local-6989586621679308490"><span class="hs-identifier hs-var">inst_tys</span></a></span><span>
</span><span id="line-416"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679308480"><span class="annot"><span class="annottext">pClsName :: Name
</span><a href="#local-6989586621679308480"><span class="hs-identifier hs-var hs-var">pClsName</span></a></span></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Options -&gt; Name -&gt; Name
</span><a href="Data.Singletons.TH.Options.html#promotedClassName"><span class="hs-identifier hs-var">promotedClassName</span></a></span><span> </span><span class="annot"><span class="annottext">Options
</span><a href="#local-6989586621679308485"><span class="hs-identifier hs-var">opts</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679308492"><span class="hs-identifier hs-var">cls_name</span></a></span><span>
</span><span id="line-417"></span><span>      </span><span id="local-6989586621679308479"><span class="annot"><span class="annottext">cls_tvb_names :: [Name]
</span><a href="#local-6989586621679308479"><span class="hs-identifier hs-var hs-var">cls_tvb_names</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">forall flag. DTyVarBndr flag -&gt; Name
</span><a href="Data.Singletons.TH.Util.html#extractTvbName"><span class="hs-identifier hs-var">extractTvbName</span></a></span><span> </span><span class="annot"><span class="annottext">[DTyVarBndrUnit]
</span><a href="#local-6989586621679308484"><span class="hs-identifier hs-var">cls_tvbs</span></a></span><span>
</span><span id="line-418"></span><span>      </span><span id="local-6989586621679308475"><span class="annot"><span class="annottext">kvs_to_bind :: OSet Name
</span><a href="#local-6989586621679308475"><span class="hs-identifier hs-var hs-var">kvs_to_bind</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) m a.
(Foldable t, Monoid m) =&gt;
(a -&gt; m) -&gt; t a -&gt; m
</span><span class="hs-identifier hs-var">foldMap</span></span><span> </span><span class="annot"><span class="annottext">DType -&gt; OSet Name
</span><span class="hs-identifier hs-var">fvDType</span></span><span> </span><span class="annot"><span class="annottext">[DType]
</span><a href="#local-6989586621679308482"><span class="hs-identifier hs-var">inst_kis</span></a></span><span>
</span><span id="line-419"></span><span>  </span><span class="annot"><span class="annottext">forall a. OSet Name -&gt; PrM a -&gt; PrM a
</span><a href="Data.Singletons.TH.Promote.Monad.html#forallBind"><span class="hs-identifier hs-var">forallBind</span></a></span><span> </span><span class="annot"><span class="annottext">OSet Name
</span><a href="#local-6989586621679308475"><span class="hs-identifier hs-var">kvs_to_bind</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-420"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679308473"><span class="annot"><span class="annottext">subst :: Map Name DType
</span><a href="#local-6989586621679308473"><span class="hs-identifier hs-var hs-var">subst</span></a></span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><span class="hs-identifier hs-var">Map.fromList</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621679308479"><span class="hs-identifier hs-var">cls_tvb_names</span></a></span><span> </span><span class="annot"><span class="annottext">[DType]
</span><a href="#local-6989586621679308482"><span class="hs-identifier hs-var">inst_kis</span></a></span><span>
</span><span id="line-421"></span><span>        </span><span id="local-6989586621679308472"><span class="annot"><span class="annottext">meth_impl :: MethodSort
</span><a href="#local-6989586621679308472"><span class="hs-identifier hs-var hs-var">meth_impl</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OMap Name DType -&gt; Map Name DType -&gt; MethodSort
</span><a href="Data.Singletons.TH.Promote.html#InstanceMethods"><span class="hs-identifier hs-var">InstanceMethods</span></a></span><span> </span><span class="annot"><span class="annottext">OMap Name DType
</span><a href="#local-6989586621679308488"><span class="hs-identifier hs-var">inst_sigs</span></a></span><span> </span><span class="annot"><span class="annottext">Map Name DType
</span><a href="#local-6989586621679308473"><span class="hs-identifier hs-var">subst</span></a></span><span>
</span><span id="line-422"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621679308470"><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621679308470"><span class="hs-identifier hs-var">meths'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679308469"><span class="annot"><span class="annottext">[ALetDecRHS]
</span><a href="#local-6989586621679308469"><span class="hs-identifier hs-var">ann_rhss</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[DType]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>
</span><span id="line-423"></span><span>      </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b c d.
Monad m =&gt;
(a -&gt; m (b, c, d)) -&gt; [a] -&gt; m ([b], [c], [d])
</span><a href="Data.Singletons.TH.Util.html#mapAndUnzip3M"><span class="hs-identifier hs-var">mapAndUnzip3M</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MethodSort
-&gt; OMap Name DType
-&gt; (Name, LetDecRHS Unannotated)
-&gt; PrM (DDec, ALetDecRHS, DType)
</span><a href="Data.Singletons.TH.Promote.html#promoteMethod"><span class="hs-identifier hs-var">promoteMethod</span></a></span><span> </span><span class="annot"><span class="annottext">MethodSort
</span><a href="#local-6989586621679308472"><span class="hs-identifier hs-var">meth_impl</span></a></span><span> </span><span class="annot"><span class="annottext">OMap Name DType
</span><a href="#local-6989586621679308497"><span class="hs-identifier hs-var">orig_meth_sigs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(Name, LetDecRHS Unannotated)]
</span><a href="#local-6989586621679308486"><span class="hs-identifier hs-var">meths</span></a></span><span>
</span><span id="line-424"></span><span>    </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). MonadWriter [DDec] m =&gt; [DDec] -&gt; m ()
</span><a href="Data.Singletons.TH.Promote.Monad.html#emitDecs"><span class="hs-identifier hs-var">emitDecs</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Maybe Overlap
-&gt; Maybe [DTyVarBndrUnit] -&gt; [DType] -&gt; DType -&gt; [DDec] -&gt; DDec
</span><span class="hs-identifier hs-var">DInstanceD</span></span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DType -&gt; [DType] -&gt; DType
</span><a href="Data.Singletons.TH.Util.html#foldType"><span class="hs-identifier hs-var">foldType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; DType
</span><span class="hs-identifier hs-var">DConT</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679308480"><span class="hs-identifier hs-var">pClsName</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-425"></span><span>                                              </span><span class="annot"><span class="annottext">[DType]
</span><a href="#local-6989586621679308482"><span class="hs-identifier hs-var">inst_kis</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621679308470"><span class="hs-identifier hs-var">meths'</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-426"></span><span>    </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UInstDecl
</span><a href="#local-6989586621679308495"><span class="hs-identifier hs-var">decl</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">id_meths :: [(Name, ALetDecRHS)]
</span><a href="Data.Singletons.TH.Syntax.html#id_meths"><span class="hs-identifier hs-var">id_meths</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">[(Name, LetDecRHS Unannotated)]
</span><a href="#local-6989586621679308486"><span class="hs-identifier hs-var">meths</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[ALetDecRHS]
</span><a href="#local-6989586621679308469"><span class="hs-identifier hs-var">ann_rhss</span></a></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-427"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-428"></span><span>    </span><span class="annot"><a href="#local-6989586621679308483"><span class="hs-identifier hs-type">lookup_cls_tvbs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Data.Singletons.TH.Promote.Monad.html#PrM"><span class="hs-identifier hs-type">PrM</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">DTyVarBndrUnit</span></span><span class="hs-special">]</span><span>
</span><span id="line-429"></span><span>    </span><span id="local-6989586621679308483"><span class="annot"><span class="annottext">lookup_cls_tvbs :: PrM [DTyVarBndrUnit]
</span><a href="#local-6989586621679308483"><span class="hs-identifier hs-var hs-var">lookup_cls_tvbs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-430"></span><span>      </span><span class="hs-comment">-- First, try consulting the map of class names to their type variables.</span><span>
</span><span id="line-431"></span><span>      </span><span class="hs-comment">-- It is important to do this first to ensure that we consider locally</span><span>
</span><span id="line-432"></span><span>      </span><span class="hs-comment">-- declared classes before imported ones. See #410 for what happens if</span><span>
</span><span id="line-433"></span><span>      </span><span class="hs-comment">-- you don't.</span><span>
</span><span id="line-434"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Map.lookup</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679308492"><span class="hs-identifier hs-var">cls_name</span></a></span><span> </span><span class="annot"><span class="annottext">Map Name [DTyVarBndrUnit]
</span><a href="#local-6989586621679308496"><span class="hs-identifier hs-var">cls_tvbs_map</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-435"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679308466"><span class="annot"><span class="annottext">[DTyVarBndrUnit]
</span><a href="#local-6989586621679308466"><span class="hs-identifier hs-var">tvbs</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">[DTyVarBndrUnit]
</span><a href="#local-6989586621679308466"><span class="hs-identifier hs-var">tvbs</span></a></span><span>
</span><span id="line-436"></span><span>        </span><span class="annot"><span class="annottext">Maybe [DTyVarBndrUnit]
</span><span class="hs-identifier hs-var">Nothing</span></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">PrM [DTyVarBndrUnit]
</span><a href="#local-6989586621679308465"><span class="hs-identifier hs-var">reify_cls_tvbs</span></a></span><span>
</span><span id="line-437"></span><span>          </span><span class="hs-comment">-- If the class isn't present in this map, we try reifying the class</span><span>
</span><span id="line-438"></span><span>          </span><span class="hs-comment">-- as a last resort.</span><span>
</span><span id="line-439"></span><span>
</span><span id="line-440"></span><span>    </span><span class="annot"><a href="#local-6989586621679308465"><span class="hs-identifier hs-type">reify_cls_tvbs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Data.Singletons.TH.Promote.Monad.html#PrM"><span class="hs-identifier hs-type">PrM</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">DTyVarBndrUnit</span></span><span class="hs-special">]</span><span>
</span><span id="line-441"></span><span>    </span><span id="local-6989586621679308465"><span class="annot"><span class="annottext">reify_cls_tvbs :: PrM [DTyVarBndrUnit]
</span><a href="#local-6989586621679308465"><span class="hs-identifier hs-var hs-var">reify_cls_tvbs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-442"></span><span>      </span><span id="local-6989586621679308464"><span class="annot"><span class="annottext">Options
</span><a href="#local-6989586621679308464"><span class="hs-identifier hs-var">opts</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). OptionsMonad m =&gt; m Options
</span><a href="Data.Singletons.TH.Options.html#getOptions"><span class="hs-identifier hs-var">getOptions</span></a></span><span>
</span><span id="line-443"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679308463"><span class="annot"><span class="annottext">pClsName :: Name
</span><a href="#local-6989586621679308463"><span class="hs-identifier hs-var hs-var">pClsName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Options -&gt; Name -&gt; Name
</span><a href="Data.Singletons.TH.Options.html#promotedClassName"><span class="hs-identifier hs-var">promotedClassName</span></a></span><span> </span><span class="annot"><span class="annottext">Options
</span><a href="#local-6989586621679308464"><span class="hs-identifier hs-var">opts</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679308492"><span class="hs-identifier hs-var">cls_name</span></a></span><span>
</span><span id="line-444"></span><span>          </span><span id="local-6989586621679308457"><span class="annot"><span class="annottext">mk_tvbs :: MaybeT PrM [DTyVarBndrUnit]
</span><a href="#local-6989586621679308457"><span class="hs-identifier hs-var hs-var">mk_tvbs</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PrM (Maybe DInfo) -&gt; MaybeT PrM [DTyVarBndrUnit]
</span><a href="#local-6989586621679308456"><span class="hs-identifier hs-var">extract_tvbs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (q :: * -&gt; *). DsMonad q =&gt; Name -&gt; q (Maybe DInfo)
</span><a href="Data.Singletons.TH.Util.html#dsReifyTypeNameInfo"><span class="hs-identifier hs-var">dsReifyTypeNameInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679308463"><span class="hs-identifier hs-var">pClsName</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-445"></span><span>                 </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Alternative f =&gt; f a -&gt; f a -&gt; f a
</span><span class="hs-operator hs-var">&lt;|&gt;</span></span><span> </span><span class="annot"><span class="annottext">PrM (Maybe DInfo) -&gt; MaybeT PrM [DTyVarBndrUnit]
</span><a href="#local-6989586621679308456"><span class="hs-identifier hs-var">extract_tvbs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (q :: * -&gt; *). DsMonad q =&gt; Name -&gt; q (Maybe DInfo)
</span><a href="Data.Singletons.TH.Util.html#dsReifyTypeNameInfo"><span class="hs-identifier hs-var">dsReifyTypeNameInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679308492"><span class="hs-identifier hs-var">cls_name</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-446"></span><span>                      </span><span class="hs-comment">-- See Note [Using dsReifyTypeNameInfo when promoting instances]</span><span>
</span><span id="line-447"></span><span>      </span><span id="local-6989586621679308453"><span class="annot"><span class="annottext">Maybe [DTyVarBndrUnit]
</span><a href="#local-6989586621679308453"><span class="hs-identifier hs-var">mb_tvbs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MaybeT m a -&gt; m (Maybe a)
</span><span class="hs-identifier hs-var">runMaybeT</span></span><span> </span><span class="annot"><span class="annottext">MaybeT PrM [DTyVarBndrUnit]
</span><a href="#local-6989586621679308457"><span class="hs-identifier hs-var">mk_tvbs</span></a></span><span>
</span><span id="line-448"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe [DTyVarBndrUnit]
</span><a href="#local-6989586621679308453"><span class="hs-identifier hs-var">mb_tvbs</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-449"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679308451"><span class="annot"><span class="annottext">[DTyVarBndrUnit]
</span><a href="#local-6989586621679308451"><span class="hs-identifier hs-var">tvbs</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">[DTyVarBndrUnit]
</span><a href="#local-6989586621679308451"><span class="hs-identifier hs-var">tvbs</span></a></span><span>
</span><span id="line-450"></span><span>        </span><span class="annot"><span class="annottext">Maybe [DTyVarBndrUnit]
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadFail m =&gt; String -&gt; m a
</span><span class="hs-identifier hs-var">fail</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Cannot find class declaration annotation for &quot;</span></span><span> </span><span class="annot"><span class="annottext">forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679308492"><span class="hs-identifier hs-var">cls_name</span></a></span><span>
</span><span id="line-451"></span><span>
</span><span id="line-452"></span><span>    </span><span class="annot"><a href="#local-6989586621679308456"><span class="hs-identifier hs-type">extract_tvbs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Data.Singletons.TH.Promote.Monad.html#PrM"><span class="hs-identifier hs-type">PrM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">DInfo</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MaybeT</span></span><span> </span><span class="annot"><a href="Data.Singletons.TH.Promote.Monad.html#PrM"><span class="hs-identifier hs-type">PrM</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">DTyVarBndrUnit</span></span><span class="hs-special">]</span><span>
</span><span id="line-453"></span><span>    </span><span id="local-6989586621679308456"><span class="annot"><span class="annottext">extract_tvbs :: PrM (Maybe DInfo) -&gt; MaybeT PrM [DTyVarBndrUnit]
</span><a href="#local-6989586621679308456"><span class="hs-identifier hs-var hs-var">extract_tvbs</span></a></span></span><span> </span><span id="local-6989586621679308449"><span class="annot"><span class="annottext">PrM (Maybe DInfo)
</span><a href="#local-6989586621679308449"><span class="hs-identifier hs-var">reify_info</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-454"></span><span>      </span><span id="local-6989586621679308448"><span class="annot"><span class="annottext">Maybe DInfo
</span><a href="#local-6989586621679308448"><span class="hs-identifier hs-var">mb_info</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">PrM (Maybe DInfo)
</span><a href="#local-6989586621679308449"><span class="hs-identifier hs-var">reify_info</span></a></span><span>
</span><span id="line-455"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe DInfo
</span><a href="#local-6989586621679308448"><span class="hs-identifier hs-var">mb_info</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-456"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DTyConI</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DClassD</span></span><span> </span><span class="annot"><span class="annottext">[DType]
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679308447"><span class="annot"><span class="annottext">[DTyVarBndrUnit]
</span><a href="#local-6989586621679308447"><span class="hs-identifier hs-var">tvbs</span></a></span></span><span> </span><span class="annot"><span class="annottext">[FunDep]
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[DDec]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe [DDec]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">[DTyVarBndrUnit]
</span><a href="#local-6989586621679308447"><span class="hs-identifier hs-var">tvbs</span></a></span><span>
</span><span id="line-457"></span><span>        </span><span class="annot"><span class="annottext">Maybe DInfo
</span><span class="hs-identifier">_</span></span><span>                                       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Alternative f =&gt; f a
</span><span class="hs-identifier hs-var">empty</span></span><span>
</span><span id="line-458"></span><span>
</span><span id="line-459"></span><span class="hs-comment">{-
Note [Using dsReifyTypeNameInfo when promoting instances]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
During the promotion of a class instance, it becomes necessary to reify the
original promoted class's info to learn various things. It's tempting to think
that just calling dsReify on the class name will be sufficient, but it's not.
Consider this class and its promotion:

  class Eq a where
    (==) :: a -&gt; a -&gt; Bool

  class PEq a where
    type (==) (x :: a) (y :: a) :: Bool

Notice how both of these classes have an identifier named (==), one at the
value level, and one at the type level. Now imagine what happens when you
attempt to promote this Template Haskell declaration:

   [d| f :: Bool
       f = () == () |]

When promoting ==, singletons-th will come up with its promoted equivalent (which also
happens to be ==). However, this promoted name is a raw Name, since it is created
with mkName. This becomes an issue when we call dsReify the raw &quot;==&quot; Name, as
Template Haskell has to arbitrarily choose between reifying the info for the
value-level (==) and the type-level (==), and in this case, it happens to pick the
value-level (==) info. We want the type-level (==) info, however, because we care
about the promoted version of (==).

Fortunately, there's a serviceable workaround. Instead of dsReify, we can use
dsReifyTypeNameInfo, which first calls lookupTypeName (to ensure we can find a Name
that's in the type namespace) and _then_ reifies it.
-}</span><span>
</span><span id="line-492"></span><span>
</span><span id="line-493"></span><span class="hs-comment">-- Which sort of class methods are being promoted?</span><span>
</span><span id="line-494"></span><span class="hs-keyword">data</span><span> </span><span id="MethodSort"><span class="annot"><a href="Data.Singletons.TH.Promote.html#MethodSort"><span class="hs-identifier hs-var">MethodSort</span></a></span></span><span>
</span><span id="line-495"></span><span>    </span><span class="hs-comment">-- The method defaults in class declarations.</span><span>
</span><span id="line-496"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="DefaultMethods"><span class="annot"><a href="Data.Singletons.TH.Promote.html#DefaultMethods"><span class="hs-identifier hs-var">DefaultMethods</span></a></span></span><span>
</span><span id="line-497"></span><span>    </span><span class="hs-comment">-- The methods in instance declarations.</span><span>
</span><span id="line-498"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="InstanceMethods"><span class="annot"><a href="Data.Singletons.TH.Promote.html#InstanceMethods"><span class="hs-identifier hs-var">InstanceMethods</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">OMap</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">DType</span></span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- ^ InstanceSigs</span><span>
</span><span id="line-499"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">DKind</span></span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- ^ Instantiations for class tyvars</span><span>
</span><span id="line-500"></span><span>                                      </span><span class="hs-comment">--   See Note [Promoted class method kinds]</span><span>
</span><span id="line-501"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span id="local-6989586621679308433"><span id="local-6989586621679308435"><span id="local-6989586621679308443"><span class="annot"><span class="annottext">Int -&gt; MethodSort -&gt; ShowS
[MethodSort] -&gt; ShowS
MethodSort -&gt; String
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [MethodSort] -&gt; ShowS
$cshowList :: [MethodSort] -&gt; ShowS
show :: MethodSort -&gt; String
$cshow :: MethodSort -&gt; String
showsPrec :: Int -&gt; MethodSort -&gt; ShowS
$cshowsPrec :: Int -&gt; MethodSort -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span>
</span><span id="line-502"></span><span>
</span><span id="line-503"></span><span class="annot"><a href="Data.Singletons.TH.Promote.html#promoteMethod"><span class="hs-identifier hs-type">promoteMethod</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Data.Singletons.TH.Promote.html#MethodSort"><span class="hs-identifier hs-type">MethodSort</span></a></span><span>
</span><span id="line-504"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">OMap</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">DType</span></span><span>    </span><span class="hs-comment">-- method types</span><span>
</span><span id="line-505"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.Singletons.TH.Syntax.html#ULetDecRHS"><span class="hs-identifier hs-type">ULetDecRHS</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-506"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Data.Singletons.TH.Promote.Monad.html#PrM"><span class="hs-identifier hs-type">PrM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DDec</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.Singletons.TH.Syntax.html#ALetDecRHS"><span class="hs-identifier hs-type">ALetDecRHS</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DType</span></span><span class="hs-special">)</span><span>
</span><span id="line-507"></span><span>                 </span><span class="hs-comment">-- returns (type instance, ALetDecRHS, promoted RHS)</span><span>
</span><span id="line-508"></span><span id="promoteMethod"><span class="annot"><span class="annottext">promoteMethod :: MethodSort
-&gt; OMap Name DType
-&gt; (Name, LetDecRHS Unannotated)
-&gt; PrM (DDec, ALetDecRHS, DType)
</span><a href="Data.Singletons.TH.Promote.html#promoteMethod"><span class="hs-identifier hs-var hs-var">promoteMethod</span></a></span></span><span> </span><span id="local-6989586621679308429"><span class="annot"><span class="annottext">MethodSort
</span><a href="#local-6989586621679308429"><span class="hs-identifier hs-var">meth_sort</span></a></span></span><span> </span><span id="local-6989586621679308428"><span class="annot"><span class="annottext">OMap Name DType
</span><a href="#local-6989586621679308428"><span class="hs-identifier hs-var">orig_sigs_map</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679308427"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679308427"><span class="hs-identifier hs-var">meth_name</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679308426"><span class="annot"><span class="annottext">LetDecRHS Unannotated
</span><a href="#local-6989586621679308426"><span class="hs-identifier hs-var">meth_rhs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-509"></span><span>  </span><span id="local-6989586621679308425"><span class="annot"><span class="annottext">Options
</span><a href="#local-6989586621679308425"><span class="hs-identifier hs-var">opts</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). OptionsMonad m =&gt; m Options
</span><a href="Data.Singletons.TH.Options.html#getOptions"><span class="hs-identifier hs-var">getOptions</span></a></span><span>
</span><span id="line-510"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621679308424"><span class="annot"><span class="annottext">[DTyVarBndrSpec]
</span><a href="#local-6989586621679308424"><span class="hs-identifier hs-var">meth_tvbs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679308423"><span class="annot"><span class="annottext">[DType]
</span><a href="#local-6989586621679308423"><span class="hs-identifier hs-var">meth_arg_kis</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679308422"><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621679308422"><span class="hs-identifier hs-var">meth_res_ki</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">PrM ([DTyVarBndrSpec], [DType], DType)
</span><a href="#local-6989586621679308421"><span class="hs-identifier hs-var">promote_meth_ty</span></a></span><span>
</span><span id="line-511"></span><span>  </span><span id="local-6989586621679308420"><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621679308420"><span class="hs-identifier hs-var">meth_arg_tvs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Applicative m =&gt; Int -&gt; m a -&gt; m [a]
</span><span class="hs-identifier hs-var">replicateM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[DType]
</span><a href="#local-6989586621679308423"><span class="hs-identifier hs-var">meth_arg_kis</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). Quasi m =&gt; String -&gt; m Name
</span><span class="hs-identifier hs-var">qNewName</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;a&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-512"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679308418"><span class="annot"><span class="annottext">proName :: Name
</span><a href="#local-6989586621679308418"><span class="hs-identifier hs-var hs-var">proName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Options -&gt; Name -&gt; Name
</span><a href="Data.Singletons.TH.Options.html#promotedTopLevelValueName"><span class="hs-identifier hs-var">promotedTopLevelValueName</span></a></span><span> </span><span class="annot"><span class="annottext">Options
</span><a href="#local-6989586621679308425"><span class="hs-identifier hs-var">opts</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679308427"><span class="hs-identifier hs-var">meth_name</span></a></span><span>
</span><span id="line-513"></span><span>      </span><span id="local-6989586621679308417"><span class="annot"><span class="annottext">helperNameBase :: String
</span><a href="#local-6989586621679308417"><span class="hs-identifier hs-var hs-var">helperNameBase</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Name -&gt; String
</span><span class="hs-identifier hs-var">nameBase</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679308418"><span class="hs-identifier hs-var">proName</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-514"></span><span>                         </span><span id="local-6989586621679308415"><span class="annot"><span class="annottext">Char
</span><a href="#local-6989586621679308415"><span class="hs-identifier hs-var">first</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span class="annot"><span class="annottext">String
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Char -&gt; Bool
</span><a href="Data.Singletons.TH.Util.html#isHsLetter"><span class="hs-identifier hs-var">isHsLetter</span></a></span><span> </span><span class="annot"><span class="annottext">Char
</span><a href="#local-6989586621679308415"><span class="hs-identifier hs-var">first</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;TFHelper&quot;</span></span><span>
</span><span id="line-515"></span><span>                         </span><span id="local-6989586621679308412"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679308412"><span class="hs-identifier hs-var">alpha</span></a></span></span><span>                            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679308412"><span class="hs-identifier hs-var">alpha</span></a></span><span>
</span><span id="line-516"></span><span>
</span><span id="line-517"></span><span>      </span><span class="hs-comment">-- family_args are the type variables in a promoted class's</span><span>
</span><span id="line-518"></span><span>      </span><span class="hs-comment">-- associated type family instance (or default implementation), e.g.,</span><span>
</span><span id="line-519"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-520"></span><span>      </span><span class="hs-comment">--   class C k where</span><span>
</span><span id="line-521"></span><span>      </span><span class="hs-comment">--     type T (a :: k) (b :: Bool)</span><span>
</span><span id="line-522"></span><span>      </span><span class="hs-comment">--     type T a b = THelper1 a b        -- family_args = [a, b]</span><span>
</span><span id="line-523"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-524"></span><span>      </span><span class="hs-comment">--   instance C Bool where</span><span>
</span><span id="line-525"></span><span>      </span><span class="hs-comment">--     type T a b = THelper2 a b        -- family_args = [a, b]</span><span>
</span><span id="line-526"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-527"></span><span>      </span><span class="hs-comment">-- We could annotate these variables with explicit kinds, but it's not</span><span>
</span><span id="line-528"></span><span>      </span><span class="hs-comment">-- strictly necessary, as kind inference can figure them out just as well.</span><span>
</span><span id="line-529"></span><span>      </span><span id="local-6989586621679308411"><span class="annot"><span class="annottext">family_args :: [DType]
</span><a href="#local-6989586621679308411"><span class="hs-identifier hs-var hs-var">family_args</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; DType
</span><span class="hs-identifier hs-var">DVarT</span></span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621679308420"><span class="hs-identifier hs-var">meth_arg_tvs</span></a></span><span>
</span><span id="line-530"></span><span>  </span><span id="local-6989586621679308410"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679308410"><span class="hs-identifier hs-var">helperName</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). Quasi m =&gt; String -&gt; m Name
</span><span class="hs-identifier hs-var">newUniqueName</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679308417"><span class="hs-identifier hs-var">helperNameBase</span></a></span><span>
</span><span id="line-531"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679308408"><span class="annot"><span class="annottext">helperDefunName :: Name
</span><a href="#local-6989586621679308408"><span class="hs-identifier hs-var hs-var">helperDefunName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Options -&gt; Name -&gt; Name
</span><a href="Data.Singletons.TH.Options.html#defunctionalizedName0"><span class="hs-identifier hs-var">defunctionalizedName0</span></a></span><span> </span><span class="annot"><span class="annottext">Options
</span><a href="#local-6989586621679308425"><span class="hs-identifier hs-var">opts</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679308410"><span class="hs-identifier hs-var">helperName</span></a></span><span>
</span><span id="line-532"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621679308406"><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621679308406"><span class="hs-identifier hs-var">pro_decs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679308405"><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621679308405"><span class="hs-identifier hs-var">defun_decs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679308404"><span class="annot"><span class="annottext">ALetDecRHS
</span><a href="#local-6989586621679308404"><span class="hs-identifier hs-var">ann_rhs</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-533"></span><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">LetDecRHSSort
-&gt; OMap Name DType
-&gt; OMap Name Fixity
-&gt; Maybe Uniq
-&gt; Name
-&gt; LetDecRHS Unannotated
-&gt; PrM ([DDec], [DDec], ALetDecRHS)
</span><a href="Data.Singletons.TH.Promote.html#promoteLetDecRHS"><span class="hs-identifier hs-var">promoteLetDecRHS</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[DTyVarBndrSpec] -&gt; [DType] -&gt; DType -&gt; LetDecRHSSort
</span><a href="Data.Singletons.TH.Promote.html#ClassMethodRHS"><span class="hs-identifier hs-var">ClassMethodRHS</span></a></span><span> </span><span class="annot"><span class="annottext">[DTyVarBndrSpec]
</span><a href="#local-6989586621679308424"><span class="hs-identifier hs-var">meth_tvbs</span></a></span><span> </span><span class="annot"><span class="annottext">[DType]
</span><a href="#local-6989586621679308423"><span class="hs-identifier hs-var">meth_arg_kis</span></a></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621679308422"><span class="hs-identifier hs-var">meth_res_ki</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-534"></span><span>                        </span><span class="annot"><span class="annottext">forall k v. OMap k v
</span><span class="hs-identifier hs-var">OMap.empty</span></span><span> </span><span class="annot"><span class="annottext">forall k v. OMap k v
</span><span class="hs-identifier hs-var">OMap.empty</span></span><span>
</span><span id="line-535"></span><span>                        </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679308410"><span class="hs-identifier hs-var">helperName</span></a></span><span> </span><span class="annot"><span class="annottext">LetDecRHS Unannotated
</span><a href="#local-6989586621679308426"><span class="hs-identifier hs-var">meth_rhs</span></a></span><span>
</span><span id="line-536"></span><span>  </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). MonadWriter [DDec] m =&gt; [DDec] -&gt; m ()
</span><a href="Data.Singletons.TH.Promote.Monad.html#emitDecs"><span class="hs-identifier hs-var">emitDecs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621679308406"><span class="hs-identifier hs-var">pro_decs</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621679308405"><span class="hs-identifier hs-var">defun_decs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-537"></span><span>  </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">DTySynEqn -&gt; DDec
</span><span class="hs-identifier hs-var">DTySynInstD</span></span><span>
</span><span id="line-538"></span><span>             </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe [DTyVarBndrUnit] -&gt; DType -&gt; DType -&gt; DTySynEqn
</span><span class="hs-identifier hs-var">DTySynEqn</span></span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-539"></span><span>                        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DType -&gt; [DType] -&gt; DType
</span><a href="Data.Singletons.TH.Util.html#foldType"><span class="hs-identifier hs-var">foldType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; DType
</span><span class="hs-identifier hs-var">DConT</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679308418"><span class="hs-identifier hs-var">proName</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[DType]
</span><a href="#local-6989586621679308411"><span class="hs-identifier hs-var">family_args</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-540"></span><span>                        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DType -&gt; [DType] -&gt; DType
</span><a href="Data.Singletons.TH.Names.html#foldApply"><span class="hs-identifier hs-var">foldApply</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; DType
</span><span class="hs-identifier hs-var">DConT</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679308408"><span class="hs-identifier hs-var">helperDefunName</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; DType
</span><span class="hs-identifier hs-var">DVarT</span></span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621679308420"><span class="hs-identifier hs-var">meth_arg_tvs</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-541"></span><span>         </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ALetDecRHS
</span><a href="#local-6989586621679308404"><span class="hs-identifier hs-var">ann_rhs</span></a></span><span>
</span><span id="line-542"></span><span>         </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Name -&gt; DType
</span><span class="hs-identifier hs-var">DConT</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679308408"><span class="hs-identifier hs-var">helperDefunName</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-543"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-544"></span><span>    </span><span class="hs-comment">-- Promote the type of a class method. For a default method, &quot;the type&quot; is</span><span>
</span><span id="line-545"></span><span>    </span><span class="hs-comment">-- simply the type of the original method. For an instance method,</span><span>
</span><span id="line-546"></span><span>    </span><span class="hs-comment">-- &quot;the type&quot; is like the type of the original method, but substituted for</span><span>
</span><span id="line-547"></span><span>    </span><span class="hs-comment">-- the types in the instance head. (e.g., if you have `class C a` and</span><span>
</span><span id="line-548"></span><span>    </span><span class="hs-comment">-- `instance C T`, then the substitution [a |-&gt; T] must be applied to the</span><span>
</span><span id="line-549"></span><span>    </span><span class="hs-comment">-- original method's type.)</span><span>
</span><span id="line-550"></span><span>    </span><span class="annot"><a href="#local-6989586621679308421"><span class="hs-identifier hs-type">promote_meth_ty</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Data.Singletons.TH.Promote.Monad.html#PrM"><span class="hs-identifier hs-type">PrM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">DTyVarBndrSpec</span></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">DKind</span></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DKind</span></span><span class="hs-special">)</span><span>
</span><span id="line-551"></span><span>    </span><span id="local-6989586621679308421"><span class="annot"><span class="annottext">promote_meth_ty :: PrM ([DTyVarBndrSpec], [DType], DType)
</span><a href="#local-6989586621679308421"><span class="hs-identifier hs-var hs-var">promote_meth_ty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-552"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">MethodSort
</span><a href="#local-6989586621679308429"><span class="hs-identifier hs-var">meth_sort</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-553"></span><span>        </span><span class="annot"><span class="annottext">MethodSort
</span><a href="Data.Singletons.TH.Promote.html#DefaultMethods"><span class="hs-identifier hs-var">DefaultMethods</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-554"></span><span>          </span><span class="hs-comment">-- No substitution for class variables is required for default</span><span>
</span><span id="line-555"></span><span>          </span><span class="hs-comment">-- method type signatures, as they share type variables with the</span><span>
</span><span id="line-556"></span><span>          </span><span class="hs-comment">-- class they inhabit.</span><span>
</span><span id="line-557"></span><span>          </span><span class="annot"><span class="annottext">PrM ([DTyVarBndrSpec], [DType], DType)
</span><a href="#local-6989586621679308398"><span class="hs-identifier hs-var">lookup_meth_ty</span></a></span><span>
</span><span id="line-558"></span><span>        </span><span class="annot"><a href="Data.Singletons.TH.Promote.html#InstanceMethods"><span class="hs-identifier hs-type">InstanceMethods</span></a></span><span> </span><span id="local-6989586621679308397"><span class="annot"><span class="annottext">OMap Name DType
</span><a href="#local-6989586621679308397"><span class="hs-identifier hs-var">inst_sigs_map</span></a></span></span><span> </span><span id="local-6989586621679308396"><span class="annot"><span class="annottext">Map Name DType
</span><a href="#local-6989586621679308396"><span class="hs-identifier hs-var">cls_subst</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-559"></span><span>          </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">forall k v. Ord k =&gt; k -&gt; OMap k v -&gt; Maybe v
</span><span class="hs-identifier hs-var">OMap.lookup</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679308427"><span class="hs-identifier hs-var">meth_name</span></a></span><span> </span><span class="annot"><span class="annottext">OMap Name DType
</span><a href="#local-6989586621679308397"><span class="hs-identifier hs-var">inst_sigs_map</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-560"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679308394"><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621679308394"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-561"></span><span>              </span><span class="hs-comment">-- We have an InstanceSig. These are easy: we can just use the</span><span>
</span><span id="line-562"></span><span>              </span><span class="hs-comment">-- instance signature's type directly, and no substitution for</span><span>
</span><span id="line-563"></span><span>              </span><span class="hs-comment">-- class variables is required.</span><span>
</span><span id="line-564"></span><span>              </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *).
OptionsMonad m =&gt;
DType -&gt; m ([DTyVarBndrSpec], [DType], DType)
</span><a href="Data.Singletons.TH.Promote.Type.html#promoteUnraveled"><span class="hs-identifier hs-var">promoteUnraveled</span></a></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621679308394"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-565"></span><span>            </span><span class="annot"><span class="annottext">Maybe DType
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-566"></span><span>              </span><span class="hs-comment">-- We don't have an InstanceSig, so we must compute the kind to use</span><span>
</span><span id="line-567"></span><span>              </span><span class="hs-comment">-- ourselves.</span><span>
</span><span id="line-568"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[DTyVarBndrSpec]
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679308393"><span class="annot"><span class="annottext">[DType]
</span><a href="#local-6989586621679308393"><span class="hs-identifier hs-var">arg_kis</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679308392"><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621679308392"><span class="hs-identifier hs-var">res_ki</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">PrM ([DTyVarBndrSpec], [DType], DType)
</span><a href="#local-6989586621679308398"><span class="hs-identifier hs-var">lookup_meth_ty</span></a></span><span>
</span><span id="line-569"></span><span>              </span><span class="hs-comment">-- Substitute for the class variables in the method's type.</span><span>
</span><span id="line-570"></span><span>              </span><span class="hs-comment">-- See Note [Promoted class method kinds]</span><span>
</span><span id="line-571"></span><span>              </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679308391"><span class="annot"><span class="annottext">arg_kis' :: [DType]
</span><a href="#local-6989586621679308391"><span class="hs-identifier hs-var hs-var">arg_kis'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map Name DType -&gt; DType -&gt; DType
</span><a href="Data.Singletons.TH.Util.html#substKind"><span class="hs-identifier hs-var">substKind</span></a></span><span> </span><span class="annot"><span class="annottext">Map Name DType
</span><a href="#local-6989586621679308396"><span class="hs-identifier hs-var">cls_subst</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[DType]
</span><a href="#local-6989586621679308393"><span class="hs-identifier hs-var">arg_kis</span></a></span><span>
</span><span id="line-572"></span><span>                  </span><span id="local-6989586621679308389"><span class="annot"><span class="annottext">res_ki' :: DType
</span><a href="#local-6989586621679308389"><span class="hs-identifier hs-var hs-var">res_ki'</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map Name DType -&gt; DType -&gt; DType
</span><a href="Data.Singletons.TH.Util.html#substKind"><span class="hs-identifier hs-var">substKind</span></a></span><span> </span><span class="annot"><span class="annottext">Map Name DType
</span><a href="#local-6989586621679308396"><span class="hs-identifier hs-var">cls_subst</span></a></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621679308392"><span class="hs-identifier hs-var">res_ki</span></a></span><span>
</span><span id="line-573"></span><span>                  </span><span class="hs-comment">-- Compute the type variable binders in a left-to-right</span><span>
</span><span id="line-574"></span><span>                  </span><span class="hs-comment">-- order, since that is the same order that the promoted</span><span>
</span><span id="line-575"></span><span>                  </span><span class="hs-comment">-- method's kind will use.</span><span>
</span><span id="line-576"></span><span>                  </span><span class="hs-comment">-- See Note [Promoted class methods and kind variable ordering]</span><span>
</span><span id="line-577"></span><span>                  </span><span id="local-6989586621679308388"><span class="annot"><span class="annottext">tvbs' :: [DTyVarBndrSpec]
</span><a href="#local-6989586621679308388"><span class="hs-identifier hs-var hs-var">tvbs'</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall newFlag oldFlag.
newFlag -&gt; [DTyVarBndr oldFlag] -&gt; [DTyVarBndr newFlag]
</span><span class="hs-identifier hs-var">changeDTVFlags</span></span><span> </span><span class="annot"><span class="annottext">Specificity
</span><span class="hs-identifier hs-var">SpecifiedSpec</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-578"></span><span>                             </span><span class="annot"><span class="annottext">[DType] -&gt; [DTyVarBndrUnit]
</span><span class="hs-identifier hs-var">toposortTyVarsOf</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[DType]
</span><a href="#local-6989586621679308391"><span class="hs-identifier hs-var">arg_kis'</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621679308389"><span class="hs-identifier hs-var">res_ki'</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-579"></span><span>              </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[DTyVarBndrSpec]
</span><a href="#local-6989586621679308388"><span class="hs-identifier hs-var">tvbs'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[DType]
</span><a href="#local-6989586621679308391"><span class="hs-identifier hs-var">arg_kis'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621679308389"><span class="hs-identifier hs-var">res_ki'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-580"></span><span>
</span><span id="line-581"></span><span>    </span><span class="hs-comment">-- Attempt to look up a class method's original type.</span><span>
</span><span id="line-582"></span><span>    </span><span class="annot"><a href="#local-6989586621679308398"><span class="hs-identifier hs-type">lookup_meth_ty</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Data.Singletons.TH.Promote.Monad.html#PrM"><span class="hs-identifier hs-type">PrM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">DTyVarBndrSpec</span></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">DKind</span></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DKind</span></span><span class="hs-special">)</span><span>
</span><span id="line-583"></span><span>    </span><span id="local-6989586621679308398"><span class="annot"><span class="annottext">lookup_meth_ty :: PrM ([DTyVarBndrSpec], [DType], DType)
</span><a href="#local-6989586621679308398"><span class="hs-identifier hs-var hs-var">lookup_meth_ty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-584"></span><span>      </span><span id="local-6989586621679308387"><span class="annot"><span class="annottext">Options
</span><a href="#local-6989586621679308387"><span class="hs-identifier hs-var">opts</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). OptionsMonad m =&gt; m Options
</span><a href="Data.Singletons.TH.Options.html#getOptions"><span class="hs-identifier hs-var">getOptions</span></a></span><span>
</span><span id="line-585"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679308386"><span class="annot"><span class="annottext">proName :: Name
</span><a href="#local-6989586621679308386"><span class="hs-identifier hs-var hs-var">proName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Options -&gt; Name -&gt; Name
</span><a href="Data.Singletons.TH.Options.html#promotedTopLevelValueName"><span class="hs-identifier hs-var">promotedTopLevelValueName</span></a></span><span> </span><span class="annot"><span class="annottext">Options
</span><a href="#local-6989586621679308387"><span class="hs-identifier hs-var">opts</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679308427"><span class="hs-identifier hs-var">meth_name</span></a></span><span>
</span><span id="line-586"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">forall k v. Ord k =&gt; k -&gt; OMap k v -&gt; Maybe v
</span><span class="hs-identifier hs-var">OMap.lookup</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679308427"><span class="hs-identifier hs-var">meth_name</span></a></span><span> </span><span class="annot"><span class="annottext">OMap Name DType
</span><a href="#local-6989586621679308428"><span class="hs-identifier hs-var">orig_sigs_map</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-587"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679308385"><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621679308385"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-588"></span><span>          </span><span class="hs-comment">-- The type of the method is in scope, so promote that.</span><span>
</span><span id="line-589"></span><span>          </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *).
OptionsMonad m =&gt;
DType -&gt; m ([DTyVarBndrSpec], [DType], DType)
</span><a href="Data.Singletons.TH.Promote.Type.html#promoteUnraveled"><span class="hs-identifier hs-var">promoteUnraveled</span></a></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621679308385"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-590"></span><span>        </span><span class="annot"><span class="annottext">Maybe DType
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-591"></span><span>          </span><span class="hs-comment">-- If the type of the method is not in scope, the only other option</span><span>
</span><span id="line-592"></span><span>          </span><span class="hs-comment">-- is to try reifying the promoted method name.</span><span>
</span><span id="line-593"></span><span>          </span><span id="local-6989586621679308384"><span class="annot"><span class="annottext">Maybe DInfo
</span><a href="#local-6989586621679308384"><span class="hs-identifier hs-var">mb_info</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (q :: * -&gt; *). DsMonad q =&gt; Name -&gt; q (Maybe DInfo)
</span><a href="Data.Singletons.TH.Util.html#dsReifyTypeNameInfo"><span class="hs-identifier hs-var">dsReifyTypeNameInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679308386"><span class="hs-identifier hs-var">proName</span></a></span><span>
</span><span id="line-594"></span><span>                     </span><span class="hs-comment">-- See Note [Using dsReifyTypeNameInfo when promoting instances]</span><span>
</span><span id="line-595"></span><span>          </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe DInfo
</span><a href="#local-6989586621679308384"><span class="hs-identifier hs-var">mb_info</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-596"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DTyConI</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DOpenTypeFamilyD</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DTypeFamilyHead</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679308383"><span class="annot"><span class="annottext">[DTyVarBndrUnit]
</span><a href="#local-6989586621679308383"><span class="hs-identifier hs-var">tvbs</span></a></span></span><span> </span><span id="local-6989586621679308382"><span class="annot"><span class="annottext">DFamilyResultSig
</span><a href="#local-6989586621679308382"><span class="hs-identifier hs-var">mb_res_ki</span></a></span></span><span> </span><span class="annot"><span class="annottext">Maybe InjectivityAnn
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe [DDec]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>
</span><span id="line-597"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679308381"><span class="annot"><span class="annottext">arg_kis :: [DType]
</span><a href="#local-6989586621679308381"><span class="hs-identifier hs-var hs-var">arg_kis</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe DType -&gt; DType
</span><a href="Data.Singletons.TH.Util.html#defaultMaybeToTypeKind"><span class="hs-identifier hs-var">defaultMaybeToTypeKind</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall flag. DTyVarBndr flag -&gt; Maybe DType
</span><a href="Data.Singletons.TH.Util.html#extractTvbKind"><span class="hs-identifier hs-var">extractTvbKind</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[DTyVarBndrUnit]
</span><a href="#local-6989586621679308383"><span class="hs-identifier hs-var">tvbs</span></a></span><span>
</span><span id="line-598"></span><span>                     </span><span id="local-6989586621679308379"><span class="annot"><span class="annottext">res_ki :: DType
</span><a href="#local-6989586621679308379"><span class="hs-identifier hs-var hs-var">res_ki</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe DType -&gt; DType
</span><a href="Data.Singletons.TH.Util.html#defaultMaybeToTypeKind"><span class="hs-identifier hs-var">defaultMaybeToTypeKind</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DFamilyResultSig -&gt; Maybe DType
</span><a href="Data.Singletons.TH.Util.html#resultSigToMaybeKind"><span class="hs-identifier hs-var">resultSigToMaybeKind</span></a></span><span> </span><span class="annot"><span class="annottext">DFamilyResultSig
</span><a href="#local-6989586621679308382"><span class="hs-identifier hs-var">mb_res_ki</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-599"></span><span>                     </span><span class="hs-comment">-- Compute the type variable binders in a left-to-right</span><span>
</span><span id="line-600"></span><span>                     </span><span class="hs-comment">-- order, since that is the same order that the promoted</span><span>
</span><span id="line-601"></span><span>                     </span><span class="hs-comment">-- method's kind will use.</span><span>
</span><span id="line-602"></span><span>                     </span><span class="hs-comment">-- See Note [Promoted class methods and kind variable ordering]</span><span>
</span><span id="line-603"></span><span>                     </span><span id="local-6989586621679308377"><span class="annot"><span class="annottext">tvbs' :: [DTyVarBndrSpec]
</span><a href="#local-6989586621679308377"><span class="hs-identifier hs-var hs-var">tvbs'</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall newFlag oldFlag.
newFlag -&gt; [DTyVarBndr oldFlag] -&gt; [DTyVarBndr newFlag]
</span><span class="hs-identifier hs-var">changeDTVFlags</span></span><span> </span><span class="annot"><span class="annottext">Specificity
</span><span class="hs-identifier hs-var">SpecifiedSpec</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-604"></span><span>                               </span><span class="annot"><span class="annottext">[DType] -&gt; [DTyVarBndrUnit]
</span><span class="hs-identifier hs-var">toposortTyVarsOf</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[DType]
</span><a href="#local-6989586621679308381"><span class="hs-identifier hs-var">arg_kis</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621679308379"><span class="hs-identifier hs-var">res_ki</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-605"></span><span>                  </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[DTyVarBndrSpec]
</span><a href="#local-6989586621679308377"><span class="hs-identifier hs-var">tvbs'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[DType]
</span><a href="#local-6989586621679308381"><span class="hs-identifier hs-var">arg_kis</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621679308379"><span class="hs-identifier hs-var">res_ki</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-606"></span><span>            </span><span class="annot"><span class="annottext">Maybe DInfo
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadFail m =&gt; String -&gt; m a
</span><span class="hs-identifier hs-var">fail</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Cannot find type annotation for &quot;</span></span><span> </span><span class="annot"><span class="annottext">forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679308386"><span class="hs-identifier hs-var">proName</span></a></span><span>
</span><span id="line-607"></span><span>
</span><span id="line-608"></span><span class="hs-comment">{-
Note [Promoted class method kinds]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider this example of a type class (and instance):

  class C a where
    m :: a -&gt; Bool -&gt; Bool
    m _ x = x

  instance C [a] where
    m l _ = null l

The promoted version of these declarations would be:

  class PC a where
    type M (x :: a) (y :: Bool) :: Bool
    type M x y = MHelper1 x y

  instance PC [a] where
    type M x y = MHelper2 x y

  type MHelper1 :: a -&gt; Bool -&gt; Bool
  type family MHelper1 x y where ...

  type MHelper2 :: [a] -&gt; Bool -&gt; Bool
  type family MHelper2 x y where ...

Getting the kind signature for MHelper1 (the promoted default implementation of
M) is quite simple, as it corresponds exactly to the kind of M. We might even
choose to make that the kind of MHelper2, but then it would be overly general
(and more difficult to find in -ddump-splices output). For this reason, we
substitute in the kinds of the instance itself to determine the kinds of
promoted method implementations like MHelper2.
-}</span><span>
</span><span id="line-642"></span><span>
</span><span id="line-643"></span><span class="annot"><a href="Data.Singletons.TH.Promote.html#promoteLetDecEnv"><span class="hs-identifier hs-type">promoteLetDecEnv</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Uniq</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Data.Singletons.TH.Syntax.html#ULetDecEnv"><span class="hs-identifier hs-type">ULetDecEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Data.Singletons.TH.Promote.Monad.html#PrM"><span class="hs-identifier hs-type">PrM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">DDec</span></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.Singletons.TH.Syntax.html#ALetDecEnv"><span class="hs-identifier hs-type">ALetDecEnv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-644"></span><span id="promoteLetDecEnv"><span class="annot"><span class="annottext">promoteLetDecEnv :: Maybe Uniq -&gt; ULetDecEnv -&gt; PrM ([DDec], ALetDecEnv)
</span><a href="Data.Singletons.TH.Promote.html#promoteLetDecEnv"><span class="hs-identifier hs-var hs-var">promoteLetDecEnv</span></a></span></span><span> </span><span id="local-6989586621679308376"><span class="annot"><span class="annottext">Maybe Uniq
</span><a href="#local-6989586621679308376"><span class="hs-identifier hs-var">mb_let_uniq</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Data.Singletons.TH.Syntax.html#LetDecEnv"><span class="hs-identifier hs-type">LetDecEnv</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">lde_defns :: forall (ann :: AnnotationFlag).
LetDecEnv ann -&gt; OMap Name (LetDecRHS ann)
</span><a href="Data.Singletons.TH.Syntax.html#lde_defns"><span class="hs-identifier hs-var">lde_defns</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621679308375"><span class="annot"><span class="annottext">OMap Name (LetDecRHS Unannotated)
</span><a href="#local-6989586621679308375"><span class="hs-identifier hs-var">value_env</span></a></span></span><span>
</span><span id="line-645"></span><span>                                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">lde_types :: forall (ann :: AnnotationFlag). LetDecEnv ann -&gt; OMap Name DType
</span><a href="Data.Singletons.TH.Syntax.html#lde_types"><span class="hs-identifier hs-var">lde_types</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621679308374"><span class="annot"><span class="annottext">OMap Name DType
</span><a href="#local-6989586621679308374"><span class="hs-identifier hs-var">type_env</span></a></span></span><span>
</span><span id="line-646"></span><span>                                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">lde_infix :: forall (ann :: AnnotationFlag). LetDecEnv ann -&gt; OMap Name Fixity
</span><a href="Data.Singletons.TH.Syntax.html#lde_infix"><span class="hs-identifier hs-var">lde_infix</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621679308373"><span class="annot"><span class="annottext">OMap Name Fixity
</span><a href="#local-6989586621679308373"><span class="hs-identifier hs-var">fix_env</span></a></span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-647"></span><span>  </span><span id="local-6989586621679308372"><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621679308372"><span class="hs-identifier hs-var">infix_decls</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b.
Monad m =&gt;
(a -&gt; m (Maybe b)) -&gt; [a] -&gt; m [b]
</span><a href="Data.Singletons.TH.Util.html#mapMaybeM"><span class="hs-identifier hs-var">mapMaybeM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a b c. (a -&gt; b -&gt; c) -&gt; (a, b) -&gt; c
</span><span class="hs-identifier hs-var">uncurry</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (q :: * -&gt; *).
OptionsMonad q =&gt;
Maybe Uniq -&gt; Name -&gt; Fixity -&gt; q (Maybe DDec)
</span><a href="Data.Singletons.TH.Promote.html#promoteInfixDecl"><span class="hs-identifier hs-var">promoteInfixDecl</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Uniq
</span><a href="#local-6989586621679308376"><span class="hs-identifier hs-var">mb_let_uniq</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-648"></span><span>                 </span><span class="annot"><span class="annottext">forall k v. OMap k v -&gt; [(k, v)]
</span><span class="hs-identifier hs-var">OMap.assocs</span></span><span> </span><span class="annot"><span class="annottext">OMap Name Fixity
</span><a href="#local-6989586621679308373"><span class="hs-identifier hs-var">fix_env</span></a></span><span>
</span><span id="line-649"></span><span>
</span><span id="line-650"></span><span>    </span><span class="hs-comment">-- promote all the declarations, producing annotated declarations</span><span>
</span><span id="line-651"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679308371"><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621679308371"><span class="hs-identifier hs-var">names</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679308370"><span class="annot"><span class="annottext">[LetDecRHS Unannotated]
</span><a href="#local-6989586621679308370"><span class="hs-identifier hs-var">rhss</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a b. [(a, b)] -&gt; ([a], [b])
</span><span class="hs-identifier hs-var">unzip</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall k v. OMap k v -&gt; [(k, v)]
</span><span class="hs-identifier hs-var">OMap.assocs</span></span><span> </span><span class="annot"><span class="annottext">OMap Name (LetDecRHS Unannotated)
</span><a href="#local-6989586621679308375"><span class="hs-identifier hs-var">value_env</span></a></span><span>
</span><span id="line-652"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621679308368"><span class="annot"><span class="annottext">[[DDec]]
</span><a href="#local-6989586621679308368"><span class="hs-identifier hs-var">pro_decs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679308367"><span class="annot"><span class="annottext">[[DDec]]
</span><a href="#local-6989586621679308367"><span class="hs-identifier hs-var">defun_decss</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679308366"><span class="annot"><span class="annottext">[ALetDecRHS]
</span><a href="#local-6989586621679308366"><span class="hs-identifier hs-var">ann_rhss</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-653"></span><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">forall a b c. [(a, b, c)] -&gt; ([a], [b], [c])
</span><span class="hs-identifier hs-var">unzip3</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-654"></span><span>       </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b c.
Applicative m =&gt;
(a -&gt; b -&gt; m c) -&gt; [a] -&gt; [b] -&gt; m [c]
</span><span class="hs-identifier hs-var">zipWithM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LetDecRHSSort
-&gt; OMap Name DType
-&gt; OMap Name Fixity
-&gt; Maybe Uniq
-&gt; Name
-&gt; LetDecRHS Unannotated
-&gt; PrM ([DDec], [DDec], ALetDecRHS)
</span><a href="Data.Singletons.TH.Promote.html#promoteLetDecRHS"><span class="hs-identifier hs-var">promoteLetDecRHS</span></a></span><span> </span><span class="annot"><span class="annottext">LetDecRHSSort
</span><a href="Data.Singletons.TH.Promote.html#LetBindingRHS"><span class="hs-identifier hs-var">LetBindingRHS</span></a></span><span> </span><span class="annot"><span class="annottext">OMap Name DType
</span><a href="#local-6989586621679308374"><span class="hs-identifier hs-var">type_env</span></a></span><span> </span><span class="annot"><span class="annottext">OMap Name Fixity
</span><a href="#local-6989586621679308373"><span class="hs-identifier hs-var">fix_env</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Uniq
</span><a href="#local-6989586621679308376"><span class="hs-identifier hs-var">mb_let_uniq</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-655"></span><span>                </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621679308371"><span class="hs-identifier hs-var">names</span></a></span><span> </span><span class="annot"><span class="annottext">[LetDecRHS Unannotated]
</span><a href="#local-6989586621679308370"><span class="hs-identifier hs-var">rhss</span></a></span><span>
</span><span id="line-656"></span><span>
</span><span id="line-657"></span><span>  </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). MonadWriter [DDec] m =&gt; [DDec] -&gt; m ()
</span><a href="Data.Singletons.TH.Promote.Monad.html#emitDecs"><span class="hs-identifier hs-var">emitDecs</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) a. Foldable t =&gt; t [a] -&gt; [a]
</span><span class="hs-identifier hs-var">concat</span></span><span> </span><span class="annot"><span class="annottext">[[DDec]]
</span><a href="#local-6989586621679308367"><span class="hs-identifier hs-var">defun_decss</span></a></span><span>
</span><span id="line-658"></span><span>  </span><span id="local-6989586621679308361"><span class="annot"><span class="annottext">OSet Name
</span><a href="#local-6989586621679308361"><span class="hs-identifier hs-var">bound_kvs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">PrM (OSet Name)
</span><a href="Data.Singletons.TH.Promote.Monad.html#allBoundKindVars"><span class="hs-identifier hs-var">allBoundKindVars</span></a></span><span>
</span><span id="line-659"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679308358"><span class="annot"><span class="annottext">decs :: [DDec]
</span><a href="#local-6989586621679308358"><span class="hs-identifier hs-var hs-var">decs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) a. Foldable t =&gt; t [a] -&gt; [a]
</span><span class="hs-identifier hs-var">concat</span></span><span> </span><span class="annot"><span class="annottext">[[DDec]]
</span><a href="#local-6989586621679308368"><span class="hs-identifier hs-var">pro_decs</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621679308372"><span class="hs-identifier hs-var">infix_decls</span></a></span><span>
</span><span id="line-660"></span><span>
</span><span id="line-661"></span><span>    </span><span class="hs-comment">-- build the ALetDecEnv</span><span>
</span><span id="line-662"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679308355"><span class="annot"><span class="annottext">let_dec_env' :: ALetDecEnv
</span><a href="#local-6989586621679308355"><span class="hs-identifier hs-var hs-var">let_dec_env'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Data.Singletons.TH.Syntax.html#LetDecEnv"><span class="hs-identifier hs-type">LetDecEnv</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">lde_defns :: OMap Name ALetDecRHS
</span><a href="Data.Singletons.TH.Syntax.html#lde_defns"><span class="hs-identifier hs-var">lde_defns</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall k v. Ord k =&gt; [(k, v)] -&gt; OMap k v
</span><span class="hs-identifier hs-var">OMap.fromList</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621679308371"><span class="hs-identifier hs-var">names</span></a></span><span> </span><span class="annot"><span class="annottext">[ALetDecRHS]
</span><a href="#local-6989586621679308366"><span class="hs-identifier hs-var">ann_rhss</span></a></span><span>
</span><span id="line-663"></span><span>                               </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">lde_types :: OMap Name DType
</span><a href="Data.Singletons.TH.Syntax.html#lde_types"><span class="hs-identifier hs-var">lde_types</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OMap Name DType
</span><a href="#local-6989586621679308374"><span class="hs-identifier hs-var">type_env</span></a></span><span>
</span><span id="line-664"></span><span>                               </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">lde_infix :: OMap Name Fixity
</span><a href="Data.Singletons.TH.Syntax.html#lde_infix"><span class="hs-identifier hs-var">lde_infix</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OMap Name Fixity
</span><a href="#local-6989586621679308373"><span class="hs-identifier hs-var">fix_env</span></a></span><span>
</span><span id="line-665"></span><span>                               </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">lde_proms :: IfAnn Annotated (OMap Name DType) ()
</span><a href="Data.Singletons.TH.Syntax.html#lde_proms"><span class="hs-identifier hs-var">lde_proms</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall k v. OMap k v
</span><span class="hs-identifier hs-var">OMap.empty</span></span><span>  </span><span class="hs-comment">-- filled in promoteLetDecs</span><span>
</span><span id="line-666"></span><span>                               </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">lde_bound_kvs :: IfAnn Annotated (OMap Name (OSet Name)) ()
</span><a href="Data.Singletons.TH.Syntax.html#lde_bound_kvs"><span class="hs-identifier hs-var">lde_bound_kvs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall k v. Ord k =&gt; [(k, v)] -&gt; OMap k v
</span><span class="hs-identifier hs-var">OMap.fromList</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">OSet Name
</span><a href="#local-6989586621679308361"><span class="hs-identifier hs-var">bound_kvs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621679308371"><span class="hs-identifier hs-var">names</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-667"></span><span>
</span><span id="line-668"></span><span>  </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621679308358"><span class="hs-identifier hs-var">decs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ALetDecEnv
</span><a href="#local-6989586621679308355"><span class="hs-identifier hs-var">let_dec_env'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-669"></span><span>
</span><span id="line-670"></span><span class="hs-comment">-- Promote a fixity declaration.</span><span>
</span><span id="line-671"></span><span class="annot"><a href="Data.Singletons.TH.Promote.html#promoteInfixDecl"><span class="hs-identifier hs-type">promoteInfixDecl</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679309388"><span class="annot"><a href="#local-6989586621679309388"><span class="hs-identifier hs-type">q</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="Data.Singletons.TH.Options.html#OptionsMonad"><span class="hs-identifier hs-type">OptionsMonad</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679309388"><span class="hs-identifier hs-type">q</span></a></span><span>
</span><span id="line-672"></span><span>                 </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Uniq</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Fixity</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679309388"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">DDec</span></span><span class="hs-special">)</span><span>
</span><span id="line-673"></span><span id="promoteInfixDecl"><span class="annot"><span class="annottext">promoteInfixDecl :: forall (q :: * -&gt; *).
OptionsMonad q =&gt;
Maybe Uniq -&gt; Name -&gt; Fixity -&gt; q (Maybe DDec)
</span><a href="Data.Singletons.TH.Promote.html#promoteInfixDecl"><span class="hs-identifier hs-var hs-var">promoteInfixDecl</span></a></span></span><span> </span><span id="local-6989586621679308334"><span class="annot"><span class="annottext">Maybe Uniq
</span><a href="#local-6989586621679308334"><span class="hs-identifier hs-var">mb_let_uniq</span></a></span></span><span> </span><span id="local-6989586621679308333"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679308333"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span id="local-6989586621679308332"><span class="annot"><span class="annottext">Fixity
</span><a href="#local-6989586621679308332"><span class="hs-identifier hs-var">fixity</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-674"></span><span>  </span><span id="local-6989586621679308331"><span class="annot"><span class="annottext">Options
</span><a href="#local-6989586621679308331"><span class="hs-identifier hs-var">opts</span></a></span></span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). OptionsMonad m =&gt; m Options
</span><a href="Data.Singletons.TH.Options.html#getOptions"><span class="hs-identifier hs-var">getOptions</span></a></span><span>
</span><span id="line-675"></span><span>  </span><span id="local-6989586621679308330"><span class="annot"><span class="annottext">Maybe NameSpace
</span><a href="#local-6989586621679308330"><span class="hs-identifier hs-var">mb_ns</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (q :: * -&gt; *). DsMonad q =&gt; Name -&gt; q (Maybe NameSpace)
</span><span class="hs-identifier hs-var">reifyNameSpace</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679308333"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-676"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe NameSpace
</span><a href="#local-6989586621679308330"><span class="hs-identifier hs-var">mb_ns</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-677"></span><span>    </span><span class="hs-comment">-- If we can't find the Name for some odd reason, fall back to promote_val</span><span>
</span><span id="line-678"></span><span>    </span><span class="annot"><span class="annottext">Maybe NameSpace
</span><span class="hs-identifier hs-var">Nothing</span></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">q (Maybe DDec)
</span><a href="#local-6989586621679308328"><span class="hs-identifier hs-var">promote_val</span></a></span><span>
</span><span id="line-679"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">NameSpace
</span><span class="hs-identifier hs-var">VarName</span></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">q (Maybe DDec)
</span><a href="#local-6989586621679308328"><span class="hs-identifier hs-var">promote_val</span></a></span><span>
</span><span id="line-680"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">NameSpace
</span><span class="hs-identifier hs-var">DataName</span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">q (Maybe DDec)
</span><a href="#local-6989586621679308325"><span class="hs-identifier hs-var">never_mind</span></a></span><span>
</span><span id="line-681"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">NameSpace
</span><span class="hs-identifier hs-var">TcClsName</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-682"></span><span>      </span><span id="local-6989586621679308323"><span class="annot"><span class="annottext">Maybe DInfo
</span><a href="#local-6989586621679308323"><span class="hs-identifier hs-var">mb_info</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (q :: * -&gt; *). DsMonad q =&gt; Name -&gt; q (Maybe DInfo)
</span><span class="hs-identifier hs-var">dsReify</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679308333"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-683"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe DInfo
</span><a href="#local-6989586621679308323"><span class="hs-identifier hs-var">mb_info</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-684"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DTyConI</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">DClassD</span></span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="annot"><span class="annottext">Maybe [DDec]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>
</span><span id="line-685"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Name -&gt; q (Maybe DDec)
</span><a href="#local-6989586621679308321"><span class="hs-identifier hs-var">finish</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Options -&gt; Name -&gt; Name
</span><a href="Data.Singletons.TH.Options.html#promotedClassName"><span class="hs-identifier hs-var">promotedClassName</span></a></span><span> </span><span class="annot"><span class="annottext">Options
</span><a href="#local-6989586621679308331"><span class="hs-identifier hs-var">opts</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679308333"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-686"></span><span>        </span><span class="annot"><span class="annottext">Maybe DInfo
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">q (Maybe DDec)
</span><a href="#local-6989586621679308325"><span class="hs-identifier hs-var">never_mind</span></a></span><span>
</span><span id="line-687"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-688"></span><span>    </span><span class="hs-comment">-- Produce the fixity declaration.</span><span>
</span><span id="line-689"></span><span>    </span><span class="annot"><a href="#local-6989586621679308321"><span class="hs-identifier hs-type">finish</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679309388"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">DDec</span></span><span class="hs-special">)</span><span>
</span><span id="line-690"></span><span>    </span><span id="local-6989586621679308321"><span class="annot"><span class="annottext">finish :: Name -&gt; q (Maybe DDec)
</span><a href="#local-6989586621679308321"><span class="hs-identifier hs-var hs-var">finish</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">DLetDec -&gt; DDec
</span><span class="hs-identifier hs-var">DLetDec</span></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Fixity -&gt; Name -&gt; DLetDec
</span><span class="hs-identifier hs-var">DInfixD</span></span><span> </span><span class="annot"><span class="annottext">Fixity
</span><a href="#local-6989586621679308332"><span class="hs-identifier hs-var">fixity</span></a></span><span>
</span><span id="line-691"></span><span>
</span><span id="line-692"></span><span>    </span><span class="hs-comment">-- Don't produce a fixity declaration at all. This happens when promoting a</span><span>
</span><span id="line-693"></span><span>    </span><span class="hs-comment">-- fixity declaration for a name whose promoted counterpart is the same as</span><span>
</span><span id="line-694"></span><span>    </span><span class="hs-comment">-- the original name.</span><span>
</span><span id="line-695"></span><span>    </span><span class="hs-comment">-- See Note [singletons-th and fixity declarations] in D.S.TH.Single.Fixity, wrinkle 1.</span><span>
</span><span id="line-696"></span><span>    </span><span class="annot"><a href="#local-6989586621679308325"><span class="hs-identifier hs-type">never_mind</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679309388"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">DDec</span></span><span class="hs-special">)</span><span>
</span><span id="line-697"></span><span>    </span><span id="local-6989586621679308325"><span class="annot"><span class="annottext">never_mind :: q (Maybe DDec)
</span><a href="#local-6989586621679308325"><span class="hs-identifier hs-var hs-var">never_mind</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-698"></span><span>
</span><span id="line-699"></span><span>    </span><span class="hs-comment">-- Certain value names do not change when promoted (e.g., infix names).</span><span>
</span><span id="line-700"></span><span>    </span><span class="hs-comment">-- Therefore, don't bother promoting their fixity declarations if</span><span>
</span><span id="line-701"></span><span>    </span><span class="hs-comment">-- 'genQuotedDecs' is set to 'True', since that will run the risk of</span><span>
</span><span id="line-702"></span><span>    </span><span class="hs-comment">-- generating duplicate fixity declarations.</span><span>
</span><span id="line-703"></span><span>    </span><span class="hs-comment">-- See Note [singletons-th and fixity declarations] in D.S.TH.Single.Fixity, wrinkle 1.</span><span>
</span><span id="line-704"></span><span>    </span><span class="annot"><a href="#local-6989586621679308328"><span class="hs-identifier hs-type">promote_val</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679309388"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">DDec</span></span><span class="hs-special">)</span><span>
</span><span id="line-705"></span><span>    </span><span id="local-6989586621679308328"><span class="annot"><span class="annottext">promote_val :: q (Maybe DDec)
</span><a href="#local-6989586621679308328"><span class="hs-identifier hs-var hs-var">promote_val</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-706"></span><span>      </span><span id="local-6989586621679308318"><span class="annot"><span class="annottext">Options
</span><a href="#local-6989586621679308318"><span class="hs-identifier hs-var">opts</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). OptionsMonad m =&gt; m Options
</span><a href="Data.Singletons.TH.Options.html#getOptions"><span class="hs-identifier hs-var">getOptions</span></a></span><span>
</span><span id="line-707"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="#local-6989586621679308317"><span class="hs-identifier hs-type">promoted_name</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span>
</span><span id="line-708"></span><span>          </span><span id="local-6989586621679308317"><span class="annot"><span class="annottext">promoted_name :: Name
</span><a href="#local-6989586621679308317"><span class="hs-identifier hs-var hs-var">promoted_name</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Options -&gt; Name -&gt; Maybe Uniq -&gt; Name
</span><a href="Data.Singletons.TH.Options.html#promotedValueName"><span class="hs-identifier hs-var">promotedValueName</span></a></span><span> </span><span class="annot"><span class="annottext">Options
</span><a href="#local-6989586621679308318"><span class="hs-identifier hs-var">opts</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679308333"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Uniq
</span><a href="#local-6989586621679308334"><span class="hs-identifier hs-var">mb_let_uniq</span></a></span><span>
</span><span id="line-709"></span><span>      </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Name -&gt; String
</span><span class="hs-identifier hs-var">nameBase</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679308333"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; String
</span><span class="hs-identifier hs-var">nameBase</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679308317"><span class="hs-identifier hs-var">promoted_name</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Options -&gt; Bool
</span><a href="Data.Singletons.TH.Options.html#genQuotedDecs"><span class="hs-identifier hs-var">genQuotedDecs</span></a></span><span> </span><span class="annot"><span class="annottext">Options
</span><a href="#local-6989586621679308318"><span class="hs-identifier hs-var">opts</span></a></span><span>
</span><span id="line-710"></span><span>         </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">q (Maybe DDec)
</span><a href="#local-6989586621679308325"><span class="hs-identifier hs-var">never_mind</span></a></span><span>
</span><span id="line-711"></span><span>         </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Name -&gt; q (Maybe DDec)
</span><a href="#local-6989586621679308321"><span class="hs-identifier hs-var">finish</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679308317"><span class="hs-identifier hs-var">promoted_name</span></a></span><span>
</span><span id="line-712"></span><span>
</span><span id="line-713"></span><span class="hs-comment">-- Try producing promoted fixity declarations for Names by reifying them</span><span>
</span><span id="line-714"></span><span class="hs-comment">-- /without/ consulting quoted declarations. If reification fails, recover and</span><span>
</span><span id="line-715"></span><span class="hs-comment">-- return the empty list.</span><span>
</span><span id="line-716"></span><span class="hs-comment">-- See [singletons-th and fixity declarations] in D.S.TH.Single.Fixity, wrinkle 2.</span><span>
</span><span id="line-717"></span><span class="annot"><a href="Data.Singletons.TH.Promote.html#promoteReifiedInfixDecls"><span class="hs-identifier hs-type">promoteReifiedInfixDecls</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679309411"><span class="annot"><a href="#local-6989586621679309411"><span class="hs-identifier hs-type">q</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="Data.Singletons.TH.Options.html#OptionsMonad"><span class="hs-identifier hs-type">OptionsMonad</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679309411"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679309411"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">DDec</span></span><span class="hs-special">]</span><span>
</span><span id="line-718"></span><span id="promoteReifiedInfixDecls"><span class="annot"><span class="annottext">promoteReifiedInfixDecls :: forall (q :: * -&gt; *). OptionsMonad q =&gt; [Name] -&gt; q [DDec]
</span><a href="Data.Singletons.TH.Promote.html#promoteReifiedInfixDecls"><span class="hs-identifier hs-var hs-var">promoteReifiedInfixDecls</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b.
Monad m =&gt;
(a -&gt; m (Maybe b)) -&gt; [a] -&gt; m [b]
</span><a href="Data.Singletons.TH.Util.html#mapMaybeM"><span class="hs-identifier hs-var">mapMaybeM</span></a></span><span> </span><span class="annot"><span class="annottext">Name -&gt; q (Maybe DDec)
</span><a href="#local-6989586621679308302"><span class="hs-identifier hs-var">tryPromoteFixityDeclaration</span></a></span><span>
</span><span id="line-719"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-720"></span><span>    </span><span class="annot"><a href="#local-6989586621679308302"><span class="hs-identifier hs-type">tryPromoteFixityDeclaration</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679309411"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">DDec</span></span><span class="hs-special">)</span><span>
</span><span id="line-721"></span><span>    </span><span id="local-6989586621679308302"><span class="annot"><span class="annottext">tryPromoteFixityDeclaration :: Name -&gt; q (Maybe DDec)
</span><a href="#local-6989586621679308302"><span class="hs-identifier hs-var hs-var">tryPromoteFixityDeclaration</span></a></span></span><span> </span><span id="local-6989586621679308301"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679308301"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-722"></span><span>      </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Quasi m =&gt; m a -&gt; m a -&gt; m a
</span><span class="hs-identifier hs-var">qRecover</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-723"></span><span>        </span><span id="local-6989586621679308299"><span class="annot"><span class="annottext">Maybe Fixity
</span><a href="#local-6989586621679308299"><span class="hs-identifier hs-var">mFixity</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). Quasi m =&gt; Name -&gt; m (Maybe Fixity)
</span><span class="hs-identifier hs-var">qReifyFixity</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679308301"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-724"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe Fixity
</span><a href="#local-6989586621679308299"><span class="hs-identifier hs-var">mFixity</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-725"></span><span>          </span><span class="annot"><span class="annottext">Maybe Fixity
</span><span class="hs-identifier hs-var">Nothing</span></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-726"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679308297"><span class="annot"><span class="annottext">Fixity
</span><a href="#local-6989586621679308297"><span class="hs-identifier hs-var">fixity</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (q :: * -&gt; *).
OptionsMonad q =&gt;
Maybe Uniq -&gt; Name -&gt; Fixity -&gt; q (Maybe DDec)
</span><a href="Data.Singletons.TH.Promote.html#promoteInfixDecl"><span class="hs-identifier hs-var">promoteInfixDecl</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679308301"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">Fixity
</span><a href="#local-6989586621679308297"><span class="hs-identifier hs-var">fixity</span></a></span><span>
</span><span id="line-727"></span><span>
</span><span id="line-728"></span><span class="hs-comment">-- Which sort of let-bound declaration's right-hand side is being promoted?</span><span>
</span><span id="line-729"></span><span class="hs-keyword">data</span><span> </span><span id="LetDecRHSSort"><span class="annot"><a href="Data.Singletons.TH.Promote.html#LetDecRHSSort"><span class="hs-identifier hs-var">LetDecRHSSort</span></a></span></span><span>
</span><span id="line-730"></span><span>    </span><span class="hs-comment">-- An ordinary (i.e., non-class-related) let-bound declaration.</span><span>
</span><span id="line-731"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="LetBindingRHS"><span class="annot"><a href="Data.Singletons.TH.Promote.html#LetBindingRHS"><span class="hs-identifier hs-var">LetBindingRHS</span></a></span></span><span>
</span><span id="line-732"></span><span>    </span><span class="hs-comment">-- The right-hand side of a class method (either a default method or a</span><span>
</span><span id="line-733"></span><span>    </span><span class="hs-comment">-- method in an instance declaration).</span><span>
</span><span id="line-734"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="ClassMethodRHS"><span class="annot"><a href="Data.Singletons.TH.Promote.html#ClassMethodRHS"><span class="hs-identifier hs-var">ClassMethodRHS</span></a></span></span><span>
</span><span id="line-735"></span><span>      </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">DTyVarBndrSpec</span></span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">DKind</span></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DKind</span></span><span>
</span><span id="line-736"></span><span>      </span><span class="hs-comment">-- The RHS's promoted type variable binders, argument types, and</span><span>
</span><span id="line-737"></span><span>      </span><span class="hs-comment">-- result type. Needed to fix #136.</span><span>
</span><span id="line-738"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span id="local-6989586621679308284"><span id="local-6989586621679308286"><span id="local-6989586621679308295"><span class="annot"><span class="annottext">Int -&gt; LetDecRHSSort -&gt; ShowS
[LetDecRHSSort] -&gt; ShowS
LetDecRHSSort -&gt; String
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [LetDecRHSSort] -&gt; ShowS
$cshowList :: [LetDecRHSSort] -&gt; ShowS
show :: LetDecRHSSort -&gt; String
$cshow :: LetDecRHSSort -&gt; String
showsPrec :: Int -&gt; LetDecRHSSort -&gt; ShowS
$cshowsPrec :: Int -&gt; LetDecRHSSort -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span>
</span><span id="line-739"></span><span>
</span><span id="line-740"></span><span class="hs-comment">-- This function is used both to promote class method defaults and normal</span><span>
</span><span id="line-741"></span><span class="hs-comment">-- let bindings. Thus, it can't quite do all the work locally and returns</span><span>
</span><span id="line-742"></span><span class="hs-comment">-- an intermediate structure. Perhaps a better design is available.</span><span>
</span><span id="line-743"></span><span class="annot"><a href="Data.Singletons.TH.Promote.html#promoteLetDecRHS"><span class="hs-identifier hs-type">promoteLetDecRHS</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Data.Singletons.TH.Promote.html#LetDecRHSSort"><span class="hs-identifier hs-type">LetDecRHSSort</span></a></span><span>
</span><span id="line-744"></span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">OMap</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">DType</span></span><span>      </span><span class="hs-comment">-- local type env't</span><span>
</span><span id="line-745"></span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">OMap</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Fixity</span></span><span>     </span><span class="hs-comment">-- local fixity env't</span><span>
</span><span id="line-746"></span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Uniq</span></span><span>           </span><span class="hs-comment">-- let-binding unique (if locally bound)</span><span>
</span><span id="line-747"></span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span>                 </span><span class="hs-comment">-- name of the thing being promoted</span><span>
</span><span id="line-748"></span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Data.Singletons.TH.Syntax.html#ULetDecRHS"><span class="hs-identifier hs-type">ULetDecRHS</span></a></span><span>           </span><span class="hs-comment">-- body of the thing</span><span>
</span><span id="line-749"></span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Data.Singletons.TH.Promote.Monad.html#PrM"><span class="hs-identifier hs-type">PrM</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">DDec</span></span><span class="hs-special">]</span><span>        </span><span class="hs-comment">-- promoted type family dec, plus the</span><span>
</span><span id="line-750"></span><span>                                        </span><span class="hs-comment">-- SAK dec (if one exists)</span><span>
</span><span id="line-751"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">DDec</span></span><span class="hs-special">]</span><span>        </span><span class="hs-comment">-- defunctionalization</span><span>
</span><span id="line-752"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.Singletons.TH.Syntax.html#ALetDecRHS"><span class="hs-identifier hs-type">ALetDecRHS</span></a></span><span> </span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- annotated RHS</span><span>
</span><span id="line-753"></span><span id="promoteLetDecRHS"><span class="annot"><span class="annottext">promoteLetDecRHS :: LetDecRHSSort
-&gt; OMap Name DType
-&gt; OMap Name Fixity
-&gt; Maybe Uniq
-&gt; Name
-&gt; LetDecRHS Unannotated
-&gt; PrM ([DDec], [DDec], ALetDecRHS)
</span><a href="Data.Singletons.TH.Promote.html#promoteLetDecRHS"><span class="hs-identifier hs-var hs-var">promoteLetDecRHS</span></a></span></span><span> </span><span id="local-6989586621679308280"><span class="annot"><span class="annottext">LetDecRHSSort
</span><a href="#local-6989586621679308280"><span class="hs-identifier hs-var">rhs_sort</span></a></span></span><span> </span><span id="local-6989586621679308279"><span class="annot"><span class="annottext">OMap Name DType
</span><a href="#local-6989586621679308279"><span class="hs-identifier hs-var">type_env</span></a></span></span><span> </span><span id="local-6989586621679308278"><span class="annot"><span class="annottext">OMap Name Fixity
</span><a href="#local-6989586621679308278"><span class="hs-identifier hs-var">fix_env</span></a></span></span><span> </span><span id="local-6989586621679308277"><span class="annot"><span class="annottext">Maybe Uniq
</span><a href="#local-6989586621679308277"><span class="hs-identifier hs-var">mb_let_uniq</span></a></span></span><span> </span><span id="local-6989586621679308276"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679308276"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span id="local-6989586621679308275"><span class="annot"><span class="annottext">LetDecRHS Unannotated
</span><a href="#local-6989586621679308275"><span class="hs-identifier hs-var">let_dec_rhs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-754"></span><span>  </span><span id="local-6989586621679308274"><span class="annot"><span class="annottext">Options
</span><a href="#local-6989586621679308274"><span class="hs-identifier hs-var">opts</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). OptionsMonad m =&gt; m Options
</span><a href="Data.Singletons.TH.Options.html#getOptions"><span class="hs-identifier hs-var">getOptions</span></a></span><span>
</span><span id="line-755"></span><span>  </span><span id="local-6989586621679308273"><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621679308273"><span class="hs-identifier hs-var">all_locals</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). MonadReader PrEnv m =&gt; m [Name]
</span><a href="Data.Singletons.TH.Promote.Monad.html#allLocals"><span class="hs-identifier hs-var">allLocals</span></a></span><span>
</span><span id="line-756"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">LetDecRHS Unannotated
</span><a href="#local-6989586621679308275"><span class="hs-identifier hs-var">let_dec_rhs</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-757"></span><span>    </span><span class="annot"><a href="Data.Singletons.TH.Syntax.html#UValue"><span class="hs-identifier hs-type">UValue</span></a></span><span> </span><span id="local-6989586621679308271"><span class="annot"><span class="annottext">DExp
</span><a href="#local-6989586621679308271"><span class="hs-identifier hs-var">exp</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-758"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621679308270"><span class="annot"><span class="annottext">Maybe LetDecRHSKindInfo
</span><a href="#local-6989586621679308270"><span class="hs-identifier hs-var">m_ldrki</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679308269"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679308269"><span class="hs-identifier hs-var">ty_num_args</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Name] -&gt; Int -&gt; PrM (Maybe LetDecRHSKindInfo, Int)
</span><a href="#local-6989586621679308268"><span class="hs-identifier hs-var">promote_let_dec_ty</span></a></span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621679308273"><span class="hs-identifier hs-var">all_locals</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-759"></span><span>      </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679308269"><span class="hs-identifier hs-var">ty_num_args</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-760"></span><span>      </span><span class="hs-keyword">then</span><span>
</span><span id="line-761"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679308267"><span class="annot"><span class="annottext">proName :: Name
</span><a href="#local-6989586621679308267"><span class="hs-identifier hs-var hs-var">proName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Options -&gt; Name -&gt; Maybe Uniq -&gt; Name
</span><a href="Data.Singletons.TH.Options.html#promotedValueName"><span class="hs-identifier hs-var">promotedValueName</span></a></span><span> </span><span class="annot"><span class="annottext">Options
</span><a href="#local-6989586621679308274"><span class="hs-identifier hs-var">opts</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679308276"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Uniq
</span><a href="#local-6989586621679308277"><span class="hs-identifier hs-var">mb_let_uniq</span></a></span><span>
</span><span id="line-762"></span><span>            </span><span id="local-6989586621679308266"><span class="annot"><span class="annottext">prom_fun_lhs :: DType
</span><a href="#local-6989586621679308266"><span class="hs-identifier hs-var hs-var">prom_fun_lhs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DType -&gt; [DType] -&gt; DType
</span><a href="Data.Singletons.TH.Util.html#foldType"><span class="hs-identifier hs-var">foldType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; DType
</span><span class="hs-identifier hs-var">DConT</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679308267"><span class="hs-identifier hs-var">proName</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; DType
</span><span class="hs-identifier hs-var">DVarT</span></span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621679308273"><span class="hs-identifier hs-var">all_locals</span></a></span><span> </span><span class="hs-keyword">in</span><span>
</span><span id="line-763"></span><span>        </span><span class="annot"><span class="annottext">forall prom_a a.
[Name]
-&gt; Maybe LetDecRHSKindInfo
-&gt; Int
-&gt; PrM (prom_a, a)
-&gt; (prom_a -&gt; [DTySynEqn])
-&gt; (DType -&gt; Int -&gt; a -&gt; ALetDecRHS)
-&gt; PrM ([DDec], [DDec], ALetDecRHS)
</span><a href="#local-6989586621679308265"><span class="hs-identifier hs-var">promote_let_dec_rhs</span></a></span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621679308273"><span class="hs-identifier hs-var">all_locals</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe LetDecRHSKindInfo
</span><a href="#local-6989586621679308270"><span class="hs-identifier hs-var">m_ldrki</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DExp -&gt; PrM (DType, ADExp)
</span><a href="Data.Singletons.TH.Promote.html#promoteExp"><span class="hs-identifier hs-var">promoteExp</span></a></span><span> </span><span class="annot"><span class="annottext">DExp
</span><a href="#local-6989586621679308271"><span class="hs-identifier hs-var">exp</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-764"></span><span>                            </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679308263"><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621679308263"><span class="hs-identifier hs-var">exp'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Maybe [DTyVarBndrUnit] -&gt; DType -&gt; DType -&gt; DTySynEqn
</span><span class="hs-identifier hs-var">DTySynEqn</span></span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621679308266"><span class="hs-identifier hs-var">prom_fun_lhs</span></a></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621679308263"><span class="hs-identifier hs-var">exp'</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-765"></span><span>                            </span><span class="annot"><span class="annottext">DType -&gt; Int -&gt; ADExp -&gt; ALetDecRHS
</span><a href="Data.Singletons.TH.Syntax.html#AValue"><span class="hs-identifier hs-var">AValue</span></a></span><span>
</span><span id="line-766"></span><span>      </span><span class="hs-keyword">else</span><span>
</span><span id="line-767"></span><span>        </span><span class="hs-comment">-- If we have a UValue with a function type, process it as though it</span><span>
</span><span id="line-768"></span><span>        </span><span class="hs-comment">-- were a UFunction. promote_function_rhs will take care of</span><span>
</span><span id="line-769"></span><span>        </span><span class="hs-comment">-- eta-expanding arguments as necessary.</span><span>
</span><span id="line-770"></span><span>        </span><span class="annot"><span class="annottext">[Name] -&gt; [DClause] -&gt; PrM ([DDec], [DDec], ALetDecRHS)
</span><a href="#local-6989586621679308261"><span class="hs-identifier hs-var">promote_function_rhs</span></a></span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621679308273"><span class="hs-identifier hs-var">all_locals</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">[DPat] -&gt; DExp -&gt; DClause
</span><span class="hs-identifier hs-var">DClause</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">DExp
</span><a href="#local-6989586621679308271"><span class="hs-identifier hs-var">exp</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-771"></span><span>    </span><span class="annot"><a href="Data.Singletons.TH.Syntax.html#UFunction"><span class="hs-identifier hs-type">UFunction</span></a></span><span> </span><span id="local-6989586621679308258"><span class="annot"><span class="annottext">[DClause]
</span><a href="#local-6989586621679308258"><span class="hs-identifier hs-var">clauses</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[Name] -&gt; [DClause] -&gt; PrM ([DDec], [DDec], ALetDecRHS)
</span><a href="#local-6989586621679308261"><span class="hs-identifier hs-var">promote_function_rhs</span></a></span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621679308273"><span class="hs-identifier hs-var">all_locals</span></a></span><span> </span><span class="annot"><span class="annottext">[DClause]
</span><a href="#local-6989586621679308258"><span class="hs-identifier hs-var">clauses</span></a></span><span>
</span><span id="line-772"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-773"></span><span>    </span><span class="hs-comment">-- Promote the RHS of a UFunction (or a UValue with a function type).</span><span>
</span><span id="line-774"></span><span>    </span><span class="annot"><a href="#local-6989586621679308261"><span class="hs-identifier hs-type">promote_function_rhs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span class="hs-special">]</span><span>
</span><span id="line-775"></span><span>                         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">DClause</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Data.Singletons.TH.Promote.Monad.html#PrM"><span class="hs-identifier hs-type">PrM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">DDec</span></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">DDec</span></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.Singletons.TH.Syntax.html#ALetDecRHS"><span class="hs-identifier hs-type">ALetDecRHS</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-776"></span><span>    </span><span id="local-6989586621679308261"><span class="annot"><span class="annottext">promote_function_rhs :: [Name] -&gt; [DClause] -&gt; PrM ([DDec], [DDec], ALetDecRHS)
</span><a href="#local-6989586621679308261"><span class="hs-identifier hs-var hs-var">promote_function_rhs</span></a></span></span><span> </span><span id="local-6989586621679308257"><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621679308257"><span class="hs-identifier hs-var">all_locals</span></a></span></span><span> </span><span id="local-6989586621679308256"><span class="annot"><span class="annottext">[DClause]
</span><a href="#local-6989586621679308256"><span class="hs-identifier hs-var">clauses</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-777"></span><span>      </span><span id="local-6989586621679308255"><span class="annot"><span class="annottext">Options
</span><a href="#local-6989586621679308255"><span class="hs-identifier hs-var">opts</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). OptionsMonad m =&gt; m Options
</span><a href="Data.Singletons.TH.Options.html#getOptions"><span class="hs-identifier hs-var">getOptions</span></a></span><span>
</span><span id="line-778"></span><span>      </span><span id="local-6989586621679308254"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679308254"><span class="hs-identifier hs-var">numArgs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[DClause] -&gt; PrM Int
</span><a href="#local-6989586621679308253"><span class="hs-identifier hs-var">count_args</span></a></span><span> </span><span class="annot"><span class="annottext">[DClause]
</span><a href="#local-6989586621679308256"><span class="hs-identifier hs-var">clauses</span></a></span><span>
</span><span id="line-779"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679308252"><span class="annot"><span class="annottext">proName :: Name
</span><a href="#local-6989586621679308252"><span class="hs-identifier hs-var hs-var">proName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Options -&gt; Name -&gt; Maybe Uniq -&gt; Name
</span><a href="Data.Singletons.TH.Options.html#promotedValueName"><span class="hs-identifier hs-var">promotedValueName</span></a></span><span> </span><span class="annot"><span class="annottext">Options
</span><a href="#local-6989586621679308255"><span class="hs-identifier hs-var">opts</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679308276"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Uniq
</span><a href="#local-6989586621679308277"><span class="hs-identifier hs-var">mb_let_uniq</span></a></span><span>
</span><span id="line-780"></span><span>          </span><span id="local-6989586621679308251"><span class="annot"><span class="annottext">prom_fun_lhs :: DType
</span><a href="#local-6989586621679308251"><span class="hs-identifier hs-var hs-var">prom_fun_lhs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DType -&gt; [DType] -&gt; DType
</span><a href="Data.Singletons.TH.Util.html#foldType"><span class="hs-identifier hs-var">foldType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; DType
</span><span class="hs-identifier hs-var">DConT</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679308252"><span class="hs-identifier hs-var">proName</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; DType
</span><span class="hs-identifier hs-var">DVarT</span></span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621679308257"><span class="hs-identifier hs-var">all_locals</span></a></span><span>
</span><span id="line-781"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621679308250"><span class="annot"><span class="annottext">Maybe LetDecRHSKindInfo
</span><a href="#local-6989586621679308250"><span class="hs-identifier hs-var">m_ldrki</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679308249"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679308249"><span class="hs-identifier hs-var">ty_num_args</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Name] -&gt; Int -&gt; PrM (Maybe LetDecRHSKindInfo, Int)
</span><a href="#local-6989586621679308268"><span class="hs-identifier hs-var">promote_let_dec_ty</span></a></span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621679308257"><span class="hs-identifier hs-var">all_locals</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679308254"><span class="hs-identifier hs-var">numArgs</span></a></span><span>
</span><span id="line-782"></span><span>      </span><span id="local-6989586621679308248"><span class="annot"><span class="annottext">[DClause]
</span><a href="#local-6989586621679308248"><span class="hs-identifier hs-var">expClauses</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; DClause -&gt; PrM DClause
</span><a href="#local-6989586621679308247"><span class="hs-identifier hs-var">etaContractOrExpand</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679308249"><span class="hs-identifier hs-var">ty_num_args</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679308254"><span class="hs-identifier hs-var">numArgs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[DClause]
</span><a href="#local-6989586621679308256"><span class="hs-identifier hs-var">clauses</span></a></span><span>
</span><span id="line-783"></span><span>      </span><span class="annot"><span class="annottext">forall prom_a a.
[Name]
-&gt; Maybe LetDecRHSKindInfo
-&gt; Int
-&gt; PrM (prom_a, a)
-&gt; (prom_a -&gt; [DTySynEqn])
-&gt; (DType -&gt; Int -&gt; a -&gt; ALetDecRHS)
-&gt; PrM ([DDec], [DDec], ALetDecRHS)
</span><a href="#local-6989586621679308265"><span class="hs-identifier hs-var">promote_let_dec_rhs</span></a></span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621679308257"><span class="hs-identifier hs-var">all_locals</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe LetDecRHSKindInfo
</span><a href="#local-6989586621679308250"><span class="hs-identifier hs-var">m_ldrki</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679308249"><span class="hs-identifier hs-var">ty_num_args</span></a></span><span>
</span><span id="line-784"></span><span>                          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b c.
Applicative m =&gt;
(a -&gt; m (b, c)) -&gt; [a] -&gt; m ([b], [c])
</span><span class="hs-identifier hs-var">mapAndUnzipM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DType -&gt; DClause -&gt; PrM (DTySynEqn, ADClause)
</span><a href="Data.Singletons.TH.Promote.html#promoteClause"><span class="hs-identifier hs-var">promoteClause</span></a></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621679308251"><span class="hs-identifier hs-var">prom_fun_lhs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[DClause]
</span><a href="#local-6989586621679308248"><span class="hs-identifier hs-var">expClauses</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-785"></span><span>                          </span><span class="annot"><span class="annottext">forall a. a -&gt; a
</span><span class="hs-identifier hs-var">id</span></span><span> </span><span class="annot"><span class="annottext">DType -&gt; Int -&gt; [ADClause] -&gt; ALetDecRHS
</span><a href="Data.Singletons.TH.Syntax.html#AFunction"><span class="hs-identifier hs-var">AFunction</span></a></span><span>
</span><span id="line-786"></span><span>
</span><span id="line-787"></span><span>    </span><span class="hs-comment">-- Promote a UValue or a UFunction.</span><span>
</span><span id="line-788"></span><span>    </span><span class="hs-comment">-- Notes about type variables:</span><span>
</span><span id="line-789"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-790"></span><span>    </span><span class="hs-comment">-- * For UValues, `prom_a` is DType and `a` is Exp.</span><span>
</span><span id="line-791"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-792"></span><span>    </span><span class="hs-comment">-- * For UFunctions, `prom_a` is [DTySynEqn] and `a` is [DClause].</span><span>
</span><span id="line-793"></span><span>    </span><span id="local-6989586621679309309"><span id="local-6989586621679309310"><span class="annot"><a href="#local-6989586621679308265"><span class="hs-identifier hs-type">promote_let_dec_rhs</span></a></span><span>
</span><span id="line-794"></span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span class="hs-special">]</span><span>                            </span><span class="hs-comment">-- Local variables bound in this scope</span><span>
</span><span id="line-795"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Data.Singletons.TH.Promote.html#LetDecRHSKindInfo"><span class="hs-identifier hs-type">LetDecRHSKindInfo</span></a></span><span>           </span><span class="hs-comment">-- Information about the promoted kind (if present)</span><span>
</span><span id="line-796"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>                               </span><span class="hs-comment">-- The number of promoted function arguments</span><span>
</span><span id="line-797"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Data.Singletons.TH.Promote.Monad.html#PrM"><span class="hs-identifier hs-type">PrM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679309310"><span class="hs-identifier hs-type">prom_a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679309309"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>                   </span><span class="hs-comment">-- Promote the RHS</span><span>
</span><span id="line-798"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679309310"><span class="hs-identifier hs-type">prom_a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">DTySynEqn</span></span><span class="hs-special">]</span><span class="hs-special">)</span><span>           </span><span class="hs-comment">-- Turn the promoted RHS into type family equations</span><span>
</span><span id="line-799"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DType</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679309309"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Data.Singletons.TH.Syntax.html#ALetDecRHS"><span class="hs-identifier hs-type">ALetDecRHS</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- Build an ALetDecRHS</span><span>
</span><span id="line-800"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Data.Singletons.TH.Promote.Monad.html#PrM"><span class="hs-identifier hs-type">PrM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">DDec</span></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">DDec</span></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.Singletons.TH.Syntax.html#ALetDecRHS"><span class="hs-identifier hs-type">ALetDecRHS</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-801"></span><span>    </span><span id="local-6989586621679308265"><span class="annot"><span class="annottext">promote_let_dec_rhs :: forall prom_a a.
[Name]
-&gt; Maybe LetDecRHSKindInfo
-&gt; Int
-&gt; PrM (prom_a, a)
-&gt; (prom_a -&gt; [DTySynEqn])
-&gt; (DType -&gt; Int -&gt; a -&gt; ALetDecRHS)
-&gt; PrM ([DDec], [DDec], ALetDecRHS)
</span><a href="#local-6989586621679308265"><span class="hs-identifier hs-var hs-var">promote_let_dec_rhs</span></a></span></span><span> </span><span id="local-6989586621679308233"><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621679308233"><span class="hs-identifier hs-var">all_locals</span></a></span></span><span> </span><span id="local-6989586621679308232"><span class="annot"><span class="annottext">Maybe LetDecRHSKindInfo
</span><a href="#local-6989586621679308232"><span class="hs-identifier hs-var">m_ldrki</span></a></span></span><span> </span><span id="local-6989586621679308231"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679308231"><span class="hs-identifier hs-var">ty_num_args</span></a></span></span><span>
</span><span id="line-802"></span><span>                        </span><span id="local-6989586621679308230"><span class="annot"><span class="annottext">PrM (prom_a, a)
</span><a href="#local-6989586621679308230"><span class="hs-identifier hs-var">promote_thing</span></a></span></span><span> </span><span id="local-6989586621679308229"><span class="annot"><span class="annottext">prom_a -&gt; [DTySynEqn]
</span><a href="#local-6989586621679308229"><span class="hs-identifier hs-var">mk_prom_eqns</span></a></span></span><span> </span><span id="local-6989586621679308228"><span class="annot"><span class="annottext">DType -&gt; Int -&gt; a -&gt; ALetDecRHS
</span><a href="#local-6989586621679308228"><span class="hs-identifier hs-var">mk_alet_dec_rhs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-803"></span><span>      </span><span id="local-6989586621679308227"><span class="annot"><span class="annottext">Options
</span><a href="#local-6989586621679308227"><span class="hs-identifier hs-var">opts</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). OptionsMonad m =&gt; m Options
</span><a href="Data.Singletons.TH.Options.html#getOptions"><span class="hs-identifier hs-var">getOptions</span></a></span><span>
</span><span id="line-804"></span><span>      </span><span id="local-6989586621679308226"><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621679308226"><span class="hs-identifier hs-var">tyvarNames</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Applicative m =&gt; Int -&gt; m a -&gt; m [a]
</span><span class="hs-identifier hs-var">replicateM</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679308231"><span class="hs-identifier hs-var">ty_num_args</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). Quasi m =&gt; String -&gt; m Name
</span><span class="hs-identifier hs-var">qNewName</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;a&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-805"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679308225"><span class="annot"><span class="annottext">proName :: Name
</span><a href="#local-6989586621679308225"><span class="hs-identifier hs-var hs-var">proName</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Options -&gt; Name -&gt; Maybe Uniq -&gt; Name
</span><a href="Data.Singletons.TH.Options.html#promotedValueName"><span class="hs-identifier hs-var">promotedValueName</span></a></span><span> </span><span class="annot"><span class="annottext">Options
</span><a href="#local-6989586621679308227"><span class="hs-identifier hs-var">opts</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679308276"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Uniq
</span><a href="#local-6989586621679308277"><span class="hs-identifier hs-var">mb_let_uniq</span></a></span><span>
</span><span id="line-806"></span><span>          </span><span id="local-6989586621679308224"><span class="annot"><span class="annottext">local_tvbs :: [DTyVarBndrUnit]
</span><a href="#local-6989586621679308224"><span class="hs-identifier hs-var hs-var">local_tvbs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall flag. Name -&gt; flag -&gt; DTyVarBndr flag
</span><span class="hs-operator hs-var">`DPlainTV`</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621679308233"><span class="hs-identifier hs-var">all_locals</span></a></span><span>
</span><span id="line-807"></span><span>          </span><span id="local-6989586621679308221"><span class="annot"><span class="annottext">m_fixity :: Maybe Fixity
</span><a href="#local-6989586621679308221"><span class="hs-identifier hs-var hs-var">m_fixity</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall k v. Ord k =&gt; k -&gt; OMap k v -&gt; Maybe v
</span><span class="hs-identifier hs-var">OMap.lookup</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679308276"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">OMap Name Fixity
</span><a href="#local-6989586621679308278"><span class="hs-identifier hs-var">fix_env</span></a></span><span>
</span><span id="line-808"></span><span>
</span><span id="line-809"></span><span>          </span><span class="annot"><a href="#local-6989586621679308220"><span class="hs-identifier hs-type">mk_tf_head</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">DTyVarBndrUnit</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DFamilyResultSig</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DTypeFamilyHead</span></span><span>
</span><span id="line-810"></span><span>          </span><span id="local-6989586621679308220"><span class="annot"><span class="annottext">mk_tf_head :: [DTyVarBndrUnit] -&gt; DFamilyResultSig -&gt; DTypeFamilyHead
</span><a href="#local-6989586621679308220"><span class="hs-identifier hs-var hs-var">mk_tf_head</span></a></span></span><span> </span><span id="local-6989586621679308219"><span class="annot"><span class="annottext">[DTyVarBndrUnit]
</span><a href="#local-6989586621679308219"><span class="hs-identifier hs-var">tvbs</span></a></span></span><span> </span><span id="local-6989586621679308218"><span class="annot"><span class="annottext">DFamilyResultSig
</span><a href="#local-6989586621679308218"><span class="hs-identifier hs-var">res_sig</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name
-&gt; [DTyVarBndrUnit]
-&gt; DFamilyResultSig
-&gt; Maybe InjectivityAnn
-&gt; DTypeFamilyHead
</span><span class="hs-identifier hs-var">DTypeFamilyHead</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679308225"><span class="hs-identifier hs-var">proName</span></a></span><span> </span><span class="annot"><span class="annottext">[DTyVarBndrUnit]
</span><a href="#local-6989586621679308219"><span class="hs-identifier hs-var">tvbs</span></a></span><span> </span><span class="annot"><span class="annottext">DFamilyResultSig
</span><a href="#local-6989586621679308218"><span class="hs-identifier hs-var">res_sig</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-811"></span><span>
</span><span id="line-812"></span><span>          </span><span class="hs-special">(</span><span id="local-6989586621679308217"><span class="annot"><span class="annottext">OSet Name
</span><a href="#local-6989586621679308217"><span class="hs-identifier hs-var">lde_kvs_to_bind</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679308216"><span class="annot"><span class="annottext">Maybe DDec
</span><a href="#local-6989586621679308216"><span class="hs-identifier hs-var">m_sak_dec</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679308215"><span class="annot"><span class="annottext">DefunKindInfo
</span><a href="#local-6989586621679308215"><span class="hs-identifier hs-var">defun_ki</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679308214"><span class="annot"><span class="annottext">DTypeFamilyHead
</span><a href="#local-6989586621679308214"><span class="hs-identifier hs-var">tf_head</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-813"></span><span>              </span><span class="hs-comment">-- There are three possible cases:</span><span>
</span><span id="line-814"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe LetDecRHSKindInfo
</span><a href="#local-6989586621679308232"><span class="hs-identifier hs-var">m_ldrki</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-815"></span><span>              </span><span class="hs-comment">-- 1. We have no kind information whatsoever.</span><span>
</span><span id="line-816"></span><span>              </span><span class="annot"><span class="annottext">Maybe LetDecRHSKindInfo
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-817"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679308213"><span class="annot"><span class="annottext">all_args :: [DTyVarBndrUnit]
</span><a href="#local-6989586621679308213"><span class="hs-identifier hs-var hs-var">all_args</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[DTyVarBndrUnit]
</span><a href="#local-6989586621679308224"><span class="hs-identifier hs-var">local_tvbs</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall flag. Name -&gt; flag -&gt; DTyVarBndr flag
</span><span class="hs-operator hs-var">`DPlainTV`</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621679308226"><span class="hs-identifier hs-var">tyvarNames</span></a></span><span> </span><span class="hs-keyword">in</span><span>
</span><span id="line-818"></span><span>                </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">forall a. OSet a
</span><span class="hs-identifier hs-var">OSet.empty</span></span><span>
</span><span id="line-819"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-820"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[DTyVarBndrUnit] -&gt; Maybe DType -&gt; DefunKindInfo
</span><a href="Data.Singletons.TH.Promote.Defun.html#DefunNoSAK"><span class="hs-identifier hs-var">DefunNoSAK</span></a></span><span> </span><span class="annot"><span class="annottext">[DTyVarBndrUnit]
</span><a href="#local-6989586621679308213"><span class="hs-identifier hs-var">all_args</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-821"></span><span>                </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[DTyVarBndrUnit] -&gt; DFamilyResultSig -&gt; DTypeFamilyHead
</span><a href="#local-6989586621679308220"><span class="hs-identifier hs-var">mk_tf_head</span></a></span><span> </span><span class="annot"><span class="annottext">[DTyVarBndrUnit]
</span><a href="#local-6989586621679308213"><span class="hs-identifier hs-var">all_args</span></a></span><span> </span><span class="annot"><span class="annottext">DFamilyResultSig
</span><span class="hs-identifier hs-var">DNoSig</span></span><span>
</span><span id="line-822"></span><span>                </span><span class="hs-special">)</span><span>
</span><span id="line-823"></span><span>              </span><span class="hs-comment">-- 2. We have some kind information in the form of a LetDecRHSKindInfo.</span><span>
</span><span id="line-824"></span><span>              </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Data.Singletons.TH.Promote.html#LDRKI"><span class="hs-identifier hs-type">LDRKI</span></a></span><span> </span><span id="local-6989586621679308208"><span class="annot"><span class="annottext">Maybe DType
</span><a href="#local-6989586621679308208"><span class="hs-identifier hs-var">m_sak</span></a></span></span><span> </span><span id="local-6989586621679308207"><span class="annot"><span class="annottext">[DTyVarBndrSpec]
</span><a href="#local-6989586621679308207"><span class="hs-identifier hs-var">tvbs</span></a></span></span><span> </span><span id="local-6989586621679308206"><span class="annot"><span class="annottext">[DType]
</span><a href="#local-6989586621679308206"><span class="hs-identifier hs-var">argKs</span></a></span></span><span> </span><span id="local-6989586621679308205"><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621679308205"><span class="hs-identifier hs-var">resK</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-825"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679308204"><span class="annot"><span class="annottext">all_args :: [DTyVarBndrUnit]
</span><a href="#local-6989586621679308204"><span class="hs-identifier hs-var hs-var">all_args</span></a></span></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[DTyVarBndrUnit]
</span><a href="#local-6989586621679308224"><span class="hs-identifier hs-var">local_tvbs</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">forall a b c. (a -&gt; b -&gt; c) -&gt; [a] -&gt; [b] -&gt; [c]
</span><span class="hs-identifier hs-var">zipWith</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall flag. Name -&gt; flag -&gt; DType -&gt; DTyVarBndr flag
</span><span class="hs-operator hs-var">`DKindedTV`</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621679308226"><span class="hs-identifier hs-var">tyvarNames</span></a></span><span> </span><span class="annot"><span class="annottext">[DType]
</span><a href="#local-6989586621679308206"><span class="hs-identifier hs-var">argKs</span></a></span><span>
</span><span id="line-826"></span><span>                    </span><span id="local-6989586621679308202"><span class="annot"><span class="annottext">lde_kvs_to_bind' :: OSet Name
</span><a href="#local-6989586621679308202"><span class="hs-identifier hs-var hs-var">lde_kvs_to_bind'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; [a] -&gt; OSet a
</span><span class="hs-identifier hs-var">OSet.fromList</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">forall flag. DTyVarBndr flag -&gt; Name
</span><a href="Data.Singletons.TH.Util.html#extractTvbName"><span class="hs-identifier hs-var">extractTvbName</span></a></span><span> </span><span class="annot"><span class="annottext">[DTyVarBndrSpec]
</span><a href="#local-6989586621679308207"><span class="hs-identifier hs-var">tvbs</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">in</span><span>
</span><span id="line-827"></span><span>                </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe DType
</span><a href="#local-6989586621679308208"><span class="hs-identifier hs-var">m_sak</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-828"></span><span>                  </span><span class="hs-comment">-- 2(a). We do not have a standalone kind signature.</span><span>
</span><span id="line-829"></span><span>                  </span><span class="annot"><span class="annottext">Maybe DType
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-830"></span><span>                    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">OSet Name
</span><a href="#local-6989586621679308202"><span class="hs-identifier hs-var">lde_kvs_to_bind'</span></a></span><span>
</span><span id="line-831"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-832"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[DTyVarBndrUnit] -&gt; Maybe DType -&gt; DefunKindInfo
</span><a href="Data.Singletons.TH.Promote.Defun.html#DefunNoSAK"><span class="hs-identifier hs-var">DefunNoSAK</span></a></span><span> </span><span class="annot"><span class="annottext">[DTyVarBndrUnit]
</span><a href="#local-6989586621679308204"><span class="hs-identifier hs-var">all_args</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621679308205"><span class="hs-identifier hs-var">resK</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-833"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[DTyVarBndrUnit] -&gt; DFamilyResultSig -&gt; DTypeFamilyHead
</span><a href="#local-6989586621679308220"><span class="hs-identifier hs-var">mk_tf_head</span></a></span><span> </span><span class="annot"><span class="annottext">[DTyVarBndrUnit]
</span><a href="#local-6989586621679308204"><span class="hs-identifier hs-var">all_args</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DType -&gt; DFamilyResultSig
</span><span class="hs-identifier hs-var">DKindSig</span></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621679308205"><span class="hs-identifier hs-var">resK</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-834"></span><span>                    </span><span class="hs-special">)</span><span>
</span><span id="line-835"></span><span>                  </span><span class="hs-comment">-- 2(b). We have a standalone kind signature.</span><span>
</span><span id="line-836"></span><span>                  </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679308201"><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621679308201"><span class="hs-identifier hs-var">sak</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-837"></span><span>                    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">OSet Name
</span><a href="#local-6989586621679308202"><span class="hs-identifier hs-var">lde_kvs_to_bind'</span></a></span><span>
</span><span id="line-838"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; DType -&gt; DDec
</span><span class="hs-identifier hs-var">DKiSigD</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679308225"><span class="hs-identifier hs-var">proName</span></a></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621679308201"><span class="hs-identifier hs-var">sak</span></a></span><span>
</span><span id="line-839"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">DType -&gt; DefunKindInfo
</span><a href="Data.Singletons.TH.Promote.Defun.html#DefunSAK"><span class="hs-identifier hs-var">DefunSAK</span></a></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621679308201"><span class="hs-identifier hs-var">sak</span></a></span><span>
</span><span id="line-840"></span><span>                      </span><span class="hs-comment">-- We opt to annotate the argument and result kinds in</span><span>
</span><span id="line-841"></span><span>                      </span><span class="hs-comment">-- the body of the type family declaration even if it is</span><span>
</span><span id="line-842"></span><span>                      </span><span class="hs-comment">-- given a standalone kind signature.</span><span>
</span><span id="line-843"></span><span>                      </span><span class="hs-comment">-- See Note [Keep redundant kind information for Haddocks].</span><span>
</span><span id="line-844"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[DTyVarBndrUnit] -&gt; DFamilyResultSig -&gt; DTypeFamilyHead
</span><a href="#local-6989586621679308220"><span class="hs-identifier hs-var">mk_tf_head</span></a></span><span> </span><span class="annot"><span class="annottext">[DTyVarBndrUnit]
</span><a href="#local-6989586621679308204"><span class="hs-identifier hs-var">all_args</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DType -&gt; DFamilyResultSig
</span><span class="hs-identifier hs-var">DKindSig</span></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621679308205"><span class="hs-identifier hs-var">resK</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-845"></span><span>                    </span><span class="hs-special">)</span><span>
</span><span id="line-846"></span><span>
</span><span id="line-847"></span><span>      </span><span id="local-6989586621679308200"><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621679308200"><span class="hs-identifier hs-var">defun_decs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Name -&gt; Maybe Fixity -&gt; DefunKindInfo -&gt; PrM [DDec]
</span><a href="Data.Singletons.TH.Promote.Defun.html#defunctionalize"><span class="hs-identifier hs-var">defunctionalize</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679308225"><span class="hs-identifier hs-var">proName</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Fixity
</span><a href="#local-6989586621679308221"><span class="hs-identifier hs-var">m_fixity</span></a></span><span> </span><span class="annot"><span class="annottext">DefunKindInfo
</span><a href="#local-6989586621679308215"><span class="hs-identifier hs-var">defun_ki</span></a></span><span>
</span><span id="line-848"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621679308199"><span class="annot"><span class="annottext">prom_a
</span><a href="#local-6989586621679308199"><span class="hs-identifier hs-var">prom_thing</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679308198"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679308198"><span class="hs-identifier hs-var">thing</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall a. OSet Name -&gt; PrM a -&gt; PrM a
</span><a href="Data.Singletons.TH.Promote.Monad.html#forallBind"><span class="hs-identifier hs-var">forallBind</span></a></span><span> </span><span class="annot"><span class="annottext">OSet Name
</span><a href="#local-6989586621679308217"><span class="hs-identifier hs-var">lde_kvs_to_bind</span></a></span><span> </span><span class="annot"><span class="annottext">PrM (prom_a, a)
</span><a href="#local-6989586621679308230"><span class="hs-identifier hs-var">promote_thing</span></a></span><span>
</span><span id="line-849"></span><span>      </span><span id="local-6989586621679308197"><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621679308197"><span class="hs-identifier hs-var">prom_fun_rhs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Name -&gt; PrM DType
</span><a href="Data.Singletons.TH.Promote.Monad.html#lookupVarE"><span class="hs-identifier hs-var">lookupVarE</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679308276"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-850"></span><span>      </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">forall a. [Maybe a] -&gt; [a]
</span><span class="hs-identifier hs-var">catMaybes</span></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Maybe DDec
</span><a href="#local-6989586621679308216"><span class="hs-identifier hs-var">m_sak_dec</span></a></span><span>
</span><span id="line-851"></span><span>                         </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">DTypeFamilyHead -&gt; [DTySynEqn] -&gt; DDec
</span><span class="hs-identifier hs-var">DClosedTypeFamilyD</span></span><span> </span><span class="annot"><span class="annottext">DTypeFamilyHead
</span><a href="#local-6989586621679308214"><span class="hs-identifier hs-var">tf_head</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">prom_a -&gt; [DTySynEqn]
</span><a href="#local-6989586621679308229"><span class="hs-identifier hs-var">mk_prom_eqns</span></a></span><span> </span><span class="annot"><span class="annottext">prom_a
</span><a href="#local-6989586621679308199"><span class="hs-identifier hs-var">prom_thing</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-852"></span><span>                         </span><span class="hs-special">]</span><span>
</span><span id="line-853"></span><span>             </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621679308200"><span class="hs-identifier hs-var">defun_decs</span></a></span><span>
</span><span id="line-854"></span><span>             </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">DType -&gt; Int -&gt; a -&gt; ALetDecRHS
</span><a href="#local-6989586621679308228"><span class="hs-identifier hs-var">mk_alet_dec_rhs</span></a></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621679308197"><span class="hs-identifier hs-var">prom_fun_rhs</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679308231"><span class="hs-identifier hs-var">ty_num_args</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679308198"><span class="hs-identifier hs-var">thing</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-855"></span><span>
</span><span id="line-856"></span><span>    </span><span class="annot"><a href="#local-6989586621679308268"><span class="hs-identifier hs-type">promote_let_dec_ty</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span class="hs-special">]</span><span> </span><span class="hs-comment">-- The local variables that the let-dec closes</span><span>
</span><span id="line-857"></span><span>                                 </span><span class="hs-comment">-- over. If this is non-empty, we cannot</span><span>
</span><span id="line-858"></span><span>                                 </span><span class="hs-comment">-- produce a standalone kind signature.</span><span>
</span><span id="line-859"></span><span>                                 </span><span class="hs-comment">-- See Note [No SAKs for let-decs with local variables]</span><span>
</span><span id="line-860"></span><span>                       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>    </span><span class="hs-comment">-- The number of arguments to default to if the</span><span>
</span><span id="line-861"></span><span>                                 </span><span class="hs-comment">-- type cannot be inferred. This is 0 for UValues</span><span>
</span><span id="line-862"></span><span>                                 </span><span class="hs-comment">-- and the number of arguments in a single clause</span><span>
</span><span id="line-863"></span><span>                                 </span><span class="hs-comment">-- for UFunctions.</span><span>
</span><span id="line-864"></span><span>                       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Data.Singletons.TH.Promote.Monad.html#PrM"><span class="hs-identifier hs-type">PrM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Data.Singletons.TH.Promote.html#LetDecRHSKindInfo"><span class="hs-identifier hs-type">LetDecRHSKindInfo</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">)</span><span>
</span><span id="line-865"></span><span>                                 </span><span class="hs-comment">-- Returns two things in a pair:</span><span>
</span><span id="line-866"></span><span>                                 </span><span class="hs-comment">--</span><span>
</span><span id="line-867"></span><span>                                 </span><span class="hs-comment">-- 1. Information about the promoted kind,</span><span>
</span><span id="line-868"></span><span>                                 </span><span class="hs-comment">--    if available.</span><span>
</span><span id="line-869"></span><span>                                 </span><span class="hs-comment">--</span><span>
</span><span id="line-870"></span><span>                                 </span><span class="hs-comment">-- 2. The number of arguments the let-dec has.</span><span>
</span><span id="line-871"></span><span>                                 </span><span class="hs-comment">--    If no kind information is available from</span><span>
</span><span id="line-872"></span><span>                                 </span><span class="hs-comment">--    which to infer this number, then this</span><span>
</span><span id="line-873"></span><span>                                 </span><span class="hs-comment">--    will default to the earlier Int argument.</span><span>
</span><span id="line-874"></span><span>    </span><span id="local-6989586621679308268"><span class="annot"><span class="annottext">promote_let_dec_ty :: [Name] -&gt; Int -&gt; PrM (Maybe LetDecRHSKindInfo, Int)
</span><a href="#local-6989586621679308268"><span class="hs-identifier hs-var hs-var">promote_let_dec_ty</span></a></span></span><span> </span><span id="local-6989586621679308193"><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621679308193"><span class="hs-identifier hs-var">all_locals</span></a></span></span><span> </span><span id="local-6989586621679308192"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679308192"><span class="hs-identifier hs-var">default_num_args</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-875"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">LetDecRHSSort
</span><a href="#local-6989586621679308280"><span class="hs-identifier hs-var">rhs_sort</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-876"></span><span>        </span><span class="annot"><a href="Data.Singletons.TH.Promote.html#ClassMethodRHS"><span class="hs-identifier hs-type">ClassMethodRHS</span></a></span><span> </span><span id="local-6989586621679308191"><span class="annot"><span class="annottext">[DTyVarBndrSpec]
</span><a href="#local-6989586621679308191"><span class="hs-identifier hs-var">tvbs</span></a></span></span><span> </span><span id="local-6989586621679308190"><span class="annot"><span class="annottext">[DType]
</span><a href="#local-6989586621679308190"><span class="hs-identifier hs-var">arg_kis</span></a></span></span><span> </span><span id="local-6989586621679308189"><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621679308189"><span class="hs-identifier hs-var">res_ki</span></a></span></span><span>
</span><span id="line-877"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-comment">-- For class method RHS helper functions, don't bother quantifying</span><span>
</span><span id="line-878"></span><span>             </span><span class="hs-comment">-- any type variables in their SAKS. We could certainly try, but</span><span>
</span><span id="line-879"></span><span>             </span><span class="hs-comment">-- given that these functions are only used internally, there's no</span><span>
</span><span id="line-880"></span><span>             </span><span class="hs-comment">-- point in trying to get the order of type variables correct,</span><span>
</span><span id="line-881"></span><span>             </span><span class="hs-comment">-- since we don't apply these functions with visible kind</span><span>
</span><span id="line-882"></span><span>             </span><span class="hs-comment">-- applications.</span><span>
</span><span id="line-883"></span><span>             </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679308188"><span class="annot"><span class="annottext">sak :: DType
</span><a href="#local-6989586621679308188"><span class="hs-identifier hs-var hs-var">sak</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[DTyVarBndrSpec] -&gt; [DType] -&gt; [DType] -&gt; DType -&gt; DType
</span><a href="Data.Singletons.TH.Util.html#ravelVanillaDType"><span class="hs-identifier hs-var">ravelVanillaDType</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">[DType]
</span><a href="#local-6989586621679308190"><span class="hs-identifier hs-var">arg_kis</span></a></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621679308189"><span class="hs-identifier hs-var">res_ki</span></a></span><span> </span><span class="hs-keyword">in</span><span>
</span><span id="line-884"></span><span>             </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe DType
-&gt; [DTyVarBndrSpec] -&gt; [DType] -&gt; DType -&gt; LetDecRHSKindInfo
</span><a href="Data.Singletons.TH.Promote.html#LDRKI"><span class="hs-identifier hs-var">LDRKI</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621679308188"><span class="hs-identifier hs-var">sak</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[DTyVarBndrSpec]
</span><a href="#local-6989586621679308191"><span class="hs-identifier hs-var">tvbs</span></a></span><span> </span><span class="annot"><span class="annottext">[DType]
</span><a href="#local-6989586621679308190"><span class="hs-identifier hs-var">arg_kis</span></a></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621679308189"><span class="hs-identifier hs-var">res_ki</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[DType]
</span><a href="#local-6989586621679308190"><span class="hs-identifier hs-var">arg_kis</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-885"></span><span>        </span><span class="annot"><span class="annottext">LetDecRHSSort
</span><a href="Data.Singletons.TH.Promote.html#LetBindingRHS"><span class="hs-identifier hs-var">LetBindingRHS</span></a></span><span>
</span><span id="line-886"></span><span>          </span><span class="hs-glyph">|</span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679308187"><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621679308187"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall k v. Ord k =&gt; k -&gt; OMap k v -&gt; Maybe v
</span><span class="hs-identifier hs-var">OMap.lookup</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679308276"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">OMap Name DType
</span><a href="#local-6989586621679308279"><span class="hs-identifier hs-var">type_env</span></a></span><span>
</span><span id="line-887"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-888"></span><span>          </span><span class="hs-comment">-- promoteType turns rank-1 uses of (-&gt;) into (~&gt;). So, we unravel</span><span>
</span><span id="line-889"></span><span>          </span><span class="hs-comment">-- first to avoid this behavior, and then ravel back.</span><span>
</span><span id="line-890"></span><span>          </span><span class="hs-special">(</span><span id="local-6989586621679308186"><span class="annot"><span class="annottext">[DTyVarBndrSpec]
</span><a href="#local-6989586621679308186"><span class="hs-identifier hs-var">tvbs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679308185"><span class="annot"><span class="annottext">[DType]
</span><a href="#local-6989586621679308185"><span class="hs-identifier hs-var">argKs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679308184"><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621679308184"><span class="hs-identifier hs-var">resultK</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *).
OptionsMonad m =&gt;
DType -&gt; m ([DTyVarBndrSpec], [DType], DType)
</span><a href="Data.Singletons.TH.Promote.Type.html#promoteUnraveled"><span class="hs-identifier hs-var">promoteUnraveled</span></a></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621679308187"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-891"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679308182"><span class="annot"><span class="annottext">m_sak :: Maybe DType
</span><a href="#local-6989586621679308182"><span class="hs-identifier hs-var hs-var">m_sak</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621679308193"><span class="hs-identifier hs-var">all_locals</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[DTyVarBndrSpec] -&gt; [DType] -&gt; [DType] -&gt; DType -&gt; DType
</span><a href="Data.Singletons.TH.Util.html#ravelVanillaDType"><span class="hs-identifier hs-var">ravelVanillaDType</span></a></span><span> </span><span class="annot"><span class="annottext">[DTyVarBndrSpec]
</span><a href="#local-6989586621679308186"><span class="hs-identifier hs-var">tvbs</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">[DType]
</span><a href="#local-6989586621679308185"><span class="hs-identifier hs-var">argKs</span></a></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621679308184"><span class="hs-identifier hs-var">resultK</span></a></span><span>
</span><span id="line-892"></span><span>                      </span><span class="hs-comment">-- If this let-dec closes over local variables, then</span><span>
</span><span id="line-893"></span><span>                      </span><span class="hs-comment">-- don't give it a SAK.</span><span>
</span><span id="line-894"></span><span>                      </span><span class="hs-comment">-- See Note [No SAKs for let-decs with local variables]</span><span>
</span><span id="line-895"></span><span>                    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-896"></span><span>          </span><span class="hs-comment">-- invariant: count_args ty == length argKs</span><span>
</span><span id="line-897"></span><span>          </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe DType
-&gt; [DTyVarBndrSpec] -&gt; [DType] -&gt; DType -&gt; LetDecRHSKindInfo
</span><a href="Data.Singletons.TH.Promote.html#LDRKI"><span class="hs-identifier hs-var">LDRKI</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe DType
</span><a href="#local-6989586621679308182"><span class="hs-identifier hs-var">m_sak</span></a></span><span> </span><span class="annot"><span class="annottext">[DTyVarBndrSpec]
</span><a href="#local-6989586621679308186"><span class="hs-identifier hs-var">tvbs</span></a></span><span> </span><span class="annot"><span class="annottext">[DType]
</span><a href="#local-6989586621679308185"><span class="hs-identifier hs-var">argKs</span></a></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621679308184"><span class="hs-identifier hs-var">resultK</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[DType]
</span><a href="#local-6989586621679308185"><span class="hs-identifier hs-var">argKs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-898"></span><span>
</span><span id="line-899"></span><span>          </span><span class="hs-glyph">|</span><span>  </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>
</span><span id="line-900"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679308192"><span class="hs-identifier hs-var">default_num_args</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-901"></span><span>
</span><span id="line-902"></span><span>    </span><span class="annot"><a href="#local-6989586621679308247"><span class="hs-identifier hs-type">etaContractOrExpand</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DClause</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Data.Singletons.TH.Promote.Monad.html#PrM"><span class="hs-identifier hs-type">PrM</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">DClause</span></span><span>
</span><span id="line-903"></span><span>    </span><span id="local-6989586621679308247"><span class="annot"><span class="annottext">etaContractOrExpand :: Int -&gt; Int -&gt; DClause -&gt; PrM DClause
</span><a href="#local-6989586621679308247"><span class="hs-identifier hs-var hs-var">etaContractOrExpand</span></a></span></span><span> </span><span id="local-6989586621679308180"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679308180"><span class="hs-identifier hs-var">ty_num_args</span></a></span></span><span> </span><span id="local-6989586621679308179"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679308179"><span class="hs-identifier hs-var">clause_num_args</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DClause</span></span><span> </span><span id="local-6989586621679308178"><span class="annot"><span class="annottext">[DPat]
</span><a href="#local-6989586621679308178"><span class="hs-identifier hs-var">pats</span></a></span></span><span> </span><span id="local-6989586621679308177"><span class="annot"><span class="annottext">DExp
</span><a href="#local-6989586621679308177"><span class="hs-identifier hs-var">exp</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-904"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679308176"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-comment">-- Eta-expand</span><span>
</span><span id="line-905"></span><span>          </span><span id="local-6989586621679308175"><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621679308175"><span class="hs-identifier hs-var">names</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Applicative m =&gt; Int -&gt; m a -&gt; m [a]
</span><span class="hs-identifier hs-var">replicateM</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679308176"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). Quasi m =&gt; String -&gt; m Name
</span><span class="hs-identifier hs-var">newUniqueName</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;a&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-906"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679308174"><span class="annot"><span class="annottext">newPats :: [DPat]
</span><a href="#local-6989586621679308174"><span class="hs-identifier hs-var hs-var">newPats</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; DPat
</span><span class="hs-identifier hs-var">DVarP</span></span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621679308175"><span class="hs-identifier hs-var">names</span></a></span><span>
</span><span id="line-907"></span><span>              </span><span id="local-6989586621679308172"><span class="annot"><span class="annottext">newArgs :: [DExp]
</span><a href="#local-6989586621679308172"><span class="hs-identifier hs-var hs-var">newArgs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; DExp
</span><span class="hs-identifier hs-var">DVarE</span></span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621679308175"><span class="hs-identifier hs-var">names</span></a></span><span>
</span><span id="line-908"></span><span>          </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[DPat] -&gt; DExp -&gt; DClause
</span><span class="hs-identifier hs-var">DClause</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[DPat]
</span><a href="#local-6989586621679308178"><span class="hs-identifier hs-var">pats</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[DPat]
</span><a href="#local-6989586621679308174"><span class="hs-identifier hs-var">newPats</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DExp -&gt; [DExp] -&gt; DExp
</span><a href="Data.Singletons.TH.Util.html#foldExp"><span class="hs-identifier hs-var">foldExp</span></a></span><span> </span><span class="annot"><span class="annottext">DExp
</span><a href="#local-6989586621679308177"><span class="hs-identifier hs-var">exp</span></a></span><span> </span><span class="annot"><span class="annottext">[DExp]
</span><a href="#local-6989586621679308172"><span class="hs-identifier hs-var">newArgs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-909"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-comment">-- Eta-contract</span><span>
</span><span id="line-910"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679308169"><span class="annot"><span class="annottext">[DPat]
</span><a href="#local-6989586621679308169"><span class="hs-identifier hs-var">clausePats</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679308168"><span class="annot"><span class="annottext">[DPat]
</span><a href="#local-6989586621679308168"><span class="hs-identifier hs-var">lamPats</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. Int -&gt; [a] -&gt; ([a], [a])
</span><span class="hs-identifier hs-var">splitAt</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679308180"><span class="hs-identifier hs-var">ty_num_args</span></a></span><span> </span><span class="annot"><span class="annottext">[DPat]
</span><a href="#local-6989586621679308178"><span class="hs-identifier hs-var">pats</span></a></span><span>
</span><span id="line-911"></span><span>          </span><span id="local-6989586621679308166"><span class="annot"><span class="annottext">DExp
</span><a href="#local-6989586621679308166"><span class="hs-identifier hs-var">lamExp</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (q :: * -&gt; *). Quasi q =&gt; [DPat] -&gt; DExp -&gt; q DExp
</span><span class="hs-identifier hs-var">mkDLamEFromDPats</span></span><span> </span><span class="annot"><span class="annottext">[DPat]
</span><a href="#local-6989586621679308168"><span class="hs-identifier hs-var">lamPats</span></a></span><span> </span><span class="annot"><span class="annottext">DExp
</span><a href="#local-6989586621679308177"><span class="hs-identifier hs-var">exp</span></a></span><span>
</span><span id="line-912"></span><span>          </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[DPat] -&gt; DExp -&gt; DClause
</span><span class="hs-identifier hs-var">DClause</span></span><span> </span><span class="annot"><span class="annottext">[DPat]
</span><a href="#local-6989586621679308169"><span class="hs-identifier hs-var">clausePats</span></a></span><span> </span><span class="annot"><span class="annottext">DExp
</span><a href="#local-6989586621679308166"><span class="hs-identifier hs-var">lamExp</span></a></span><span>
</span><span id="line-913"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-914"></span><span>        </span><span id="local-6989586621679308176"><span class="annot"><span class="annottext">n :: Int
</span><a href="#local-6989586621679308176"><span class="hs-identifier hs-var hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679308180"><span class="hs-identifier hs-var">ty_num_args</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679308179"><span class="hs-identifier hs-var">clause_num_args</span></a></span><span>
</span><span id="line-915"></span><span>
</span><span id="line-916"></span><span>    </span><span class="annot"><a href="#local-6989586621679308253"><span class="hs-identifier hs-type">count_args</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">DClause</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Data.Singletons.TH.Promote.Monad.html#PrM"><span class="hs-identifier hs-type">PrM</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-917"></span><span>    </span><span id="local-6989586621679308253"><span class="annot"><span class="annottext">count_args :: [DClause] -&gt; PrM Int
</span><a href="#local-6989586621679308253"><span class="hs-identifier hs-var hs-var">count_args</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DClause</span></span><span> </span><span id="local-6989586621679308163"><span class="annot"><span class="annottext">[DPat]
</span><a href="#local-6989586621679308163"><span class="hs-identifier hs-var">pats</span></a></span></span><span> </span><span class="annot"><span class="annottext">DExp
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span class="annot"><span class="annottext">[DClause]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[DPat]
</span><a href="#local-6989586621679308163"><span class="hs-identifier hs-var">pats</span></a></span><span>
</span><span id="line-918"></span><span>    </span><span class="annot"><a href="#local-6989586621679308253"><span class="hs-identifier hs-var">count_args</span></a></span><span> </span><span class="annot"><span class="annottext">[DClause]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadFail m =&gt; String -&gt; m a
</span><span class="hs-identifier hs-var">fail</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Impossible! A function without clauses.&quot;</span></span><span>
</span><span id="line-919"></span><span>
</span><span id="line-920"></span><span class="hs-comment">-- An auxiliary data type used in promoteLetDecRHS that describes information</span><span>
</span><span id="line-921"></span><span class="hs-comment">-- related to the promoted kind of a class method default or normal</span><span>
</span><span id="line-922"></span><span class="hs-comment">-- let binding.</span><span>
</span><span id="line-923"></span><span class="hs-keyword">data</span><span> </span><span id="LetDecRHSKindInfo"><span class="annot"><a href="Data.Singletons.TH.Promote.html#LetDecRHSKindInfo"><span class="hs-identifier hs-var">LetDecRHSKindInfo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-924"></span><span>  </span><span id="LDRKI"><span class="annot"><a href="Data.Singletons.TH.Promote.html#LDRKI"><span class="hs-identifier hs-var">LDRKI</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">DKind</span></span><span class="hs-special">)</span><span>    </span><span class="hs-comment">-- The standalone kind signature, if applicable.</span><span>
</span><span id="line-925"></span><span>                         </span><span class="hs-comment">-- This will be Nothing if the let-dec RHS has local</span><span>
</span><span id="line-926"></span><span>                         </span><span class="hs-comment">-- variables that it closes over.</span><span>
</span><span id="line-927"></span><span>                         </span><span class="hs-comment">-- See Note [No SAKs for let-decs with local variables]</span><span>
</span><span id="line-928"></span><span>        </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">DTyVarBndrSpec</span></span><span class="hs-special">]</span><span> </span><span class="hs-comment">-- The type variable binders of the kind.</span><span>
</span><span id="line-929"></span><span>        </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">DKind</span></span><span class="hs-special">]</span><span>          </span><span class="hs-comment">-- The argument kinds.</span><span>
</span><span id="line-930"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">DKind</span></span><span>            </span><span class="hs-comment">-- The result kind.</span><span>
</span><span id="line-931"></span><span>
</span><span id="line-932"></span><span class="hs-comment">{-
Note [No SAKs for let-decs with local variables]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider promoting this:

  f :: Bool
  f = let x = True
          g :: () -&gt; Bool
          g _ = x
      in g ()

Clearly, the promoted `F` type family will have the following SAK:

  type F :: ()

What about `G`? At a passing glance, it appears that you could get away with
this:

  type G :: Bool -&gt; ()

But this isn't quite right, since `g` closes over `x = True`. The body of `G`,
therefore, has to lift `x` to be an explicit argument:

  type family G x (u :: ()) :: Bool where
    G x _ = x

At present, we don't keep track of the types of local variables like `x`, which
makes it difficult to create a SAK for things like `G`. Here are some possible
ideas, each followed by explanations for why they are infeasible:

* Use wildcards:

    type G :: _ -&gt; () -&gt; Bool

  Alas, GHC currently does not allow wildcards in SAKs. See GHC#17432.

* Use visible dependent quantification to avoid having to say what the kind
  of `x` is:

    type G :: forall x -&gt; () -&gt; Bool

  A clever trick to be sure, but it doesn't quite do what we want, since
  GHC will generalize that kind to become `forall (x :: k) -&gt; () -&gt; Bool`,
  which is more general than we want.

In any case, it's probably not worth bothering with SAKs for local definitions
like `g` in the first place, so we avoid generating SAKs for anything that
closes over at least one local variable for now. If someone yells about this,
we'll reconsider this design.

Note [Keep redundant kind information for Haddocks]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
`singletons-th` generates explicit argument kinds and result kinds for
type-level declarations whenever possible, even if those kinds are technically
redundant. For example, `singletons-th` would promote this:

  id' :: a -&gt; a

To this:

  type Id' :: a -&gt; a
  type family Id' (x :: a) :: a where ...

Strictly speaking, the argument and result kind of Id' are unnecessary, since
the same information is already present in the standalone kind signature.
However, due to a Haddock limitation
(https://github.com/haskell/haddock/issues/1178), Haddock will not render
standalone kind signatures at all, so if the argument and result kind of Id'
were omitted in the body, Haddock would render it like so:

  type family Id' x where ...

This is unfortunate for Haddock viewers, as this does not convey any kind
information whatsoever. Until the aformentioned Haddock issue is resolved, we
work around this limitation by generating the redundant argument and kind
information anyway. Thankfully, this is simple to accomplish, as we already
compute this information to begin with.
-}</span><span>
</span><span id="line-1010"></span><span>
</span><span id="line-1011"></span><span class="annot"><a href="Data.Singletons.TH.Promote.html#promoteClause"><span class="hs-identifier hs-type">promoteClause</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DType</span></span><span> </span><span class="hs-comment">-- What to use as the LHS of the promoted type family</span><span>
</span><span id="line-1012"></span><span>                       </span><span class="hs-comment">-- equation. This should consist of the promoted name of</span><span>
</span><span id="line-1013"></span><span>                       </span><span class="hs-comment">-- the function to which the clause belongs, applied to</span><span>
</span><span id="line-1014"></span><span>                       </span><span class="hs-comment">-- any local arguments (e.g., `Go x y z`).</span><span>
</span><span id="line-1015"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DClause</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Data.Singletons.TH.Promote.Monad.html#PrM"><span class="hs-identifier hs-type">PrM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DTySynEqn</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.Singletons.TH.Syntax.html#ADClause"><span class="hs-identifier hs-type">ADClause</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1016"></span><span id="promoteClause"><span class="annot"><span class="annottext">promoteClause :: DType -&gt; DClause -&gt; PrM (DTySynEqn, ADClause)
</span><a href="Data.Singletons.TH.Promote.html#promoteClause"><span class="hs-identifier hs-var hs-var">promoteClause</span></a></span></span><span> </span><span id="local-6989586621679308162"><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621679308162"><span class="hs-identifier hs-var">pro_clause_fun</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DClause</span></span><span> </span><span id="local-6989586621679308161"><span class="annot"><span class="annottext">[DPat]
</span><a href="#local-6989586621679308161"><span class="hs-identifier hs-var">pats</span></a></span></span><span> </span><span id="local-6989586621679308160"><span class="annot"><span class="annottext">DExp
</span><a href="#local-6989586621679308160"><span class="hs-identifier hs-var">exp</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1017"></span><span>  </span><span class="hs-comment">-- promoting the patterns creates variable bindings. These are passed</span><span>
</span><span id="line-1018"></span><span>  </span><span class="hs-comment">-- to the function promoted the RHS</span><span>
</span><span id="line-1019"></span><span>  </span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621679308159"><span class="annot"><span class="annottext">[DType]
</span><a href="#local-6989586621679308159"><span class="hs-identifier hs-var">types</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679308158"><span class="annot"><span class="annottext">[ADPat]
</span><a href="#local-6989586621679308158"><span class="hs-identifier hs-var">pats'</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621679308157"><span class="annot"><span class="annottext">PromDPatInfos
</span><a href="#local-6989586621679308157"><span class="hs-identifier hs-var">prom_pat_infos</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall m (q :: * -&gt; *) a. QWithAux m q a -&gt; q (a, m)
</span><a href="Data.Singletons.TH.Util.html#evalForPair"><span class="hs-identifier hs-var">evalForPair</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b c.
Applicative m =&gt;
(a -&gt; m (b, c)) -&gt; [a] -&gt; m ([b], [c])
</span><span class="hs-identifier hs-var">mapAndUnzipM</span></span><span> </span><span class="annot"><span class="annottext">DPat -&gt; QWithAux PromDPatInfos PrM (DType, ADPat)
</span><a href="Data.Singletons.TH.Promote.html#promotePat"><span class="hs-identifier hs-var">promotePat</span></a></span><span> </span><span class="annot"><span class="annottext">[DPat]
</span><a href="#local-6989586621679308161"><span class="hs-identifier hs-var">pats</span></a></span><span>
</span><span id="line-1020"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="Data.Singletons.TH.Syntax.html#PromDPatInfos"><span class="hs-identifier hs-type">PromDPatInfos</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">prom_dpat_vars :: PromDPatInfos -&gt; VarPromotions
</span><a href="Data.Singletons.TH.Syntax.html#prom_dpat_vars"><span class="hs-identifier hs-var">prom_dpat_vars</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621679308152"><span class="annot"><span class="annottext">VarPromotions
</span><a href="#local-6989586621679308152"><span class="hs-identifier hs-var">new_vars</span></a></span></span><span>
</span><span id="line-1021"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">prom_dpat_sig_kvs :: PromDPatInfos -&gt; OSet Name
</span><a href="Data.Singletons.TH.Syntax.html#prom_dpat_sig_kvs"><span class="hs-identifier hs-var">prom_dpat_sig_kvs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621679308150"><span class="annot"><span class="annottext">OSet Name
</span><a href="#local-6989586621679308150"><span class="hs-identifier hs-var">sig_kvs</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PromDPatInfos
</span><a href="#local-6989586621679308157"><span class="hs-identifier hs-var">prom_pat_infos</span></a></span><span>
</span><span id="line-1022"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621679308149"><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621679308149"><span class="hs-identifier hs-var">ty</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679308148"><span class="annot"><span class="annottext">ADExp
</span><a href="#local-6989586621679308148"><span class="hs-identifier hs-var">ann_exp</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall a. OSet Name -&gt; PrM a -&gt; PrM a
</span><a href="Data.Singletons.TH.Promote.Monad.html#forallBind"><span class="hs-identifier hs-var">forallBind</span></a></span><span> </span><span class="annot"><span class="annottext">OSet Name
</span><a href="#local-6989586621679308150"><span class="hs-identifier hs-var">sig_kvs</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1023"></span><span>                   </span><span class="annot"><span class="annottext">forall a. VarPromotions -&gt; PrM a -&gt; PrM a
</span><a href="Data.Singletons.TH.Promote.Monad.html#lambdaBind"><span class="hs-identifier hs-var">lambdaBind</span></a></span><span> </span><span class="annot"><span class="annottext">VarPromotions
</span><a href="#local-6989586621679308152"><span class="hs-identifier hs-var">new_vars</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1024"></span><span>                   </span><span class="annot"><span class="annottext">DExp -&gt; PrM (DType, ADExp)
</span><a href="Data.Singletons.TH.Promote.html#promoteExp"><span class="hs-identifier hs-var">promoteExp</span></a></span><span> </span><span class="annot"><span class="annottext">DExp
</span><a href="#local-6989586621679308160"><span class="hs-identifier hs-var">exp</span></a></span><span>
</span><span id="line-1025"></span><span>  </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Maybe [DTyVarBndrUnit] -&gt; DType -&gt; DType -&gt; DTySynEqn
</span><span class="hs-identifier hs-var">DTySynEqn</span></span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DType -&gt; [DType] -&gt; DType
</span><a href="Data.Singletons.TH.Util.html#foldType"><span class="hs-identifier hs-var">foldType</span></a></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621679308162"><span class="hs-identifier hs-var">pro_clause_fun</span></a></span><span> </span><span class="annot"><span class="annottext">[DType]
</span><a href="#local-6989586621679308159"><span class="hs-identifier hs-var">types</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621679308149"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-1026"></span><span>         </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">VarPromotions -&gt; [ADPat] -&gt; ADExp -&gt; ADClause
</span><a href="Data.Singletons.TH.Syntax.html#ADClause"><span class="hs-identifier hs-var">ADClause</span></a></span><span> </span><span class="annot"><span class="annottext">VarPromotions
</span><a href="#local-6989586621679308152"><span class="hs-identifier hs-var">new_vars</span></a></span><span> </span><span class="annot"><span class="annottext">[ADPat]
</span><a href="#local-6989586621679308158"><span class="hs-identifier hs-var">pats'</span></a></span><span> </span><span class="annot"><span class="annottext">ADExp
</span><a href="#local-6989586621679308148"><span class="hs-identifier hs-var">ann_exp</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-1027"></span><span>
</span><span id="line-1028"></span><span class="annot"><a href="Data.Singletons.TH.Promote.html#promoteMatch"><span class="hs-identifier hs-type">promoteMatch</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DType</span></span><span> </span><span class="hs-comment">-- What to use as the LHS of the promoted type family</span><span>
</span><span id="line-1029"></span><span>                      </span><span class="hs-comment">-- equation. This should consist of the promoted name of</span><span>
</span><span id="line-1030"></span><span>                      </span><span class="hs-comment">-- the case expression to which the match belongs, applied</span><span>
</span><span id="line-1031"></span><span>                      </span><span class="hs-comment">-- to any local arguments (e.g., `Case x y z`).</span><span>
</span><span id="line-1032"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DMatch</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Data.Singletons.TH.Promote.Monad.html#PrM"><span class="hs-identifier hs-type">PrM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DTySynEqn</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.Singletons.TH.Syntax.html#ADMatch"><span class="hs-identifier hs-type">ADMatch</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1033"></span><span id="promoteMatch"><span class="annot"><span class="annottext">promoteMatch :: DType -&gt; DMatch -&gt; PrM (DTySynEqn, ADMatch)
</span><a href="Data.Singletons.TH.Promote.html#promoteMatch"><span class="hs-identifier hs-var hs-var">promoteMatch</span></a></span></span><span> </span><span id="local-6989586621679308144"><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621679308144"><span class="hs-identifier hs-var">pro_case_fun</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DMatch</span></span><span> </span><span id="local-6989586621679308142"><span class="annot"><span class="annottext">DPat
</span><a href="#local-6989586621679308142"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621679308141"><span class="annot"><span class="annottext">DExp
</span><a href="#local-6989586621679308141"><span class="hs-identifier hs-var">exp</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1034"></span><span>  </span><span class="hs-comment">-- promoting the patterns creates variable bindings. These are passed</span><span>
</span><span id="line-1035"></span><span>  </span><span class="hs-comment">-- to the function promoted the RHS</span><span>
</span><span id="line-1036"></span><span>  </span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621679308140"><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621679308140"><span class="hs-identifier hs-var">ty</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679308139"><span class="annot"><span class="annottext">ADPat
</span><a href="#local-6989586621679308139"><span class="hs-identifier hs-var">pat'</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621679308138"><span class="annot"><span class="annottext">PromDPatInfos
</span><a href="#local-6989586621679308138"><span class="hs-identifier hs-var">prom_pat_infos</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall m (q :: * -&gt; *) a. QWithAux m q a -&gt; q (a, m)
</span><a href="Data.Singletons.TH.Util.html#evalForPair"><span class="hs-identifier hs-var">evalForPair</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">DPat -&gt; QWithAux PromDPatInfos PrM (DType, ADPat)
</span><a href="Data.Singletons.TH.Promote.html#promotePat"><span class="hs-identifier hs-var">promotePat</span></a></span><span> </span><span class="annot"><span class="annottext">DPat
</span><a href="#local-6989586621679308142"><span class="hs-identifier hs-var">pat</span></a></span><span>
</span><span id="line-1037"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="Data.Singletons.TH.Syntax.html#PromDPatInfos"><span class="hs-identifier hs-type">PromDPatInfos</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">prom_dpat_vars :: PromDPatInfos -&gt; VarPromotions
</span><a href="Data.Singletons.TH.Syntax.html#prom_dpat_vars"><span class="hs-identifier hs-var">prom_dpat_vars</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621679308137"><span class="annot"><span class="annottext">VarPromotions
</span><a href="#local-6989586621679308137"><span class="hs-identifier hs-var">new_vars</span></a></span></span><span>
</span><span id="line-1038"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">prom_dpat_sig_kvs :: PromDPatInfos -&gt; OSet Name
</span><a href="Data.Singletons.TH.Syntax.html#prom_dpat_sig_kvs"><span class="hs-identifier hs-var">prom_dpat_sig_kvs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621679308136"><span class="annot"><span class="annottext">OSet Name
</span><a href="#local-6989586621679308136"><span class="hs-identifier hs-var">sig_kvs</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PromDPatInfos
</span><a href="#local-6989586621679308138"><span class="hs-identifier hs-var">prom_pat_infos</span></a></span><span>
</span><span id="line-1039"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621679308135"><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621679308135"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679308134"><span class="annot"><span class="annottext">ADExp
</span><a href="#local-6989586621679308134"><span class="hs-identifier hs-var">ann_exp</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall a. OSet Name -&gt; PrM a -&gt; PrM a
</span><a href="Data.Singletons.TH.Promote.Monad.html#forallBind"><span class="hs-identifier hs-var">forallBind</span></a></span><span> </span><span class="annot"><span class="annottext">OSet Name
</span><a href="#local-6989586621679308136"><span class="hs-identifier hs-var">sig_kvs</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1040"></span><span>                    </span><span class="annot"><span class="annottext">forall a. VarPromotions -&gt; PrM a -&gt; PrM a
</span><a href="Data.Singletons.TH.Promote.Monad.html#lambdaBind"><span class="hs-identifier hs-var">lambdaBind</span></a></span><span> </span><span class="annot"><span class="annottext">VarPromotions
</span><a href="#local-6989586621679308137"><span class="hs-identifier hs-var">new_vars</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1041"></span><span>                    </span><span class="annot"><span class="annottext">DExp -&gt; PrM (DType, ADExp)
</span><a href="Data.Singletons.TH.Promote.html#promoteExp"><span class="hs-identifier hs-var">promoteExp</span></a></span><span> </span><span class="annot"><span class="annottext">DExp
</span><a href="#local-6989586621679308141"><span class="hs-identifier hs-var">exp</span></a></span><span>
</span><span id="line-1042"></span><span>  </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Maybe [DTyVarBndrUnit] -&gt; DType -&gt; DType -&gt; DTySynEqn
</span><span class="hs-identifier hs-var">DTySynEqn</span></span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621679308144"><span class="hs-identifier hs-var">pro_case_fun</span></a></span><span> </span><span class="annot"><span class="annottext">DType -&gt; DType -&gt; DType
</span><span class="hs-operator hs-var">`DAppT`</span></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621679308140"><span class="hs-identifier hs-var">ty</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621679308135"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-1043"></span><span>           </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">VarPromotions -&gt; ADPat -&gt; ADExp -&gt; ADMatch
</span><a href="Data.Singletons.TH.Syntax.html#ADMatch"><span class="hs-identifier hs-var">ADMatch</span></a></span><span> </span><span class="annot"><span class="annottext">VarPromotions
</span><a href="#local-6989586621679308137"><span class="hs-identifier hs-var">new_vars</span></a></span><span> </span><span class="annot"><span class="annottext">ADPat
</span><a href="#local-6989586621679308139"><span class="hs-identifier hs-var">pat'</span></a></span><span> </span><span class="annot"><span class="annottext">ADExp
</span><a href="#local-6989586621679308134"><span class="hs-identifier hs-var">ann_exp</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1044"></span><span>
</span><span id="line-1045"></span><span class="hs-comment">-- promotes a term pattern into a type pattern, accumulating bound variable names</span><span>
</span><span id="line-1046"></span><span class="annot"><a href="Data.Singletons.TH.Promote.html#promotePat"><span class="hs-identifier hs-type">promotePat</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DPat</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Data.Singletons.TH.Util.html#QWithAux"><span class="hs-identifier hs-type">QWithAux</span></a></span><span> </span><span class="annot"><a href="Data.Singletons.TH.Syntax.html#PromDPatInfos"><span class="hs-identifier hs-type">PromDPatInfos</span></a></span><span> </span><span class="annot"><a href="Data.Singletons.TH.Promote.Monad.html#PrM"><span class="hs-identifier hs-type">PrM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DType</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.Singletons.TH.Syntax.html#ADPat"><span class="hs-identifier hs-type">ADPat</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1047"></span><span id="promotePat"><span class="annot"><span class="annottext">promotePat :: DPat -&gt; QWithAux PromDPatInfos PrM (DType, ADPat)
</span><a href="Data.Singletons.TH.Promote.html#promotePat"><span class="hs-identifier hs-var hs-var">promotePat</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DLitP</span></span><span> </span><span id="local-6989586621679308130"><span class="annot"><span class="annottext">Lit
</span><a href="#local-6989586621679308130"><span class="hs-identifier hs-var">lit</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Lit -&gt; ADPat
</span><a href="Data.Singletons.TH.Syntax.html#ADLitP"><span class="hs-identifier hs-var">ADLitP</span></a></span><span> </span><span class="annot"><span class="annottext">Lit
</span><a href="#local-6989586621679308130"><span class="hs-identifier hs-var">lit</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). MonadFail m =&gt; Lit -&gt; m DType
</span><a href="Data.Singletons.TH.Promote.html#promoteLitPat"><span class="hs-identifier hs-var">promoteLitPat</span></a></span><span> </span><span class="annot"><span class="annottext">Lit
</span><a href="#local-6989586621679308130"><span class="hs-identifier hs-var">lit</span></a></span><span>
</span><span id="line-1048"></span><span class="annot"><a href="Data.Singletons.TH.Promote.html#promotePat"><span class="hs-identifier hs-var">promotePat</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DVarP</span></span><span> </span><span id="local-6989586621679308126"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679308126"><span class="hs-identifier hs-var">name</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1049"></span><span>      </span><span class="hs-comment">-- term vars can be symbols... type vars can't!</span><span>
</span><span id="line-1050"></span><span>  </span><span id="local-6989586621679308125"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679308125"><span class="hs-identifier hs-var">tyName</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (q :: * -&gt; *). Quasi q =&gt; Name -&gt; q Name
</span><a href="Data.Singletons.TH.Names.html#mkTyName"><span class="hs-identifier hs-var">mkTyName</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679308126"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-1051"></span><span>  </span><span class="annot"><span class="annottext">forall w (m :: * -&gt; *). MonadWriter w m =&gt; w -&gt; m ()
</span><span class="hs-identifier hs-var">tell</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VarPromotions -&gt; OSet Name -&gt; PromDPatInfos
</span><a href="Data.Singletons.TH.Syntax.html#PromDPatInfos"><span class="hs-identifier hs-var">PromDPatInfos</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679308126"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679308125"><span class="hs-identifier hs-var">tyName</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">forall a. OSet a
</span><span class="hs-identifier hs-var">OSet.empty</span></span><span>
</span><span id="line-1052"></span><span>  </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; DType
</span><span class="hs-identifier hs-var">DVarT</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679308125"><span class="hs-identifier hs-var">tyName</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Name -&gt; ADPat
</span><a href="Data.Singletons.TH.Syntax.html#ADVarP"><span class="hs-identifier hs-var">ADVarP</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679308126"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1053"></span><span class="annot"><a href="Data.Singletons.TH.Promote.html#promotePat"><span class="hs-identifier hs-var">promotePat</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DConP</span></span><span> </span><span id="local-6989586621679308120"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679308120"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span id="local-6989586621679308119"><span class="annot"><span class="annottext">[DType]
</span><a href="#local-6989586621679308119"><span class="hs-identifier hs-var">tys</span></a></span></span><span> </span><span id="local-6989586621679308118"><span class="annot"><span class="annottext">[DPat]
</span><a href="#local-6989586621679308118"><span class="hs-identifier hs-var">pats</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1054"></span><span>  </span><span id="local-6989586621679308117"><span class="annot"><span class="annottext">Options
</span><a href="#local-6989586621679308117"><span class="hs-identifier hs-var">opts</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). OptionsMonad m =&gt; m Options
</span><a href="Data.Singletons.TH.Options.html#getOptions"><span class="hs-identifier hs-var">getOptions</span></a></span><span>
</span><span id="line-1055"></span><span>  </span><span id="local-6989586621679308116"><span class="annot"><span class="annottext">[DType]
</span><a href="#local-6989586621679308116"><span class="hs-identifier hs-var">kis</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f (t b)
</span><span class="hs-identifier hs-var">traverse</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (m :: * -&gt; *).
OptionsMonad m =&gt;
PromoteTypeOptions -&gt; DType -&gt; m DType
</span><a href="Data.Singletons.TH.Promote.Type.html#promoteType_options"><span class="hs-identifier hs-var">promoteType_options</span></a></span><span> </span><span class="annot"><span class="annottext">PromoteTypeOptions
</span><a href="#local-6989586621679308113"><span class="hs-identifier hs-var">conOptions</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[DType]
</span><a href="#local-6989586621679308119"><span class="hs-identifier hs-var">tys</span></a></span><span>
</span><span id="line-1056"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621679308112"><span class="annot"><span class="annottext">[DType]
</span><a href="#local-6989586621679308112"><span class="hs-identifier hs-var">types</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679308111"><span class="annot"><span class="annottext">[ADPat]
</span><a href="#local-6989586621679308111"><span class="hs-identifier hs-var">pats'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b c.
Applicative m =&gt;
(a -&gt; m (b, c)) -&gt; [a] -&gt; m ([b], [c])
</span><span class="hs-identifier hs-var">mapAndUnzipM</span></span><span> </span><span class="annot"><span class="annottext">DPat -&gt; QWithAux PromDPatInfos PrM (DType, ADPat)
</span><a href="Data.Singletons.TH.Promote.html#promotePat"><span class="hs-identifier hs-var">promotePat</span></a></span><span> </span><span class="annot"><span class="annottext">[DPat]
</span><a href="#local-6989586621679308118"><span class="hs-identifier hs-var">pats</span></a></span><span>
</span><span id="line-1057"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679308110"><span class="annot"><span class="annottext">name' :: Name
</span><a href="#local-6989586621679308110"><span class="hs-identifier hs-var hs-var">name'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Options -&gt; Name -&gt; Name
</span><a href="Data.Singletons.TH.Options.html#promotedDataTypeOrConName"><span class="hs-identifier hs-var">promotedDataTypeOrConName</span></a></span><span> </span><span class="annot"><span class="annottext">Options
</span><a href="#local-6989586621679308117"><span class="hs-identifier hs-var">opts</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679308120"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-1058"></span><span>  </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DType -&gt; [DType] -&gt; DType
</span><a href="Data.Singletons.TH.Util.html#foldType"><span class="hs-identifier hs-var">foldType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldl</span></span><span> </span><span class="annot"><span class="annottext">DType -&gt; DType -&gt; DType
</span><span class="hs-identifier hs-var">DAppKindT</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; DType
</span><span class="hs-identifier hs-var">DConT</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679308110"><span class="hs-identifier hs-var">name'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[DType]
</span><a href="#local-6989586621679308116"><span class="hs-identifier hs-var">kis</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[DType]
</span><a href="#local-6989586621679308112"><span class="hs-identifier hs-var">types</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Name -&gt; [DType] -&gt; [ADPat] -&gt; ADPat
</span><a href="Data.Singletons.TH.Syntax.html#ADConP"><span class="hs-identifier hs-var">ADConP</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679308120"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">[DType]
</span><a href="#local-6989586621679308116"><span class="hs-identifier hs-var">kis</span></a></span><span> </span><span class="annot"><span class="annottext">[ADPat]
</span><a href="#local-6989586621679308111"><span class="hs-identifier hs-var">pats'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1059"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1060"></span><span>    </span><span class="hs-comment">-- Currently, visible type patterns of data constructors are the one place</span><span>
</span><span id="line-1061"></span><span>    </span><span class="hs-comment">-- in `singletons-th` where it makes sense to promote wildcard types, as it</span><span>
</span><span id="line-1062"></span><span>    </span><span class="hs-comment">-- will produce code that GHC will accept.</span><span>
</span><span id="line-1063"></span><span>    </span><span class="annot"><a href="#local-6989586621679308113"><span class="hs-identifier hs-type">conOptions</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Data.Singletons.TH.Promote.Type.html#PromoteTypeOptions"><span class="hs-identifier hs-type">PromoteTypeOptions</span></a></span><span>
</span><span id="line-1064"></span><span>    </span><span id="local-6989586621679308113"><span class="annot"><span class="annottext">conOptions :: PromoteTypeOptions
</span><a href="#local-6989586621679308113"><span class="hs-identifier hs-var hs-var">conOptions</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PromoteTypeOptions
</span><a href="Data.Singletons.TH.Promote.Type.html#defaultPromoteTypeOptions"><span class="hs-identifier hs-var">defaultPromoteTypeOptions</span></a></span><span class="hs-special">{</span><span class="annot"><span class="annottext">ptoAllowWildcards :: Bool
</span><a href="Data.Singletons.TH.Promote.Type.html#ptoAllowWildcards"><span class="hs-identifier hs-var">ptoAllowWildcards</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">}</span><span>
</span><span id="line-1065"></span><span class="annot"><a href="Data.Singletons.TH.Promote.html#promotePat"><span class="hs-identifier hs-var">promotePat</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DTildeP</span></span><span> </span><span id="local-6989586621679308102"><span class="annot"><span class="annottext">DPat
</span><a href="#local-6989586621679308102"><span class="hs-identifier hs-var">pat</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1066"></span><span>  </span><span class="annot"><span class="annottext">forall (q :: * -&gt; *). Quasi q =&gt; String -&gt; q ()
</span><a href="Data.Singletons.TH.Util.html#qReportWarning"><span class="hs-identifier hs-var">qReportWarning</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Lazy pattern converted into regular pattern in promotion&quot;</span></span><span>
</span><span id="line-1067"></span><span>  </span><span class="annot"><span class="annottext">forall (a :: * -&gt; * -&gt; *) b c d.
Arrow a =&gt;
a b c -&gt; a (d, b) (d, c)
</span><span class="hs-identifier hs-var">second</span></span><span> </span><span class="annot"><span class="annottext">ADPat -&gt; ADPat
</span><a href="Data.Singletons.TH.Syntax.html#ADTildeP"><span class="hs-identifier hs-var">ADTildeP</span></a></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">DPat -&gt; QWithAux PromDPatInfos PrM (DType, ADPat)
</span><a href="Data.Singletons.TH.Promote.html#promotePat"><span class="hs-identifier hs-var">promotePat</span></a></span><span> </span><span class="annot"><span class="annottext">DPat
</span><a href="#local-6989586621679308102"><span class="hs-identifier hs-var">pat</span></a></span><span>
</span><span id="line-1068"></span><span class="annot"><a href="Data.Singletons.TH.Promote.html#promotePat"><span class="hs-identifier hs-var">promotePat</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DBangP</span></span><span> </span><span id="local-6989586621679308098"><span class="annot"><span class="annottext">DPat
</span><a href="#local-6989586621679308098"><span class="hs-identifier hs-var">pat</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1069"></span><span>  </span><span class="annot"><span class="annottext">forall (q :: * -&gt; *). Quasi q =&gt; String -&gt; q ()
</span><a href="Data.Singletons.TH.Util.html#qReportWarning"><span class="hs-identifier hs-var">qReportWarning</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Strict pattern converted into regular pattern in promotion&quot;</span></span><span>
</span><span id="line-1070"></span><span>  </span><span class="annot"><span class="annottext">forall (a :: * -&gt; * -&gt; *) b c d.
Arrow a =&gt;
a b c -&gt; a (d, b) (d, c)
</span><span class="hs-identifier hs-var">second</span></span><span> </span><span class="annot"><span class="annottext">ADPat -&gt; ADPat
</span><a href="Data.Singletons.TH.Syntax.html#ADBangP"><span class="hs-identifier hs-var">ADBangP</span></a></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">DPat -&gt; QWithAux PromDPatInfos PrM (DType, ADPat)
</span><a href="Data.Singletons.TH.Promote.html#promotePat"><span class="hs-identifier hs-var">promotePat</span></a></span><span> </span><span class="annot"><span class="annottext">DPat
</span><a href="#local-6989586621679308098"><span class="hs-identifier hs-var">pat</span></a></span><span>
</span><span id="line-1071"></span><span class="annot"><a href="Data.Singletons.TH.Promote.html#promotePat"><span class="hs-identifier hs-var">promotePat</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DSigP</span></span><span> </span><span id="local-6989586621679308095"><span class="annot"><span class="annottext">DPat
</span><a href="#local-6989586621679308095"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621679308094"><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621679308094"><span class="hs-identifier hs-var">ty</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1072"></span><span>  </span><span class="hs-comment">-- We must maintain the invariant that any promoted pattern signature must</span><span>
</span><span id="line-1073"></span><span>  </span><span class="hs-comment">-- not have any wildcards in the underlying pattern.</span><span>
</span><span id="line-1074"></span><span>  </span><span class="hs-comment">-- See Note [Singling pattern signatures].</span><span>
</span><span id="line-1075"></span><span>  </span><span id="local-6989586621679308093"><span class="annot"><span class="annottext">DPat
</span><a href="#local-6989586621679308093"><span class="hs-identifier hs-var">wildless_pat</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (q :: * -&gt; *). DsMonad q =&gt; DPat -&gt; q DPat
</span><span class="hs-identifier hs-var">removeWilds</span></span><span> </span><span class="annot"><span class="annottext">DPat
</span><a href="#local-6989586621679308095"><span class="hs-identifier hs-var">pat</span></a></span><span>
</span><span id="line-1076"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621679308091"><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621679308091"><span class="hs-identifier hs-var">promoted</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679308090"><span class="annot"><span class="annottext">ADPat
</span><a href="#local-6989586621679308090"><span class="hs-identifier hs-var">pat'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">DPat -&gt; QWithAux PromDPatInfos PrM (DType, ADPat)
</span><a href="Data.Singletons.TH.Promote.html#promotePat"><span class="hs-identifier hs-var">promotePat</span></a></span><span> </span><span class="annot"><span class="annottext">DPat
</span><a href="#local-6989586621679308093"><span class="hs-identifier hs-var">wildless_pat</span></a></span><span>
</span><span id="line-1077"></span><span>  </span><span id="local-6989586621679308089"><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621679308089"><span class="hs-identifier hs-var">ki</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). OptionsMonad m =&gt; DType -&gt; m DType
</span><a href="Data.Singletons.TH.Promote.Type.html#promoteType"><span class="hs-identifier hs-var">promoteType</span></a></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621679308094"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-1078"></span><span>  </span><span class="annot"><span class="annottext">forall w (m :: * -&gt; *). MonadWriter w m =&gt; w -&gt; m ()
</span><span class="hs-identifier hs-var">tell</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VarPromotions -&gt; OSet Name -&gt; PromDPatInfos
</span><a href="Data.Singletons.TH.Syntax.html#PromDPatInfos"><span class="hs-identifier hs-var">PromDPatInfos</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DType -&gt; OSet Name
</span><span class="hs-identifier hs-var">fvDType</span></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621679308089"><span class="hs-identifier hs-var">ki</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1079"></span><span>  </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DType -&gt; DType -&gt; DType
</span><span class="hs-identifier hs-var">DSigT</span></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621679308091"><span class="hs-identifier hs-var">promoted</span></a></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621679308089"><span class="hs-identifier hs-var">ki</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">DType -&gt; ADPat -&gt; DType -&gt; ADPat
</span><a href="Data.Singletons.TH.Syntax.html#ADSigP"><span class="hs-identifier hs-var">ADSigP</span></a></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621679308091"><span class="hs-identifier hs-var">promoted</span></a></span><span> </span><span class="annot"><span class="annottext">ADPat
</span><a href="#local-6989586621679308090"><span class="hs-identifier hs-var">pat'</span></a></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621679308089"><span class="hs-identifier hs-var">ki</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1080"></span><span class="annot"><a href="Data.Singletons.TH.Promote.html#promotePat"><span class="hs-identifier hs-var">promotePat</span></a></span><span> </span><span class="annot"><span class="annottext">DPat
</span><span class="hs-identifier hs-var">DWildP</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DType
</span><span class="hs-identifier hs-var">DWildCardT</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ADPat
</span><a href="Data.Singletons.TH.Syntax.html#ADWildP"><span class="hs-identifier hs-var">ADWildP</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1081"></span><span>
</span><span id="line-1082"></span><span class="annot"><a href="Data.Singletons.TH.Promote.html#promoteExp"><span class="hs-identifier hs-type">promoteExp</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DExp</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Data.Singletons.TH.Promote.Monad.html#PrM"><span class="hs-identifier hs-type">PrM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DType</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.Singletons.TH.Syntax.html#ADExp"><span class="hs-identifier hs-type">ADExp</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1083"></span><span id="promoteExp"><span class="annot"><span class="annottext">promoteExp :: DExp -&gt; PrM (DType, ADExp)
</span><a href="Data.Singletons.TH.Promote.html#promoteExp"><span class="hs-identifier hs-var hs-var">promoteExp</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DVarE</span></span><span> </span><span id="local-6989586621679308083"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679308083"><span class="hs-identifier hs-var">name</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Name -&gt; ADExp
</span><a href="Data.Singletons.TH.Syntax.html#ADVarE"><span class="hs-identifier hs-var">ADVarE</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679308083"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; PrM DType
</span><a href="Data.Singletons.TH.Promote.Monad.html#lookupVarE"><span class="hs-identifier hs-var">lookupVarE</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679308083"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-1084"></span><span class="annot"><a href="Data.Singletons.TH.Promote.html#promoteExp"><span class="hs-identifier hs-var">promoteExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DConE</span></span><span> </span><span id="local-6989586621679308080"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679308080"><span class="hs-identifier hs-var">name</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1085"></span><span>  </span><span id="local-6989586621679308079"><span class="annot"><span class="annottext">Options
</span><a href="#local-6989586621679308079"><span class="hs-identifier hs-var">opts</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). OptionsMonad m =&gt; m Options
</span><a href="Data.Singletons.TH.Options.html#getOptions"><span class="hs-identifier hs-var">getOptions</span></a></span><span>
</span><span id="line-1086"></span><span>  </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; DType
</span><span class="hs-identifier hs-var">DConT</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Options -&gt; Name -&gt; Name
</span><a href="Data.Singletons.TH.Options.html#defunctionalizedName0"><span class="hs-identifier hs-var">defunctionalizedName0</span></a></span><span> </span><span class="annot"><span class="annottext">Options
</span><a href="#local-6989586621679308079"><span class="hs-identifier hs-var">opts</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679308080"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Name -&gt; ADExp
</span><a href="Data.Singletons.TH.Syntax.html#ADConE"><span class="hs-identifier hs-var">ADConE</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679308080"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1087"></span><span class="annot"><a href="Data.Singletons.TH.Promote.html#promoteExp"><span class="hs-identifier hs-var">promoteExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DLitE</span></span><span> </span><span id="local-6989586621679308076"><span class="annot"><span class="annottext">Lit
</span><a href="#local-6989586621679308076"><span class="hs-identifier hs-var">lit</span></a></span></span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Lit -&gt; ADExp
</span><a href="Data.Singletons.TH.Syntax.html#ADLitE"><span class="hs-identifier hs-var">ADLitE</span></a></span><span> </span><span class="annot"><span class="annottext">Lit
</span><a href="#local-6989586621679308076"><span class="hs-identifier hs-var">lit</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall (q :: * -&gt; *). OptionsMonad q =&gt; Lit -&gt; q DType
</span><a href="Data.Singletons.TH.Promote.html#promoteLitExp"><span class="hs-identifier hs-var">promoteLitExp</span></a></span><span> </span><span class="annot"><span class="annottext">Lit
</span><a href="#local-6989586621679308076"><span class="hs-identifier hs-var">lit</span></a></span><span>
</span><span id="line-1088"></span><span class="annot"><a href="Data.Singletons.TH.Promote.html#promoteExp"><span class="hs-identifier hs-var">promoteExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DAppE</span></span><span> </span><span id="local-6989586621679308072"><span class="annot"><span class="annottext">DExp
</span><a href="#local-6989586621679308072"><span class="hs-identifier hs-var">exp1</span></a></span></span><span> </span><span id="local-6989586621679308071"><span class="annot"><span class="annottext">DExp
</span><a href="#local-6989586621679308071"><span class="hs-identifier hs-var">exp2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1089"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621679308070"><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621679308070"><span class="hs-identifier hs-var">exp1'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679308069"><span class="annot"><span class="annottext">ADExp
</span><a href="#local-6989586621679308069"><span class="hs-identifier hs-var">ann_exp1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">DExp -&gt; PrM (DType, ADExp)
</span><a href="Data.Singletons.TH.Promote.html#promoteExp"><span class="hs-identifier hs-var">promoteExp</span></a></span><span> </span><span class="annot"><span class="annottext">DExp
</span><a href="#local-6989586621679308072"><span class="hs-identifier hs-var">exp1</span></a></span><span>
</span><span id="line-1090"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621679308068"><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621679308068"><span class="hs-identifier hs-var">exp2'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679308067"><span class="annot"><span class="annottext">ADExp
</span><a href="#local-6989586621679308067"><span class="hs-identifier hs-var">ann_exp2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">DExp -&gt; PrM (DType, ADExp)
</span><a href="Data.Singletons.TH.Promote.html#promoteExp"><span class="hs-identifier hs-var">promoteExp</span></a></span><span> </span><span class="annot"><span class="annottext">DExp
</span><a href="#local-6989586621679308071"><span class="hs-identifier hs-var">exp2</span></a></span><span>
</span><span id="line-1091"></span><span>  </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DType -&gt; DType -&gt; DType
</span><a href="Data.Singletons.TH.Names.html#apply"><span class="hs-identifier hs-var">apply</span></a></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621679308070"><span class="hs-identifier hs-var">exp1'</span></a></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621679308068"><span class="hs-identifier hs-var">exp2'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ADExp -&gt; ADExp -&gt; ADExp
</span><a href="Data.Singletons.TH.Syntax.html#ADAppE"><span class="hs-identifier hs-var">ADAppE</span></a></span><span> </span><span class="annot"><span class="annottext">ADExp
</span><a href="#local-6989586621679308069"><span class="hs-identifier hs-var">ann_exp1</span></a></span><span> </span><span class="annot"><span class="annottext">ADExp
</span><a href="#local-6989586621679308067"><span class="hs-identifier hs-var">ann_exp2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1092"></span><span class="hs-comment">-- Until we get visible kind applications, this is the best we can do.</span><span>
</span><span id="line-1093"></span><span class="annot"><a href="Data.Singletons.TH.Promote.html#promoteExp"><span class="hs-identifier hs-var">promoteExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DAppTypeE</span></span><span> </span><span id="local-6989586621679308063"><span class="annot"><span class="annottext">DExp
</span><a href="#local-6989586621679308063"><span class="hs-identifier hs-var">exp</span></a></span></span><span> </span><span class="annot"><span class="annottext">DType
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1094"></span><span>  </span><span class="annot"><span class="annottext">forall (q :: * -&gt; *). Quasi q =&gt; String -&gt; q ()
</span><a href="Data.Singletons.TH.Util.html#qReportWarning"><span class="hs-identifier hs-var">qReportWarning</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Visible type applications are ignored by `singletons-th`.&quot;</span></span><span>
</span><span id="line-1095"></span><span>  </span><span class="annot"><span class="annottext">DExp -&gt; PrM (DType, ADExp)
</span><a href="Data.Singletons.TH.Promote.html#promoteExp"><span class="hs-identifier hs-var">promoteExp</span></a></span><span> </span><span class="annot"><span class="annottext">DExp
</span><a href="#local-6989586621679308063"><span class="hs-identifier hs-var">exp</span></a></span><span>
</span><span id="line-1096"></span><span class="annot"><a href="Data.Singletons.TH.Promote.html#promoteExp"><span class="hs-identifier hs-var">promoteExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DLamE</span></span><span> </span><span id="local-6989586621679308061"><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621679308061"><span class="hs-identifier hs-var">names</span></a></span></span><span> </span><span id="local-6989586621679308060"><span class="annot"><span class="annottext">DExp
</span><a href="#local-6989586621679308060"><span class="hs-identifier hs-var">exp</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1097"></span><span>  </span><span id="local-6989586621679308059"><span class="annot"><span class="annottext">Options
</span><a href="#local-6989586621679308059"><span class="hs-identifier hs-var">opts</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). OptionsMonad m =&gt; m Options
</span><a href="Data.Singletons.TH.Options.html#getOptions"><span class="hs-identifier hs-var">getOptions</span></a></span><span>
</span><span id="line-1098"></span><span>  </span><span id="local-6989586621679308058"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679308058"><span class="hs-identifier hs-var">lambdaName</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). Quasi m =&gt; String -&gt; m Name
</span><span class="hs-identifier hs-var">newUniqueName</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Lambda&quot;</span></span><span>
</span><span id="line-1099"></span><span>  </span><span id="local-6989586621679308057"><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621679308057"><span class="hs-identifier hs-var">tyNames</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">forall (q :: * -&gt; *). Quasi q =&gt; Name -&gt; q Name
</span><a href="Data.Singletons.TH.Names.html#mkTyName"><span class="hs-identifier hs-var">mkTyName</span></a></span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621679308061"><span class="hs-identifier hs-var">names</span></a></span><span>
</span><span id="line-1100"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679308056"><span class="annot"><span class="annottext">var_proms :: VarPromotions
</span><a href="#local-6989586621679308056"><span class="hs-identifier hs-var hs-var">var_proms</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621679308061"><span class="hs-identifier hs-var">names</span></a></span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621679308057"><span class="hs-identifier hs-var">tyNames</span></a></span><span>
</span><span id="line-1101"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621679308055"><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621679308055"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679308054"><span class="annot"><span class="annottext">ADExp
</span><a href="#local-6989586621679308054"><span class="hs-identifier hs-var">ann_exp</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall a. VarPromotions -&gt; PrM a -&gt; PrM a
</span><a href="Data.Singletons.TH.Promote.Monad.html#lambdaBind"><span class="hs-identifier hs-var">lambdaBind</span></a></span><span> </span><span class="annot"><span class="annottext">VarPromotions
</span><a href="#local-6989586621679308056"><span class="hs-identifier hs-var">var_proms</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">DExp -&gt; PrM (DType, ADExp)
</span><a href="Data.Singletons.TH.Promote.html#promoteExp"><span class="hs-identifier hs-var">promoteExp</span></a></span><span> </span><span class="annot"><span class="annottext">DExp
</span><a href="#local-6989586621679308060"><span class="hs-identifier hs-var">exp</span></a></span><span>
</span><span id="line-1102"></span><span>  </span><span id="local-6989586621679308053"><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621679308053"><span class="hs-identifier hs-var">all_locals</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). MonadReader PrEnv m =&gt; m [Name]
</span><a href="Data.Singletons.TH.Promote.Monad.html#allLocals"><span class="hs-identifier hs-var">allLocals</span></a></span><span>
</span><span id="line-1103"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679308052"><span class="annot"><span class="annottext">all_args :: [Name]
</span><a href="#local-6989586621679308052"><span class="hs-identifier hs-var hs-var">all_args</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621679308053"><span class="hs-identifier hs-var">all_locals</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621679308057"><span class="hs-identifier hs-var">tyNames</span></a></span><span>
</span><span id="line-1104"></span><span>      </span><span id="local-6989586621679308051"><span class="annot"><span class="annottext">tvbs :: [DTyVarBndrUnit]
</span><a href="#local-6989586621679308051"><span class="hs-identifier hs-var hs-var">tvbs</span></a></span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall flag. Name -&gt; flag -&gt; DTyVarBndr flag
</span><span class="hs-operator hs-var">`DPlainTV`</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621679308052"><span class="hs-identifier hs-var">all_args</span></a></span><span>
</span><span id="line-1105"></span><span>  </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). MonadWriter [DDec] m =&gt; [DDec] -&gt; m ()
</span><a href="Data.Singletons.TH.Promote.Monad.html#emitDecs"><span class="hs-identifier hs-var">emitDecs</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">DTypeFamilyHead -&gt; [DTySynEqn] -&gt; DDec
</span><span class="hs-identifier hs-var">DClosedTypeFamilyD</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name
-&gt; [DTyVarBndrUnit]
-&gt; DFamilyResultSig
-&gt; Maybe InjectivityAnn
-&gt; DTypeFamilyHead
</span><span class="hs-identifier hs-var">DTypeFamilyHead</span></span><span>
</span><span id="line-1106"></span><span>                                 </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679308058"><span class="hs-identifier hs-var">lambdaName</span></a></span><span>
</span><span id="line-1107"></span><span>                                 </span><span class="annot"><span class="annottext">[DTyVarBndrUnit]
</span><a href="#local-6989586621679308051"><span class="hs-identifier hs-var">tvbs</span></a></span><span>
</span><span id="line-1108"></span><span>                                 </span><span class="annot"><span class="annottext">DFamilyResultSig
</span><span class="hs-identifier hs-var">DNoSig</span></span><span>
</span><span id="line-1109"></span><span>                                 </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span>
</span><span id="line-1110"></span><span>                               </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Maybe [DTyVarBndrUnit] -&gt; DType -&gt; DType -&gt; DTySynEqn
</span><span class="hs-identifier hs-var">DTySynEqn</span></span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-1111"></span><span>                                          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DType -&gt; [DType] -&gt; DType
</span><a href="Data.Singletons.TH.Util.html#foldType"><span class="hs-identifier hs-var">foldType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; DType
</span><span class="hs-identifier hs-var">DConT</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679308058"><span class="hs-identifier hs-var">lambdaName</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1112"></span><span>                                           </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; DType
</span><span class="hs-identifier hs-var">DVarT</span></span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621679308052"><span class="hs-identifier hs-var">all_args</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1113"></span><span>                                          </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621679308055"><span class="hs-identifier hs-var">rhs</span></a></span><span class="hs-special">]</span><span class="hs-special">]</span><span>
</span><span id="line-1114"></span><span>  </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). MonadWriter [DDec] m =&gt; m [DDec] -&gt; m ()
</span><a href="Data.Singletons.TH.Promote.Monad.html#emitDecsM"><span class="hs-identifier hs-var">emitDecsM</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; Maybe Fixity -&gt; DefunKindInfo -&gt; PrM [DDec]
</span><a href="Data.Singletons.TH.Promote.Defun.html#defunctionalize"><span class="hs-identifier hs-var">defunctionalize</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679308058"><span class="hs-identifier hs-var">lambdaName</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[DTyVarBndrUnit] -&gt; Maybe DType -&gt; DefunKindInfo
</span><a href="Data.Singletons.TH.Promote.Defun.html#DefunNoSAK"><span class="hs-identifier hs-var">DefunNoSAK</span></a></span><span> </span><span class="annot"><span class="annottext">[DTyVarBndrUnit]
</span><a href="#local-6989586621679308051"><span class="hs-identifier hs-var">tvbs</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-1115"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679308049"><span class="annot"><span class="annottext">promLambda :: DType
</span><a href="#local-6989586621679308049"><span class="hs-identifier hs-var hs-var">promLambda</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldl</span></span><span> </span><span class="annot"><span class="annottext">DType -&gt; DType -&gt; DType
</span><a href="Data.Singletons.TH.Names.html#apply"><span class="hs-identifier hs-var">apply</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; DType
</span><span class="hs-identifier hs-var">DConT</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Options -&gt; Name -&gt; Int -&gt; Name
</span><a href="Data.Singletons.TH.Options.html#defunctionalizedName"><span class="hs-identifier hs-var">defunctionalizedName</span></a></span><span> </span><span class="annot"><span class="annottext">Options
</span><a href="#local-6989586621679308059"><span class="hs-identifier hs-var">opts</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679308058"><span class="hs-identifier hs-var">lambdaName</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1116"></span><span>                               </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; DType
</span><span class="hs-identifier hs-var">DVarT</span></span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621679308053"><span class="hs-identifier hs-var">all_locals</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1117"></span><span>  </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621679308049"><span class="hs-identifier hs-var">promLambda</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Name] -&gt; DType -&gt; [Name] -&gt; ADExp -&gt; ADExp
</span><a href="Data.Singletons.TH.Syntax.html#ADLamE"><span class="hs-identifier hs-var">ADLamE</span></a></span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621679308057"><span class="hs-identifier hs-var">tyNames</span></a></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621679308049"><span class="hs-identifier hs-var">promLambda</span></a></span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621679308061"><span class="hs-identifier hs-var">names</span></a></span><span> </span><span class="annot"><span class="annottext">ADExp
</span><a href="#local-6989586621679308054"><span class="hs-identifier hs-var">ann_exp</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1118"></span><span class="annot"><a href="Data.Singletons.TH.Promote.html#promoteExp"><span class="hs-identifier hs-var">promoteExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DCaseE</span></span><span> </span><span id="local-6989586621679308046"><span class="annot"><span class="annottext">DExp
</span><a href="#local-6989586621679308046"><span class="hs-identifier hs-var">exp</span></a></span></span><span> </span><span id="local-6989586621679308045"><span class="annot"><span class="annottext">[DMatch]
</span><a href="#local-6989586621679308045"><span class="hs-identifier hs-var">matches</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1119"></span><span>  </span><span id="local-6989586621679308044"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679308044"><span class="hs-identifier hs-var">caseTFName</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). Quasi m =&gt; String -&gt; m Name
</span><span class="hs-identifier hs-var">newUniqueName</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Case&quot;</span></span><span>
</span><span id="line-1120"></span><span>  </span><span id="local-6989586621679308043"><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621679308043"><span class="hs-identifier hs-var">all_locals</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). MonadReader PrEnv m =&gt; m [Name]
</span><a href="Data.Singletons.TH.Promote.Monad.html#allLocals"><span class="hs-identifier hs-var">allLocals</span></a></span><span>
</span><span id="line-1121"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679308042"><span class="annot"><span class="annottext">prom_case :: DType
</span><a href="#local-6989586621679308042"><span class="hs-identifier hs-var hs-var">prom_case</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DType -&gt; [DType] -&gt; DType
</span><a href="Data.Singletons.TH.Util.html#foldType"><span class="hs-identifier hs-var">foldType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; DType
</span><span class="hs-identifier hs-var">DConT</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679308044"><span class="hs-identifier hs-var">caseTFName</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; DType
</span><span class="hs-identifier hs-var">DVarT</span></span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621679308043"><span class="hs-identifier hs-var">all_locals</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1122"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621679308041"><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621679308041"><span class="hs-identifier hs-var">exp'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679308040"><span class="annot"><span class="annottext">ADExp
</span><a href="#local-6989586621679308040"><span class="hs-identifier hs-var">ann_exp</span></a></span></span><span class="hs-special">)</span><span>     </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">DExp -&gt; PrM (DType, ADExp)
</span><a href="Data.Singletons.TH.Promote.html#promoteExp"><span class="hs-identifier hs-var">promoteExp</span></a></span><span> </span><span class="annot"><span class="annottext">DExp
</span><a href="#local-6989586621679308046"><span class="hs-identifier hs-var">exp</span></a></span><span>
</span><span id="line-1123"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621679308039"><span class="annot"><span class="annottext">[DTySynEqn]
</span><a href="#local-6989586621679308039"><span class="hs-identifier hs-var">eqns</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679308038"><span class="annot"><span class="annottext">[ADMatch]
</span><a href="#local-6989586621679308038"><span class="hs-identifier hs-var">ann_matches</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b c.
Applicative m =&gt;
(a -&gt; m (b, c)) -&gt; [a] -&gt; m ([b], [c])
</span><span class="hs-identifier hs-var">mapAndUnzipM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DType -&gt; DMatch -&gt; PrM (DTySynEqn, ADMatch)
</span><a href="Data.Singletons.TH.Promote.html#promoteMatch"><span class="hs-identifier hs-var">promoteMatch</span></a></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621679308042"><span class="hs-identifier hs-var">prom_case</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[DMatch]
</span><a href="#local-6989586621679308045"><span class="hs-identifier hs-var">matches</span></a></span><span>
</span><span id="line-1124"></span><span>  </span><span id="local-6989586621679308037"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679308037"><span class="hs-identifier hs-var">tyvarName</span></a></span></span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). Quasi m =&gt; String -&gt; m Name
</span><span class="hs-identifier hs-var">qNewName</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;t&quot;</span></span><span>
</span><span id="line-1125"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679308036"><span class="annot"><span class="annottext">all_args :: [Name]
</span><a href="#local-6989586621679308036"><span class="hs-identifier hs-var hs-var">all_args</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621679308043"><span class="hs-identifier hs-var">all_locals</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679308037"><span class="hs-identifier hs-var">tyvarName</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1126"></span><span>      </span><span id="local-6989586621679308035"><span class="annot"><span class="annottext">tvbs :: [DTyVarBndrUnit]
</span><a href="#local-6989586621679308035"><span class="hs-identifier hs-var hs-var">tvbs</span></a></span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall flag. Name -&gt; flag -&gt; DTyVarBndr flag
</span><span class="hs-operator hs-var">`DPlainTV`</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621679308036"><span class="hs-identifier hs-var">all_args</span></a></span><span>
</span><span id="line-1127"></span><span>  </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). MonadWriter [DDec] m =&gt; [DDec] -&gt; m ()
</span><a href="Data.Singletons.TH.Promote.Monad.html#emitDecs"><span class="hs-identifier hs-var">emitDecs</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">DTypeFamilyHead -&gt; [DTySynEqn] -&gt; DDec
</span><span class="hs-identifier hs-var">DClosedTypeFamilyD</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name
-&gt; [DTyVarBndrUnit]
-&gt; DFamilyResultSig
-&gt; Maybe InjectivityAnn
-&gt; DTypeFamilyHead
</span><span class="hs-identifier hs-var">DTypeFamilyHead</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679308044"><span class="hs-identifier hs-var">caseTFName</span></a></span><span> </span><span class="annot"><span class="annottext">[DTyVarBndrUnit]
</span><a href="#local-6989586621679308035"><span class="hs-identifier hs-var">tvbs</span></a></span><span> </span><span class="annot"><span class="annottext">DFamilyResultSig
</span><span class="hs-identifier hs-var">DNoSig</span></span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[DTySynEqn]
</span><a href="#local-6989586621679308039"><span class="hs-identifier hs-var">eqns</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1128"></span><span>    </span><span class="hs-comment">-- See Note [Annotate case return type] in Single</span><span>
</span><span id="line-1129"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679308034"><span class="annot"><span class="annottext">applied_case :: DType
</span><a href="#local-6989586621679308034"><span class="hs-identifier hs-var hs-var">applied_case</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621679308042"><span class="hs-identifier hs-var">prom_case</span></a></span><span> </span><span class="annot"><span class="annottext">DType -&gt; DType -&gt; DType
</span><span class="hs-operator hs-var">`DAppT`</span></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621679308041"><span class="hs-identifier hs-var">exp'</span></a></span><span>
</span><span id="line-1130"></span><span>  </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621679308034"><span class="hs-identifier hs-var">applied_case</span></a></span><span>
</span><span id="line-1131"></span><span>         </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ADExp -&gt; [ADMatch] -&gt; DType -&gt; ADExp
</span><a href="Data.Singletons.TH.Syntax.html#ADCaseE"><span class="hs-identifier hs-var">ADCaseE</span></a></span><span> </span><span class="annot"><span class="annottext">ADExp
</span><a href="#local-6989586621679308040"><span class="hs-identifier hs-var">ann_exp</span></a></span><span> </span><span class="annot"><span class="annottext">[ADMatch]
</span><a href="#local-6989586621679308038"><span class="hs-identifier hs-var">ann_matches</span></a></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621679308034"><span class="hs-identifier hs-var">applied_case</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-1132"></span><span class="annot"><a href="Data.Singletons.TH.Promote.html#promoteExp"><span class="hs-identifier hs-var">promoteExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DLetE</span></span><span> </span><span id="local-6989586621679308031"><span class="annot"><span class="annottext">[DLetDec]
</span><a href="#local-6989586621679308031"><span class="hs-identifier hs-var">decs</span></a></span></span><span> </span><span id="local-6989586621679308030"><span class="annot"><span class="annottext">DExp
</span><a href="#local-6989586621679308030"><span class="hs-identifier hs-var">exp</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1133"></span><span>  </span><span id="local-6989586621679308029"><span class="annot"><span class="annottext">Uniq
</span><a href="#local-6989586621679308029"><span class="hs-identifier hs-var">unique</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (q :: * -&gt; *). DsMonad q =&gt; q Uniq
</span><a href="Data.Singletons.TH.Util.html#qNewUnique"><span class="hs-identifier hs-var">qNewUnique</span></a></span><span>
</span><span id="line-1134"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621679308027"><span class="annot"><span class="annottext">[LetBind]
</span><a href="#local-6989586621679308027"><span class="hs-identifier hs-var">binds</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679308026"><span class="annot"><span class="annottext">ALetDecEnv
</span><a href="#local-6989586621679308026"><span class="hs-identifier hs-var">ann_env</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Maybe Uniq -&gt; [DLetDec] -&gt; PrM ([LetBind], ALetDecEnv)
</span><a href="Data.Singletons.TH.Promote.html#promoteLetDecs"><span class="hs-identifier hs-var">promoteLetDecs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Uniq
</span><a href="#local-6989586621679308029"><span class="hs-identifier hs-var">unique</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[DLetDec]
</span><a href="#local-6989586621679308031"><span class="hs-identifier hs-var">decs</span></a></span><span>
</span><span id="line-1135"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621679308025"><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621679308025"><span class="hs-identifier hs-var">exp'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679308024"><span class="annot"><span class="annottext">ADExp
</span><a href="#local-6989586621679308024"><span class="hs-identifier hs-var">ann_exp</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall a. [LetBind] -&gt; PrM a -&gt; PrM a
</span><a href="Data.Singletons.TH.Promote.Monad.html#letBind"><span class="hs-identifier hs-var">letBind</span></a></span><span> </span><span class="annot"><span class="annottext">[LetBind]
</span><a href="#local-6989586621679308027"><span class="hs-identifier hs-var">binds</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">DExp -&gt; PrM (DType, ADExp)
</span><a href="Data.Singletons.TH.Promote.html#promoteExp"><span class="hs-identifier hs-var">promoteExp</span></a></span><span> </span><span class="annot"><span class="annottext">DExp
</span><a href="#local-6989586621679308030"><span class="hs-identifier hs-var">exp</span></a></span><span>
</span><span id="line-1136"></span><span>  </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621679308025"><span class="hs-identifier hs-var">exp'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ALetDecEnv -&gt; ADExp -&gt; ADExp
</span><a href="Data.Singletons.TH.Syntax.html#ADLetE"><span class="hs-identifier hs-var">ADLetE</span></a></span><span> </span><span class="annot"><span class="annottext">ALetDecEnv
</span><a href="#local-6989586621679308026"><span class="hs-identifier hs-var">ann_env</span></a></span><span> </span><span class="annot"><span class="annottext">ADExp
</span><a href="#local-6989586621679308024"><span class="hs-identifier hs-var">ann_exp</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1137"></span><span class="annot"><a href="Data.Singletons.TH.Promote.html#promoteExp"><span class="hs-identifier hs-var">promoteExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DSigE</span></span><span> </span><span id="local-6989586621679308021"><span class="annot"><span class="annottext">DExp
</span><a href="#local-6989586621679308021"><span class="hs-identifier hs-var">exp</span></a></span></span><span> </span><span id="local-6989586621679308020"><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621679308020"><span class="hs-identifier hs-var">ty</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1138"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621679308019"><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621679308019"><span class="hs-identifier hs-var">exp'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679308018"><span class="annot"><span class="annottext">ADExp
</span><a href="#local-6989586621679308018"><span class="hs-identifier hs-var">ann_exp</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">DExp -&gt; PrM (DType, ADExp)
</span><a href="Data.Singletons.TH.Promote.html#promoteExp"><span class="hs-identifier hs-var">promoteExp</span></a></span><span> </span><span class="annot"><span class="annottext">DExp
</span><a href="#local-6989586621679308021"><span class="hs-identifier hs-var">exp</span></a></span><span>
</span><span id="line-1139"></span><span>  </span><span id="local-6989586621679308017"><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621679308017"><span class="hs-identifier hs-var">ty'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). OptionsMonad m =&gt; DType -&gt; m DType
</span><a href="Data.Singletons.TH.Promote.Type.html#promoteType"><span class="hs-identifier hs-var">promoteType</span></a></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621679308020"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-1140"></span><span>  </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DType -&gt; DType -&gt; DType
</span><span class="hs-identifier hs-var">DSigT</span></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621679308019"><span class="hs-identifier hs-var">exp'</span></a></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621679308017"><span class="hs-identifier hs-var">ty'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">DType -&gt; ADExp -&gt; DType -&gt; ADExp
</span><a href="Data.Singletons.TH.Syntax.html#ADSigE"><span class="hs-identifier hs-var">ADSigE</span></a></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621679308019"><span class="hs-identifier hs-var">exp'</span></a></span><span> </span><span class="annot"><span class="annottext">ADExp
</span><a href="#local-6989586621679308018"><span class="hs-identifier hs-var">ann_exp</span></a></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621679308017"><span class="hs-identifier hs-var">ty'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1141"></span><span class="annot"><a href="Data.Singletons.TH.Promote.html#promoteExp"><span class="hs-identifier hs-var">promoteExp</span></a></span><span> </span><span id="local-6989586621679308015"><span class="annot"><span class="annottext">e :: DExp
</span><a href="#local-6989586621679308015"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DStaticE</span></span><span> </span><span class="annot"><span class="annottext">DExp
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadFail m =&gt; String -&gt; m a
</span><span class="hs-identifier hs-var">fail</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Static expressions cannot be promoted: &quot;</span></span><span> </span><span class="annot"><span class="annottext">forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">DExp
</span><a href="#local-6989586621679308015"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1142"></span><span>
</span><span id="line-1143"></span><span id="local-6989586621679309261"><span class="annot"><a href="Data.Singletons.TH.Promote.html#promoteLitExp"><span class="hs-identifier hs-type">promoteLitExp</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Data.Singletons.TH.Options.html#OptionsMonad"><span class="hs-identifier hs-type">OptionsMonad</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679309261"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Lit</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679309261"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">DType</span></span></span><span>
</span><span id="line-1144"></span><span id="promoteLitExp"><span class="annot"><span class="annottext">promoteLitExp :: forall (q :: * -&gt; *). OptionsMonad q =&gt; Lit -&gt; q DType
</span><a href="Data.Singletons.TH.Promote.html#promoteLitExp"><span class="hs-identifier hs-var hs-var">promoteLitExp</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">IntegerL</span></span><span> </span><span id="local-6989586621679307988"><span class="annot"><span class="annottext">Uniq
</span><a href="#local-6989586621679307988"><span class="hs-identifier hs-var">n</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1145"></span><span>  </span><span id="local-6989586621679307987"><span class="annot"><span class="annottext">Options
</span><a href="#local-6989586621679307987"><span class="hs-identifier hs-var">opts</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). OptionsMonad m =&gt; m Options
</span><a href="Data.Singletons.TH.Options.html#getOptions"><span class="hs-identifier hs-var">getOptions</span></a></span><span>
</span><span id="line-1146"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679307986"><span class="annot"><span class="annottext">tyFromIntegerName :: Name
</span><a href="#local-6989586621679307986"><span class="hs-identifier hs-var hs-var">tyFromIntegerName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Options -&gt; Name -&gt; Maybe Uniq -&gt; Name
</span><a href="Data.Singletons.TH.Options.html#promotedValueName"><span class="hs-identifier hs-var">promotedValueName</span></a></span><span> </span><span class="annot"><span class="annottext">Options
</span><a href="#local-6989586621679307987"><span class="hs-identifier hs-var">opts</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="Data.Singletons.TH.Names.html#fromIntegerName"><span class="hs-identifier hs-var">fromIntegerName</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-1147"></span><span>      </span><span id="local-6989586621679307984"><span class="annot"><span class="annottext">tyNegateName :: Name
</span><a href="#local-6989586621679307984"><span class="hs-identifier hs-var hs-var">tyNegateName</span></a></span></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Options -&gt; Name -&gt; Maybe Uniq -&gt; Name
</span><a href="Data.Singletons.TH.Options.html#promotedValueName"><span class="hs-identifier hs-var">promotedValueName</span></a></span><span> </span><span class="annot"><span class="annottext">Options
</span><a href="#local-6989586621679307987"><span class="hs-identifier hs-var">opts</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="Data.Singletons.TH.Names.html#negateName"><span class="hs-identifier hs-var">negateName</span></a></span><span>      </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-1148"></span><span>  </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Uniq
</span><a href="#local-6989586621679307988"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;=</span></span><span> </span><span class="annot"><span class="annottext">Uniq
</span><span class="hs-number">0</span></span><span>
</span><span id="line-1149"></span><span>     </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; DType
</span><span class="hs-identifier hs-var">DConT</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679307986"><span class="hs-identifier hs-var">tyFromIntegerName</span></a></span><span> </span><span class="annot"><span class="annottext">DType -&gt; DType -&gt; DType
</span><span class="hs-operator hs-var">`DAppT`</span></span><span> </span><span class="annot"><span class="annottext">TyLit -&gt; DType
</span><span class="hs-identifier hs-var">DLitT</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Uniq -&gt; TyLit
</span><span class="hs-identifier hs-var">NumTyLit</span></span><span> </span><span class="annot"><span class="annottext">Uniq
</span><a href="#local-6989586621679307988"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1150"></span><span>     </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; DType
</span><span class="hs-identifier hs-var">DConT</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679307984"><span class="hs-identifier hs-var">tyNegateName</span></a></span><span> </span><span class="annot"><span class="annottext">DType -&gt; DType -&gt; DType
</span><span class="hs-operator hs-var">`DAppT`</span></span><span>
</span><span id="line-1151"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; DType
</span><span class="hs-identifier hs-var">DConT</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679307986"><span class="hs-identifier hs-var">tyFromIntegerName</span></a></span><span> </span><span class="annot"><span class="annottext">DType -&gt; DType -&gt; DType
</span><span class="hs-operator hs-var">`DAppT`</span></span><span> </span><span class="annot"><span class="annottext">TyLit -&gt; DType
</span><span class="hs-identifier hs-var">DLitT</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Uniq -&gt; TyLit
</span><span class="hs-identifier hs-var">NumTyLit</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">-</span><span class="annot"><span class="annottext">Uniq
</span><a href="#local-6989586621679307988"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1152"></span><span class="annot"><a href="Data.Singletons.TH.Promote.html#promoteLitExp"><span class="hs-identifier hs-var">promoteLitExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">StringL</span></span><span> </span><span id="local-6989586621679307979"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679307979"><span class="hs-identifier hs-var">str</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1153"></span><span>  </span><span id="local-6989586621679307978"><span class="annot"><span class="annottext">Options
</span><a href="#local-6989586621679307978"><span class="hs-identifier hs-var">opts</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). OptionsMonad m =&gt; m Options
</span><a href="Data.Singletons.TH.Options.html#getOptions"><span class="hs-identifier hs-var">getOptions</span></a></span><span>
</span><span id="line-1154"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679307977"><span class="annot"><span class="annottext">prom_str_lit :: DType
</span><a href="#local-6989586621679307977"><span class="hs-identifier hs-var hs-var">prom_str_lit</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TyLit -&gt; DType
</span><span class="hs-identifier hs-var">DLitT</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; TyLit
</span><span class="hs-identifier hs-var">StrTyLit</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679307979"><span class="hs-identifier hs-var">str</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1155"></span><span>  </span><span id="local-6989586621679307975"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679307975"><span class="hs-identifier hs-var">os_enabled</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). Quasi m =&gt; Extension -&gt; m Bool
</span><span class="hs-identifier hs-var">qIsExtEnabled</span></span><span> </span><span class="annot"><span class="annottext">Extension
</span><span class="hs-identifier hs-var">LangExt.OverloadedStrings</span></span><span>
</span><span id="line-1156"></span><span>  </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679307975"><span class="hs-identifier hs-var">os_enabled</span></a></span><span>
</span><span id="line-1157"></span><span>         </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Name -&gt; DType
</span><span class="hs-identifier hs-var">DConT</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Options -&gt; Name -&gt; Maybe Uniq -&gt; Name
</span><a href="Data.Singletons.TH.Options.html#promotedValueName"><span class="hs-identifier hs-var">promotedValueName</span></a></span><span> </span><span class="annot"><span class="annottext">Options
</span><a href="#local-6989586621679307978"><span class="hs-identifier hs-var">opts</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="Data.Singletons.TH.Names.html#fromStringName"><span class="hs-identifier hs-var">fromStringName</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">DType -&gt; DType -&gt; DType
</span><span class="hs-operator hs-var">`DAppT`</span></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621679307977"><span class="hs-identifier hs-var">prom_str_lit</span></a></span><span>
</span><span id="line-1158"></span><span>         </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621679307977"><span class="hs-identifier hs-var">prom_str_lit</span></a></span><span>
</span><span id="line-1159"></span><span class="annot"><a href="Data.Singletons.TH.Promote.html#promoteLitExp"><span class="hs-identifier hs-var">promoteLitExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">CharL</span></span><span> </span><span id="local-6989586621679307970"><span class="annot"><span class="annottext">Char
</span><a href="#local-6989586621679307970"><span class="hs-identifier hs-var">c</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TyLit -&gt; DType
</span><span class="hs-identifier hs-var">DLitT</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Char -&gt; TyLit
</span><span class="hs-identifier hs-var">CharTyLit</span></span><span> </span><span class="annot"><span class="annottext">Char
</span><a href="#local-6989586621679307970"><span class="hs-identifier hs-var">c</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1160"></span><span class="annot"><a href="Data.Singletons.TH.Promote.html#promoteLitExp"><span class="hs-identifier hs-var">promoteLitExp</span></a></span><span> </span><span id="local-6989586621679307968"><span class="annot"><span class="annottext">Lit
</span><a href="#local-6989586621679307968"><span class="hs-identifier hs-var">lit</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1161"></span><span>  </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadFail m =&gt; String -&gt; m a
</span><span class="hs-identifier hs-var">fail</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Only string, natural number, and character literals can be promoted: &quot;</span></span><span> </span><span class="annot"><span class="annottext">forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Lit
</span><a href="#local-6989586621679307968"><span class="hs-identifier hs-var">lit</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1162"></span><span>
</span><span id="line-1163"></span><span id="local-6989586621679309278"><span class="annot"><a href="Data.Singletons.TH.Promote.html#promoteLitPat"><span class="hs-identifier hs-type">promoteLitPat</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadFail</span></span><span> </span><span class="annot"><a href="#local-6989586621679309278"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Lit</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679309278"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">DType</span></span></span><span>
</span><span id="line-1164"></span><span id="promoteLitPat"><span class="annot"><span class="annottext">promoteLitPat :: forall (m :: * -&gt; *). MonadFail m =&gt; Lit -&gt; m DType
</span><a href="Data.Singletons.TH.Promote.html#promoteLitPat"><span class="hs-identifier hs-var hs-var">promoteLitPat</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">IntegerL</span></span><span> </span><span id="local-6989586621679307957"><span class="annot"><span class="annottext">Uniq
</span><a href="#local-6989586621679307957"><span class="hs-identifier hs-var">n</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1165"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Uniq
</span><a href="#local-6989586621679307957"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;=</span></span><span> </span><span class="annot"><span class="annottext">Uniq
</span><span class="hs-number">0</span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TyLit -&gt; DType
</span><span class="hs-identifier hs-var">DLitT</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Uniq -&gt; TyLit
</span><span class="hs-identifier hs-var">NumTyLit</span></span><span> </span><span class="annot"><span class="annottext">Uniq
</span><a href="#local-6989586621679307957"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1166"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1167"></span><span>    </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadFail m =&gt; String -&gt; m a
</span><span class="hs-identifier hs-var">fail</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Negative literal patterns are not allowed,\n&quot;</span></span><span> </span><span class="annot"><span class="annottext">forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span>
</span><span id="line-1168"></span><span>           </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;because literal patterns are promoted to natural numbers.&quot;</span></span><span>
</span><span id="line-1169"></span><span class="annot"><a href="Data.Singletons.TH.Promote.html#promoteLitPat"><span class="hs-identifier hs-var">promoteLitPat</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">StringL</span></span><span> </span><span id="local-6989586621679307956"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679307956"><span class="hs-identifier hs-var">str</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TyLit -&gt; DType
</span><span class="hs-identifier hs-var">DLitT</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; TyLit
</span><span class="hs-identifier hs-var">StrTyLit</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679307956"><span class="hs-identifier hs-var">str</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1170"></span><span class="annot"><a href="Data.Singletons.TH.Promote.html#promoteLitPat"><span class="hs-identifier hs-var">promoteLitPat</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">CharL</span></span><span> </span><span id="local-6989586621679307955"><span class="annot"><span class="annottext">Char
</span><a href="#local-6989586621679307955"><span class="hs-identifier hs-var">c</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TyLit -&gt; DType
</span><span class="hs-identifier hs-var">DLitT</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Char -&gt; TyLit
</span><span class="hs-identifier hs-var">CharTyLit</span></span><span> </span><span class="annot"><span class="annottext">Char
</span><a href="#local-6989586621679307955"><span class="hs-identifier hs-var">c</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1171"></span><span class="annot"><a href="Data.Singletons.TH.Promote.html#promoteLitPat"><span class="hs-identifier hs-var">promoteLitPat</span></a></span><span> </span><span id="local-6989586621679307954"><span class="annot"><span class="annottext">Lit
</span><a href="#local-6989586621679307954"><span class="hs-identifier hs-var">lit</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1172"></span><span>  </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadFail m =&gt; String -&gt; m a
</span><span class="hs-identifier hs-var">fail</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Only string, natural number, and character literals can be promoted: &quot;</span></span><span> </span><span class="annot"><span class="annottext">forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Lit
</span><a href="#local-6989586621679307954"><span class="hs-identifier hs-var">lit</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1173"></span></pre></body></html>