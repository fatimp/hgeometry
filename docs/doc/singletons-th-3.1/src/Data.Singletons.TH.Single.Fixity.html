<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables #-}</span><span>
</span><span id="line-2"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Data.Singletons.TH.Single.Fixity</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-3"></span><span>
</span><span id="line-4"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Prelude</span></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier">exp</span></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-5"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Language.Haskell.TH</span></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier">cxt</span></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-6"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Language.Haskell.TH.Syntax</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">NameSpace</span></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">Quasi</span></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-7"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Data.Singletons.TH.Options.html"><span class="hs-identifier">Data.Singletons.TH.Options</span></a></span><span>
</span><span id="line-8"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Data.Singletons.TH.Util.html"><span class="hs-identifier">Data.Singletons.TH.Util</span></a></span><span>
</span><span id="line-9"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Language.Haskell.TH.Desugar</span></span><span>
</span><span id="line-10"></span><span>
</span><span id="line-11"></span><span class="hs-comment">-- Single a fixity declaration.</span><span>
</span><span id="line-12"></span><span class="annot"><a href="Data.Singletons.TH.Single.Fixity.html#singInfixDecl"><span class="hs-identifier hs-type">singInfixDecl</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679302128"><span class="annot"><a href="#local-6989586621679302128"><span class="hs-identifier hs-type">q</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="Data.Singletons.TH.Options.html#OptionsMonad"><span class="hs-identifier hs-type">OptionsMonad</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679302128"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Fixity</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679302128"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">DLetDec</span></span><span class="hs-special">)</span><span>
</span><span id="line-13"></span><span id="singInfixDecl"><span class="annot"><span class="annottext">singInfixDecl :: forall (q :: * -&gt; *).
OptionsMonad q =&gt;
Name -&gt; Fixity -&gt; q (Maybe DLetDec)
</span><a href="Data.Singletons.TH.Single.Fixity.html#singInfixDecl"><span class="hs-identifier hs-var hs-var">singInfixDecl</span></a></span></span><span> </span><span id="local-6989586621679302072"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679302072"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span id="local-6989586621679302071"><span class="annot"><span class="annottext">Fixity
</span><a href="#local-6989586621679302071"><span class="hs-identifier hs-var">fixity</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-14"></span><span>  </span><span id="local-6989586621679302070"><span class="annot"><span class="annottext">Options
</span><a href="#local-6989586621679302070"><span class="hs-identifier hs-var">opts</span></a></span></span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). OptionsMonad m =&gt; m Options
</span><a href="Data.Singletons.TH.Options.html#getOptions"><span class="hs-identifier hs-var">getOptions</span></a></span><span>
</span><span id="line-15"></span><span>  </span><span id="local-6989586621679302068"><span class="annot"><span class="annottext">Maybe NameSpace
</span><a href="#local-6989586621679302068"><span class="hs-identifier hs-var">mb_ns</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (q :: * -&gt; *). DsMonad q =&gt; Name -&gt; q (Maybe NameSpace)
</span><span class="hs-identifier hs-var">reifyNameSpace</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679302072"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-16"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe NameSpace
</span><a href="#local-6989586621679302068"><span class="hs-identifier hs-var">mb_ns</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-17"></span><span>    </span><span class="hs-comment">-- If we can't find the Name for some odd reason,</span><span>
</span><span id="line-18"></span><span>    </span><span class="hs-comment">-- fall back to singValName</span><span>
</span><span id="line-19"></span><span>    </span><span class="annot"><span class="annottext">Maybe NameSpace
</span><span class="hs-identifier hs-var">Nothing</span></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Name -&gt; q (Maybe DLetDec)
</span><a href="#local-6989586621679302066"><span class="hs-identifier hs-var">finish</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Options -&gt; Name -&gt; Name
</span><a href="Data.Singletons.TH.Options.html#singledValueName"><span class="hs-identifier hs-var">singledValueName</span></a></span><span>   </span><span class="annot"><span class="annottext">Options
</span><a href="#local-6989586621679302070"><span class="hs-identifier hs-var">opts</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679302072"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-20"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">NameSpace
</span><span class="hs-identifier hs-var">VarName</span></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Name -&gt; q (Maybe DLetDec)
</span><a href="#local-6989586621679302066"><span class="hs-identifier hs-var">finish</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Options -&gt; Name -&gt; Name
</span><a href="Data.Singletons.TH.Options.html#singledValueName"><span class="hs-identifier hs-var">singledValueName</span></a></span><span>   </span><span class="annot"><span class="annottext">Options
</span><a href="#local-6989586621679302070"><span class="hs-identifier hs-var">opts</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679302072"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-21"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">NameSpace
</span><span class="hs-identifier hs-var">DataName</span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Name -&gt; q (Maybe DLetDec)
</span><a href="#local-6989586621679302066"><span class="hs-identifier hs-var">finish</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Options -&gt; Name -&gt; Name
</span><a href="Data.Singletons.TH.Options.html#singledDataConName"><span class="hs-identifier hs-var">singledDataConName</span></a></span><span> </span><span class="annot"><span class="annottext">Options
</span><a href="#local-6989586621679302070"><span class="hs-identifier hs-var">opts</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679302072"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-22"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">NameSpace
</span><span class="hs-identifier hs-var">TcClsName</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-23"></span><span>      </span><span id="local-6989586621679302060"><span class="annot"><span class="annottext">Maybe DInfo
</span><a href="#local-6989586621679302060"><span class="hs-identifier hs-var">mb_info</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (q :: * -&gt; *). DsMonad q =&gt; Name -&gt; q (Maybe DInfo)
</span><span class="hs-identifier hs-var">dsReify</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679302072"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-24"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe DInfo
</span><a href="#local-6989586621679302060"><span class="hs-identifier hs-var">mb_info</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-25"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DTyConI</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">DClassD</span></span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="annot"><span class="annottext">Maybe [DDec]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>
</span><span id="line-26"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Name -&gt; q (Maybe DLetDec)
</span><a href="#local-6989586621679302066"><span class="hs-identifier hs-var">finish</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Options -&gt; Name -&gt; Name
</span><a href="Data.Singletons.TH.Options.html#singledClassName"><span class="hs-identifier hs-var">singledClassName</span></a></span><span> </span><span class="annot"><span class="annottext">Options
</span><a href="#local-6989586621679302070"><span class="hs-identifier hs-var">opts</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679302072"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-27"></span><span>        </span><span class="annot"><span class="annottext">Maybe DInfo
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-28"></span><span>          </span><span class="hs-comment">-- Don't produce anything for other type constructors (type synonyms,</span><span>
</span><span id="line-29"></span><span>          </span><span class="hs-comment">-- type families, data types, etc.).</span><span>
</span><span id="line-30"></span><span>          </span><span class="hs-comment">-- See [singletons-th and fixity declarations], wrinkle 1.</span><span>
</span><span id="line-31"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-32"></span><span>    </span><span class="annot"><a href="#local-6989586621679302066"><span class="hs-identifier hs-type">finish</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679302128"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">DLetDec</span></span><span class="hs-special">)</span><span>
</span><span id="line-33"></span><span>    </span><span id="local-6989586621679302066"><span class="annot"><span class="annottext">finish :: Name -&gt; q (Maybe DLetDec)
</span><a href="#local-6989586621679302066"><span class="hs-identifier hs-var hs-var">finish</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Fixity -&gt; Name -&gt; DLetDec
</span><span class="hs-identifier hs-var">DInfixD</span></span><span> </span><span class="annot"><span class="annottext">Fixity
</span><a href="#local-6989586621679302071"><span class="hs-identifier hs-var">fixity</span></a></span><span>
</span><span id="line-34"></span><span>
</span><span id="line-35"></span><span class="hs-comment">-- Try producing singled fixity declarations for Names by reifying them</span><span>
</span><span id="line-36"></span><span class="hs-comment">-- /without/ consulting quoted declarations. If reification fails, recover and</span><span>
</span><span id="line-37"></span><span class="hs-comment">-- return the empty list.</span><span>
</span><span id="line-38"></span><span class="hs-comment">-- See [singletons-th and fixity declarations], wrinkle 2.</span><span>
</span><span id="line-39"></span><span class="annot"><a href="Data.Singletons.TH.Single.Fixity.html#singReifiedInfixDecls"><span class="hs-identifier hs-type">singReifiedInfixDecls</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679302103"><span class="annot"><a href="#local-6989586621679302103"><span class="hs-identifier hs-type">q</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="Data.Singletons.TH.Options.html#OptionsMonad"><span class="hs-identifier hs-type">OptionsMonad</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679302103"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679302103"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">DDec</span></span><span class="hs-special">]</span><span>
</span><span id="line-40"></span><span id="singReifiedInfixDecls"><span class="annot"><span class="annottext">singReifiedInfixDecls :: forall (q :: * -&gt; *). OptionsMonad q =&gt; [Name] -&gt; q [DDec]
</span><a href="Data.Singletons.TH.Single.Fixity.html#singReifiedInfixDecls"><span class="hs-identifier hs-var hs-var">singReifiedInfixDecls</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b.
Monad m =&gt;
(a -&gt; m (Maybe b)) -&gt; [a] -&gt; m [b]
</span><a href="Data.Singletons.TH.Util.html#mapMaybeM"><span class="hs-identifier hs-var">mapMaybeM</span></a></span><span> </span><span class="annot"><span class="annottext">Name -&gt; q (Maybe DDec)
</span><a href="#local-6989586621679302032"><span class="hs-identifier hs-var">trySingFixityDeclaration</span></a></span><span>
</span><span id="line-41"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-42"></span><span>    </span><span class="annot"><a href="#local-6989586621679302032"><span class="hs-identifier hs-type">trySingFixityDeclaration</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679302103"><span class="hs-identifier hs-type">q</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">DDec</span></span><span class="hs-special">)</span><span>
</span><span id="line-43"></span><span>    </span><span id="local-6989586621679302032"><span class="annot"><span class="annottext">trySingFixityDeclaration :: Name -&gt; q (Maybe DDec)
</span><a href="#local-6989586621679302032"><span class="hs-identifier hs-var hs-var">trySingFixityDeclaration</span></a></span></span><span> </span><span id="local-6989586621679302031"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679302031"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-44"></span><span>      </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Quasi m =&gt; m a -&gt; m a -&gt; m a
</span><span class="hs-identifier hs-var">qRecover</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-45"></span><span>        </span><span id="local-6989586621679302029"><span class="annot"><span class="annottext">Maybe Fixity
</span><a href="#local-6989586621679302029"><span class="hs-identifier hs-var">mFixity</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *). Quasi m =&gt; Name -&gt; m (Maybe Fixity)
</span><span class="hs-identifier hs-var">qReifyFixity</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679302031"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-46"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe Fixity
</span><a href="#local-6989586621679302029"><span class="hs-identifier hs-var">mFixity</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-47"></span><span>          </span><span class="annot"><span class="annottext">Maybe Fixity
</span><span class="hs-identifier hs-var">Nothing</span></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-48"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679302027"><span class="annot"><span class="annottext">Fixity
</span><a href="#local-6989586621679302027"><span class="hs-identifier hs-var">fixity</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">DLetDec -&gt; DDec
</span><span class="hs-identifier hs-var">DLetDec</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">forall (q :: * -&gt; *).
OptionsMonad q =&gt;
Name -&gt; Fixity -&gt; q (Maybe DLetDec)
</span><a href="Data.Singletons.TH.Single.Fixity.html#singInfixDecl"><span class="hs-identifier hs-var">singInfixDecl</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679302031"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">Fixity
</span><a href="#local-6989586621679302027"><span class="hs-identifier hs-var">fixity</span></a></span><span>
</span><span id="line-49"></span><span>
</span><span id="line-50"></span><span class="hs-comment">{-
Note [singletons-th and fixity declarations]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Promoting and singling fixity declarations is surprisingly tricky to get right.
This Note serves as a place to document the insights learned after getting this
wrong at various points.

As a general rule, when promoting something with a fixity declaration like this
one:

  infixl 5 `foo`

singletons-th will produce promoted and singled versions of them:

  infixl 5 `Foo`
  infixl 5 `sFoo`

singletons-th will also produce fixity declarations for its defunctionalization
symbols (see Note [Fixity declarations for defunctionalization symbols] in
D.S.TH.Promote.Defun):

  infixl 5 `FooSym0`
  infixl 5 `FooSym1`
  ...

-----
-- Wrinkle 1: When not to promote/single fixity declarations
-----

Rules are meant to be broken, and the general rule above is no exception. There
are certain cases where singletons-th does *not* produce promoted or singled
versions of fixity declarations:

* During promotion, fixity declarations for the following sorts of names will
  not receive promoted counterparts:

  - Data types
  - Type synonyms
  - Type families
  - Data constructors
  - Infix values

  We exclude the first four because the promoted versions of these names are
  the same as the originals, so generating an extra fixity declaration for them
  would run the risk of having duplicates, which GHC would reject with an error.

  We exclude infix value because while their promoted versions are different,
  they share the same name base. In concrete terms, this:

    $(promote [d|
      infixl 4 ###
      (###) :: a -&gt; a -&gt; a
      |])

  Is promoted to the following:

    type family (###) (x :: a) (y :: a) :: a where ...

  So giving the type-level (###) a fixity declaration would clash with the
  existing one for the value-level (###).

  There *is* a scenario where we should generate a fixity declaration for the
  type-level (###), however. Imagine the above example used the `promoteOnly`
  function instead of `promote`. Then the type-level (###) would lack a fixity
  declaration altogether because the original fixity declaration was discarded
  by `promoteOnly`! The same problem would arise if one had to choose between
  the `singletons` and `singletonsOnly` functions.

  The difference between `promote` and `promoteOnly` (as well as `singletons`
  and `singletonsOnly`) is whether the `genQuotedDecs` option is set to `True`
  or `False`, respectively. Therefore, if `genQuotedDecs` is set to `False`
  when promoting the fixity declaration for an infix value, we opt to generate
  a fixity declaration (with the same name base) so that the type-level version
  of that value gets one.

* During singling, the following things will not have their fixity declarations
  singled:

  - Type synonyms or type families. This is because singletons-th does not
    generate singled versions of them in the first place (they only receive
    defunctionalization symbols).

  - Data types. This is because the singled version of a data type T is
    always of the form:

      data ST :: forall a_1 ... a_n. T a_1 ... a_n -&gt; Type where ...

    Regardless of how many arguments T has, ST will have exactly one argument.
    This makes is rather pointless to generate a fixity declaration for it.

-----
-- Wrinkle 2: Making sure fixity declarations are promoted/singled properly
-----

There are two situations where singletons-th must promote/single fixity
declarations:

1. When quoting code, i.e., with `promote` or `singletons`.
2. When reifying code, i.e., with `genPromotions` or `genSingletons`.

In the case of (1), singletons-th stores the quoted fixity declarations in the
lde_infix field of LetDecEnv. Therefore, it suffices to call
promoteInfixDecl/singleInfixDecl when processing LetDecEnvs.

In the case of (2), there is no LetDecEnv to use, so we must instead reify
the fixity declarations and promote/single those. See D.S.TH.Single.Data.singDataD
(which singles data constructors) for a place that does this&#8212;we will use
singDataD as a running example for the rest of this section.

One complication is that code paths like singDataD are invoked in both (1) and
(2). This runs the risk that singletons-th will generate duplicate infix
declarations for data constructors in situation (1), as it will try to single
their fixity declarations once when processing them in LetDecEnvs and again
when reifying them in singDataD.

To avoid this pitfall, when reifying declarations in singDataD we take care
*not* to consult any quoted declarations when reifying (i.e., we do not use
reifyWithLocals for functions like it). Therefore, it we are in situation (1),
then the reification in singDataD will fail (and recover gracefully), so it
will not produce any singled fixity declarations. Therefore, the only singled
fixity declarations will be produced by processing LetDecEnvs.
-}</span><span>
</span><span id="line-172"></span></pre></body></html>