<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">{- Data/Singletons/Promote/Defun.hs

(c) Richard Eisenberg, Jan Stolarek 2014
rae@cs.brynmawr.edu

This file creates defunctionalization symbols for types during promotion.
-}</span><span>
</span><span id="line-8"></span><span>
</span><span id="line-9"></span><span class="hs-pragma">{-# LANGUAGE TemplateHaskell #-}</span><span>
</span><span id="line-10"></span><span>
</span><span id="line-11"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Data.Singletons.Promote.Defun</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-12"></span><span>
</span><span id="line-13"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Language.Haskell.TH.Desugar</span></span><span>
</span><span id="line-14"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Data.Singletons.Promote.Monad.html"><span class="hs-identifier">Data.Singletons.Promote.Monad</span></a></span><span>
</span><span id="line-15"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Data.Singletons.Promote.Type.html"><span class="hs-identifier">Data.Singletons.Promote.Type</span></a></span><span>
</span><span id="line-16"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Data.Singletons.Names.html"><span class="hs-identifier">Data.Singletons.Names</span></a></span><span>
</span><span id="line-17"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Language.Haskell.TH.Syntax</span></span><span>
</span><span id="line-18"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Data.Singletons.Syntax.html"><span class="hs-identifier">Data.Singletons.Syntax</span></a></span><span>
</span><span id="line-19"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Data.Singletons.TH.Options.html"><span class="hs-identifier">Data.Singletons.TH.Options</span></a></span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Data.Singletons.Util.html"><span class="hs-identifier">Data.Singletons.Util</span></a></span><span>
</span><span id="line-21"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad</span></span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Map.Strict</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Map</span></span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Map.Strict</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Map</span></span><span class="hs-special">)</span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Maybe</span></span><span>
</span><span id="line-25"></span><span>
</span><span id="line-26"></span><span class="annot"><a href="Data.Singletons.Promote.Defun.html#defunInfo"><span class="hs-identifier hs-type">defunInfo</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DInfo</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Data.Singletons.Promote.Monad.html#PrM"><span class="hs-identifier hs-type">PrM</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">DDec</span></span><span class="hs-special">]</span><span>
</span><span id="line-27"></span><span id="defunInfo"><span class="annot"><span class="annottext">defunInfo :: DInfo -&gt; PrM [DDec]
</span><a href="Data.Singletons.Promote.Defun.html#defunInfo"><span class="hs-identifier hs-var hs-var">defunInfo</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DTyConI</span></span><span> </span><span id="local-6989586621681358540"><span class="annot"><span class="annottext">DDec
</span><a href="#local-6989586621681358540"><span class="hs-identifier hs-var">dec</span></a></span></span><span> </span><span id="local-6989586621681358539"><span class="annot"><span class="annottext">Maybe [DDec]
</span><a href="#local-6989586621681358539"><span class="hs-identifier hs-var">_instances</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DDec -&gt; PrM [DDec]
</span><a href="Data.Singletons.Promote.Defun.html#buildDefunSyms"><span class="hs-identifier hs-var">buildDefunSyms</span></a></span><span> </span><span class="annot"><span class="annottext">DDec
</span><a href="#local-6989586621681358540"><span class="hs-identifier hs-var">dec</span></a></span><span>
</span><span id="line-28"></span><span class="annot"><a href="Data.Singletons.Promote.Defun.html#defunInfo"><span class="hs-identifier hs-var">defunInfo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DPrimTyConI</span></span><span> </span><span id="local-6989586621681358536"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681358536"><span class="hs-identifier hs-var">_name</span></a></span></span><span> </span><span id="local-6989586621681358535"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681358535"><span class="hs-identifier hs-var">_numArgs</span></a></span></span><span> </span><span id="local-6989586621681358534"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681358534"><span class="hs-identifier hs-var">_unlifted</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-29"></span><span>  </span><span class="annot"><span class="annottext">String -&gt; PrM [DDec]
forall (m :: * -&gt; *) a. MonadFail m =&gt; String -&gt; m a
</span><span class="hs-identifier hs-var">fail</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; PrM [DDec]) -&gt; String -&gt; PrM [DDec]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Building defunctionalization symbols of primitive &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span>
</span><span id="line-30"></span><span>         </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;type constructors not supported&quot;</span></span><span>
</span><span id="line-31"></span><span class="annot"><a href="Data.Singletons.Promote.Defun.html#defunInfo"><span class="hs-identifier hs-var">defunInfo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DVarI</span></span><span> </span><span id="local-6989586621681358532"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681358532"><span class="hs-identifier hs-var">_name</span></a></span></span><span> </span><span id="local-6989586621681358531"><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681358531"><span class="hs-identifier hs-var">_ty</span></a></span></span><span> </span><span id="local-6989586621681358530"><span class="annot"><span class="annottext">Maybe Name
</span><a href="#local-6989586621681358530"><span class="hs-identifier hs-var">_mdec</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-32"></span><span>  </span><span class="annot"><span class="annottext">String -&gt; PrM [DDec]
forall (m :: * -&gt; *) a. MonadFail m =&gt; String -&gt; m a
</span><span class="hs-identifier hs-var">fail</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Building defunctionalization symbols of values not supported&quot;</span></span><span>
</span><span id="line-33"></span><span class="annot"><a href="Data.Singletons.Promote.Defun.html#defunInfo"><span class="hs-identifier hs-var">defunInfo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DTyVarI</span></span><span> </span><span id="local-6989586621681358528"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681358528"><span class="hs-identifier hs-var">_name</span></a></span></span><span> </span><span id="local-6989586621681358527"><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681358527"><span class="hs-identifier hs-var">_ty</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-34"></span><span>  </span><span class="annot"><span class="annottext">String -&gt; PrM [DDec]
forall (m :: * -&gt; *) a. MonadFail m =&gt; String -&gt; m a
</span><span class="hs-identifier hs-var">fail</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Building defunctionalization symbols of type variables not supported&quot;</span></span><span>
</span><span id="line-35"></span><span class="annot"><a href="Data.Singletons.Promote.Defun.html#defunInfo"><span class="hs-identifier hs-var">defunInfo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DPatSynI</span></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-36"></span><span>  </span><span class="annot"><span class="annottext">String -&gt; PrM [DDec]
forall (m :: * -&gt; *) a. MonadFail m =&gt; String -&gt; m a
</span><span class="hs-identifier hs-var">fail</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Building defunctionalization symbols of pattern synonyms not supported&quot;</span></span><span>
</span><span id="line-37"></span><span>
</span><span id="line-38"></span><span class="hs-comment">-- Defunctionalize type families defined at the top level (i.e., not associated</span><span>
</span><span id="line-39"></span><span class="hs-comment">-- with a type class).</span><span>
</span><span id="line-40"></span><span class="annot"><a href="Data.Singletons.Promote.Defun.html#defunTopLevelTypeDecls"><span class="hs-identifier hs-type">defunTopLevelTypeDecls</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-41"></span><span>     </span><span class="hs-special">[</span><span class="annot"><a href="Data.Singletons.Syntax.html#TySynDecl"><span class="hs-identifier hs-type">TySynDecl</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-42"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Data.Singletons.Syntax.html#ClosedTypeFamilyDecl"><span class="hs-identifier hs-type">ClosedTypeFamilyDecl</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-43"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Data.Singletons.Syntax.html#OpenTypeFamilyDecl"><span class="hs-identifier hs-type">OpenTypeFamilyDecl</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-44"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Data.Singletons.Promote.Monad.html#PrM"><span class="hs-identifier hs-type">PrM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-45"></span><span id="defunTopLevelTypeDecls"><span class="annot"><span class="annottext">defunTopLevelTypeDecls :: [TySynDecl]
-&gt; [ClosedTypeFamilyDecl] -&gt; [OpenTypeFamilyDecl] -&gt; PrM ()
</span><a href="Data.Singletons.Promote.Defun.html#defunTopLevelTypeDecls"><span class="hs-identifier hs-var hs-var">defunTopLevelTypeDecls</span></a></span></span><span> </span><span id="local-6989586621681358524"><span class="annot"><span class="annottext">[TySynDecl]
</span><a href="#local-6989586621681358524"><span class="hs-identifier hs-var">ty_syns</span></a></span></span><span> </span><span id="local-6989586621681358523"><span class="annot"><span class="annottext">[ClosedTypeFamilyDecl]
</span><a href="#local-6989586621681358523"><span class="hs-identifier hs-var">c_tyfams</span></a></span></span><span> </span><span id="local-6989586621681358522"><span class="annot"><span class="annottext">[OpenTypeFamilyDecl]
</span><a href="#local-6989586621681358522"><span class="hs-identifier hs-var">o_tyfams</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-46"></span><span>  </span><span id="local-6989586621681358521"><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621681358521"><span class="hs-identifier hs-var">defun_ty_syns</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-47"></span><span>    </span><span class="annot"><span class="annottext">(TySynDecl -&gt; PrM [DDec]) -&gt; [TySynDecl] -&gt; PrM [DDec]
forall (monad :: * -&gt; *) monoid (t :: * -&gt; *) a.
(Monad monad, Monoid monoid, Traversable t) =&gt;
(a -&gt; monad monoid) -&gt; t a -&gt; monad monoid
</span><a href="Data.Singletons.Util.html#concatMapM"><span class="hs-identifier hs-var">concatMapM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><a href="Data.Singletons.Syntax.html#TySynDecl"><span class="hs-identifier hs-type">TySynDecl</span></a></span><span> </span><span id="local-6989586621681358518"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681358518"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span id="local-6989586621681358517"><span class="annot"><span class="annottext">[DTyVarBndr]
</span><a href="#local-6989586621681358517"><span class="hs-identifier hs-var">tvbs</span></a></span></span><span> </span><span id="local-6989586621681358516"><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681358516"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Name -&gt; [DTyVarBndr] -&gt; DType -&gt; PrM [DDec]
</span><a href="Data.Singletons.Promote.Defun.html#buildDefunSymsTySynD"><span class="hs-identifier hs-var">buildDefunSymsTySynD</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681358518"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">[DTyVarBndr]
</span><a href="#local-6989586621681358517"><span class="hs-identifier hs-var">tvbs</span></a></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681358516"><span class="hs-identifier hs-var">rhs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[TySynDecl]
</span><a href="#local-6989586621681358524"><span class="hs-identifier hs-var">ty_syns</span></a></span><span>
</span><span id="line-48"></span><span>  </span><span id="local-6989586621681358514"><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621681358514"><span class="hs-identifier hs-var">defun_c_tyfams</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-49"></span><span>    </span><span class="annot"><span class="annottext">(ClosedTypeFamilyDecl -&gt; PrM [DDec])
-&gt; [ClosedTypeFamilyDecl] -&gt; PrM [DDec]
forall (monad :: * -&gt; *) monoid (t :: * -&gt; *) a.
(Monad monad, Monoid monoid, Traversable t) =&gt;
(a -&gt; monad monoid) -&gt; t a -&gt; monad monoid
</span><a href="Data.Singletons.Util.html#concatMapM"><span class="hs-identifier hs-var">concatMapM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DTypeFamilyHead -&gt; PrM [DDec]
</span><a href="Data.Singletons.Promote.Defun.html#buildDefunSymsClosedTypeFamilyD"><span class="hs-identifier hs-var">buildDefunSymsClosedTypeFamilyD</span></a></span><span> </span><span class="annot"><span class="annottext">(DTypeFamilyHead -&gt; PrM [DDec])
-&gt; (ClosedTypeFamilyDecl -&gt; DTypeFamilyHead)
-&gt; ClosedTypeFamilyDecl
-&gt; PrM [DDec]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ClosedTypeFamilyDecl -&gt; DTypeFamilyHead
forall (info :: FamilyInfo). TypeFamilyDecl info -&gt; DTypeFamilyHead
</span><a href="Data.Singletons.Syntax.html#getTypeFamilyDecl"><span class="hs-identifier hs-var hs-var">getTypeFamilyDecl</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[ClosedTypeFamilyDecl]
</span><a href="#local-6989586621681358523"><span class="hs-identifier hs-var">c_tyfams</span></a></span><span>
</span><span id="line-50"></span><span>  </span><span id="local-6989586621681358510"><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621681358510"><span class="hs-identifier hs-var">defun_o_tyfams</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-51"></span><span>    </span><span class="annot"><span class="annottext">(OpenTypeFamilyDecl -&gt; PrM [DDec])
-&gt; [OpenTypeFamilyDecl] -&gt; PrM [DDec]
forall (monad :: * -&gt; *) monoid (t :: * -&gt; *) a.
(Monad monad, Monoid monoid, Traversable t) =&gt;
(a -&gt; monad monoid) -&gt; t a -&gt; monad monoid
</span><a href="Data.Singletons.Util.html#concatMapM"><span class="hs-identifier hs-var">concatMapM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DTypeFamilyHead -&gt; PrM [DDec]
</span><a href="Data.Singletons.Promote.Defun.html#buildDefunSymsOpenTypeFamilyD"><span class="hs-identifier hs-var">buildDefunSymsOpenTypeFamilyD</span></a></span><span> </span><span class="annot"><span class="annottext">(DTypeFamilyHead -&gt; PrM [DDec])
-&gt; (OpenTypeFamilyDecl -&gt; DTypeFamilyHead)
-&gt; OpenTypeFamilyDecl
-&gt; PrM [DDec]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">OpenTypeFamilyDecl -&gt; DTypeFamilyHead
forall (info :: FamilyInfo). TypeFamilyDecl info -&gt; DTypeFamilyHead
</span><a href="Data.Singletons.Syntax.html#getTypeFamilyDecl"><span class="hs-identifier hs-var hs-var">getTypeFamilyDecl</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[OpenTypeFamilyDecl]
</span><a href="#local-6989586621681358522"><span class="hs-identifier hs-var">o_tyfams</span></a></span><span>
</span><span id="line-52"></span><span>  </span><span class="annot"><span class="annottext">[DDec] -&gt; PrM ()
forall (m :: * -&gt; *). MonadWriter [DDec] m =&gt; [DDec] -&gt; m ()
</span><a href="Data.Singletons.Promote.Monad.html#emitDecs"><span class="hs-identifier hs-var">emitDecs</span></a></span><span> </span><span class="annot"><span class="annottext">([DDec] -&gt; PrM ()) -&gt; [DDec] -&gt; PrM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621681358521"><span class="hs-identifier hs-var">defun_ty_syns</span></a></span><span> </span><span class="annot"><span class="annottext">[DDec] -&gt; [DDec] -&gt; [DDec]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621681358514"><span class="hs-identifier hs-var">defun_c_tyfams</span></a></span><span> </span><span class="annot"><span class="annottext">[DDec] -&gt; [DDec] -&gt; [DDec]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621681358510"><span class="hs-identifier hs-var">defun_o_tyfams</span></a></span><span>
</span><span id="line-53"></span><span>
</span><span id="line-54"></span><span class="hs-comment">-- Defunctionalize all the type families associated with a type class.</span><span>
</span><span id="line-55"></span><span class="annot"><a href="Data.Singletons.Promote.Defun.html#defunAssociatedTypeFamilies"><span class="hs-identifier hs-type">defunAssociatedTypeFamilies</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-56"></span><span>     </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">DTyVarBndr</span></span><span class="hs-special">]</span><span>         </span><span class="hs-comment">-- The type variables bound by the parent class</span><span>
</span><span id="line-57"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Data.Singletons.Syntax.html#OpenTypeFamilyDecl"><span class="hs-identifier hs-type">OpenTypeFamilyDecl</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-comment">-- The type families associated with the parent class</span><span>
</span><span id="line-58"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Data.Singletons.Promote.Monad.html#PrM"><span class="hs-identifier hs-type">PrM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-59"></span><span id="defunAssociatedTypeFamilies"><span class="annot"><span class="annottext">defunAssociatedTypeFamilies :: [DTyVarBndr] -&gt; [OpenTypeFamilyDecl] -&gt; PrM ()
</span><a href="Data.Singletons.Promote.Defun.html#defunAssociatedTypeFamilies"><span class="hs-identifier hs-var hs-var">defunAssociatedTypeFamilies</span></a></span></span><span> </span><span id="local-6989586621681358506"><span class="annot"><span class="annottext">[DTyVarBndr]
</span><a href="#local-6989586621681358506"><span class="hs-identifier hs-var">cls_tvbs</span></a></span></span><span> </span><span id="local-6989586621681358505"><span class="annot"><span class="annottext">[OpenTypeFamilyDecl]
</span><a href="#local-6989586621681358505"><span class="hs-identifier hs-var">atfs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-60"></span><span>  </span><span id="local-6989586621681358504"><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621681358504"><span class="hs-identifier hs-var">defun_atfs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(OpenTypeFamilyDecl -&gt; PrM [DDec])
-&gt; [OpenTypeFamilyDecl] -&gt; PrM [DDec]
forall (monad :: * -&gt; *) monoid (t :: * -&gt; *) a.
(Monad monad, Monoid monoid, Traversable t) =&gt;
(a -&gt; monad monoid) -&gt; t a -&gt; monad monoid
</span><a href="Data.Singletons.Util.html#concatMapM"><span class="hs-identifier hs-var">concatMapM</span></a></span><span> </span><span class="annot"><span class="annottext">OpenTypeFamilyDecl -&gt; PrM [DDec]
</span><a href="#local-6989586621681358503"><span class="hs-identifier hs-var">defun</span></a></span><span> </span><span class="annot"><span class="annottext">[OpenTypeFamilyDecl]
</span><a href="#local-6989586621681358505"><span class="hs-identifier hs-var">atfs</span></a></span><span>
</span><span id="line-61"></span><span>  </span><span class="annot"><span class="annottext">[DDec] -&gt; PrM ()
forall (m :: * -&gt; *). MonadWriter [DDec] m =&gt; [DDec] -&gt; m ()
</span><a href="Data.Singletons.Promote.Monad.html#emitDecs"><span class="hs-identifier hs-var">emitDecs</span></a></span><span> </span><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621681358504"><span class="hs-identifier hs-var">defun_atfs</span></a></span><span>
</span><span id="line-62"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-63"></span><span>    </span><span class="annot"><a href="#local-6989586621681358503"><span class="hs-identifier hs-type">defun</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Data.Singletons.Syntax.html#OpenTypeFamilyDecl"><span class="hs-identifier hs-type">OpenTypeFamilyDecl</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Data.Singletons.Promote.Monad.html#PrM"><span class="hs-identifier hs-type">PrM</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">DDec</span></span><span class="hs-special">]</span><span>
</span><span id="line-64"></span><span>    </span><span id="local-6989586621681358503"><span class="annot"><span class="annottext">defun :: OpenTypeFamilyDecl -&gt; PrM [DDec]
</span><a href="#local-6989586621681358503"><span class="hs-identifier hs-var hs-var">defun</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Data.Singletons.Syntax.html#TypeFamilyDecl"><span class="hs-identifier hs-type">TypeFamilyDecl</span></a></span><span> </span><span id="local-6989586621681358501"><span class="annot"><span class="annottext">DTypeFamilyHead
</span><a href="#local-6989586621681358501"><span class="hs-identifier hs-var">tf_head</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-65"></span><span>      </span><span class="annot"><span class="annottext">(DTyVarBndr -&gt; DTyVarBndr)
-&gt; (Maybe DType -&gt; Maybe DType) -&gt; DTypeFamilyHead -&gt; PrM [DDec]
</span><a href="Data.Singletons.Promote.Defun.html#buildDefunSymsTypeFamilyHead"><span class="hs-identifier hs-var">buildDefunSymsTypeFamilyHead</span></a></span><span> </span><span class="annot"><span class="annottext">DTyVarBndr -&gt; DTyVarBndr
</span><a href="#local-6989586621681358499"><span class="hs-identifier hs-var">ascribe_tf_tvb_kind</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe DType -&gt; Maybe DType
forall a. a -&gt; a
</span><span class="hs-identifier hs-var">id</span></span><span> </span><span class="annot"><span class="annottext">DTypeFamilyHead
</span><a href="#local-6989586621681358501"><span class="hs-identifier hs-var">tf_head</span></a></span><span>
</span><span id="line-66"></span><span>
</span><span id="line-67"></span><span>    </span><span class="hs-comment">-- Maps class-bound type variables to their kind annotations (if supplied).</span><span>
</span><span id="line-68"></span><span>    </span><span class="hs-comment">-- For example, `class C (a :: Bool) b (c :: Type)` will produce</span><span>
</span><span id="line-69"></span><span>    </span><span class="hs-comment">-- {a |-&gt; Bool, c |-&gt; Type}.</span><span>
</span><span id="line-70"></span><span>    </span><span class="annot"><a href="#local-6989586621681358497"><span class="hs-identifier hs-type">cls_tvb_kind_map</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">DKind</span></span><span>
</span><span id="line-71"></span><span>    </span><span id="local-6989586621681358497"><span class="annot"><span class="annottext">cls_tvb_kind_map :: Map Name DType
</span><a href="#local-6989586621681358497"><span class="hs-identifier hs-var hs-var">cls_tvb_kind_map</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Name, DType)] -&gt; Map Name DType
forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><span class="hs-identifier hs-var">Map.fromList</span></span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DTyVarBndr -&gt; Name
</span><a href="Data.Singletons.Util.html#extractTvbName"><span class="hs-identifier hs-var">extractTvbName</span></a></span><span> </span><span class="annot"><span class="annottext">DTyVarBndr
</span><a href="#local-6989586621681358493"><span class="hs-identifier hs-var">tvb</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681358492"><span class="hs-identifier hs-var">tvb_kind</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-72"></span><span>                                    </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621681358493"><span class="annot"><span class="annottext">DTyVarBndr
</span><a href="#local-6989586621681358493"><span class="hs-identifier hs-var">tvb</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[DTyVarBndr]
</span><a href="#local-6989586621681358506"><span class="hs-identifier hs-var">cls_tvbs</span></a></span><span>
</span><span id="line-73"></span><span>                                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621681358492"><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681358492"><span class="hs-identifier hs-var">tvb_kind</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">DTyVarBndr -&gt; Maybe DType
</span><a href="Data.Singletons.Util.html#extractTvbKind"><span class="hs-identifier hs-var">extractTvbKind</span></a></span><span> </span><span class="annot"><span class="annottext">DTyVarBndr
</span><a href="#local-6989586621681358493"><span class="hs-identifier hs-var">tvb</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-74"></span><span>                                    </span><span class="hs-special">]</span><span>
</span><span id="line-75"></span><span>
</span><span id="line-76"></span><span>    </span><span class="hs-comment">-- If the parent class lacks a SAK, we cannot safely default kinds to</span><span>
</span><span id="line-77"></span><span>    </span><span class="hs-comment">-- Type. All we can do is make use of whatever kind information that parent</span><span>
</span><span id="line-78"></span><span>    </span><span class="hs-comment">-- class provides and let kind inference do the rest.</span><span>
</span><span id="line-79"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-80"></span><span>    </span><span class="hs-comment">-- We can sometimes learn more specific information about unannotated type</span><span>
</span><span id="line-81"></span><span>    </span><span class="hs-comment">-- family binders from the parent class, as in the following example:</span><span>
</span><span id="line-82"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-83"></span><span>    </span><span class="hs-comment">--   class C (a :: Bool) where</span><span>
</span><span id="line-84"></span><span>    </span><span class="hs-comment">--     type T a :: Type</span><span>
</span><span id="line-85"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-86"></span><span>    </span><span class="hs-comment">-- Here, we know that `T :: Bool -&gt; Type` because we can infer that the `a`</span><span>
</span><span id="line-87"></span><span>    </span><span class="hs-comment">-- in `type T a` should be of kind `Bool` from the class SAK.</span><span>
</span><span id="line-88"></span><span>    </span><span class="annot"><a href="#local-6989586621681358499"><span class="hs-identifier hs-type">ascribe_tf_tvb_kind</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DTyVarBndr</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DTyVarBndr</span></span><span>
</span><span id="line-89"></span><span>    </span><span id="local-6989586621681358499"><span class="annot"><span class="annottext">ascribe_tf_tvb_kind :: DTyVarBndr -&gt; DTyVarBndr
</span><a href="#local-6989586621681358499"><span class="hs-identifier hs-var hs-var">ascribe_tf_tvb_kind</span></a></span></span><span> </span><span id="local-6989586621681358490"><span class="annot"><span class="annottext">DTyVarBndr
</span><a href="#local-6989586621681358490"><span class="hs-identifier hs-var">tvb</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-90"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">DTyVarBndr
</span><a href="#local-6989586621681358490"><span class="hs-identifier hs-var">tvb</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-91"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">DKindedTV</span></span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">DTyVarBndr
</span><a href="#local-6989586621681358490"><span class="hs-identifier hs-var">tvb</span></a></span><span>
</span><span id="line-92"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">DPlainTV</span></span><span> </span><span id="local-6989586621681358487"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681358487"><span class="hs-identifier hs-var">n</span></a></span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">DTyVarBndr -&gt; (DType -&gt; DTyVarBndr) -&gt; Maybe DType -&gt; DTyVarBndr
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><span class="hs-identifier hs-var">maybe</span></span><span> </span><span class="annot"><span class="annottext">DTyVarBndr
</span><a href="#local-6989586621681358490"><span class="hs-identifier hs-var">tvb</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; DType -&gt; DTyVarBndr
</span><span class="hs-identifier hs-var">DKindedTV</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681358487"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Maybe DType -&gt; DTyVarBndr) -&gt; Maybe DType -&gt; DTyVarBndr
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; Map Name DType -&gt; Maybe DType
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Map.lookup</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681358487"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Map Name DType
</span><a href="#local-6989586621681358497"><span class="hs-identifier hs-var">cls_tvb_kind_map</span></a></span><span>
</span><span id="line-93"></span><span>
</span><span id="line-94"></span><span class="annot"><a href="Data.Singletons.Promote.Defun.html#buildDefunSyms"><span class="hs-identifier hs-type">buildDefunSyms</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DDec</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Data.Singletons.Promote.Monad.html#PrM"><span class="hs-identifier hs-type">PrM</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">DDec</span></span><span class="hs-special">]</span><span>
</span><span id="line-95"></span><span id="buildDefunSyms"><span class="annot"><span class="annottext">buildDefunSyms :: DDec -&gt; PrM [DDec]
</span><a href="Data.Singletons.Promote.Defun.html#buildDefunSyms"><span class="hs-identifier hs-var hs-var">buildDefunSyms</span></a></span></span><span> </span><span id="local-6989586621681358484"><span class="annot"><span class="annottext">DDec
</span><a href="#local-6989586621681358484"><span class="hs-identifier hs-var">dec</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-96"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">DDec
</span><a href="#local-6989586621681358484"><span class="hs-identifier hs-var">dec</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-97"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">DDataD</span></span><span> </span><span id="local-6989586621681358482"><span class="annot"><span class="annottext">NewOrData
</span><a href="#local-6989586621681358482"><span class="hs-identifier hs-var">_new_or_data</span></a></span></span><span> </span><span id="local-6989586621681358481"><span class="annot"><span class="annottext">DCxt
</span><a href="#local-6989586621681358481"><span class="hs-identifier hs-var">_cxt</span></a></span></span><span> </span><span id="local-6989586621681358480"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681358480"><span class="hs-identifier hs-var">_tyName</span></a></span></span><span> </span><span id="local-6989586621681358479"><span class="annot"><span class="annottext">[DTyVarBndr]
</span><a href="#local-6989586621681358479"><span class="hs-identifier hs-var">_tvbs</span></a></span></span><span> </span><span id="local-6989586621681358478"><span class="annot"><span class="annottext">Maybe DType
</span><a href="#local-6989586621681358478"><span class="hs-identifier hs-var">_k</span></a></span></span><span> </span><span id="local-6989586621681358477"><span class="annot"><span class="annottext">[DCon]
</span><a href="#local-6989586621681358477"><span class="hs-identifier hs-var">ctors</span></a></span></span><span> </span><span id="local-6989586621681358476"><span class="annot"><span class="annottext">[DDerivClause]
</span><a href="#local-6989586621681358476"><span class="hs-identifier hs-var">_derivings</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-98"></span><span>      </span><span class="annot"><span class="annottext">[DCon] -&gt; PrM [DDec]
</span><a href="Data.Singletons.Promote.Defun.html#buildDefunSymsDataD"><span class="hs-identifier hs-var">buildDefunSymsDataD</span></a></span><span> </span><span class="annot"><span class="annottext">[DCon]
</span><a href="#local-6989586621681358477"><span class="hs-identifier hs-var">ctors</span></a></span><span>
</span><span id="line-99"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">DClosedTypeFamilyD</span></span><span> </span><span id="local-6989586621681358473"><span class="annot"><span class="annottext">DTypeFamilyHead
</span><a href="#local-6989586621681358473"><span class="hs-identifier hs-var">tf_head</span></a></span></span><span> </span><span class="annot"><span class="annottext">[DTySynEqn]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-100"></span><span>      </span><span class="annot"><span class="annottext">DTypeFamilyHead -&gt; PrM [DDec]
</span><a href="Data.Singletons.Promote.Defun.html#buildDefunSymsClosedTypeFamilyD"><span class="hs-identifier hs-var">buildDefunSymsClosedTypeFamilyD</span></a></span><span> </span><span class="annot"><span class="annottext">DTypeFamilyHead
</span><a href="#local-6989586621681358473"><span class="hs-identifier hs-var">tf_head</span></a></span><span>
</span><span id="line-101"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">DOpenTypeFamilyD</span></span><span> </span><span id="local-6989586621681358471"><span class="annot"><span class="annottext">DTypeFamilyHead
</span><a href="#local-6989586621681358471"><span class="hs-identifier hs-var">tf_head</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-102"></span><span>      </span><span class="annot"><span class="annottext">DTypeFamilyHead -&gt; PrM [DDec]
</span><a href="Data.Singletons.Promote.Defun.html#buildDefunSymsOpenTypeFamilyD"><span class="hs-identifier hs-var">buildDefunSymsOpenTypeFamilyD</span></a></span><span> </span><span class="annot"><span class="annottext">DTypeFamilyHead
</span><a href="#local-6989586621681358471"><span class="hs-identifier hs-var">tf_head</span></a></span><span>
</span><span id="line-103"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">DTySynD</span></span><span> </span><span id="local-6989586621681358469"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681358469"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span id="local-6989586621681358468"><span class="annot"><span class="annottext">[DTyVarBndr]
</span><a href="#local-6989586621681358468"><span class="hs-identifier hs-var">tvbs</span></a></span></span><span> </span><span id="local-6989586621681358467"><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681358467"><span class="hs-identifier hs-var">rhs</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-104"></span><span>      </span><span class="annot"><span class="annottext">Name -&gt; [DTyVarBndr] -&gt; DType -&gt; PrM [DDec]
</span><a href="Data.Singletons.Promote.Defun.html#buildDefunSymsTySynD"><span class="hs-identifier hs-var">buildDefunSymsTySynD</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681358469"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">[DTyVarBndr]
</span><a href="#local-6989586621681358468"><span class="hs-identifier hs-var">tvbs</span></a></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681358467"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-105"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">DClassD</span></span><span> </span><span id="local-6989586621681358465"><span class="annot"><span class="annottext">DCxt
</span><a href="#local-6989586621681358465"><span class="hs-identifier hs-var">_cxt</span></a></span></span><span> </span><span id="local-6989586621681358464"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681358464"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span id="local-6989586621681358463"><span class="annot"><span class="annottext">[DTyVarBndr]
</span><a href="#local-6989586621681358463"><span class="hs-identifier hs-var">tvbs</span></a></span></span><span> </span><span id="local-6989586621681358462"><span class="annot"><span class="annottext">[FunDep]
</span><a href="#local-6989586621681358462"><span class="hs-identifier hs-var">_fundeps</span></a></span></span><span> </span><span id="local-6989586621681358461"><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621681358461"><span class="hs-identifier hs-var">_members</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-106"></span><span>      </span><span class="annot"><span class="annottext">Name -&gt; [DTyVarBndr] -&gt; Maybe DType -&gt; PrM [DDec]
</span><a href="Data.Singletons.Promote.Defun.html#defunReify"><span class="hs-identifier hs-var">defunReify</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681358464"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">[DTyVarBndr]
</span><a href="#local-6989586621681358463"><span class="hs-identifier hs-var">tvbs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DType -&gt; Maybe DType
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; DType
</span><span class="hs-identifier hs-var">DConT</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="Data.Singletons.Names.html#constraintName"><span class="hs-identifier hs-var">constraintName</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-107"></span><span>    </span><span class="annot"><span class="annottext">DDec
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; PrM [DDec]
forall (m :: * -&gt; *) a. MonadFail m =&gt; String -&gt; m a
</span><span class="hs-identifier hs-var">fail</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; PrM [DDec]) -&gt; String -&gt; PrM [DDec]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Defunctionalization symbols can only be built for &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span>
</span><span id="line-108"></span><span>                </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;type families and data declarations&quot;</span></span><span>
</span><span id="line-109"></span><span>
</span><span id="line-110"></span><span class="hs-comment">-- Unlike open type families, closed type families that lack SAKS do not</span><span>
</span><span id="line-111"></span><span class="hs-comment">-- default anything to Type, instead relying on kind inference to figure out</span><span>
</span><span id="line-112"></span><span class="hs-comment">-- unspecified kinds.</span><span>
</span><span id="line-113"></span><span class="annot"><a href="Data.Singletons.Promote.Defun.html#buildDefunSymsClosedTypeFamilyD"><span class="hs-identifier hs-type">buildDefunSymsClosedTypeFamilyD</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DTypeFamilyHead</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Data.Singletons.Promote.Monad.html#PrM"><span class="hs-identifier hs-type">PrM</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">DDec</span></span><span class="hs-special">]</span><span>
</span><span id="line-114"></span><span id="buildDefunSymsClosedTypeFamilyD"><span class="annot"><span class="annottext">buildDefunSymsClosedTypeFamilyD :: DTypeFamilyHead -&gt; PrM [DDec]
</span><a href="Data.Singletons.Promote.Defun.html#buildDefunSymsClosedTypeFamilyD"><span class="hs-identifier hs-var hs-var">buildDefunSymsClosedTypeFamilyD</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(DTyVarBndr -&gt; DTyVarBndr)
-&gt; (Maybe DType -&gt; Maybe DType) -&gt; DTypeFamilyHead -&gt; PrM [DDec]
</span><a href="Data.Singletons.Promote.Defun.html#buildDefunSymsTypeFamilyHead"><span class="hs-identifier hs-var">buildDefunSymsTypeFamilyHead</span></a></span><span> </span><span class="annot"><span class="annottext">DTyVarBndr -&gt; DTyVarBndr
forall a. a -&gt; a
</span><span class="hs-identifier hs-var">id</span></span><span> </span><span class="annot"><span class="annottext">Maybe DType -&gt; Maybe DType
forall a. a -&gt; a
</span><span class="hs-identifier hs-var">id</span></span><span>
</span><span id="line-115"></span><span>
</span><span id="line-116"></span><span class="hs-comment">-- If an open type family lacks a SAK and has type variable binders or a result</span><span>
</span><span id="line-117"></span><span class="hs-comment">-- without explicit kinds, then they default to Type (hence the uses of</span><span>
</span><span id="line-118"></span><span class="hs-comment">-- default{Tvb,Maybe}ToTypeKind).</span><span>
</span><span id="line-119"></span><span class="annot"><a href="Data.Singletons.Promote.Defun.html#buildDefunSymsOpenTypeFamilyD"><span class="hs-identifier hs-type">buildDefunSymsOpenTypeFamilyD</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DTypeFamilyHead</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Data.Singletons.Promote.Monad.html#PrM"><span class="hs-identifier hs-type">PrM</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">DDec</span></span><span class="hs-special">]</span><span>
</span><span id="line-120"></span><span id="buildDefunSymsOpenTypeFamilyD"><span class="annot"><span class="annottext">buildDefunSymsOpenTypeFamilyD :: DTypeFamilyHead -&gt; PrM [DDec]
</span><a href="Data.Singletons.Promote.Defun.html#buildDefunSymsOpenTypeFamilyD"><span class="hs-identifier hs-var hs-var">buildDefunSymsOpenTypeFamilyD</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-121"></span><span>  </span><span class="annot"><span class="annottext">(DTyVarBndr -&gt; DTyVarBndr)
-&gt; (Maybe DType -&gt; Maybe DType) -&gt; DTypeFamilyHead -&gt; PrM [DDec]
</span><a href="Data.Singletons.Promote.Defun.html#buildDefunSymsTypeFamilyHead"><span class="hs-identifier hs-var">buildDefunSymsTypeFamilyHead</span></a></span><span> </span><span class="annot"><span class="annottext">DTyVarBndr -&gt; DTyVarBndr
</span><a href="Data.Singletons.Util.html#defaultTvbToTypeKind"><span class="hs-identifier hs-var">defaultTvbToTypeKind</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DType -&gt; Maybe DType
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(DType -&gt; Maybe DType)
-&gt; (Maybe DType -&gt; DType) -&gt; Maybe DType -&gt; Maybe DType
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Maybe DType -&gt; DType
</span><a href="Data.Singletons.Util.html#defaultMaybeToTypeKind"><span class="hs-identifier hs-var">defaultMaybeToTypeKind</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-122"></span><span>
</span><span id="line-123"></span><span class="annot"><a href="Data.Singletons.Promote.Defun.html#buildDefunSymsTypeFamilyHead"><span class="hs-identifier hs-type">buildDefunSymsTypeFamilyHead</span></a></span><span>
</span><span id="line-124"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DTyVarBndr</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DTyVarBndr</span></span><span class="hs-special">)</span><span>   </span><span class="hs-comment">-- How to default each type variable binder</span><span>
</span><span id="line-125"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">DKind</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">DKind</span></span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- How to default the result kind</span><span>
</span><span id="line-126"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DTypeFamilyHead</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Data.Singletons.Promote.Monad.html#PrM"><span class="hs-identifier hs-type">PrM</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">DDec</span></span><span class="hs-special">]</span><span>
</span><span id="line-127"></span><span id="buildDefunSymsTypeFamilyHead"><span class="annot"><span class="annottext">buildDefunSymsTypeFamilyHead :: (DTyVarBndr -&gt; DTyVarBndr)
-&gt; (Maybe DType -&gt; Maybe DType) -&gt; DTypeFamilyHead -&gt; PrM [DDec]
</span><a href="Data.Singletons.Promote.Defun.html#buildDefunSymsTypeFamilyHead"><span class="hs-identifier hs-var hs-var">buildDefunSymsTypeFamilyHead</span></a></span></span><span> </span><span id="local-6989586621681358455"><span class="annot"><span class="annottext">DTyVarBndr -&gt; DTyVarBndr
</span><a href="#local-6989586621681358455"><span class="hs-identifier hs-var">default_tvb</span></a></span></span><span> </span><span id="local-6989586621681358454"><span class="annot"><span class="annottext">Maybe DType -&gt; Maybe DType
</span><a href="#local-6989586621681358454"><span class="hs-identifier hs-var">default_kind</span></a></span></span><span>
</span><span id="line-128"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DTypeFamilyHead</span></span><span> </span><span id="local-6989586621681358452"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681358452"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span id="local-6989586621681358451"><span class="annot"><span class="annottext">[DTyVarBndr]
</span><a href="#local-6989586621681358451"><span class="hs-identifier hs-var">tvbs</span></a></span></span><span> </span><span id="local-6989586621681358450"><span class="annot"><span class="annottext">DFamilyResultSig
</span><a href="#local-6989586621681358450"><span class="hs-identifier hs-var">result_sig</span></a></span></span><span> </span><span class="annot"><span class="annottext">Maybe InjectivityAnn
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-129"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681358449"><span class="annot"><span class="annottext">arg_tvbs :: [DTyVarBndr]
</span><a href="#local-6989586621681358449"><span class="hs-identifier hs-var hs-var">arg_tvbs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(DTyVarBndr -&gt; DTyVarBndr) -&gt; [DTyVarBndr] -&gt; [DTyVarBndr]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">DTyVarBndr -&gt; DTyVarBndr
</span><a href="#local-6989586621681358455"><span class="hs-identifier hs-var">default_tvb</span></a></span><span> </span><span class="annot"><span class="annottext">[DTyVarBndr]
</span><a href="#local-6989586621681358451"><span class="hs-identifier hs-var">tvbs</span></a></span><span>
</span><span id="line-130"></span><span>      </span><span id="local-6989586621681358448"><span class="annot"><span class="annottext">res_kind :: Maybe DType
</span><a href="#local-6989586621681358448"><span class="hs-identifier hs-var hs-var">res_kind</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe DType -&gt; Maybe DType
</span><a href="#local-6989586621681358454"><span class="hs-identifier hs-var">default_kind</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DFamilyResultSig -&gt; Maybe DType
</span><a href="Data.Singletons.Util.html#resultSigToMaybeKind"><span class="hs-identifier hs-var">resultSigToMaybeKind</span></a></span><span> </span><span class="annot"><span class="annottext">DFamilyResultSig
</span><a href="#local-6989586621681358450"><span class="hs-identifier hs-var">result_sig</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-131"></span><span>  </span><span class="annot"><span class="annottext">Name -&gt; [DTyVarBndr] -&gt; Maybe DType -&gt; PrM [DDec]
</span><a href="Data.Singletons.Promote.Defun.html#defunReify"><span class="hs-identifier hs-var">defunReify</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681358452"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">[DTyVarBndr]
</span><a href="#local-6989586621681358449"><span class="hs-identifier hs-var">arg_tvbs</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe DType
</span><a href="#local-6989586621681358448"><span class="hs-identifier hs-var">res_kind</span></a></span><span>
</span><span id="line-132"></span><span>
</span><span id="line-133"></span><span class="annot"><a href="Data.Singletons.Promote.Defun.html#buildDefunSymsTySynD"><span class="hs-identifier hs-type">buildDefunSymsTySynD</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">DTyVarBndr</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DType</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Data.Singletons.Promote.Monad.html#PrM"><span class="hs-identifier hs-type">PrM</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">DDec</span></span><span class="hs-special">]</span><span>
</span><span id="line-134"></span><span id="buildDefunSymsTySynD"><span class="annot"><span class="annottext">buildDefunSymsTySynD :: Name -&gt; [DTyVarBndr] -&gt; DType -&gt; PrM [DDec]
</span><a href="Data.Singletons.Promote.Defun.html#buildDefunSymsTySynD"><span class="hs-identifier hs-var hs-var">buildDefunSymsTySynD</span></a></span></span><span> </span><span id="local-6989586621681358446"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681358446"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span id="local-6989586621681358445"><span class="annot"><span class="annottext">[DTyVarBndr]
</span><a href="#local-6989586621681358445"><span class="hs-identifier hs-var">tvbs</span></a></span></span><span> </span><span id="local-6989586621681358444"><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681358444"><span class="hs-identifier hs-var">rhs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name -&gt; [DTyVarBndr] -&gt; Maybe DType -&gt; PrM [DDec]
</span><a href="Data.Singletons.Promote.Defun.html#defunReify"><span class="hs-identifier hs-var">defunReify</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681358446"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">[DTyVarBndr]
</span><a href="#local-6989586621681358445"><span class="hs-identifier hs-var">tvbs</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe DType
</span><a href="#local-6989586621681358443"><span class="hs-identifier hs-var">mb_res_kind</span></a></span><span>
</span><span id="line-135"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-136"></span><span>    </span><span class="hs-comment">-- If a type synonym lacks a SAK, we can &quot;infer&quot; its result kind by</span><span>
</span><span id="line-137"></span><span>    </span><span class="hs-comment">-- checking for an explicit kind annotation on the right-hand side.</span><span>
</span><span id="line-138"></span><span>    </span><span class="annot"><a href="#local-6989586621681358443"><span class="hs-identifier hs-type">mb_res_kind</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">DKind</span></span><span>
</span><span id="line-139"></span><span>    </span><span id="local-6989586621681358443"><span class="annot"><span class="annottext">mb_res_kind :: Maybe DType
</span><a href="#local-6989586621681358443"><span class="hs-identifier hs-var hs-var">mb_res_kind</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681358444"><span class="hs-identifier hs-var">rhs</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-140"></span><span>                    </span><span class="annot"><span class="hs-identifier hs-type">DSigT</span></span><span> </span><span class="annot"><span class="annottext">DType
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621681358441"><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681358441"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">DType -&gt; Maybe DType
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681358441"><span class="hs-identifier hs-var">k</span></a></span><span>
</span><span id="line-141"></span><span>                    </span><span class="annot"><span class="annottext">DType
</span><span class="hs-identifier">_</span></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe DType
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-142"></span><span>
</span><span id="line-143"></span><span class="annot"><a href="Data.Singletons.Promote.Defun.html#buildDefunSymsDataD"><span class="hs-identifier hs-type">buildDefunSymsDataD</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">DCon</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Data.Singletons.Promote.Monad.html#PrM"><span class="hs-identifier hs-type">PrM</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">DDec</span></span><span class="hs-special">]</span><span>
</span><span id="line-144"></span><span id="buildDefunSymsDataD"><span class="annot"><span class="annottext">buildDefunSymsDataD :: [DCon] -&gt; PrM [DDec]
</span><a href="Data.Singletons.Promote.Defun.html#buildDefunSymsDataD"><span class="hs-identifier hs-var hs-var">buildDefunSymsDataD</span></a></span></span><span> </span><span id="local-6989586621681358440"><span class="annot"><span class="annottext">[DCon]
</span><a href="#local-6989586621681358440"><span class="hs-identifier hs-var">ctors</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-145"></span><span>  </span><span class="annot"><span class="annottext">(DCon -&gt; PrM [DDec]) -&gt; [DCon] -&gt; PrM [DDec]
forall (monad :: * -&gt; *) monoid (t :: * -&gt; *) a.
(Monad monad, Monoid monoid, Traversable t) =&gt;
(a -&gt; monad monoid) -&gt; t a -&gt; monad monoid
</span><a href="Data.Singletons.Util.html#concatMapM"><span class="hs-identifier hs-var">concatMapM</span></a></span><span> </span><span class="annot"><span class="annottext">DCon -&gt; PrM [DDec]
</span><a href="#local-6989586621681358439"><span class="hs-identifier hs-var">promoteCtor</span></a></span><span> </span><span class="annot"><span class="annottext">[DCon]
</span><a href="#local-6989586621681358440"><span class="hs-identifier hs-var">ctors</span></a></span><span>
</span><span id="line-146"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-147"></span><span>    </span><span class="annot"><a href="#local-6989586621681358439"><span class="hs-identifier hs-type">promoteCtor</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DCon</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Data.Singletons.Promote.Monad.html#PrM"><span class="hs-identifier hs-type">PrM</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">DDec</span></span><span class="hs-special">]</span><span>
</span><span id="line-148"></span><span>    </span><span id="local-6989586621681358439"><span class="annot"><span class="annottext">promoteCtor :: DCon -&gt; PrM [DDec]
</span><a href="#local-6989586621681358439"><span class="hs-identifier hs-var hs-var">promoteCtor</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DCon</span></span><span> </span><span id="local-6989586621681358437"><span class="annot"><span class="annottext">[DTyVarBndr]
</span><a href="#local-6989586621681358437"><span class="hs-identifier hs-var">tvbs</span></a></span></span><span> </span><span class="annot"><span class="annottext">DCxt
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621681358436"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681358436"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span id="local-6989586621681358435"><span class="annot"><span class="annottext">DConFields
</span><a href="#local-6989586621681358435"><span class="hs-identifier hs-var">fields</span></a></span></span><span> </span><span id="local-6989586621681358434"><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681358434"><span class="hs-identifier hs-var">res_ty</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-149"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681358433"><span class="annot"><span class="annottext">arg_tys :: DCxt
</span><a href="#local-6989586621681358433"><span class="hs-identifier hs-var hs-var">arg_tys</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DConFields -&gt; DCxt
</span><a href="Data.Singletons.Util.html#tysOfConFields"><span class="hs-identifier hs-var">tysOfConFields</span></a></span><span> </span><span class="annot"><span class="annottext">DConFields
</span><a href="#local-6989586621681358435"><span class="hs-identifier hs-var">fields</span></a></span><span>
</span><span id="line-150"></span><span>      </span><span id="local-6989586621681358431"><span class="annot"><span class="annottext">DCxt
</span><a href="#local-6989586621681358431"><span class="hs-identifier hs-var">arg_kis</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(DType -&gt; PrM DType) -&gt; DCxt -&gt; PrM DCxt
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f (t b)
</span><span class="hs-identifier hs-var">traverse</span></span><span> </span><span class="annot"><span class="annottext">DType -&gt; PrM DType
forall (m :: * -&gt; *). MonadFail m =&gt; DType -&gt; m DType
</span><a href="Data.Singletons.Promote.Type.html#promoteType_NC"><span class="hs-identifier hs-var">promoteType_NC</span></a></span><span> </span><span class="annot"><span class="annottext">DCxt
</span><a href="#local-6989586621681358433"><span class="hs-identifier hs-var">arg_tys</span></a></span><span>
</span><span id="line-151"></span><span>      </span><span id="local-6989586621681358428"><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681358428"><span class="hs-identifier hs-var">res_ki</span></a></span></span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">DType -&gt; PrM DType
forall (m :: * -&gt; *). MonadFail m =&gt; DType -&gt; m DType
</span><a href="Data.Singletons.Promote.Type.html#promoteType_NC"><span class="hs-identifier hs-var">promoteType_NC</span></a></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681358434"><span class="hs-identifier hs-var">res_ty</span></a></span><span>
</span><span id="line-152"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681358427"><span class="annot"><span class="annottext">con_ki :: DType
</span><a href="#local-6989586621681358427"><span class="hs-identifier hs-var hs-var">con_ki</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[DTyVarBndr] -&gt; DCxt -&gt; DCxt -&gt; DType -&gt; DType
</span><a href="Data.Singletons.Util.html#ravelVanillaDType"><span class="hs-identifier hs-var">ravelVanillaDType</span></a></span><span> </span><span class="annot"><span class="annottext">[DTyVarBndr]
</span><a href="#local-6989586621681358437"><span class="hs-identifier hs-var">tvbs</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">DCxt
</span><a href="#local-6989586621681358431"><span class="hs-identifier hs-var">arg_kis</span></a></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681358428"><span class="hs-identifier hs-var">res_ki</span></a></span><span>
</span><span id="line-153"></span><span>      </span><span id="local-6989586621681358425"><span class="annot"><span class="annottext">Maybe Fixity
</span><a href="#local-6989586621681358425"><span class="hs-identifier hs-var">m_fixity</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Name -&gt; PrM (Maybe Fixity)
forall (q :: * -&gt; *). DsMonad q =&gt; Name -&gt; q (Maybe Fixity)
</span><span class="hs-identifier hs-var">reifyFixityWithLocals</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681358436"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-154"></span><span>      </span><span class="annot"><span class="annottext">Name -&gt; Maybe Fixity -&gt; DefunKindInfo -&gt; PrM [DDec]
</span><a href="Data.Singletons.Promote.Defun.html#defunctionalize"><span class="hs-identifier hs-var">defunctionalize</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681358436"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Fixity
</span><a href="#local-6989586621681358425"><span class="hs-identifier hs-var">m_fixity</span></a></span><span> </span><span class="annot"><span class="annottext">(DefunKindInfo -&gt; PrM [DDec]) -&gt; DefunKindInfo -&gt; PrM [DDec]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">DType -&gt; DefunKindInfo
</span><a href="Data.Singletons.Promote.Defun.html#DefunSAK"><span class="hs-identifier hs-var">DefunSAK</span></a></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681358427"><span class="hs-identifier hs-var">con_ki</span></a></span><span>
</span><span id="line-155"></span><span>
</span><span id="line-156"></span><span class="hs-comment">-- Generate defunctionalization symbols for a name, using reifyFixityWithLocals</span><span>
</span><span id="line-157"></span><span class="hs-comment">-- to determine what the fixity of each symbol should be</span><span>
</span><span id="line-158"></span><span class="hs-comment">-- (see Note [Fixity declarations for defunctionalization symbols])</span><span>
</span><span id="line-159"></span><span class="hs-comment">-- and dsReifyType to determine whether defunctionalization should make use</span><span>
</span><span id="line-160"></span><span class="hs-comment">-- of SAKs or not (see Note [Defunctionalization game plan]).</span><span>
</span><span id="line-161"></span><span class="annot"><a href="Data.Singletons.Promote.Defun.html#defunReify"><span class="hs-identifier hs-type">defunReify</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span>           </span><span class="hs-comment">-- Name of the declaration to be defunctionalized</span><span>
</span><span id="line-162"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">DTyVarBndr</span></span><span class="hs-special">]</span><span>   </span><span class="hs-comment">-- The declaration's type variable binders</span><span>
</span><span id="line-163"></span><span>                             </span><span class="hs-comment">-- (only used if the declaration lacks a SAK)</span><span>
</span><span id="line-164"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">DKind</span></span><span>    </span><span class="hs-comment">-- The declaration's return kind, if it has one</span><span>
</span><span id="line-165"></span><span>                             </span><span class="hs-comment">-- (only used if the declaration lacks a SAK)</span><span>
</span><span id="line-166"></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Data.Singletons.Promote.Monad.html#PrM"><span class="hs-identifier hs-type">PrM</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">DDec</span></span><span class="hs-special">]</span><span>
</span><span id="line-167"></span><span id="defunReify"><span class="annot"><span class="annottext">defunReify :: Name -&gt; [DTyVarBndr] -&gt; Maybe DType -&gt; PrM [DDec]
</span><a href="Data.Singletons.Promote.Defun.html#defunReify"><span class="hs-identifier hs-var hs-var">defunReify</span></a></span></span><span> </span><span id="local-6989586621681358421"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681358421"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span id="local-6989586621681358420"><span class="annot"><span class="annottext">[DTyVarBndr]
</span><a href="#local-6989586621681358420"><span class="hs-identifier hs-var">tvbs</span></a></span></span><span> </span><span id="local-6989586621681358419"><span class="annot"><span class="annottext">Maybe DType
</span><a href="#local-6989586621681358419"><span class="hs-identifier hs-var">m_res_kind</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-168"></span><span>  </span><span id="local-6989586621681358418"><span class="annot"><span class="annottext">Maybe Fixity
</span><a href="#local-6989586621681358418"><span class="hs-identifier hs-var">m_fixity</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Name -&gt; PrM (Maybe Fixity)
forall (q :: * -&gt; *). DsMonad q =&gt; Name -&gt; q (Maybe Fixity)
</span><span class="hs-identifier hs-var">reifyFixityWithLocals</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681358421"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-169"></span><span>  </span><span id="local-6989586621681358417"><span class="annot"><span class="annottext">Maybe DType
</span><a href="#local-6989586621681358417"><span class="hs-identifier hs-var">m_sak</span></a></span></span><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Name -&gt; PrM (Maybe DType)
forall (q :: * -&gt; *). DsMonad q =&gt; Name -&gt; q (Maybe DType)
</span><span class="hs-identifier hs-var">dsReifyType</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681358421"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-170"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681358415"><span class="annot"><span class="annottext">defun :: DefunKindInfo -&gt; PrM [DDec]
</span><a href="#local-6989586621681358415"><span class="hs-identifier hs-var hs-var">defun</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name -&gt; Maybe Fixity -&gt; DefunKindInfo -&gt; PrM [DDec]
</span><a href="Data.Singletons.Promote.Defun.html#defunctionalize"><span class="hs-identifier hs-var">defunctionalize</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681358421"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Fixity
</span><a href="#local-6989586621681358418"><span class="hs-identifier hs-var">m_fixity</span></a></span><span>
</span><span id="line-171"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe DType
</span><a href="#local-6989586621681358417"><span class="hs-identifier hs-var">m_sak</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-172"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621681358414"><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681358414"><span class="hs-identifier hs-var">sak</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">DefunKindInfo -&gt; PrM [DDec]
</span><a href="#local-6989586621681358415"><span class="hs-identifier hs-var">defun</span></a></span><span> </span><span class="annot"><span class="annottext">(DefunKindInfo -&gt; PrM [DDec]) -&gt; DefunKindInfo -&gt; PrM [DDec]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">DType -&gt; DefunKindInfo
</span><a href="Data.Singletons.Promote.Defun.html#DefunSAK"><span class="hs-identifier hs-var">DefunSAK</span></a></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681358414"><span class="hs-identifier hs-var">sak</span></a></span><span>
</span><span id="line-173"></span><span>    </span><span class="annot"><span class="annottext">Maybe DType
</span><span class="hs-identifier hs-var">Nothing</span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">DefunKindInfo -&gt; PrM [DDec]
</span><a href="#local-6989586621681358415"><span class="hs-identifier hs-var">defun</span></a></span><span> </span><span class="annot"><span class="annottext">(DefunKindInfo -&gt; PrM [DDec]) -&gt; DefunKindInfo -&gt; PrM [DDec]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[DTyVarBndr] -&gt; Maybe DType -&gt; DefunKindInfo
</span><a href="Data.Singletons.Promote.Defun.html#DefunNoSAK"><span class="hs-identifier hs-var">DefunNoSAK</span></a></span><span> </span><span class="annot"><span class="annottext">[DTyVarBndr]
</span><a href="#local-6989586621681358420"><span class="hs-identifier hs-var">tvbs</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe DType
</span><a href="#local-6989586621681358419"><span class="hs-identifier hs-var">m_res_kind</span></a></span><span>
</span><span id="line-174"></span><span>
</span><span id="line-175"></span><span class="hs-comment">-- Generate symbol data types, Apply instances, and other declarations required</span><span>
</span><span id="line-176"></span><span class="hs-comment">-- for defunctionalization.</span><span>
</span><span id="line-177"></span><span class="hs-comment">-- See Note [Defunctionalization game plan] for an overview of the design</span><span>
</span><span id="line-178"></span><span class="hs-comment">-- considerations involved.</span><span>
</span><span id="line-179"></span><span class="annot"><a href="Data.Singletons.Promote.Defun.html#defunctionalize"><span class="hs-identifier hs-type">defunctionalize</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span>
</span><span id="line-180"></span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Fixity</span></span><span>
</span><span id="line-181"></span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Data.Singletons.Promote.Defun.html#DefunKindInfo"><span class="hs-identifier hs-type">DefunKindInfo</span></a></span><span>
</span><span id="line-182"></span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Data.Singletons.Promote.Monad.html#PrM"><span class="hs-identifier hs-type">PrM</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">DDec</span></span><span class="hs-special">]</span><span>
</span><span id="line-183"></span><span id="defunctionalize"><span class="annot"><span class="annottext">defunctionalize :: Name -&gt; Maybe Fixity -&gt; DefunKindInfo -&gt; PrM [DDec]
</span><a href="Data.Singletons.Promote.Defun.html#defunctionalize"><span class="hs-identifier hs-var hs-var">defunctionalize</span></a></span></span><span> </span><span id="local-6989586621681358412"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681358412"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span id="local-6989586621681358411"><span class="annot"><span class="annottext">Maybe Fixity
</span><a href="#local-6989586621681358411"><span class="hs-identifier hs-var">m_fixity</span></a></span></span><span> </span><span id="local-6989586621681358410"><span class="annot"><span class="annottext">DefunKindInfo
</span><a href="#local-6989586621681358410"><span class="hs-identifier hs-var">defun_ki</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-184"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">DefunKindInfo
</span><a href="#local-6989586621681358410"><span class="hs-identifier hs-var">defun_ki</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-185"></span><span>    </span><span class="annot"><a href="Data.Singletons.Promote.Defun.html#DefunSAK"><span class="hs-identifier hs-type">DefunSAK</span></a></span><span> </span><span id="local-6989586621681358409"><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681358409"><span class="hs-identifier hs-var">sak</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-186"></span><span>      </span><span class="hs-comment">-- Even if a declaration has a SAK, its kind may not be vanilla.</span><span>
</span><span id="line-187"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">DType -&gt; Either String ([DTyVarBndr], DCxt, DCxt, DType)
</span><a href="Data.Singletons.Util.html#unravelVanillaDType_either"><span class="hs-identifier hs-var">unravelVanillaDType_either</span></a></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681358409"><span class="hs-identifier hs-var">sak</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-188"></span><span>        </span><span class="hs-comment">-- If the kind isn't vanilla, use the fallback approach.</span><span>
</span><span id="line-189"></span><span>        </span><span class="hs-comment">-- See Note [Defunctionalization game plan],</span><span>
</span><span id="line-190"></span><span>        </span><span class="hs-comment">-- Wrinkle 2: Non-vanilla kinds.</span><span>
</span><span id="line-191"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[DTyVarBndr] -&gt; Maybe DType -&gt; PrM [DDec]
</span><a href="#local-6989586621681358407"><span class="hs-identifier hs-var">defun_fallback</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DType -&gt; Maybe DType
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681358409"><span class="hs-identifier hs-var">sak</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-192"></span><span>        </span><span class="hs-comment">-- Otherwise, proceed with defun_vanilla_sak.</span><span>
</span><span id="line-193"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681358406"><span class="annot"><span class="annottext">[DTyVarBndr]
</span><a href="#local-6989586621681358406"><span class="hs-identifier hs-var">sak_tvbs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681358405"><span class="annot"><span class="annottext">DCxt
</span><a href="#local-6989586621681358405"><span class="hs-identifier hs-var">_sak_cxt</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681358404"><span class="annot"><span class="annottext">DCxt
</span><a href="#local-6989586621681358404"><span class="hs-identifier hs-var">sak_arg_kis</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681358403"><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681358403"><span class="hs-identifier hs-var">sak_res_ki</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-194"></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[DTyVarBndr] -&gt; DCxt -&gt; DType -&gt; PrM [DDec]
</span><a href="#local-6989586621681358402"><span class="hs-identifier hs-var">defun_vanilla_sak</span></a></span><span> </span><span class="annot"><span class="annottext">[DTyVarBndr]
</span><a href="#local-6989586621681358406"><span class="hs-identifier hs-var">sak_tvbs</span></a></span><span> </span><span class="annot"><span class="annottext">DCxt
</span><a href="#local-6989586621681358404"><span class="hs-identifier hs-var">sak_arg_kis</span></a></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681358403"><span class="hs-identifier hs-var">sak_res_ki</span></a></span><span>
</span><span id="line-195"></span><span>    </span><span class="hs-comment">-- If a declaration lacks a SAK, it likely has a partial kind.</span><span>
</span><span id="line-196"></span><span>    </span><span class="hs-comment">-- See Note [Defunctionalization game plan], Wrinkle 1: Partial kinds.</span><span>
</span><span id="line-197"></span><span>    </span><span class="annot"><a href="Data.Singletons.Promote.Defun.html#DefunNoSAK"><span class="hs-identifier hs-type">DefunNoSAK</span></a></span><span> </span><span id="local-6989586621681358401"><span class="annot"><span class="annottext">[DTyVarBndr]
</span><a href="#local-6989586621681358401"><span class="hs-identifier hs-var">tvbs</span></a></span></span><span> </span><span id="local-6989586621681358400"><span class="annot"><span class="annottext">Maybe DType
</span><a href="#local-6989586621681358400"><span class="hs-identifier hs-var">m_res</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[DTyVarBndr] -&gt; Maybe DType -&gt; PrM [DDec]
</span><a href="#local-6989586621681358407"><span class="hs-identifier hs-var">defun_fallback</span></a></span><span> </span><span class="annot"><span class="annottext">[DTyVarBndr]
</span><a href="#local-6989586621681358401"><span class="hs-identifier hs-var">tvbs</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe DType
</span><a href="#local-6989586621681358400"><span class="hs-identifier hs-var">m_res</span></a></span><span>
</span><span id="line-198"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-199"></span><span>    </span><span class="hs-comment">-- Generate defunctionalization symbols for things with vanilla SAKs.</span><span>
</span><span id="line-200"></span><span>    </span><span class="hs-comment">-- The symbols themselves will also be given SAKs.</span><span>
</span><span id="line-201"></span><span>    </span><span class="annot"><a href="#local-6989586621681358402"><span class="hs-identifier hs-type">defun_vanilla_sak</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">DTyVarBndr</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">DKind</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DKind</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Data.Singletons.Promote.Monad.html#PrM"><span class="hs-identifier hs-type">PrM</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">DDec</span></span><span class="hs-special">]</span><span>
</span><span id="line-202"></span><span>    </span><span id="local-6989586621681358402"><span class="annot"><span class="annottext">defun_vanilla_sak :: [DTyVarBndr] -&gt; DCxt -&gt; DType -&gt; PrM [DDec]
</span><a href="#local-6989586621681358402"><span class="hs-identifier hs-var hs-var">defun_vanilla_sak</span></a></span></span><span> </span><span id="local-6989586621681358399"><span class="annot"><span class="annottext">[DTyVarBndr]
</span><a href="#local-6989586621681358399"><span class="hs-identifier hs-var">sak_tvbs</span></a></span></span><span> </span><span id="local-6989586621681358398"><span class="annot"><span class="annottext">DCxt
</span><a href="#local-6989586621681358398"><span class="hs-identifier hs-var">sak_arg_kis</span></a></span></span><span> </span><span id="local-6989586621681358397"><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681358397"><span class="hs-identifier hs-var">sak_res_ki</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-203"></span><span>      </span><span id="local-6989586621681358396"><span class="annot"><span class="annottext">Options
</span><a href="#local-6989586621681358396"><span class="hs-identifier hs-var">opts</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">PrM Options
forall (m :: * -&gt; *). OptionsMonad m =&gt; m Options
</span><a href="Data.Singletons.TH.Options.html#getOptions"><span class="hs-identifier hs-var">getOptions</span></a></span><span>
</span><span id="line-204"></span><span>      </span><span id="local-6989586621681358394"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681358394"><span class="hs-identifier hs-var">extra_name</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; PrM Name
forall (m :: * -&gt; *). Quasi m =&gt; String -&gt; m Name
</span><span class="hs-identifier hs-var">qNewName</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;arg&quot;</span></span><span>
</span><span id="line-205"></span><span>      </span><span class="hs-comment">-- Use noExactName below to avoid #17537.</span><span>
</span><span id="line-206"></span><span>      </span><span id="local-6989586621681358392"><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621681358392"><span class="hs-identifier hs-var">arg_names</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int -&gt; PrM Name -&gt; PrM [Name]
forall (m :: * -&gt; *) a. Applicative m =&gt; Int -&gt; m a -&gt; m [a]
</span><span class="hs-identifier hs-var">replicateM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DCxt -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">DCxt
</span><a href="#local-6989586621681358398"><span class="hs-identifier hs-var">sak_arg_kis</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; Name
</span><a href="Data.Singletons.Util.html#noExactName"><span class="hs-identifier hs-var">noExactName</span></a></span><span> </span><span class="annot"><span class="annottext">(Name -&gt; Name) -&gt; PrM Name -&gt; PrM Name
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; PrM Name
forall (m :: * -&gt; *). Quasi m =&gt; String -&gt; m Name
</span><span class="hs-identifier hs-var">qNewName</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;a&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-207"></span><span>
</span><span id="line-208"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span class="hs-comment">-- The inner loop. @go n arg_nks res_nks@ returns @(res_k, decls)@.</span><span>
</span><span id="line-209"></span><span>          </span><span class="hs-comment">-- Using one particular example:</span><span>
</span><span id="line-210"></span><span>          </span><span class="hs-comment">--</span><span>
</span><span id="line-211"></span><span>          </span><span class="hs-comment">-- @</span><span>
</span><span id="line-212"></span><span>          </span><span class="hs-comment">-- type ExampleSym2 :: a -&gt; b -&gt; c ~&gt; d ~&gt; Type</span><span>
</span><span id="line-213"></span><span>          </span><span class="hs-comment">-- data ExampleSym2 x y where ...</span><span>
</span><span id="line-214"></span><span>          </span><span class="hs-comment">-- type instance Apply (ExampleSym2 x y) z = ExampleSym3 x y z</span><span>
</span><span id="line-215"></span><span>          </span><span class="hs-comment">-- ...</span><span>
</span><span id="line-216"></span><span>          </span><span class="hs-comment">-- @</span><span>
</span><span id="line-217"></span><span>          </span><span class="hs-comment">--</span><span>
</span><span id="line-218"></span><span>          </span><span class="hs-comment">-- We have:</span><span>
</span><span id="line-219"></span><span>          </span><span class="hs-comment">--</span><span>
</span><span id="line-220"></span><span>          </span><span class="hs-comment">-- * @n@ is 2. This is incremented in each iteration of `go`.</span><span>
</span><span id="line-221"></span><span>          </span><span class="hs-comment">--</span><span>
</span><span id="line-222"></span><span>          </span><span class="hs-comment">-- * @arg_nks@ is [(x, a), (y, b)]. Each element in this list is a</span><span>
</span><span id="line-223"></span><span>          </span><span class="hs-comment">-- (type variable name, type variable kind) pair. The kinds appear in</span><span>
</span><span id="line-224"></span><span>          </span><span class="hs-comment">-- the SAK, separated by matchable arrows (-&gt;).</span><span>
</span><span id="line-225"></span><span>          </span><span class="hs-comment">--</span><span>
</span><span id="line-226"></span><span>          </span><span class="hs-comment">-- * @res_tvbs@ is [(z, c), (w, d)]. Each element in this list is a</span><span>
</span><span id="line-227"></span><span>          </span><span class="hs-comment">-- (type variable name, type variable kind) pair. The kinds appear in</span><span>
</span><span id="line-228"></span><span>          </span><span class="hs-comment">-- @res_k@, separated by unmatchable arrows (~&gt;).</span><span>
</span><span id="line-229"></span><span>          </span><span class="hs-comment">--</span><span>
</span><span id="line-230"></span><span>          </span><span class="hs-comment">-- * @res_k@ is `c ~&gt; d ~&gt; Type`. @res_k@ is returned so that earlier</span><span>
</span><span id="line-231"></span><span>          </span><span class="hs-comment">--   defunctionalization symbols can build on the result kinds of</span><span>
</span><span id="line-232"></span><span>          </span><span class="hs-comment">--   later symbols. For instance, ExampleSym1 would get the result</span><span>
</span><span id="line-233"></span><span>          </span><span class="hs-comment">--   kind `b ~&gt; c ~&gt; d ~&gt; Type` by prepending `b` to ExampleSym2's</span><span>
</span><span id="line-234"></span><span>          </span><span class="hs-comment">--   result kind `c ~&gt; d ~&gt; Type`.</span><span>
</span><span id="line-235"></span><span>          </span><span class="hs-comment">--</span><span>
</span><span id="line-236"></span><span>          </span><span class="hs-comment">-- * @decls@ are all of the declarations corresponding to ExampleSym2</span><span>
</span><span id="line-237"></span><span>          </span><span class="hs-comment">--   and later defunctionalization symbols. This is the main payload of</span><span>
</span><span id="line-238"></span><span>          </span><span class="hs-comment">--   the function.</span><span>
</span><span id="line-239"></span><span>          </span><span class="hs-comment">--</span><span>
</span><span id="line-240"></span><span>          </span><span class="hs-comment">-- This function is quadratic because it appends a variable at the end of</span><span>
</span><span id="line-241"></span><span>          </span><span class="hs-comment">-- the @arg_nks@ list at each iteration. In practice, this is unlikely</span><span>
</span><span id="line-242"></span><span>          </span><span class="hs-comment">-- to be a performance bottleneck since the number of arguments rarely</span><span>
</span><span id="line-243"></span><span>          </span><span class="hs-comment">-- gets to be that large.</span><span>
</span><span id="line-244"></span><span>          </span><span class="annot"><a href="#local-6989586621681358387"><span class="hs-identifier hs-type">go</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DKind</span></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DKind</span></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DKind</span></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">DDec</span></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-245"></span><span>          </span><span id="local-6989586621681358387"><span class="annot"><span class="annottext">go :: Int -&gt; [(Name, DType)] -&gt; [(Name, DType)] -&gt; (DType, [DDec])
</span><a href="#local-6989586621681358387"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621681358386"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681358386"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621681358385"><span class="annot"><span class="annottext">[(Name, DType)]
</span><a href="#local-6989586621681358385"><span class="hs-identifier hs-var">arg_nks</span></a></span></span><span> </span><span id="local-6989586621681358384"><span class="annot"><span class="annottext">[(Name, DType)]
</span><a href="#local-6989586621681358384"><span class="hs-identifier hs-var">res_nkss</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-246"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[(Name, DType)]
</span><a href="#local-6989586621681358384"><span class="hs-identifier hs-var">res_nkss</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-247"></span><span>              </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-248"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span class="hs-comment">-- Somewhat surprisingly, we do *not* generate SAKs for</span><span>
</span><span id="line-249"></span><span>                    </span><span class="hs-comment">-- fully saturated defunctionalization symbols.</span><span>
</span><span id="line-250"></span><span>                    </span><span class="hs-comment">-- See Note [No SAKs for fully saturated defunctionalization symbols]</span><span>
</span><span id="line-251"></span><span>                    </span><span id="local-6989586621681358383"><span class="annot"><span class="annottext">sat_decs :: [DDec]
</span><a href="#local-6989586621681358383"><span class="hs-identifier hs-var hs-var">sat_decs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Options -&gt; Int -&gt; [DTyVarBndr] -&gt; Maybe DType -&gt; [DDec]
</span><a href="#local-6989586621681358382"><span class="hs-identifier hs-var">mk_sat_decs</span></a></span><span> </span><span class="annot"><span class="annottext">Options
</span><a href="#local-6989586621681358396"><span class="hs-identifier hs-var">opts</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681358386"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((Name, DType) -&gt; DTyVarBndr) -&gt; [(Name, DType)] -&gt; [DTyVarBndr]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Name -&gt; DType -&gt; DTyVarBndr) -&gt; (Name, DType) -&gt; DTyVarBndr
forall a b c. (a -&gt; b -&gt; c) -&gt; (a, b) -&gt; c
</span><span class="hs-identifier hs-var">uncurry</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; DType -&gt; DTyVarBndr
</span><span class="hs-identifier hs-var">DKindedTV</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(Name, DType)]
</span><a href="#local-6989586621681358385"><span class="hs-identifier hs-var">arg_nks</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-252"></span><span>                                           </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DType -&gt; Maybe DType
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681358397"><span class="hs-identifier hs-var">sak_res_ki</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-253"></span><span>                </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681358397"><span class="hs-identifier hs-var">sak_res_ki</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621681358383"><span class="hs-identifier hs-var">sat_decs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-254"></span><span>              </span><span id="local-6989586621681358380"><span class="annot"><span class="annottext">(Name, DType)
</span><a href="#local-6989586621681358380"><span class="hs-identifier hs-var">res_nk</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621681358379"><span class="annot"><span class="annottext">[(Name, DType)]
</span><a href="#local-6989586621681358379"><span class="hs-identifier hs-var">res_nks</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-255"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681358378"><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681358378"><span class="hs-identifier hs-var">res_ki</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681358377"><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621681358377"><span class="hs-identifier hs-var">decs</span></a></span></span><span class="hs-special">)</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [(Name, DType)] -&gt; [(Name, DType)] -&gt; (DType, [DDec])
</span><a href="#local-6989586621681358387"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681358386"><span class="hs-identifier hs-var">n</span></a></span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[(Name, DType)]
</span><a href="#local-6989586621681358385"><span class="hs-identifier hs-var">arg_nks</span></a></span><span> </span><span class="annot"><span class="annottext">[(Name, DType)] -&gt; [(Name, DType)] -&gt; [(Name, DType)]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">(Name, DType)
</span><a href="#local-6989586621681358380"><span class="hs-identifier hs-var">res_nk</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(Name, DType)]
</span><a href="#local-6989586621681358379"><span class="hs-identifier hs-var">res_nks</span></a></span><span>
</span><span id="line-256"></span><span>                    </span><span id="local-6989586621681358375"><span class="annot"><span class="annottext">tyfun :: DType
</span><a href="#local-6989586621681358375"><span class="hs-identifier hs-var hs-var">tyfun</span></a></span></span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DType -&gt; DType -&gt; DType
</span><a href="Data.Singletons.Promote.Defun.html#buildTyFunArrow"><span class="hs-identifier hs-var">buildTyFunArrow</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Name, DType) -&gt; DType
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span> </span><span class="annot"><span class="annottext">(Name, DType)
</span><a href="#local-6989586621681358380"><span class="hs-identifier hs-var">res_nk</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681358378"><span class="hs-identifier hs-var">res_ki</span></a></span><span>
</span><span id="line-257"></span><span>                    </span><span id="local-6989586621681358373"><span class="annot"><span class="annottext">defun_sak_dec :: DDec
</span><a href="#local-6989586621681358373"><span class="hs-identifier hs-var hs-var">defun_sak_dec</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name -&gt; DType -&gt; DDec
</span><span class="hs-identifier hs-var">DKiSigD</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Options -&gt; Name -&gt; Int -&gt; Name
</span><a href="Data.Singletons.TH.Options.html#defunctionalizedName"><span class="hs-identifier hs-var hs-var">defunctionalizedName</span></a></span><span> </span><span class="annot"><span class="annottext">Options
</span><a href="#local-6989586621681358396"><span class="hs-identifier hs-var">opts</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681358412"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681358386"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(DType -&gt; DDec) -&gt; DType -&gt; DDec
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-258"></span><span>                                       </span><span class="annot"><span class="annottext">[DTyVarBndr] -&gt; DCxt -&gt; DCxt -&gt; DType -&gt; DType
</span><a href="Data.Singletons.Util.html#ravelVanillaDType"><span class="hs-identifier hs-var">ravelVanillaDType</span></a></span><span> </span><span class="annot"><span class="annottext">[DTyVarBndr]
</span><a href="#local-6989586621681358399"><span class="hs-identifier hs-var">sak_tvbs</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((Name, DType) -&gt; DType) -&gt; [(Name, DType)] -&gt; DCxt
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(Name, DType) -&gt; DType
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span> </span><span class="annot"><span class="annottext">[(Name, DType)]
</span><a href="#local-6989586621681358385"><span class="hs-identifier hs-var">arg_nks</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681358375"><span class="hs-identifier hs-var">tyfun</span></a></span><span>
</span><span id="line-259"></span><span>                    </span><span id="local-6989586621681358370"><span class="annot"><span class="annottext">defun_other_decs :: [DDec]
</span><a href="#local-6989586621681358370"><span class="hs-identifier hs-var hs-var">defun_other_decs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Options
-&gt; Int -&gt; [DTyVarBndr] -&gt; Name -&gt; Name -&gt; Maybe DType -&gt; [DDec]
</span><a href="#local-6989586621681358369"><span class="hs-identifier hs-var">mk_defun_decs</span></a></span><span> </span><span class="annot"><span class="annottext">Options
</span><a href="#local-6989586621681358396"><span class="hs-identifier hs-var">opts</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681358386"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((Name, DType) -&gt; DTyVarBndr) -&gt; [(Name, DType)] -&gt; [DTyVarBndr]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; DTyVarBndr
</span><span class="hs-identifier hs-var">DPlainTV</span></span><span> </span><span class="annot"><span class="annottext">(Name -&gt; DTyVarBndr)
-&gt; ((Name, DType) -&gt; Name) -&gt; (Name, DType) -&gt; DTyVarBndr
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Name, DType) -&gt; Name
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(Name, DType)]
</span><a href="#local-6989586621681358385"><span class="hs-identifier hs-var">arg_nks</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-260"></span><span>                                                     </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Name, DType) -&gt; Name
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">(Name, DType)
</span><a href="#local-6989586621681358380"><span class="hs-identifier hs-var">res_nk</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681358394"><span class="hs-identifier hs-var">extra_name</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe DType
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-261"></span><span>                </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681358375"><span class="hs-identifier hs-var">tyfun</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">DDec
</span><a href="#local-6989586621681358373"><span class="hs-identifier hs-var">defun_sak_dec</span></a></span><span class="annot"><span class="annottext">DDec -&gt; [DDec] -&gt; [DDec]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621681358370"><span class="hs-identifier hs-var">defun_other_decs</span></a></span><span> </span><span class="annot"><span class="annottext">[DDec] -&gt; [DDec] -&gt; [DDec]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621681358377"><span class="hs-identifier hs-var">decs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-262"></span><span>
</span><span id="line-263"></span><span>      </span><span class="annot"><span class="annottext">[DDec] -&gt; PrM [DDec]
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">([DDec] -&gt; PrM [DDec]) -&gt; [DDec] -&gt; PrM [DDec]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(DType, [DDec]) -&gt; [DDec]
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span> </span><span class="annot"><span class="annottext">((DType, [DDec]) -&gt; [DDec]) -&gt; (DType, [DDec]) -&gt; [DDec]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; [(Name, DType)] -&gt; [(Name, DType)] -&gt; (DType, [DDec])
</span><a href="#local-6989586621681358387"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">([(Name, DType)] -&gt; (DType, [DDec]))
-&gt; [(Name, DType)] -&gt; (DType, [DDec])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Name] -&gt; DCxt -&gt; [(Name, DType)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621681358392"><span class="hs-identifier hs-var">arg_names</span></a></span><span> </span><span class="annot"><span class="annottext">DCxt
</span><a href="#local-6989586621681358398"><span class="hs-identifier hs-var">sak_arg_kis</span></a></span><span>
</span><span id="line-264"></span><span>
</span><span id="line-265"></span><span>    </span><span class="hs-comment">-- If defun_sak can't be used to defunctionalize something, this fallback</span><span>
</span><span id="line-266"></span><span>    </span><span class="hs-comment">-- approach is used. This is used when defunctionalizing something with a</span><span>
</span><span id="line-267"></span><span>    </span><span class="hs-comment">-- partial kind</span><span>
</span><span id="line-268"></span><span>    </span><span class="hs-comment">-- (see Note [Defunctionalization game plan], Wrinkle 1: Partial kinds)</span><span>
</span><span id="line-269"></span><span>    </span><span class="hs-comment">-- or a non-vanilla kind</span><span>
</span><span id="line-270"></span><span>    </span><span class="hs-comment">-- (see Note [Defunctionalization game plan], Wrinkle 2: Non-vanilla kinds).</span><span>
</span><span id="line-271"></span><span>    </span><span class="annot"><a href="#local-6989586621681358407"><span class="hs-identifier hs-type">defun_fallback</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">DTyVarBndr</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">DKind</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Data.Singletons.Promote.Monad.html#PrM"><span class="hs-identifier hs-type">PrM</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">DDec</span></span><span class="hs-special">]</span><span>
</span><span id="line-272"></span><span>    </span><span id="local-6989586621681358407"><span class="annot"><span class="annottext">defun_fallback :: [DTyVarBndr] -&gt; Maybe DType -&gt; PrM [DDec]
</span><a href="#local-6989586621681358407"><span class="hs-identifier hs-var hs-var">defun_fallback</span></a></span></span><span> </span><span id="local-6989586621681358368"><span class="annot"><span class="annottext">[DTyVarBndr]
</span><a href="#local-6989586621681358368"><span class="hs-identifier hs-var">tvbs'</span></a></span></span><span> </span><span id="local-6989586621681358367"><span class="annot"><span class="annottext">Maybe DType
</span><a href="#local-6989586621681358367"><span class="hs-identifier hs-var">m_res'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-273"></span><span>      </span><span id="local-6989586621681358366"><span class="annot"><span class="annottext">Options
</span><a href="#local-6989586621681358366"><span class="hs-identifier hs-var">opts</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">PrM Options
forall (m :: * -&gt; *). OptionsMonad m =&gt; m Options
</span><a href="Data.Singletons.TH.Options.html#getOptions"><span class="hs-identifier hs-var">getOptions</span></a></span><span>
</span><span id="line-274"></span><span>      </span><span id="local-6989586621681358365"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681358365"><span class="hs-identifier hs-var">extra_name</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; PrM Name
forall (m :: * -&gt; *). Quasi m =&gt; String -&gt; m Name
</span><span class="hs-identifier hs-var">qNewName</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;arg&quot;</span></span><span>
</span><span id="line-275"></span><span>      </span><span class="hs-comment">-- Use noExactTyVars below to avoid #11812.</span><span>
</span><span id="line-276"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621681358364"><span class="annot"><span class="annottext">[DTyVarBndr]
</span><a href="#local-6989586621681358364"><span class="hs-identifier hs-var">tvbs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681358363"><span class="annot"><span class="annottext">Maybe DType
</span><a href="#local-6989586621681358363"><span class="hs-identifier hs-var">m_res</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[DTyVarBndr] -&gt; Maybe DType -&gt; PrM ([DTyVarBndr], Maybe DType)
</span><a href="#local-6989586621681358362"><span class="hs-identifier hs-var">eta_expand</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[DTyVarBndr] -&gt; [DTyVarBndr]
forall a. Data a =&gt; a -&gt; a
</span><a href="Data.Singletons.Util.html#noExactTyVars"><span class="hs-identifier hs-var">noExactTyVars</span></a></span><span> </span><span class="annot"><span class="annottext">[DTyVarBndr]
</span><a href="#local-6989586621681358368"><span class="hs-identifier hs-var">tvbs'</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe DType -&gt; Maybe DType
forall a. Data a =&gt; a -&gt; a
</span><a href="Data.Singletons.Util.html#noExactTyVars"><span class="hs-identifier hs-var">noExactTyVars</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe DType
</span><a href="#local-6989586621681358367"><span class="hs-identifier hs-var">m_res'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-277"></span><span>
</span><span id="line-278"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span class="hs-comment">-- The inner loop. @go n arg_tvbs res_tvbs@ returns @(m_res_k, decls)@.</span><span>
</span><span id="line-279"></span><span>          </span><span class="hs-comment">-- Using one particular example:</span><span>
</span><span id="line-280"></span><span>          </span><span class="hs-comment">--</span><span>
</span><span id="line-281"></span><span>          </span><span class="hs-comment">-- @</span><span>
</span><span id="line-282"></span><span>          </span><span class="hs-comment">-- data ExampleSym2 (x :: a) y :: c ~&gt; d ~&gt; Type where ...</span><span>
</span><span id="line-283"></span><span>          </span><span class="hs-comment">-- type instance Apply (ExampleSym2 x y) z = ExampleSym3 x y z</span><span>
</span><span id="line-284"></span><span>          </span><span class="hs-comment">-- ...</span><span>
</span><span id="line-285"></span><span>          </span><span class="hs-comment">-- @</span><span>
</span><span id="line-286"></span><span>          </span><span class="hs-comment">--</span><span>
</span><span id="line-287"></span><span>          </span><span class="hs-comment">-- This works very similarly to the `go` function in</span><span>
</span><span id="line-288"></span><span>          </span><span class="hs-comment">-- `defun_vanilla_sak`. The main differences are:</span><span>
</span><span id="line-289"></span><span>          </span><span class="hs-comment">--</span><span>
</span><span id="line-290"></span><span>          </span><span class="hs-comment">-- * This function does not produce any SAKs for defunctionalization</span><span>
</span><span id="line-291"></span><span>          </span><span class="hs-comment">--   symbols.</span><span>
</span><span id="line-292"></span><span>          </span><span class="hs-comment">--</span><span>
</span><span id="line-293"></span><span>          </span><span class="hs-comment">-- * Instead of [(Name, DKind)], this function uses [DTyVarBndr] as</span><span>
</span><span id="line-294"></span><span>          </span><span class="hs-comment">--   the types of @arg_tvbs@ and @res_tvbs@. This is because the</span><span>
</span><span id="line-295"></span><span>          </span><span class="hs-comment">--   kinds are not always known. By a similar token, this function</span><span>
</span><span id="line-296"></span><span>          </span><span class="hs-comment">--   uses Maybe DKind, not DKind, as the type of @m_res_k@, since</span><span>
</span><span id="line-297"></span><span>          </span><span class="hs-comment">--   the result kind is not always fully known.</span><span>
</span><span id="line-298"></span><span>          </span><span class="annot"><a href="#local-6989586621681358360"><span class="hs-identifier hs-type">go</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">DTyVarBndr</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">DTyVarBndr</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">DKind</span></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">DDec</span></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-299"></span><span>          </span><span id="local-6989586621681358360"><span class="annot"><span class="annottext">go :: Int -&gt; [DTyVarBndr] -&gt; [DTyVarBndr] -&gt; (Maybe DType, [DDec])
</span><a href="#local-6989586621681358360"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621681358359"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681358359"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621681358358"><span class="annot"><span class="annottext">[DTyVarBndr]
</span><a href="#local-6989586621681358358"><span class="hs-identifier hs-var">arg_tvbs</span></a></span></span><span> </span><span id="local-6989586621681358357"><span class="annot"><span class="annottext">[DTyVarBndr]
</span><a href="#local-6989586621681358357"><span class="hs-identifier hs-var">res_tvbss</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-300"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[DTyVarBndr]
</span><a href="#local-6989586621681358357"><span class="hs-identifier hs-var">res_tvbss</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-301"></span><span>              </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-302"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681358356"><span class="annot"><span class="annottext">sat_decs :: [DDec]
</span><a href="#local-6989586621681358356"><span class="hs-identifier hs-var hs-var">sat_decs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Options -&gt; Int -&gt; [DTyVarBndr] -&gt; Maybe DType -&gt; [DDec]
</span><a href="#local-6989586621681358382"><span class="hs-identifier hs-var">mk_sat_decs</span></a></span><span> </span><span class="annot"><span class="annottext">Options
</span><a href="#local-6989586621681358366"><span class="hs-identifier hs-var">opts</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681358359"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">[DTyVarBndr]
</span><a href="#local-6989586621681358358"><span class="hs-identifier hs-var">arg_tvbs</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe DType
</span><a href="#local-6989586621681358363"><span class="hs-identifier hs-var">m_res</span></a></span><span>
</span><span id="line-303"></span><span>                </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe DType
</span><a href="#local-6989586621681358363"><span class="hs-identifier hs-var">m_res</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621681358356"><span class="hs-identifier hs-var">sat_decs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-304"></span><span>              </span><span id="local-6989586621681358355"><span class="annot"><span class="annottext">DTyVarBndr
</span><a href="#local-6989586621681358355"><span class="hs-identifier hs-var">res_tvb</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621681358354"><span class="annot"><span class="annottext">[DTyVarBndr]
</span><a href="#local-6989586621681358354"><span class="hs-identifier hs-var">res_tvbs</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-305"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681358353"><span class="annot"><span class="annottext">Maybe DType
</span><a href="#local-6989586621681358353"><span class="hs-identifier hs-var">m_res_ki</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681358352"><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621681358352"><span class="hs-identifier hs-var">decs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [DTyVarBndr] -&gt; [DTyVarBndr] -&gt; (Maybe DType, [DDec])
</span><a href="#local-6989586621681358360"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681358359"><span class="hs-identifier hs-var">n</span></a></span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[DTyVarBndr]
</span><a href="#local-6989586621681358358"><span class="hs-identifier hs-var">arg_tvbs</span></a></span><span> </span><span class="annot"><span class="annottext">[DTyVarBndr] -&gt; [DTyVarBndr] -&gt; [DTyVarBndr]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">DTyVarBndr
</span><a href="#local-6989586621681358355"><span class="hs-identifier hs-var">res_tvb</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[DTyVarBndr]
</span><a href="#local-6989586621681358354"><span class="hs-identifier hs-var">res_tvbs</span></a></span><span>
</span><span id="line-306"></span><span>                    </span><span id="local-6989586621681358351"><span class="annot"><span class="annottext">m_tyfun :: Maybe DType
</span><a href="#local-6989586621681358351"><span class="hs-identifier hs-var hs-var">m_tyfun</span></a></span></span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe DType -&gt; Maybe DType -&gt; Maybe DType
</span><a href="Data.Singletons.Promote.Defun.html#buildTyFunArrow_maybe"><span class="hs-identifier hs-var">buildTyFunArrow_maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DTyVarBndr -&gt; Maybe DType
</span><a href="Data.Singletons.Util.html#extractTvbKind"><span class="hs-identifier hs-var">extractTvbKind</span></a></span><span> </span><span class="annot"><span class="annottext">DTyVarBndr
</span><a href="#local-6989586621681358355"><span class="hs-identifier hs-var">res_tvb</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-307"></span><span>                                                             </span><span class="annot"><span class="annottext">Maybe DType
</span><a href="#local-6989586621681358353"><span class="hs-identifier hs-var">m_res_ki</span></a></span><span>
</span><span id="line-308"></span><span>                    </span><span id="local-6989586621681358349"><span class="annot"><span class="annottext">defun_decs' :: [DDec]
</span><a href="#local-6989586621681358349"><span class="hs-identifier hs-var hs-var">defun_decs'</span></a></span></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Options
-&gt; Int -&gt; [DTyVarBndr] -&gt; Name -&gt; Name -&gt; Maybe DType -&gt; [DDec]
</span><a href="#local-6989586621681358369"><span class="hs-identifier hs-var">mk_defun_decs</span></a></span><span> </span><span class="annot"><span class="annottext">Options
</span><a href="#local-6989586621681358366"><span class="hs-identifier hs-var">opts</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681358359"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">[DTyVarBndr]
</span><a href="#local-6989586621681358358"><span class="hs-identifier hs-var">arg_tvbs</span></a></span><span>
</span><span id="line-309"></span><span>                                                     </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DTyVarBndr -&gt; Name
</span><a href="Data.Singletons.Util.html#extractTvbName"><span class="hs-identifier hs-var">extractTvbName</span></a></span><span> </span><span class="annot"><span class="annottext">DTyVarBndr
</span><a href="#local-6989586621681358355"><span class="hs-identifier hs-var">res_tvb</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-310"></span><span>                                                     </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681358365"><span class="hs-identifier hs-var">extra_name</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe DType
</span><a href="#local-6989586621681358351"><span class="hs-identifier hs-var">m_tyfun</span></a></span><span>
</span><span id="line-311"></span><span>                </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe DType
</span><a href="#local-6989586621681358351"><span class="hs-identifier hs-var">m_tyfun</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621681358349"><span class="hs-identifier hs-var">defun_decs'</span></a></span><span> </span><span class="annot"><span class="annottext">[DDec] -&gt; [DDec] -&gt; [DDec]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621681358352"><span class="hs-identifier hs-var">decs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-312"></span><span>
</span><span id="line-313"></span><span>      </span><span class="annot"><span class="annottext">[DDec] -&gt; PrM [DDec]
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">([DDec] -&gt; PrM [DDec]) -&gt; [DDec] -&gt; PrM [DDec]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Maybe DType, [DDec]) -&gt; [DDec]
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span> </span><span class="annot"><span class="annottext">((Maybe DType, [DDec]) -&gt; [DDec])
-&gt; (Maybe DType, [DDec]) -&gt; [DDec]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; [DTyVarBndr] -&gt; [DTyVarBndr] -&gt; (Maybe DType, [DDec])
</span><a href="#local-6989586621681358360"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">[DTyVarBndr]
</span><a href="#local-6989586621681358364"><span class="hs-identifier hs-var">tvbs</span></a></span><span>
</span><span id="line-314"></span><span>
</span><span id="line-315"></span><span>    </span><span class="annot"><a href="#local-6989586621681358369"><span class="hs-identifier hs-type">mk_defun_decs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Data.Singletons.TH.Options.html#Options"><span class="hs-identifier hs-type">Options</span></a></span><span>
</span><span id="line-316"></span><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-317"></span><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">DTyVarBndr</span></span><span class="hs-special">]</span><span>
</span><span id="line-318"></span><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span>
</span><span id="line-319"></span><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span>
</span><span id="line-320"></span><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">DKind</span></span><span>
</span><span id="line-321"></span><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">DDec</span></span><span class="hs-special">]</span><span>
</span><span id="line-322"></span><span>    </span><span id="local-6989586621681358369"><span class="annot"><span class="annottext">mk_defun_decs :: Options
-&gt; Int -&gt; [DTyVarBndr] -&gt; Name -&gt; Name -&gt; Maybe DType -&gt; [DDec]
</span><a href="#local-6989586621681358369"><span class="hs-identifier hs-var hs-var">mk_defun_decs</span></a></span></span><span> </span><span id="local-6989586621681358348"><span class="annot"><span class="annottext">Options
</span><a href="#local-6989586621681358348"><span class="hs-identifier hs-var">opts</span></a></span></span><span> </span><span id="local-6989586621681358347"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681358347"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621681358346"><span class="annot"><span class="annottext">[DTyVarBndr]
</span><a href="#local-6989586621681358346"><span class="hs-identifier hs-var">arg_tvbs</span></a></span></span><span> </span><span id="local-6989586621681358345"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681358345"><span class="hs-identifier hs-var">tyfun_name</span></a></span></span><span> </span><span id="local-6989586621681358344"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681358344"><span class="hs-identifier hs-var">extra_name</span></a></span></span><span> </span><span id="local-6989586621681358343"><span class="annot"><span class="annottext">Maybe DType
</span><a href="#local-6989586621681358343"><span class="hs-identifier hs-var">m_tyfun</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-323"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681358342"><span class="annot"><span class="annottext">data_name :: Name
</span><a href="#local-6989586621681358342"><span class="hs-identifier hs-var hs-var">data_name</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Options -&gt; Name -&gt; Int -&gt; Name
</span><a href="Data.Singletons.TH.Options.html#defunctionalizedName"><span class="hs-identifier hs-var hs-var">defunctionalizedName</span></a></span><span> </span><span class="annot"><span class="annottext">Options
</span><a href="#local-6989586621681358348"><span class="hs-identifier hs-var">opts</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681358412"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681358347"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-324"></span><span>          </span><span id="local-6989586621681358341"><span class="annot"><span class="annottext">next_name :: Name
</span><a href="#local-6989586621681358341"><span class="hs-identifier hs-var hs-var">next_name</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Options -&gt; Name -&gt; Int -&gt; Name
</span><a href="Data.Singletons.TH.Options.html#defunctionalizedName"><span class="hs-identifier hs-var hs-var">defunctionalizedName</span></a></span><span> </span><span class="annot"><span class="annottext">Options
</span><a href="#local-6989586621681358348"><span class="hs-identifier hs-var">opts</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681358412"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681358347"><span class="hs-identifier hs-var">n</span></a></span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-325"></span><span>          </span><span id="local-6989586621681358340"><span class="annot"><span class="annottext">con_name :: Name
</span><a href="#local-6989586621681358340"><span class="hs-identifier hs-var hs-var">con_name</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; Name -&gt; Name
</span><a href="Data.Singletons.Util.html#prefixName"><span class="hs-identifier hs-var">prefixName</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;&quot;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;:&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Name -&gt; Name) -&gt; Name -&gt; Name
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; Name -&gt; Name
</span><a href="Data.Singletons.Util.html#suffixName"><span class="hs-identifier hs-var">suffixName</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;KindInference&quot;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;###&quot;</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681358342"><span class="hs-identifier hs-var">data_name</span></a></span><span>
</span><span id="line-326"></span><span>          </span><span id="local-6989586621681358337"><span class="annot"><span class="annottext">arg_names :: [Name]
</span><a href="#local-6989586621681358337"><span class="hs-identifier hs-var hs-var">arg_names</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(DTyVarBndr -&gt; Name) -&gt; [DTyVarBndr] -&gt; [Name]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">DTyVarBndr -&gt; Name
</span><a href="Data.Singletons.Util.html#extractTvbName"><span class="hs-identifier hs-var">extractTvbName</span></a></span><span> </span><span class="annot"><span class="annottext">[DTyVarBndr]
</span><a href="#local-6989586621681358346"><span class="hs-identifier hs-var">arg_tvbs</span></a></span><span>
</span><span id="line-327"></span><span>          </span><span id="local-6989586621681358336"><span class="annot"><span class="annottext">params :: [DTyVarBndr]
</span><a href="#local-6989586621681358336"><span class="hs-identifier hs-var hs-var">params</span></a></span></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[DTyVarBndr]
</span><a href="#local-6989586621681358346"><span class="hs-identifier hs-var">arg_tvbs</span></a></span><span> </span><span class="annot"><span class="annottext">[DTyVarBndr] -&gt; [DTyVarBndr] -&gt; [DTyVarBndr]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Name -&gt; DTyVarBndr
</span><span class="hs-identifier hs-var">DPlainTV</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681358345"><span class="hs-identifier hs-var">tyfun_name</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-328"></span><span>          </span><span id="local-6989586621681358335"><span class="annot"><span class="annottext">con_eq_ct :: DType
</span><a href="#local-6989586621681358335"><span class="hs-identifier hs-var hs-var">con_eq_ct</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name -&gt; DType
</span><span class="hs-identifier hs-var">DConT</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="Data.Singletons.Names.html#sameKindName"><span class="hs-identifier hs-var">sameKindName</span></a></span><span> </span><span class="annot"><span class="annottext">DType -&gt; DType -&gt; DType
</span><span class="hs-operator hs-var">`DAppT`</span></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681358332"><span class="hs-identifier hs-var">lhs</span></a></span><span> </span><span class="annot"><span class="annottext">DType -&gt; DType -&gt; DType
</span><span class="hs-operator hs-var">`DAppT`</span></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681358331"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-329"></span><span>            </span><span class="hs-keyword">where</span><span>
</span><span id="line-330"></span><span>              </span><span id="local-6989586621681358332"><span class="annot"><span class="annottext">lhs :: DType
</span><a href="#local-6989586621681358332"><span class="hs-identifier hs-var hs-var">lhs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DType -&gt; DCxt -&gt; DType
</span><a href="Data.Singletons.Util.html#foldType"><span class="hs-identifier hs-var">foldType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; DType
</span><span class="hs-identifier hs-var">DConT</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681358342"><span class="hs-identifier hs-var">data_name</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Name -&gt; DType) -&gt; [Name] -&gt; DCxt
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; DType
</span><span class="hs-identifier hs-var">DVarT</span></span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621681358337"><span class="hs-identifier hs-var">arg_names</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">DType -&gt; DType -&gt; DType
</span><a href="Data.Singletons.Names.html#apply"><span class="hs-operator hs-var">`apply`</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; DType
</span><span class="hs-identifier hs-var">DVarT</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681358344"><span class="hs-identifier hs-var">extra_name</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-331"></span><span>              </span><span id="local-6989586621681358331"><span class="annot"><span class="annottext">rhs :: DType
</span><a href="#local-6989586621681358331"><span class="hs-identifier hs-var hs-var">rhs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DType -&gt; DCxt -&gt; DType
</span><a href="Data.Singletons.Util.html#foldType"><span class="hs-identifier hs-var">foldType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; DType
</span><span class="hs-identifier hs-var">DConT</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681358341"><span class="hs-identifier hs-var">next_name</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Name -&gt; DType) -&gt; [Name] -&gt; DCxt
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; DType
</span><span class="hs-identifier hs-var">DVarT</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621681358337"><span class="hs-identifier hs-var">arg_names</span></a></span><span> </span><span class="annot"><span class="annottext">[Name] -&gt; [Name] -&gt; [Name]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681358344"><span class="hs-identifier hs-var">extra_name</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-332"></span><span>          </span><span id="local-6989586621681358327"><span class="annot"><span class="annottext">con_decl :: DCon
</span><a href="#local-6989586621681358327"><span class="hs-identifier hs-var hs-var">con_decl</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[DTyVarBndr] -&gt; DCxt -&gt; Name -&gt; DConFields -&gt; DType -&gt; DCon
</span><span class="hs-identifier hs-var">DCon</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681358335"><span class="hs-identifier hs-var">con_eq_ct</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681358340"><span class="hs-identifier hs-var">con_name</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; [DBangType] -&gt; DConFields
</span><span class="hs-identifier hs-var">DNormalC</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-333"></span><span>                             </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DType -&gt; [DTyVarBndr] -&gt; DType
</span><a href="Data.Singletons.Util.html#foldTypeTvbs"><span class="hs-identifier hs-var">foldTypeTvbs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; DType
</span><span class="hs-identifier hs-var">DConT</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681358342"><span class="hs-identifier hs-var">data_name</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[DTyVarBndr]
</span><a href="#local-6989586621681358336"><span class="hs-identifier hs-var">params</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-334"></span><span>          </span><span id="local-6989586621681358324"><span class="annot"><span class="annottext">data_decl :: DDec
</span><a href="#local-6989586621681358324"><span class="hs-identifier hs-var hs-var">data_decl</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">NewOrData
-&gt; DCxt
-&gt; Name
-&gt; [DTyVarBndr]
-&gt; Maybe DType
-&gt; [DCon]
-&gt; [DDerivClause]
-&gt; DDec
</span><span class="hs-identifier hs-var">DDataD</span></span><span> </span><span class="annot"><span class="annottext">NewOrData
</span><span class="hs-identifier hs-var">Data</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681358342"><span class="hs-identifier hs-var">data_name</span></a></span><span> </span><span class="annot"><span class="annottext">[DTyVarBndr]
</span><a href="#local-6989586621681358322"><span class="hs-identifier hs-var">args</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe DType
</span><a href="#local-6989586621681358343"><span class="hs-identifier hs-var">m_tyfun</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">DCon
</span><a href="#local-6989586621681358327"><span class="hs-identifier hs-var">con_decl</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-335"></span><span>            </span><span class="hs-keyword">where</span><span>
</span><span id="line-336"></span><span>              </span><span id="local-6989586621681358322"><span class="annot"><span class="annottext">args :: [DTyVarBndr]
</span><a href="#local-6989586621681358322"><span class="hs-identifier hs-var hs-var">args</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Maybe DType -&gt; Bool
forall a. Maybe a -&gt; Bool
</span><span class="hs-identifier hs-var">isJust</span></span><span> </span><span class="annot"><span class="annottext">Maybe DType
</span><a href="#local-6989586621681358343"><span class="hs-identifier hs-var">m_tyfun</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[DTyVarBndr]
</span><a href="#local-6989586621681358346"><span class="hs-identifier hs-var">arg_tvbs</span></a></span><span>
</span><span id="line-337"></span><span>                   </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[DTyVarBndr]
</span><a href="#local-6989586621681358336"><span class="hs-identifier hs-var">params</span></a></span><span>
</span><span id="line-338"></span><span>          </span><span id="local-6989586621681358320"><span class="annot"><span class="annottext">app_data_ty :: DType
</span><a href="#local-6989586621681358320"><span class="hs-identifier hs-var hs-var">app_data_ty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DType -&gt; [DTyVarBndr] -&gt; DType
</span><a href="Data.Singletons.Util.html#foldTypeTvbs"><span class="hs-identifier hs-var">foldTypeTvbs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; DType
</span><span class="hs-identifier hs-var">DConT</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681358342"><span class="hs-identifier hs-var">data_name</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[DTyVarBndr]
</span><a href="#local-6989586621681358346"><span class="hs-identifier hs-var">arg_tvbs</span></a></span><span>
</span><span id="line-339"></span><span>          </span><span id="local-6989586621681358319"><span class="annot"><span class="annottext">app_eqn :: DTySynEqn
</span><a href="#local-6989586621681358319"><span class="hs-identifier hs-var hs-var">app_eqn</span></a></span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe [DTyVarBndr] -&gt; DType -&gt; DType -&gt; DTySynEqn
</span><span class="hs-identifier hs-var">DTySynEqn</span></span><span> </span><span class="annot"><span class="annottext">Maybe [DTyVarBndr]
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-340"></span><span>                                  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; DType
</span><span class="hs-identifier hs-var">DConT</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="Data.Singletons.Names.html#applyName"><span class="hs-identifier hs-var">applyName</span></a></span><span> </span><span class="annot"><span class="annottext">DType -&gt; DType -&gt; DType
</span><span class="hs-operator hs-var">`DAppT`</span></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681358320"><span class="hs-identifier hs-var">app_data_ty</span></a></span><span>
</span><span id="line-341"></span><span>                                                   </span><span class="annot"><span class="annottext">DType -&gt; DType -&gt; DType
</span><span class="hs-operator hs-var">`DAppT`</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; DType
</span><span class="hs-identifier hs-var">DVarT</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681358345"><span class="hs-identifier hs-var">tyfun_name</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-342"></span><span>                                  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DType -&gt; [DTyVarBndr] -&gt; DType
</span><a href="Data.Singletons.Util.html#foldTypeTvbs"><span class="hs-identifier hs-var">foldTypeTvbs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; DType
</span><span class="hs-identifier hs-var">DConT</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681358341"><span class="hs-identifier hs-var">next_name</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-343"></span><span>                                                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[DTyVarBndr]
</span><a href="#local-6989586621681358346"><span class="hs-identifier hs-var">arg_tvbs</span></a></span><span> </span><span class="annot"><span class="annottext">[DTyVarBndr] -&gt; [DTyVarBndr] -&gt; [DTyVarBndr]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Name -&gt; DTyVarBndr
</span><span class="hs-identifier hs-var">DPlainTV</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681358345"><span class="hs-identifier hs-var">tyfun_name</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-344"></span><span>          </span><span id="local-6989586621681358316"><span class="annot"><span class="annottext">app_decl :: DDec
</span><a href="#local-6989586621681358316"><span class="hs-identifier hs-var hs-var">app_decl</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DTySynEqn -&gt; DDec
</span><span class="hs-identifier hs-var">DTySynInstD</span></span><span> </span><span class="annot"><span class="annottext">DTySynEqn
</span><a href="#local-6989586621681358319"><span class="hs-identifier hs-var">app_eqn</span></a></span><span>
</span><span id="line-345"></span><span>          </span><span id="local-6989586621681358314"><span class="annot"><span class="annottext">suppress :: DDec
</span><a href="#local-6989586621681358314"><span class="hs-identifier hs-var hs-var">suppress</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe Overlap
-&gt; Maybe [DTyVarBndr] -&gt; DCxt -&gt; DType -&gt; [DDec] -&gt; DDec
</span><span class="hs-identifier hs-var">DInstanceD</span></span><span> </span><span class="annot"><span class="annottext">Maybe Overlap
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">Maybe [DTyVarBndr]
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-346"></span><span>                          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; DType
</span><span class="hs-identifier hs-var">DConT</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="Data.Singletons.Names.html#suppressClassName"><span class="hs-identifier hs-var">suppressClassName</span></a></span><span> </span><span class="annot"><span class="annottext">DType -&gt; DType -&gt; DType
</span><span class="hs-operator hs-var">`DAppT`</span></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681358320"><span class="hs-identifier hs-var">app_data_ty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-347"></span><span>                          </span><span class="hs-special">[</span><span class="annot"><span class="annottext">DLetDec -&gt; DDec
</span><span class="hs-identifier hs-var">DLetDec</span></span><span> </span><span class="annot"><span class="annottext">(DLetDec -&gt; DDec) -&gt; DLetDec -&gt; DDec
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; [DClause] -&gt; DLetDec
</span><span class="hs-identifier hs-var">DFunD</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="Data.Singletons.Names.html#suppressMethodName"><span class="hs-identifier hs-var">suppressMethodName</span></a></span><span>
</span><span id="line-348"></span><span>                                           </span><span class="hs-special">[</span><span class="annot"><span class="annottext">[DPat] -&gt; DExp -&gt; DClause
</span><span class="hs-identifier hs-var">DClause</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-349"></span><span>                                                    </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; DExp
</span><span class="hs-identifier hs-var">DVarE</span></span><span> </span><span class="hs-special">'</span><span class="hs-identifier">snd</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">DExp -&gt; DExp -&gt; DExp
</span><span class="hs-operator hs-var">`DAppE`</span></span><span>
</span><span id="line-350"></span><span>                                                     </span><span class="annot"><span class="annottext">[DExp] -&gt; DExp
</span><span class="hs-identifier hs-var">mkTupleDExp</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Name -&gt; DExp
</span><span class="hs-identifier hs-var">DConE</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681358340"><span class="hs-identifier hs-var">con_name</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-351"></span><span>                                                                  </span><span class="annot"><span class="annottext">[DExp] -&gt; DExp
</span><span class="hs-identifier hs-var">mkTupleDExp</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">]</span><span>
</span><span id="line-352"></span><span>
</span><span id="line-353"></span><span>          </span><span class="hs-comment">-- See Note [Fixity declarations for defunctionalization symbols]</span><span>
</span><span id="line-354"></span><span>          </span><span id="local-6989586621681358303"><span class="annot"><span class="annottext">fixity_decl :: [DDec]
</span><a href="#local-6989586621681358303"><span class="hs-identifier hs-var hs-var">fixity_decl</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe DDec -&gt; [DDec]
forall a. Maybe a -&gt; [a]
</span><span class="hs-identifier hs-var">maybeToList</span></span><span> </span><span class="annot"><span class="annottext">(Maybe DDec -&gt; [DDec]) -&gt; Maybe DDec -&gt; [DDec]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Fixity -&gt; DDec) -&gt; Maybe Fixity -&gt; Maybe DDec
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; Fixity -&gt; DDec
</span><a href="#local-6989586621681358301"><span class="hs-identifier hs-var">mk_fix_decl</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681358342"><span class="hs-identifier hs-var">data_name</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe Fixity
</span><a href="#local-6989586621681358411"><span class="hs-identifier hs-var">m_fixity</span></a></span><span>
</span><span id="line-355"></span><span>      </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">DDec
</span><a href="#local-6989586621681358324"><span class="hs-identifier hs-var">data_decl</span></a></span><span> </span><span class="annot"><span class="annottext">DDec -&gt; [DDec] -&gt; [DDec]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">DDec
</span><a href="#local-6989586621681358316"><span class="hs-identifier hs-var">app_decl</span></a></span><span> </span><span class="annot"><span class="annottext">DDec -&gt; [DDec] -&gt; [DDec]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">DDec
</span><a href="#local-6989586621681358314"><span class="hs-identifier hs-var">suppress</span></a></span><span> </span><span class="annot"><span class="annottext">DDec -&gt; [DDec] -&gt; [DDec]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621681358303"><span class="hs-identifier hs-var">fixity_decl</span></a></span><span>
</span><span id="line-356"></span><span>
</span><span id="line-357"></span><span>    </span><span class="hs-comment">-- Generate a &quot;fully saturated&quot; defunction symbol, along with a fixity</span><span>
</span><span id="line-358"></span><span>    </span><span class="hs-comment">-- declaration (if needed).</span><span>
</span><span id="line-359"></span><span>    </span><span class="annot"><a href="#local-6989586621681358382"><span class="hs-identifier hs-type">mk_sat_decs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Data.Singletons.TH.Options.html#Options"><span class="hs-identifier hs-type">Options</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">DTyVarBndr</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">DKind</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">DDec</span></span><span class="hs-special">]</span><span>
</span><span id="line-360"></span><span>    </span><span id="local-6989586621681358382"><span class="annot"><span class="annottext">mk_sat_decs :: Options -&gt; Int -&gt; [DTyVarBndr] -&gt; Maybe DType -&gt; [DDec]
</span><a href="#local-6989586621681358382"><span class="hs-identifier hs-var hs-var">mk_sat_decs</span></a></span></span><span> </span><span id="local-6989586621681358300"><span class="annot"><span class="annottext">Options
</span><a href="#local-6989586621681358300"><span class="hs-identifier hs-var">opts</span></a></span></span><span> </span><span id="local-6989586621681358299"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681358299"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621681358298"><span class="annot"><span class="annottext">[DTyVarBndr]
</span><a href="#local-6989586621681358298"><span class="hs-identifier hs-var">sat_tvbs</span></a></span></span><span> </span><span id="local-6989586621681358297"><span class="annot"><span class="annottext">Maybe DType
</span><a href="#local-6989586621681358297"><span class="hs-identifier hs-var">m_sat_res</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-361"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681358296"><span class="annot"><span class="annottext">sat_name :: Name
</span><a href="#local-6989586621681358296"><span class="hs-identifier hs-var hs-var">sat_name</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Options -&gt; Name -&gt; Int -&gt; Name
</span><a href="Data.Singletons.TH.Options.html#defunctionalizedName"><span class="hs-identifier hs-var hs-var">defunctionalizedName</span></a></span><span> </span><span class="annot"><span class="annottext">Options
</span><a href="#local-6989586621681358300"><span class="hs-identifier hs-var">opts</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681358412"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681358299"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-362"></span><span>          </span><span id="local-6989586621681358295"><span class="annot"><span class="annottext">sat_dec :: DDec
</span><a href="#local-6989586621681358295"><span class="hs-identifier hs-var hs-var">sat_dec</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name -&gt; [DTyVarBndr] -&gt; DType -&gt; DDec
</span><span class="hs-identifier hs-var">DTySynD</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681358296"><span class="hs-identifier hs-var">sat_name</span></a></span><span> </span><span class="annot"><span class="annottext">[DTyVarBndr]
</span><a href="#local-6989586621681358298"><span class="hs-identifier hs-var">sat_tvbs</span></a></span><span> </span><span class="annot"><span class="annottext">(DType -&gt; DDec) -&gt; DType -&gt; DDec
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-363"></span><span>                     </span><span class="annot"><span class="annottext">DType -&gt; [DTyVarBndr] -&gt; DType
</span><a href="Data.Singletons.Util.html#foldTypeTvbs"><span class="hs-identifier hs-var">foldTypeTvbs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; DType
</span><span class="hs-identifier hs-var">DConT</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681358412"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[DTyVarBndr]
</span><a href="#local-6989586621681358298"><span class="hs-identifier hs-var">sat_tvbs</span></a></span><span> </span><span class="annot"><span class="annottext">DType -&gt; Maybe DType -&gt; DType
</span><a href="Data.Singletons.Util.html#maybeSigT"><span class="hs-operator hs-var">`maybeSigT`</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe DType
</span><a href="#local-6989586621681358297"><span class="hs-identifier hs-var">m_sat_res</span></a></span><span>
</span><span id="line-364"></span><span>          </span><span id="local-6989586621681358293"><span class="annot"><span class="annottext">sat_fixity_dec :: [DDec]
</span><a href="#local-6989586621681358293"><span class="hs-identifier hs-var hs-var">sat_fixity_dec</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe DDec -&gt; [DDec]
forall a. Maybe a -&gt; [a]
</span><span class="hs-identifier hs-var">maybeToList</span></span><span> </span><span class="annot"><span class="annottext">(Maybe DDec -&gt; [DDec]) -&gt; Maybe DDec -&gt; [DDec]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Fixity -&gt; DDec) -&gt; Maybe Fixity -&gt; Maybe DDec
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; Fixity -&gt; DDec
</span><a href="#local-6989586621681358301"><span class="hs-identifier hs-var">mk_fix_decl</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681358296"><span class="hs-identifier hs-var">sat_name</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe Fixity
</span><a href="#local-6989586621681358411"><span class="hs-identifier hs-var">m_fixity</span></a></span><span>
</span><span id="line-365"></span><span>      </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">DDec
</span><a href="#local-6989586621681358295"><span class="hs-identifier hs-var">sat_dec</span></a></span><span> </span><span class="annot"><span class="annottext">DDec -&gt; [DDec] -&gt; [DDec]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[DDec]
</span><a href="#local-6989586621681358293"><span class="hs-identifier hs-var">sat_fixity_dec</span></a></span><span>
</span><span id="line-366"></span><span>
</span><span id="line-367"></span><span>    </span><span class="hs-comment">-- Generate extra kind variable binders corresponding to the number of</span><span>
</span><span id="line-368"></span><span>    </span><span class="hs-comment">-- arrows in the return kind (if provided). Examples:</span><span>
</span><span id="line-369"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-370"></span><span>    </span><span class="hs-comment">-- &gt;&gt;&gt; eta_expand [(x :: a), (y :: b)] (Just (c -&gt; Type))</span><span>
</span><span id="line-371"></span><span>    </span><span class="hs-comment">-- ([(x :: a), (y :: b), (e :: c)], Just Type)</span><span>
</span><span id="line-372"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-373"></span><span>    </span><span class="hs-comment">-- &gt;&gt;&gt; eta_expand [(x :: a), (y :: b)] Nothing</span><span>
</span><span id="line-374"></span><span>    </span><span class="hs-comment">-- ([(x :: a), (y :: b)], Nothing)</span><span>
</span><span id="line-375"></span><span>    </span><span class="annot"><a href="#local-6989586621681358362"><span class="hs-identifier hs-type">eta_expand</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">DTyVarBndr</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">DKind</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Data.Singletons.Promote.Monad.html#PrM"><span class="hs-identifier hs-type">PrM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">DTyVarBndr</span></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">DKind</span></span><span class="hs-special">)</span><span>
</span><span id="line-376"></span><span>    </span><span id="local-6989586621681358362"><span class="annot"><span class="annottext">eta_expand :: [DTyVarBndr] -&gt; Maybe DType -&gt; PrM ([DTyVarBndr], Maybe DType)
</span><a href="#local-6989586621681358362"><span class="hs-identifier hs-var hs-var">eta_expand</span></a></span></span><span> </span><span id="local-6989586621681358292"><span class="annot"><span class="annottext">[DTyVarBndr]
</span><a href="#local-6989586621681358292"><span class="hs-identifier hs-var">m_arg_tvbs</span></a></span></span><span> </span><span class="annot"><span class="annottext">Maybe DType
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">([DTyVarBndr], Maybe DType) -&gt; PrM ([DTyVarBndr], Maybe DType)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[DTyVarBndr]
</span><a href="#local-6989586621681358292"><span class="hs-identifier hs-var">m_arg_tvbs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe DType
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span>
</span><span id="line-377"></span><span>    </span><span class="annot"><a href="#local-6989586621681358362"><span class="hs-identifier hs-var">eta_expand</span></a></span><span> </span><span id="local-6989586621681358291"><span class="annot"><span class="annottext">[DTyVarBndr]
</span><a href="#local-6989586621681358291"><span class="hs-identifier hs-var">m_arg_tvbs</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621681358290"><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681358290"><span class="hs-identifier hs-var">res_kind</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-378"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681358289"><span class="annot"><span class="annottext">DFunArgs
</span><a href="#local-6989586621681358289"><span class="hs-identifier hs-var">arg_ks</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681358288"><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681358288"><span class="hs-identifier hs-var">result_k</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DType -&gt; (DFunArgs, DType)
</span><span class="hs-identifier hs-var">unravelDType</span></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681358290"><span class="hs-identifier hs-var">res_kind</span></a></span><span>
</span><span id="line-379"></span><span>            </span><span id="local-6989586621681358286"><span class="annot"><span class="annottext">vis_arg_ks :: [DVisFunArg]
</span><a href="#local-6989586621681358286"><span class="hs-identifier hs-var hs-var">vis_arg_ks</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DFunArgs -&gt; [DVisFunArg]
</span><span class="hs-identifier hs-var">filterDVisFunArgs</span></span><span> </span><span class="annot"><span class="annottext">DFunArgs
</span><a href="#local-6989586621681358289"><span class="hs-identifier hs-var">arg_ks</span></a></span><span>
</span><span id="line-380"></span><span>        </span><span id="local-6989586621681358284"><span class="annot"><span class="annottext">[DTyVarBndr]
</span><a href="#local-6989586621681358284"><span class="hs-identifier hs-var">extra_arg_tvbs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(DVisFunArg -&gt; PrM DTyVarBndr) -&gt; [DVisFunArg] -&gt; PrM [DTyVarBndr]
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f (t b)
</span><span class="hs-identifier hs-var">traverse</span></span><span> </span><span class="annot"><span class="annottext">DVisFunArg -&gt; PrM DTyVarBndr
</span><a href="#local-6989586621681358283"><span class="hs-identifier hs-var">mk_extra_tvb</span></a></span><span> </span><span class="annot"><span class="annottext">[DVisFunArg]
</span><a href="#local-6989586621681358286"><span class="hs-identifier hs-var">vis_arg_ks</span></a></span><span>
</span><span id="line-381"></span><span>        </span><span class="annot"><span class="annottext">([DTyVarBndr], Maybe DType) -&gt; PrM ([DTyVarBndr], Maybe DType)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[DTyVarBndr]
</span><a href="#local-6989586621681358291"><span class="hs-identifier hs-var">m_arg_tvbs</span></a></span><span> </span><span class="annot"><span class="annottext">[DTyVarBndr] -&gt; [DTyVarBndr] -&gt; [DTyVarBndr]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[DTyVarBndr]
</span><a href="#local-6989586621681358284"><span class="hs-identifier hs-var">extra_arg_tvbs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">DType -&gt; Maybe DType
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681358288"><span class="hs-identifier hs-var">result_k</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-382"></span><span>
</span><span id="line-383"></span><span>    </span><span class="hs-comment">-- Convert a DVisFunArg to a DTyVarBndr, generating a fresh type variable</span><span>
</span><span id="line-384"></span><span>    </span><span class="hs-comment">-- name if the DVisFunArg is an anonymous argument.</span><span>
</span><span id="line-385"></span><span>    </span><span class="annot"><a href="#local-6989586621681358283"><span class="hs-identifier hs-type">mk_extra_tvb</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DVisFunArg</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Data.Singletons.Promote.Monad.html#PrM"><span class="hs-identifier hs-type">PrM</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">DTyVarBndr</span></span><span>
</span><span id="line-386"></span><span>    </span><span id="local-6989586621681358283"><span class="annot"><span class="annottext">mk_extra_tvb :: DVisFunArg -&gt; PrM DTyVarBndr
</span><a href="#local-6989586621681358283"><span class="hs-identifier hs-var hs-var">mk_extra_tvb</span></a></span></span><span> </span><span id="local-6989586621681358282"><span class="annot"><span class="annottext">DVisFunArg
</span><a href="#local-6989586621681358282"><span class="hs-identifier hs-var">vfa</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-387"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">DVisFunArg
</span><a href="#local-6989586621681358282"><span class="hs-identifier hs-var">vfa</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-388"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">DVisFADep</span></span><span> </span><span id="local-6989586621681358280"><span class="annot"><span class="annottext">DTyVarBndr
</span><a href="#local-6989586621681358280"><span class="hs-identifier hs-var">tvb</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">DTyVarBndr -&gt; PrM DTyVarBndr
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">DTyVarBndr
</span><a href="#local-6989586621681358280"><span class="hs-identifier hs-var">tvb</span></a></span><span>
</span><span id="line-389"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">DVisFAAnon</span></span><span> </span><span id="local-6989586621681358278"><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681358278"><span class="hs-identifier hs-var">k</span></a></span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Name -&gt; DType -&gt; DTyVarBndr
</span><span class="hs-identifier hs-var">DKindedTV</span></span><span> </span><span class="annot"><span class="annottext">(Name -&gt; DType -&gt; DTyVarBndr)
-&gt; PrM Name -&gt; PrM (DType -&gt; DTyVarBndr)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; PrM Name
forall (m :: * -&gt; *). Quasi m =&gt; String -&gt; m Name
</span><span class="hs-identifier hs-var">qNewName</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;e&quot;</span></span><span> </span><span class="annot"><span class="annottext">PrM (DType -&gt; DTyVarBndr) -&gt; PrM DType -&gt; PrM DTyVarBndr
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">DType -&gt; PrM DType
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681358278"><span class="hs-identifier hs-var">k</span></a></span><span>
</span><span id="line-390"></span><span>
</span><span id="line-391"></span><span>    </span><span class="annot"><a href="#local-6989586621681358301"><span class="hs-identifier hs-type">mk_fix_decl</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Fixity</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DDec</span></span><span>
</span><span id="line-392"></span><span>    </span><span id="local-6989586621681358301"><span class="annot"><span class="annottext">mk_fix_decl :: Name -&gt; Fixity -&gt; DDec
</span><a href="#local-6989586621681358301"><span class="hs-identifier hs-var hs-var">mk_fix_decl</span></a></span></span><span> </span><span id="local-6989586621681358277"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681358277"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621681358276"><span class="annot"><span class="annottext">Fixity
</span><a href="#local-6989586621681358276"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DLetDec -&gt; DDec
</span><span class="hs-identifier hs-var">DLetDec</span></span><span> </span><span class="annot"><span class="annottext">(DLetDec -&gt; DDec) -&gt; DLetDec -&gt; DDec
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Fixity -&gt; Name -&gt; DLetDec
</span><span class="hs-identifier hs-var">DInfixD</span></span><span> </span><span class="annot"><span class="annottext">Fixity
</span><a href="#local-6989586621681358276"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681358277"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-393"></span><span>
</span><span id="line-394"></span><span class="hs-comment">-- Indicates whether the type being defunctionalized has a standalone kind</span><span>
</span><span id="line-395"></span><span class="hs-comment">-- signature. If it does, DefunSAK contains the kind. If not, DefunNoSAK</span><span>
</span><span id="line-396"></span><span class="hs-comment">-- contains whatever information is known about its type variable binders</span><span>
</span><span id="line-397"></span><span class="hs-comment">-- and result kind.</span><span>
</span><span id="line-398"></span><span class="hs-comment">-- See Note [Defunctionalization game plan] for details on how this</span><span>
</span><span id="line-399"></span><span class="hs-comment">-- information is used.</span><span>
</span><span id="line-400"></span><span class="hs-keyword">data</span><span> </span><span id="DefunKindInfo"><span class="annot"><a href="Data.Singletons.Promote.Defun.html#DefunKindInfo"><span class="hs-identifier hs-var">DefunKindInfo</span></a></span></span><span>
</span><span id="line-401"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="DefunSAK"><span class="annot"><a href="Data.Singletons.Promote.Defun.html#DefunSAK"><span class="hs-identifier hs-var">DefunSAK</span></a></span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">DKind</span></span><span>
</span><span id="line-402"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="DefunNoSAK"><span class="annot"><a href="Data.Singletons.Promote.Defun.html#DefunNoSAK"><span class="hs-identifier hs-var">DefunNoSAK</span></a></span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">DTyVarBndr</span></span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">DKind</span></span><span class="hs-special">)</span><span>
</span><span id="line-403"></span><span>
</span><span id="line-404"></span><span class="hs-comment">-- Shorthand for building (k1 ~&gt; k2)</span><span>
</span><span id="line-405"></span><span class="annot"><a href="Data.Singletons.Promote.Defun.html#buildTyFunArrow"><span class="hs-identifier hs-type">buildTyFunArrow</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DKind</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DKind</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DKind</span></span><span>
</span><span id="line-406"></span><span id="buildTyFunArrow"><span class="annot"><span class="annottext">buildTyFunArrow :: DType -&gt; DType -&gt; DType
</span><a href="Data.Singletons.Promote.Defun.html#buildTyFunArrow"><span class="hs-identifier hs-var hs-var">buildTyFunArrow</span></a></span></span><span> </span><span id="local-6989586621681358274"><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681358274"><span class="hs-identifier hs-var">k1</span></a></span></span><span> </span><span id="local-6989586621681358273"><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681358273"><span class="hs-identifier hs-var">k2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name -&gt; DType
</span><span class="hs-identifier hs-var">DConT</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="Data.Singletons.Names.html#tyFunArrowName"><span class="hs-identifier hs-var">tyFunArrowName</span></a></span><span> </span><span class="annot"><span class="annottext">DType -&gt; DType -&gt; DType
</span><span class="hs-operator hs-var">`DAppT`</span></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681358274"><span class="hs-identifier hs-var">k1</span></a></span><span> </span><span class="annot"><span class="annottext">DType -&gt; DType -&gt; DType
</span><span class="hs-operator hs-var">`DAppT`</span></span><span> </span><span class="annot"><span class="annottext">DType
</span><a href="#local-6989586621681358273"><span class="hs-identifier hs-var">k2</span></a></span><span>
</span><span id="line-407"></span><span>
</span><span id="line-408"></span><span class="annot"><a href="Data.Singletons.Promote.Defun.html#buildTyFunArrow_maybe"><span class="hs-identifier hs-type">buildTyFunArrow_maybe</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">DKind</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">DKind</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">DKind</span></span><span>
</span><span id="line-409"></span><span id="buildTyFunArrow_maybe"><span class="annot"><span class="annottext">buildTyFunArrow_maybe :: Maybe DType -&gt; Maybe DType -&gt; Maybe DType
</span><a href="Data.Singletons.Promote.Defun.html#buildTyFunArrow_maybe"><span class="hs-identifier hs-var hs-var">buildTyFunArrow_maybe</span></a></span></span><span> </span><span id="local-6989586621681358271"><span class="annot"><span class="annottext">Maybe DType
</span><a href="#local-6989586621681358271"><span class="hs-identifier hs-var">m_k1</span></a></span></span><span> </span><span id="local-6989586621681358270"><span class="annot"><span class="annottext">Maybe DType
</span><a href="#local-6989586621681358270"><span class="hs-identifier hs-var">m_k2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DType -&gt; DType -&gt; DType
</span><a href="Data.Singletons.Promote.Defun.html#buildTyFunArrow"><span class="hs-identifier hs-var">buildTyFunArrow</span></a></span><span> </span><span class="annot"><span class="annottext">(DType -&gt; DType -&gt; DType) -&gt; Maybe DType -&gt; Maybe (DType -&gt; DType)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Maybe DType
</span><a href="#local-6989586621681358271"><span class="hs-identifier hs-var">m_k1</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (DType -&gt; DType) -&gt; Maybe DType -&gt; Maybe DType
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">Maybe DType
</span><a href="#local-6989586621681358270"><span class="hs-identifier hs-var">m_k2</span></a></span><span>
</span><span id="line-410"></span><span>
</span><span id="line-411"></span><span class="hs-comment">{-
Note [Defunctionalization game plan]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Generating defunctionalization symbols involves a surprising amount of
complexity. This Note gives a broad overview of what happens during
defunctionalization and highlights various design considerations.
As a working example, we will use the following type family:

  type Foo :: forall c a b. a -&gt; b -&gt; c -&gt; c
  type family Foo x y z where ...

We must generate a defunctionalization symbol for every number of arguments
to which Foo can be partially applied. We do so by generating the following
declarations:

  type FooSym0 :: forall c a b. a ~&gt; b ~&gt; c ~&gt; c
  data FooSym0 f where
   FooSym0KindInference :: SameKind (Apply FooSym0 arg) (FooSym1 arg)
                        =&gt; FooSym0 f
  type instance Apply FooSym0 x = FooSym1 x

  type FooSym1 :: forall c a b. a -&gt; b ~&gt; c ~&gt; c
  data FooSym1 x f where
    FooSym1KindInference :: SameKind (Apply (FooSym1 a) arg) (FooSym2 a arg)
                         =&gt; FooSym1 a f
  type instance Apply (FooSym1 x) y = FooSym2 x y

  type FooSym2 :: forall c a b. a -&gt; b -&gt; c ~&gt; c
  data FooSym2 x y f where
    FooSym2KindInference :: SameKind (Apply (FooSym2 x y) arg) (FooSym3 x y arg)
                         =&gt; FooSym2 x y f
  type instance Apply (FooSym2 x y) z = FooSym3 x y z

  type FooSym3 (x :: a) (y :: b) (z :: c) = Foo x y z :: c

Some things to note:

* Each defunctionalization symbol has its own standalone kind signature. The
  number after `Sym` in each symbol indicates the number of leading -&gt; arrows
  in its kind&#8212;that is, the number of arguments to which it can be applied
  directly to without the use of the Apply type family.

  See &quot;Wrinkle 1: Partial kinds&quot; below for what happens if the declaration
  being defunctionalized does *not* have a standalone kind signature.

* Each data declaration has a constructor with the suffix `-KindInference`
  in its name. These are redundant in the particular case of Foo, where the
  kind is already known. They play a more vital role when the kind of the
  declaration being defunctionalized is only partially known.
  See &quot;Wrinkle 1: Partial kinds&quot; below for more information.

* FooSym3, the last defunctionalization symbol, is somewhat special in that
  it is a type synonym, not a data type. These sorts of symbols are referred
  to as &quot;fully saturated&quot; defunctionalization symbols. Furthermore, these
  symbols are intentionally *not* given SAKs. See
  Note [No SAKs for fully saturated defunctionalization symbols].

* If Foo had a fixity declaration (e.g., infixl 4 `Foo`), then we would also
  generate fixity declarations for each defunctionalization symbol (e.g.,
  infixl 4 `FooSym0`).
  See Note [Fixity declarations for defunctionalization symbols].

* Foo has a vanilla kind signature. (See
  Note [Vanilla-type validity checking during promotion] in D.S.Promote.Type
  for what &quot;vanilla&quot; means in this context.) Having a vanilla type signature is
  important, as it is a property that makes it much simpler to preserve the
  order of type variables (`forall c a b.`) in each of the defunctionalization
  symbols.

  That being said, it is not strictly required that the kind be vanilla. There
  is another approach that can be used to defunctionalize things with
  non-vanilla types, at the possible expense of having different type variable
  orders between different defunctionalization symbols.
  See &quot;Wrinkle 2: Non-vanilla kinds&quot; below for more information.

-----
-- Wrinkle 1: Partial kinds
-----

The Foo example above has a standalone kind signature, but not everything has
this much kind information. For example, consider this:

  $(singletons [d|
    type family Not x where
      Not False = True
      Not True  = False
    |])

The inferred kind for Not is `Bool -&gt; Bool`, but since Not was declared in TH
quotes, `singletons` has no knowledge of this. Instead, we must rely on kind
inference to give Not's defunctionalization symbols the appropriate kinds.
Here is a na&#239;ve first attempt:

  data NotSym0 f
  type instance Apply NotSym0 x = NotSym1 x

  type NotSym1 x = Not x

NotSym1 will have the inferred kind `Bool -&gt; Bool`, but poor NotSym0 will have
the inferred kind `forall k. k -&gt; Type`, which is far more general than we
would like. We can do slightly better by supplying additional kind information
in a data constructor, like so:

  type SameKind :: k -&gt; k -&gt; Constraint
  class SameKind x y = ()

  data NotSym0 f where
    NotSym0KindInference :: SameKind (Apply NotSym0 arg) (NotSym1 arg)
                         =&gt; NotSym0 f

NotSym0KindInference is not intended to ever be seen by the user. Its only
reason for existing is its existential
`SameKind (Apply NotSym0 arg) (NotSym1 arg)` context, which allows GHC to
figure out that NotSym0 has kind `Bool ~&gt; Bool`. This is a bit of a hack, but
it works quite nicely. The only problem is that GHC is likely to warn that
NotSym0KindInference is unused, which is annoying. To work around this, we
mention the data constructor in an instance of a dummy class:

  instance SuppressUnusedWarnings NotSym0 where
    suppressUnusedWarnings = snd (NotSym0KindInference, ())

Similarly, this SuppressUnusedWarnings class is not intended to ever be seen
by the user. As its name suggests, it only exists to help suppress &quot;unused
data constructor&quot; warnings.

Some declarations have a mixture of known kinds and unknown kinds, such as in
this example:

  $(singletons [d|
    type family Bar x (y :: Nat) (z :: Nat) :: Nat where ...
    |])

We can use the known kinds to guide kind inference. In this particular example
of Bar, here are the defunctionalization symbols that would be generated:

  data BarSym0 f where ...
  data BarSym1 x :: Nat ~&gt; Nat ~&gt; Nat where ...
  data BarSym2 x (y :: Nat) :: Nat ~&gt; Nat where ...
  type BarSym3 x (y :: Nat) (z :: Nat) = Bar x y z :: Nat

-----
-- Wrinkle 2: Non-vanilla kinds
-----

There is only limited support for defunctionalizing declarations with
non-vanilla kinds. One example of something with a non-vanilla kind is the
following, which uses a nested forall:

  $(singletons [d|
    type Baz :: forall a. a -&gt; forall b. b -&gt; Type
    data Baz x y
    |])

One might envision generating the following defunctionalization symbols for
Baz:

  type BazSym0 :: forall a. a ~&gt; forall b. b ~&gt; Type
  data BazSym0 f where ...

  type BarSym1 :: forall a. a -&gt; forall b. b ~&gt; Type
  data BazSym1 x f where ...

  type family BazSym2 (x :: a) (y :: b) = Baz x y :: Type

Unfortunately, doing so would require impredicativity, since we would have:

    forall a. a ~&gt; forall b. b ~&gt; Type
  = forall a. (~&gt;) a (forall b. b ~&gt; Type)
  = forall a. TyFun a (forall b. b ~&gt; Type) -&gt; Type

Note that TyFun is an ordinary data type, so having its second argument be
(forall b. b ~&gt; Type) is truly impredicative. As a result, trying to preserve
nested or higher-rank foralls is a non-starter.

We need not reject Baz entirely, however. We can still generate perfectly
usable defunctionalization symbols if we are willing to sacrifice the exact
order of foralls. When we encounter a non-vanilla kind such as Baz's, we simply
fall back to the algorithm used when we encounter a partial kind (as described
in &quot;Wrinkle 1: Partial kinds&quot; above.) In other words, we generate the
following symbols:

  data BazSym0 :: a ~&gt; b ~&gt; Type where ...
  data BazSym1 (x :: a) :: b ~&gt; Type where ...
  type BazSym2 (x :: a) (y :: b) = Baz x y :: Type

The kinds of BazSym0 and BazSym1 both start with `forall a b.`,
whereas the `b` is quantified later in Baz itself. For most use cases, however,
this is not a huge concern.

Another way kinds can be non-vanilla is if they contain visible dependent
quantification, like so:

  $(singletons [d|
    type Quux :: forall (k :: Type) -&gt; k -&gt; Type
    data Quux x y
    |])

What should the kind of QuuxSym0 be? Intuitively, it should be this:

  type QuuxSym0 :: forall (k :: Type) ~&gt; k ~&gt; Type

Alas, `forall (k :: Type) ~&gt;` simply doesn't work. See #304. But there is an
acceptable compromise we can make that can give us defunctionalization symbols
for Quux. Once again, we fall back to the partial kind algorithm:

  data QuuxSym0 :: Type ~&gt; k ~&gt; Type where ...
  data QuuxSym1 (k :: Type) :: k ~&gt; Type where ...
  type QuuxSym2 (k :: Type) (x :: k) = Quux k x :: Type

The catch is that the kind of QuuxSym0, `forall k. Type ~&gt; k ~&gt; Type`, is
slightly more general than it ought to be. In practice, however, this is
unlikely to be a problem as long as you apply QuuxSym0 to arguments of the
right kinds.

Note [No SAKs for fully saturated defunctionalization symbols]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
When generating defunctionalization symbols, most of the symbols are data
types. The last one, however, is a type synonym. For example, this code:

  $(singletons [d|
    type Const :: a -&gt; b -&gt; a
    type Const x y = x
    |])

Will generate the following symbols:

  type ConstSym0 :: a ~&gt; b ~&gt; a
  data ConstSym0 f where ...

  type ConstSym1 :: a -&gt; b ~&gt; a
  data ConstSym1 x f where ...

  type ConstSym2 (x :: a) (y :: b) = Const x y :: a

ConstSym2, the sole type synonym of the bunch, is what is referred to as a
&quot;fully saturated&quot; defunctionaliztion symbol.

At first glance, ConstSym2 may not seem terribly useful, since it is
effectively a thin wrapper around the original Const type. Indeed, fully
saturated symbols are never appear directly in user-written code. Instead,
they are most valuable in TH-generated code, as singletons often generates code
that directly applies a defunctionalization symbol to some number of arguments
(see, for instance, D.S.Names.promoteTySym). In theory, such code could carve
out a special case for fully saturated applications and apply the original
type instead of a defunctionalization symbol, but determining when an
application is fully saturated is often difficult in practice. As a result, it
is more convenient to just generate code that always applies FuncSymN to N
arguments, and to let fully saturated defunctionalization symbols handle the
case where N equals the number of arguments needed to fully saturate Func.

Another curious thing about fully saturated defunctionalization symbols do
*not* get assigned SAKs, unlike their data type brethren. Why not just give
ConstSym2 a SAK like this?

  type ConstSym2 :: a -&gt; b -&gt; a
  type ConstSym2 x y = Const x y

This would in fact work for most use cases, but there are a handful of corner
cases where this approach would break down. Here is one such corner case:

  $(promote [d|
    class Applicative f where
      pure :: a -&gt; f a
      ...
      (*&gt;) :: f a -&gt; f b -&gt; f b
    |])

  ==&gt;

  class PApplicative f where
    type Pure (x :: a) :: f a
    type (*&gt;) (x :: f a) (y :: f b) :: f b

What would happen if we were to defunctionalize the promoted version of (*&gt;)?
We'd end up with the following defunctionalization symbols:

  type (*&gt;@#@$)   :: f a ~&gt; f b ~&gt; f b
  data (*&gt;@#@$) f where ...

  type (*&gt;@#@$$)  :: f a -&gt; f b ~&gt; f b
  data (*&gt;@#@$$) x f where ...

  type (*&gt;@#@$$$) :: f a -&gt; f b -&gt; f b
  type (*&gt;@#@$$$) x y = (*&gt;) x y

It turns out, however, that (*&gt;@#@$$$) will not kind-check. Because (*&gt;@#@$$$)
has a standalone kind signature, it is kind-generalized *before* kind-checking
the actual definition itself. Therefore, the full kind is:

  type (*&gt;@#@$$$) :: forall {k} (f :: k -&gt; Type) (a :: k) (b :: k).
                     f a -&gt; f b -&gt; f b
  type (*&gt;@#@$$$) x y = (*&gt;) x y

However, the kind of (*&gt;) is
`forall (f :: Type -&gt; Type) (a :: Type) (b :: Type). f a -&gt; f b -&gt; f b`.
This is not general enough for (*&gt;@#@$$$), which expects kind-polymorphic `f`,
`a`, and `b`, leading to a kind error. You might think that we could somehow
infer this information, but note the quoted definition of Applicative (and
PApplicative, as a consequence) omits the kinds of `f`, `a`, and `b` entirely.
Unless we were to implement full-blown kind inference inside of Template
Haskell (which is a tall order), the kind `f a -&gt; f b -&gt; f b` is about as good
as we can get.

Note that (*&gt;@#@$) and (*&gt;@#@$$) are implemented as GADTs, not type synonyms.
This allows them to have kind-polymorphic `f`, `a`, and `b` in their kinds
while equating `k` to be `Type` in their data constructors, which neatly avoids
the issue that (*&gt;@#@$$$) faces.

-----

In one last attempt to salvage the idea of giving SAKs to fully saturated
defunctionalization symbols, I explored an idea where we would add
&quot;dummy constraints&quot; to get the kinds exactly right. The idea was to first
define a type synonym for dummy contexts:

  type Dummy :: Constraint -&gt; Constraint
  type Dummy x = () ~ ()

Dummy simply ignores its argument and returns `() ~ ()`. `() ~ ()` was chosen
because it's one of the few Constraints that can currently be used at the kind
level. Dummy could, in theory, be used like this:

  type (*&gt;@#@$)   :: Dummy (PApplicative f) =&gt; f a ~&gt; f b ~&gt; f b
  type (*&gt;@#@$$)  :: Dummy (PApplicative f) =&gt; f a -&gt; f b ~&gt; f b
  type (*&gt;@#@$$$) :: Dummy (PApplicative f) =&gt; f a -&gt; f b -&gt; f b

The advantage to using `Dummy (PApplicative f)` is that it would constraint `f`
to be of kind `Type -&gt; Type`, which would get the kinds exactly the way we want
them. Sounds great, right? Unfortunately, it doesn't work in practice. Consider
this example:

  $(promoteOnly [d|
    class C a where
      m1 :: a -&gt; a
      m1 = m2

      m2 :: a -&gt; a
      m2 = m1
    |])

  ==&gt;

  class PC a where
    type M1 (x :: a) :: a
    type M1 x = Apply M2Sym1 x

    type M2 (x :: a) :: a
    type M2 x = Apply M1Sym1 x

The generated code would fail to compile, instead throwing this error:

  error:
      &#8226; Class &#8216;PC&#8217; cannot be used here
          (it is defined and used in the same recursive group)
      &#8226; In the first argument of &#8216;Dummy&#8217;, namely &#8216;(PC a)&#8217;
        In a standalone kind signature for &#8216;M2Sym1&#8217;:
          forall a. Dummy (PC a) =&gt; a -&gt; a
     |
     | type M2Sym1 :: forall a. Dummy (PC a) =&gt; a -&gt; a
     |                                 ^^^^

Ugh. I suspect this is a GHC bug (see
https://gitlab.haskell.org/ghc/ghc/issues/15942#note_242075), but it's one
that's unlikely to be fixed any time soon.

A slight variations on idea is to use the original class instead of the
promoted class in `Dummy` contexts, e.g.,

  type M2Sym1 :: forall a. Dummy (C a) =&gt; a -&gt; a

This would avoid the recursive group issues, but it would introduce a new
problem: the original class is not guaranteed to exist if
`promoteOnly` or `singletonsOnly` are used to create the promoted class.
(Indeed, this is precisely the case in the `PC` example.)

-----

As an alternative to type synonyms, we might consider using type families to
define fully saturated defunctionalization symbols. For instance, we could try
this:

  type (*&gt;@#@$$$) :: f a -&gt; f b -&gt; f b
  type family (*&gt;@#@$$$) x y where
    (*&gt;@#@$$$) x y = (*&gt;) x y

Like before, the full kind of (*&gt;@#@$$$) is generalized to be
`forall {k} (f :: k -&gt; Type) (a :: k) (b :: k)`. The difference is that the
type family equation *matches* on `k` such that the equation will only trigger
if `k` is equal to `Type`. (This is similar to the trick that (*&gt;@#@$) and
(*&gt;@#@$$) employ, as being GADTs allows them to constrain `k` to be `Type` in
their data constructors.)

Alas, the type family approach is strictly less powerful than the type synonym
approach. Consider the following code:

  $(singletons [d|
    data Nat = Z | S Nat

    natMinus :: Nat -&gt; Nat -&gt; Nat
    natMinus Z     _     = Z
    natMinus (S a) (S b) = natMinus a b
    natMinus a     Z     = a
    |])

Among other things, this will generate the following declarations:

  type ZSym0 :: Nat

  type NatMinus :: Nat -&gt; Nat -&gt; Nat
  type family NatMinus x y where
    NatMinus Z     _     = ZSym0
    NatMinus (S a) (S b) = NatMinus a b
    NatMinus a     Z     = a

  sNatMinus :: SNat x -&gt; SNat y -&gt; SNat (NatMinus x y)
  sNatMinus SZ      _       = SZ
  sNatMinus (SS sA) (SS sB) = sNatMinus sA sB
  sNatMinus sA      SZ      = sA

Shockingly, this will either succeed or fail to compile depending on whether
ZSym0 is a type synonym or a type family. If ZSym0 is a type synonym, then
the first and third equations of NatMinus will be compatible (since GHC will
be able to infer that Z ~ ZSym0), which is what allows the third equation of
sNatMinus to typecheck. If ZSym0 is a type family, however, then the third
equation of NatMinus will be incompatible with the first, which will cause
the third equation of sNatMinus to fail to typecheck:

  error:
      &#8226; Could not deduce: NatMinus x 'Z ~ x
        from the context: y ~ 'Z
          bound by a pattern with constructor: SZ :: SNat 'Z,
                   in an equation for &#8216;sNatMinus&#8217;
        &#8216;x&#8217; is a rigid type variable bound by
          the type signature for:
            sNatMinus :: forall (x :: Nat) (y :: Nat).
                         SNat x -&gt; SNat y -&gt; SNat (NatMinus x y)
        Expected type: SNat (NatMinus x y)
          Actual type: SNat x
      &#8226; In the expression: sA
        In an equation for &#8216;sNatMinus&#8217;: sNatMinus sA SZ = sA
      &#8226; Relevant bindings include
          sA :: SNat x
          sNatMinus :: SNat x -&gt; SNat y -&gt; SNat (NatMinus x y)

One could work around the issue by tweaking the third equation of natMinus
slightly:

  $(singletons [d|
    ...

    natMinus :: Nat -&gt; Nat -&gt; Nat
    natMinus Z       _     = Z
    natMinus (S a)   (S b) = natMinus a b
    natMinus a@(S _) Z     = a
    |])

But I would generally prefer to avoid having the user add extraneous pattern
matches when possible. Given the choice between expressiveness and SAKs, I give
the edge to expressiveness.

Bottom line: don't give fully saturated defunctionalization symbols SAKs. This
is admittedly not ideal, but it's unlikely to be a sticking point in practice,
given that these symbols are almost exclusively used in autogenerated code
in the first place. If we want to support promoting code that uses visible
type application (see #378), we will need to figure out how to resolve this
issue.

Note [Fixity declarations for defunctionalization symbols]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Just like we promote fixity declarations, we should also generate fixity
declarations for defunctionaliztion symbols. A primary use case is the
following scenario:

  (.) :: (b -&gt; c) -&gt; (a -&gt; b) -&gt; (a -&gt; c)
  (f . g) x = f (g x)
  infixr 9 .

One often writes (f . g . h) at the value level, but because (.) is promoted
to a type family with three arguments, this doesn't directly translate to the
type level. Instead, one must write this:

  f .@#@$$$ g .@#@$$$ h

But in order to ensure that this associates to the right as expected, one must
generate an `infixr 9 .@#@#$$$` declaration. This is why defunctionalize accepts
a Maybe Fixity argument.
-}</span><span>
</span><span id="line-898"></span></pre></body></html>