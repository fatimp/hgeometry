<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE TupleSections #-}</span><span>
</span><span id="line-2"></span><span class="hs-keyword">module</span><span> </span><span class="annot"><a href="GHC.Core.LateCC.TopLevelBinds.html"><span class="hs-identifier">GHC.Core.LateCC.TopLevelBinds</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-3"></span><span>
</span><span id="line-4"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Prelude.html"><span class="hs-identifier">GHC.Prelude</span></a></span><span>
</span><span id="line-5"></span><span>
</span><span id="line-6"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.html"><span class="hs-identifier">GHC.Core</span></a></span><span>
</span><span id="line-7"></span><span class="hs-comment">-- import GHC.Core.LateCC</span><span>
</span><span id="line-8"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.LateCC.Types.html"><span class="hs-identifier">GHC.Core.LateCC.Types</span></a></span><span>
</span><span id="line-9"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.LateCC.Utils.html"><span class="hs-identifier">GHC.Core.LateCC.Utils</span></a></span><span>
</span><span id="line-10"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Monad.html"><span class="hs-identifier">GHC.Core.Opt.Monad</span></a></span><span>
</span><span id="line-11"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Driver.DynFlags.html"><span class="hs-identifier">GHC.Driver.DynFlags</span></a></span><span>
</span><span id="line-12"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Id.html"><span class="hs-identifier">GHC.Types.Id</span></a></span><span>
</span><span id="line-13"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Name.html"><span class="hs-identifier">GHC.Types.Name</span></a></span><span>
</span><span id="line-14"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Unit.Module.ModGuts.html"><span class="hs-identifier">GHC.Unit.Module.ModGuts</span></a></span><span>
</span><span id="line-15"></span><span>
</span><span id="line-16"></span><span class="hs-comment">{- Note [Collecting late cost centres]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Usually cost centres defined by a module are collected
during tidy by collectCostCentres. However with `-fprof-late`
we insert cost centres after inlining. So we keep a list of
all the cost centres we inserted and combine that with the list
of cost centres found during tidy.

To avoid overhead when using -fprof-inline there is a flag to stop
us from collecting them here when we run this pass before tidy.

Note [Adding late cost centres to top level bindings]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The basic idea is very simple. For every top level binder
`f = rhs` we compile it as if the user had written
`f = {-# SCC f #-} rhs`.

If we do this after unfoldings for `f` have been created this
doesn't impact core-level optimizations at all. If we do it
before the cost centre will be included in the unfolding and
might inhibit optimizations at the call site. For this reason
we provide flags for both approaches as they have different
tradeoffs.

We also don't add a cost centre for any binder that is a constructor
worker or wrapper. These will never meaningfully enrich the resulting
profile so we improve efficiency by omitting those.

-}</span><span>
</span><span id="line-45"></span><span>
</span><span id="line-46"></span><span class="hs-comment">-- | Add late cost centres directly to the 'ModGuts'. This is used inside the</span><span>
</span><span id="line-47"></span><span class="hs-comment">-- core pipeline with the -fprof-late-inline flag. It should not be used after</span><span>
</span><span id="line-48"></span><span class="hs-comment">-- tidy, since it does not manually track inserted cost centers. See</span><span>
</span><span id="line-49"></span><span class="hs-comment">-- Note [Collecting late cost centres].</span><span>
</span><span id="line-50"></span><span class="annot"><a href="GHC.Core.LateCC.TopLevelBinds.html#topLevelBindsCCMG"><span class="hs-identifier hs-type">topLevelBindsCCMG</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Unit.Module.ModGuts.html#ModGuts"><span class="hs-identifier hs-type">ModGuts</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.Opt.Monad.html#CoreM"><span class="hs-identifier hs-type">CoreM</span></a></span><span> </span><span class="annot"><a href="GHC.Unit.Module.ModGuts.html#ModGuts"><span class="hs-identifier hs-type">ModGuts</span></a></span><span>
</span><span id="line-51"></span><span id="topLevelBindsCCMG"><span class="annot"><span class="annottext">topLevelBindsCCMG :: ModGuts -&gt; CoreM ModGuts
</span><a href="GHC.Core.LateCC.TopLevelBinds.html#topLevelBindsCCMG"><span class="hs-identifier hs-var hs-var">topLevelBindsCCMG</span></a></span></span><span> </span><span id="local-6989586621682765362"><span class="annot"><span class="annottext">ModGuts
</span><a href="#local-6989586621682765362"><span class="hs-identifier hs-var">guts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-52"></span><span>    </span><span id="local-6989586621682765363"><span class="annot"><a href="#local-6989586621682765363"><span class="hs-identifier hs-var">dflags</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CoreM DynFlags
forall (m :: * -&gt; *). HasDynFlags m =&gt; m DynFlags
</span><a href="GHC.Driver.DynFlags.html#getDynFlags"><span class="hs-identifier hs-var">getDynFlags</span></a></span><span>
</span><span id="line-53"></span><span>    </span><span class="hs-keyword">let</span><span>
</span><span id="line-54"></span><span>      </span><span id="local-6989586621682765365"><span class="annot"><a href="#local-6989586621682765365"><span class="hs-identifier hs-var hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-55"></span><span>        </span><span class="annot"><a href="GHC.Core.LateCC.Types.html#LateCCEnv"><span class="hs-identifier hs-type">LateCCEnv</span></a></span><span>
</span><span id="line-56"></span><span>          </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">lateCCEnv_module :: Module
</span><a href="#local-6989586621682765367"><span class="hs-identifier hs-var">lateCCEnv_module</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ModGuts -&gt; Module
</span><a href="GHC.Unit.Module.ModGuts.html#mg_module"><span class="hs-identifier hs-var">mg_module</span></a></span><span> </span><span class="annot"><span class="annottext">ModGuts
</span><a href="#local-6989586621682765362"><span class="hs-identifier hs-var">guts</span></a></span><span>
</span><span id="line-57"></span><span>
</span><span id="line-58"></span><span>            </span><span class="hs-comment">-- We don't use this for topLevelBindsCC, so Nothing is okay</span><span>
</span><span id="line-59"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">lateCCEnv_file :: Maybe FastString
</span><a href="#local-6989586621682765369"><span class="hs-identifier hs-var">lateCCEnv_file</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe FastString
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-60"></span><span>
</span><span id="line-61"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">lateCCEnv_countEntries :: Bool
</span><a href="#local-6989586621682765370"><span class="hs-identifier hs-var">lateCCEnv_countEntries</span></a></span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">GeneralFlag -&gt; DynFlags -&gt; Bool
</span><a href="GHC.Driver.DynFlags.html#gopt"><span class="hs-identifier hs-var">gopt</span></a></span><span> </span><span class="annot"><span class="annottext">GeneralFlag
</span><a href="GHC.Driver.Flags.html#Opt_ProfCountEntries"><span class="hs-identifier hs-var">Opt_ProfCountEntries</span></a></span><span> </span><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621682765363"><span class="hs-identifier hs-var">dflags</span></a></span><span>
</span><span id="line-62"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">lateCCEnv_collectCCs :: Bool
</span><a href="#local-6989586621682765373"><span class="hs-identifier hs-var">lateCCEnv_collectCCs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-63"></span><span>          </span><span class="hs-special">}</span><span>
</span><span id="line-64"></span><span>      </span><span id="local-6989586621682765374"><span class="annot"><a href="#local-6989586621682765374"><span class="hs-identifier hs-var hs-var">guts'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-65"></span><span>        </span><span class="annot"><span class="annottext">ModGuts
</span><a href="#local-6989586621682765362"><span class="hs-identifier hs-var">guts</span></a></span><span>
</span><span id="line-66"></span><span>          </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="GHC.Unit.Module.ModGuts.html#mg_binds"><span class="hs-identifier hs-var">mg_binds</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-67"></span><span>              </span><span class="annot"><span class="hs-identifier hs-type">fst</span></span><span>
</span><span id="line-68"></span><span>                </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.LateCC.Utils.html#doLateCostCenters"><span class="hs-identifier hs-type">doLateCostCenters</span></a></span><span>
</span><span id="line-69"></span><span>                    </span><span class="annot"><a href="#local-6989586621682765365"><span class="hs-identifier hs-type">env</span></a></span><span>
</span><span id="line-70"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.LateCC.Types.html#initLateCCState"><span class="hs-identifier hs-type">initLateCCState</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-71"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.LateCC.TopLevelBinds.html#topLevelBindsCC"><span class="hs-identifier hs-type">topLevelBindsCC</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">const</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">True</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-72"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Unit.Module.ModGuts.html#mg_binds"><span class="hs-identifier hs-var">mg_binds</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682765362"><span class="hs-identifier hs-type">guts</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-73"></span><span>                </span><span class="hs-special">)</span><span>
</span><span id="line-74"></span><span>          </span><span class="hs-special">}</span><span>
</span><span id="line-75"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">return</span></span><span> </span><span class="annot"><a href="#local-6989586621682765374"><span class="hs-identifier hs-type">guts'</span></a></span><span>
</span><span id="line-76"></span><span>
</span><span id="line-77"></span><span class="hs-comment">-- | Insert cost centres on top-level bindings in the module, depending on</span><span>
</span><span id="line-78"></span><span class="hs-comment">-- whether or not they satisfy the given predicate.</span><span>
</span><span id="line-79"></span><span id="local-6989586621682765308"><span class="annot"><a href="GHC.Core.LateCC.TopLevelBinds.html#topLevelBindsCC"><span class="hs-identifier hs-type">topLevelBindsCC</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreBind"><span class="hs-identifier hs-type">CoreBind</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.LateCC.Types.html#LateCCM"><span class="hs-identifier hs-type">LateCCM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682765308"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="GHC.Core.html#CoreBind"><span class="hs-identifier hs-type">CoreBind</span></a></span></span><span>
</span><span id="line-80"></span><span id="topLevelBindsCC"><span class="annot"><span class="annottext">topLevelBindsCC :: forall s. (CoreExpr -&gt; Bool) -&gt; CoreBind -&gt; LateCCM s CoreBind
</span><a href="GHC.Core.LateCC.TopLevelBinds.html#topLevelBindsCC"><span class="hs-identifier hs-var hs-var">topLevelBindsCC</span></a></span></span><span> </span><span id="local-6989586621682765396"><span class="annot"><span class="annottext">CoreExpr -&gt; Bool
</span><a href="#local-6989586621682765396"><span class="hs-identifier hs-var">pred</span></a></span></span><span> </span><span id="local-6989586621682765397"><span class="annot"><span class="annottext">CoreBind
</span><a href="#local-6989586621682765397"><span class="hs-identifier hs-var">core_bind</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-81"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">CoreBind
</span><a href="#local-6989586621682765397"><span class="hs-identifier hs-var">core_bind</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-82"></span><span>      </span><span class="annot"><a href="GHC.Core.html#NonRec"><span class="hs-identifier hs-type">NonRec</span></a></span><span> </span><span id="local-6989586621682765399"><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682765399"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span id="local-6989586621682765400"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682765400"><span class="hs-identifier hs-var">rhs</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-83"></span><span>        </span><span class="annot"><span class="annottext">CoreBndr -&gt; CoreExpr -&gt; CoreBind
forall b. b -&gt; Expr b -&gt; Bind b
</span><a href="GHC.Core.html#NonRec"><span class="hs-identifier hs-var">NonRec</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682765399"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">(CoreExpr -&gt; CoreBind)
-&gt; ReaderT LateCCEnv (State (LateCCState s)) CoreExpr
-&gt; LateCCM s CoreBind
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">CoreBndr
-&gt; CoreExpr -&gt; ReaderT LateCCEnv (State (LateCCState s)) CoreExpr
forall s. CoreBndr -&gt; CoreExpr -&gt; LateCCM s CoreExpr
</span><a href="#local-6989586621682765402"><span class="hs-identifier hs-var">doBndr</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682765399"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682765400"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-84"></span><span>      </span><span class="annot"><a href="GHC.Core.html#Rec"><span class="hs-identifier hs-type">Rec</span></a></span><span> </span><span id="local-6989586621682765404"><span class="annot"><span class="annottext">[(CoreBndr, CoreExpr)]
</span><a href="#local-6989586621682765404"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-85"></span><span>        </span><span class="annot"><span class="annottext">[(CoreBndr, CoreExpr)] -&gt; CoreBind
forall b. [(b, Expr b)] -&gt; Bind b
</span><a href="GHC.Core.html#Rec"><span class="hs-identifier hs-var">Rec</span></a></span><span> </span><span class="annot"><span class="annottext">([(CoreBndr, CoreExpr)] -&gt; CoreBind)
-&gt; ReaderT LateCCEnv (State (LateCCState s)) [(CoreBndr, CoreExpr)]
-&gt; LateCCM s CoreBind
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">((CoreBndr, CoreExpr)
 -&gt; ReaderT LateCCEnv (State (LateCCState s)) (CoreBndr, CoreExpr))
-&gt; [(CoreBndr, CoreExpr)]
-&gt; ReaderT LateCCEnv (State (LateCCState s)) [(CoreBndr, CoreExpr)]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; [a] -&gt; m [b]
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">(CoreBndr, CoreExpr)
-&gt; ReaderT LateCCEnv (State (LateCCState s)) (CoreBndr, CoreExpr)
forall s. (CoreBndr, CoreExpr) -&gt; LateCCM s (CoreBndr, CoreExpr)
</span><a href="#local-6989586621682765406"><span class="hs-identifier hs-var">doPair</span></a></span><span> </span><span class="annot"><span class="annottext">[(CoreBndr, CoreExpr)]
</span><a href="#local-6989586621682765404"><span class="hs-identifier hs-var">bs</span></a></span><span>
</span><span id="line-86"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-87"></span><span>    </span><span id="local-6989586621682765338"><span class="annot"><a href="#local-6989586621682765406"><span class="hs-identifier hs-type">doPair</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.LateCC.Types.html#LateCCM"><span class="hs-identifier hs-type">LateCCM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682765338"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span></span><span>
</span><span id="line-88"></span><span>    </span><span id="local-6989586621682765406"><span class="annot"><span class="annottext">doPair :: forall s. (CoreBndr, CoreExpr) -&gt; LateCCM s (CoreBndr, CoreExpr)
</span><a href="#local-6989586621682765406"><span class="hs-identifier hs-var hs-var">doPair</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621682765410"><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682765410"><span class="hs-identifier hs-var">b</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621682765411"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682765411"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682765410"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">,</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(CoreExpr -&gt; (CoreBndr, CoreExpr))
-&gt; ReaderT LateCCEnv (State (LateCCState s)) CoreExpr
-&gt; ReaderT LateCCEnv (State (LateCCState s)) (CoreBndr, CoreExpr)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">CoreBndr
-&gt; CoreExpr -&gt; ReaderT LateCCEnv (State (LateCCState s)) CoreExpr
forall s. CoreBndr -&gt; CoreExpr -&gt; LateCCM s CoreExpr
</span><a href="#local-6989586621682765402"><span class="hs-identifier hs-var">doBndr</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682765410"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682765411"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-89"></span><span>
</span><span id="line-90"></span><span>    </span><span id="local-6989586621682765333"><span class="annot"><a href="#local-6989586621682765402"><span class="hs-identifier hs-type">doBndr</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.LateCC.Types.html#LateCCM"><span class="hs-identifier hs-type">LateCCM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682765333"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span></span><span>
</span><span id="line-91"></span><span>    </span><span id="local-6989586621682765402"><span class="annot"><span class="annottext">doBndr :: forall s. CoreBndr -&gt; CoreExpr -&gt; LateCCM s CoreExpr
</span><a href="#local-6989586621682765402"><span class="hs-identifier hs-var hs-var">doBndr</span></a></span></span><span> </span><span id="local-6989586621682765417"><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682765417"><span class="hs-identifier hs-var">bndr</span></a></span></span><span> </span><span id="local-6989586621682765418"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682765418"><span class="hs-identifier hs-var">rhs</span></a></span></span><span>
</span><span id="line-92"></span><span>      </span><span class="hs-comment">-- Cost centres on constructor workers are pretty much useless</span><span>
</span><span id="line-93"></span><span>      </span><span class="hs-comment">-- so we don't emit them if we are looking at the rhs of a constructor</span><span>
</span><span id="line-94"></span><span>      </span><span class="hs-comment">-- binding.</span><span>
</span><span id="line-95"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">DataCon
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CoreBndr -&gt; Maybe DataCon
</span><a href="GHC.Types.Id.html#isDataConId_maybe"><span class="hs-identifier hs-var">isDataConId_maybe</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682765417"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; ReaderT LateCCEnv (State (LateCCState s)) CoreExpr
forall a. a -&gt; ReaderT LateCCEnv (State (LateCCState s)) a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682765418"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-96"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; Bool
</span><a href="#local-6989586621682765396"><span class="hs-identifier hs-var">pred</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682765418"><span class="hs-identifier hs-var">rhs</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">CoreBndr
-&gt; CoreExpr -&gt; ReaderT LateCCEnv (State (LateCCState s)) CoreExpr
forall s. CoreBndr -&gt; CoreExpr -&gt; LateCCM s CoreExpr
</span><a href="#local-6989586621682765420"><span class="hs-identifier hs-var">addCC</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682765417"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682765418"><span class="hs-identifier hs-var">rhs</span></a></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">CoreExpr -&gt; ReaderT LateCCEnv (State (LateCCState s)) CoreExpr
forall a. a -&gt; ReaderT LateCCEnv (State (LateCCState s)) a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682765418"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-97"></span><span>
</span><span id="line-98"></span><span>    </span><span class="hs-comment">-- We want to put the cost centre below the lambda as we only care about</span><span>
</span><span id="line-99"></span><span>    </span><span class="hs-comment">-- executions of the RHS.</span><span>
</span><span id="line-100"></span><span>    </span><span id="local-6989586621682765421"><span class="annot"><a href="#local-6989586621682765420"><span class="hs-identifier hs-type">addCC</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Types.Var.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Core.LateCC.Types.html#LateCCM"><span class="hs-identifier hs-type">LateCCM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621682765421"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="GHC.Core.html#CoreExpr"><span class="hs-identifier hs-type">CoreExpr</span></a></span></span><span>
</span><span id="line-101"></span><span>    </span><span id="local-6989586621682765420"><span class="annot"><span class="annottext">addCC :: forall s. CoreBndr -&gt; CoreExpr -&gt; LateCCM s CoreExpr
</span><a href="#local-6989586621682765420"><span class="hs-identifier hs-var hs-var">addCC</span></a></span></span><span> </span><span id="local-6989586621682765426"><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682765426"><span class="hs-identifier hs-var">bndr</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Core.html#Lam"><span class="hs-identifier hs-type">Lam</span></a></span><span> </span><span id="local-6989586621682765428"><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682765428"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span id="local-6989586621682765429"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682765429"><span class="hs-identifier hs-var">rhs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreBndr -&gt; CoreExpr -&gt; CoreExpr
forall b. b -&gt; Expr b -&gt; Expr b
</span><a href="GHC.Core.html#Lam"><span class="hs-identifier hs-var">Lam</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682765428"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">(CoreExpr -&gt; CoreExpr)
-&gt; ReaderT LateCCEnv (State (LateCCState s)) CoreExpr
-&gt; ReaderT LateCCEnv (State (LateCCState s)) CoreExpr
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">CoreBndr
-&gt; CoreExpr -&gt; ReaderT LateCCEnv (State (LateCCState s)) CoreExpr
forall s. CoreBndr -&gt; CoreExpr -&gt; LateCCM s CoreExpr
</span><a href="#local-6989586621682765420"><span class="hs-identifier hs-var">addCC</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682765426"><span class="hs-identifier hs-var">bndr</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682765429"><span class="hs-identifier hs-var">rhs</span></a></span><span>
</span><span id="line-102"></span><span>    </span><span class="annot"><a href="#local-6989586621682765420"><span class="hs-identifier hs-var">addCC</span></a></span><span> </span><span id="local-6989586621682765430"><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682765430"><span class="hs-identifier hs-var">bndr</span></a></span></span><span> </span><span id="local-6989586621682765431"><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682765431"><span class="hs-identifier hs-var">rhs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-103"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621682765432"><span class="annot"><span class="annottext">name :: Name
</span><a href="#local-6989586621682765432"><span class="hs-identifier hs-var hs-var">name</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CoreBndr -&gt; Name
</span><a href="GHC.Types.Id.html#idName"><span class="hs-identifier hs-var">idName</span></a></span><span> </span><span class="annot"><span class="annottext">CoreBndr
</span><a href="#local-6989586621682765430"><span class="hs-identifier hs-var">bndr</span></a></span><span>
</span><span id="line-104"></span><span>          </span><span id="local-6989586621682765434"><span class="annot"><span class="annottext">cc_loc :: SrcSpan
</span><a href="#local-6989586621682765434"><span class="hs-identifier hs-var hs-var">cc_loc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name -&gt; SrcSpan
</span><a href="GHC.Types.Name.html#nameSrcSpan"><span class="hs-identifier hs-var">nameSrcSpan</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621682765432"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-105"></span><span>          </span><span id="local-6989586621682765436"><span class="annot"><span class="annottext">cc_name :: FastString
</span><a href="#local-6989586621682765436"><span class="hs-identifier hs-var hs-var">cc_name</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name -&gt; FastString
forall a. NamedThing a =&gt; a -&gt; FastString
</span><a href="GHC.Types.Name.html#getOccFS"><span class="hs-identifier hs-var">getOccFS</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621682765432"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-106"></span><span>      </span><span class="annot"><span class="annottext">FastString
-&gt; SrcSpan
-&gt; CoreExpr
-&gt; ReaderT LateCCEnv (State (LateCCState s)) CoreExpr
forall s. FastString -&gt; SrcSpan -&gt; CoreExpr -&gt; LateCCM s CoreExpr
</span><a href="GHC.Core.LateCC.Utils.html#insertCC"><span class="hs-identifier hs-var">insertCC</span></a></span><span> </span><span class="annot"><span class="annottext">FastString
</span><a href="#local-6989586621682765436"><span class="hs-identifier hs-var">cc_name</span></a></span><span> </span><span class="annot"><span class="annottext">SrcSpan
</span><a href="#local-6989586621682765434"><span class="hs-identifier hs-var">cc_loc</span></a></span><span> </span><span class="annot"><span class="annottext">CoreExpr
</span><a href="#local-6989586621682765431"><span class="hs-identifier hs-var">rhs</span></a></span></pre></body></html>